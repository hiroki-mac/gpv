<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module SphericalHarmonics - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><span class="include">NMath</span>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-coslat">#coslat</a>
    
    <li ><a href="#method-i-deg2mu">#deg2mu</a>
    
    <li ><a href="#method-i-gauss_w">#gauss_w</a>
    
    <li ><a href="#method-i-lg_dlat">#lg_dlat</a>
    
    <li ><a href="#method-i-lg_invtrans">#lg_invtrans</a>
    
    <li ><a href="#method-i-lg_trans">#lg_trans</a>
    
    <li ><a href="#method-i-mu2deg">#mu2deg</a>
    
    <li ><a href="#method-i-multiply_cos">#multiply_cos</a>
    
    <li ><a href="#method-i-multiply_sin">#multiply_sin</a>
    
    <li ><a href="#method-i-p_m_nT">#p_m_nT</a>
    
    <li ><a href="#method-i-sh_divergence">#sh_divergence</a>
    
    <li ><a href="#method-i-sh_dlat">#sh_dlat</a>
    
    <li ><a href="#method-i-sh_dlon">#sh_dlon</a>
    
    <li ><a href="#method-i-sh_dlon_and_dlat">#sh_dlon_and_dlat</a>
    
    <li ><a href="#method-i-sh_energyspectrum">#sh_energyspectrum</a>
    
    <li ><a href="#method-i-sh_init">#sh_init</a>
    
    <li ><a href="#method-i-sh_invlaplacian">#sh_invlaplacian</a>
    
    <li ><a href="#method-i-sh_invtrans">#sh_invtrans</a>
    
    <li ><a href="#method-i-sh_invtrans_multi">#sh_invtrans_multi</a>
    
    <li ><a href="#method-i-sh_laplacian">#sh_laplacian</a>
    
    <li ><a href="#method-i-sh_trans">#sh_trans</a>
    
    <li ><a href="#method-i-sh_trans_multi">#sh_trans_multi</a>
    
    <li ><a href="#method-i-sh_uvcomps">#sh_uvcomps</a>
    
    <li ><a href="#method-i-sh_vor_and_div">#sh_vor_and_div</a>
    
    <li ><a href="#method-i-sh_vorticity">#sh_vorticity</a>
    
    <li ><a href="#method-i-sinlat">#sinlat</a>
    
    <li ><a href="#method-i-sp_cos2_dmu">#sp_cos2_dmu</a>
    
    <li ><a href="#method-i-sp_divergence">#sp_divergence</a>
    
    <li ><a href="#method-i-sp_dlon">#sp_dlon</a>
    
    <li ><a href="#method-i-sp_dmu_cos2">#sp_dmu_cos2</a>
    
    <li ><a href="#method-i-sp_invlaplacian">#sp_invlaplacian</a>
    
    <li ><a href="#method-i-sp_laplacian">#sp_laplacian</a>
    
    <li ><a href="#method-i-sp_vorticity">#sp_vorticity</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-SphericalHarmonics">
  <h1 id="module-SphericalHarmonics" class="module">
    module SphericalHarmonics
  </h1>

  <section class="description">
    
<p>class <a href="NArray.html"><code>NArray</code></a></p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">round</span>(<span class="ruby-identifier">n</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">round</span>(<span class="ruby-identifier">n</span>)}
<span class="ruby-keyword">end</span>
</pre>

<p>end</p>

  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <section class="constants-list">
      <header>
        <h3>Constants</h3>
      </header>
      <dl>
      
        <dt id="Integer">Integer
        
        <dd>
        
      
      </dl>
    </section>
    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-coslat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">coslat</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="coslat-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 817</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">coslat</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-ivar">@coslat</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-deg2mu" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">deg2mu</span><span
            class="method-args">(lat)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>緯度（Deg）をサイン緯度（μ）に変換 lat : 1D <a href="NArray.html"><code>NArray</code></a></p>
          
          

          
          <div class="method-source-code" id="deg2mu-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 54</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">deg2mu</span>(<span class="ruby-identifier">lat</span>)
      <span class="ruby-identifier">mu</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-gauss_w" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">gauss_w</span><span
            class="method-args">(lat)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>サインガウス緯度（sin(θ_k)）とガウス重み（w_k）を求める mu: 1D <a href="NArray.html"><code>NArray</code></a></p>
          
          

          
          <div class="method-source-code" id="gauss_w-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 143</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">gauss_w</span>(<span class="ruby-identifier">lat</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lat</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Integer</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">jmax</span> = <span class="ruby-identifier">lat</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">jmax</span> = <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">mu</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">gw</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">pjmax_m1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">pjmax_p1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">pjmax</span>    = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">mu</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">gw</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">pjmax_m1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">pjmax_p1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>)
      <span class="ruby-identifier">pjmax</span>    = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># ニュートン法でガウス緯度を計算する。（参考：石岡 2004）</span>
    <span class="ruby-comment"># 初期推定値。muが与えられているときはそれを初期推定値とする。</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lat</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Integer</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span>
        <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">j</span>] = <span class="ruby-identifier">cos</span>(<span class="ruby-constant">PI</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">jmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">j</span><span class="ruby-value">-0.25</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">jmax</span><span class="ruby-value">+0.5</span>))
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">mu</span> = <span class="ruby-identifier">deg2mu</span>(<span class="ruby-identifier">lat</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># 必要なルジャンドル多項式を求める</span>
    <span class="ruby-value">50</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span>
        <span class="ruby-identifier">pjmax_m1</span>[<span class="ruby-identifier">j</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_Pl</span>(<span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">j</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">sqrt</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1.0</span>)
        <span class="ruby-identifier">pjmax_p1</span>[<span class="ruby-identifier">j</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_Pl</span>(<span class="ruby-identifier">jmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">j</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">sqrt</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">jmax</span><span class="ruby-value">+3.0</span>)
        <span class="ruby-identifier">pjmax</span>[<span class="ruby-identifier">j</span>]    = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_Pl</span>(<span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">j</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">sqrt</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">jmax</span><span class="ruby-value">+1.0</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">n</span> = <span class="ruby-identifier">jmax</span>
      <span class="ruby-identifier">dpjmax</span> = ( (<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">/</span><span class="ruby-identifier">sqrt</span>((<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">pjmax_m1</span> <span class="ruby-operator">-</span> \
                <span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">sqrt</span>((<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+3.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">pjmax_p1</span> )<span class="ruby-operator">/</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">mu</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu</span>)
      <span class="ruby-comment"># 次の推定値</span>
      <span class="ruby-identifier">mu_next</span> = <span class="ruby-identifier">mu</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">pjmax</span><span class="ruby-operator">/</span><span class="ruby-identifier">dpjmax</span>
      <span class="ruby-comment"># 収束判定</span>
      <span class="ruby-keyword">if</span> ((<span class="ruby-identifier">mu</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">mu_next</span>).<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1.0E-15</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">mu</span> = <span class="ruby-identifier">mu_next</span> ; <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;mu has calculated by #{t+1} times iteration.\n&quot;</span>; <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">mu</span> = <span class="ruby-identifier">mu_next</span> ; <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;mu calculation was not converged. \n&quot;</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-value">49</span>)
      <span class="ruby-keyword">end</span>
    }

    <span class="ruby-comment"># ガウス重みを計算する</span>
    <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span>
      <span class="ruby-identifier">pjmax_m1</span>[<span class="ruby-identifier">j</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_Pl</span>(<span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">j</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">sqrt</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1.0</span>)
      <span class="ruby-identifier">pjmax_p1</span>[<span class="ruby-identifier">j</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_Pl</span>(<span class="ruby-identifier">jmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">j</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">sqrt</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">jmax</span><span class="ruby-value">+3.0</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">n</span> = <span class="ruby-identifier">jmax</span>
    <span class="ruby-identifier">dpjmax</span> = ( (<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">/</span><span class="ruby-identifier">sqrt</span>((<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">pjmax_m1</span> <span class="ruby-operator">-</span> \
              <span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">sqrt</span>((<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+3.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">pjmax_p1</span> )<span class="ruby-operator">/</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">mu</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu</span>)
    <span class="ruby-identifier">gw</span> = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">sqrt</span>((<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">pjmax_m1</span><span class="ruby-operator">*</span><span class="ruby-identifier">dpjmax</span>)

<span class="ruby-comment">#    binding.pry</span>
    <span class="ruby-value">10</span>.<span class="ruby-identifier">times</span>{ <span class="ruby-identifier">gw</span> = <span class="ruby-identifier">gw</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">sum</span> } <span class="ruby-comment"># test ガウス重みの精度が上がる？</span>

<span class="ruby-comment">#    binding.pry</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">mu</span>, <span class="ruby-identifier">gw</span>
  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lg_dlat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lg_dlat</span><span
            class="method-args">(gphys)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>緯度微分d/dmu（グリッド→スペクトルー(緯度微分)→グリッド） 引数：GPhysオブジェクト、P0n、ガウス重み</p>
          
          

          
          <div class="method-source-code" id="lg_dlat-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1029</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lg_dlat</span>(<span class="ruby-identifier">gphys</span>)
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-identifier">lg_trans</span>( <span class="ruby-identifier">gphys</span>)
        <span class="ruby-comment">#スペクトル→グリッド（緯度微分：d/dmu）</span>
        <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">lg_invtrans</span>(<span class="ruby-identifier">sn</span>, <span class="ruby-keyword">true</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lg_invtrans" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lg_invtrans</span><span
            class="method-args">(sn, dlat=false, nmax=@pmn[0,0,true].size-2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>ルジャンドル逆変換 引数：スペクトルデータ、P_n^0、緯度(Deg)</p>
          
          

          
          <div class="method-source-code" id="lg_invtrans-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 528</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lg_invtrans</span>(<span class="ruby-identifier">sn</span>, <span class="ruby-identifier">dlat</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">nmax</span>=<span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>)
<span class="ruby-identifier">jmax</span> = <span class="ruby-ivar">@lat</span>.<span class="ruby-identifier">size</span>
<span class="ruby-identifier">pn</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">true</span>]
<span class="ruby-identifier">dpn</span> = <span class="ruby-ivar">@dpmn</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">true</span>]

<span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">sn</span>.<span class="ruby-identifier">shape</span>
<span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
<span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>)<span class="ruby-comment">#.fill!(0.0)</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>])<span class="ruby-comment">#.fill!(0.0)</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(0.0)</span>
  <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 4&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>)<span class="ruby-comment">#.fill!(0.0)</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>])<span class="ruby-comment">#.fill!(0.0)</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(0.0)</span>
  <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 4&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
<span class="ruby-identifier">sn_tmp</span> = <span class="ruby-identifier">sn</span>.<span class="ruby-identifier">val</span>



<span class="ruby-comment"># ルジェンドル逆変換</span>
<span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlat</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> ) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">pn</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">pn_na</span> = <span class="ruby-identifier">pn</span>.<span class="ruby-identifier">to_na</span>
      <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">pn_na</span> = <span class="ruby-identifier">pn</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span> <span class="ruby-comment">#三角切断</span>
        <span class="ruby-identifier">gj</span>[<span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] =  <span class="ruby-identifier">pn_na</span>[<span class="ruby-identifier">j</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>].<span class="ruby-identifier">mul_add</span>(<span class="ruby-identifier">sn_tmp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-keyword">false</span>], <span class="ruby-value">0</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">dlat</span> ) <span class="ruby-keyword">then</span> <span class="ruby-comment">#緯度微分を作用させたルジャンドル逆変換</span>
             <span class="ruby-keyword">if</span> (<span class="ruby-identifier">pn</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
                    <span class="ruby-identifier">dpn_na</span> = <span class="ruby-identifier">dpn</span>.<span class="ruby-identifier">to_na</span>
              <span class="ruby-keyword">else</span>
                      <span class="ruby-identifier">dpn_na</span> = <span class="ruby-identifier">dpn</span>
        <span class="ruby-keyword">end</span>

              <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span> <span class="ruby-comment">#三角切断</span>
                <span class="ruby-identifier">gj</span>[<span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] =  <span class="ruby-identifier">dpn_na</span>[<span class="ruby-identifier">j</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>].<span class="ruby-identifier">mul_add</span>( <span class="ruby-identifier">sn_tmp</span>[ <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-keyword">false</span>], <span class="ruby-value">0</span>)
              <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment">#GPhysオブジェクト化</span>
      <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">sn</span>.<span class="ruby-identifier">grid_copy</span>
      <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">vlat</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@lat</span>,{<span class="ruby-string">&quot;latitude&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot; &quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;deg&quot;</span>},<span class="ruby-string">&quot;lat&quot;</span>)
      <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">vlat</span>
      <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">yaxis</span>) <span class="ruby-comment">#第 0軸を置き換える</span>

      <span class="ruby-comment"># 変数の設定</span>
      <span class="ruby-identifier">sname</span> = <span class="ruby-identifier">sn</span>.<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">lname</span> = <span class="ruby-identifier">sn</span>.<span class="ruby-identifier">long_name</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">sn</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>

<span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gj</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">lname</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">sname</span>)
      <span class="ruby-identifier">gphys_gj</span>= <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lg_trans" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lg_trans</span><span
            class="method-args">(gj, nmax=@pmn[0,0,true].size-2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <pre>ルジャンドル正変換
引数：グリッドデータ、P_n^0、ガウス重み</pre>

<p>グリッドデータgjは1次元目が lat でなければならない。</p>
          
          

          
          <div class="method-source-code" id="lg_trans-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 464</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lg_trans</span>(<span class="ruby-identifier">gj</span>, <span class="ruby-identifier">nmax</span>=<span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>)
<span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">gj</span>.<span class="ruby-identifier">shape</span>
<span class="ruby-identifier">jmax</span> = <span class="ruby-identifier">shapes</span>[<span class="ruby-value">0</span>]
<span class="ruby-identifier">pn</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">true</span>]
<span class="ruby-identifier">dpn</span> = <span class="ruby-ivar">@dpmn</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">true</span>]

<span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
<span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
  <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 4&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
  <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 4&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>


<span class="ruby-identifier">gj_na</span> = <span class="ruby-identifier">gj</span>.<span class="ruby-identifier">val</span>
<span class="ruby-identifier">gj_na</span> = <span class="ruby-identifier">gj_na</span>.<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gj_na</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>)

<span class="ruby-comment"># ルジェンドル正変換</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">pn</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">pn_na</span> = <span class="ruby-identifier">pn</span>.<span class="ruby-identifier">to_na</span>
      <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">pn_na</span> = <span class="ruby-identifier">pn</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>
        <span class="ruby-identifier">sn</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = (<span class="ruby-value">0.5</span><span class="ruby-operator">*</span> ( <span class="ruby-identifier">gj_na</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">mul_add</span>(<span class="ruby-identifier">pn_na</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">n</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-ivar">@gw</span>[<span class="ruby-keyword">true</span>]), <span class="ruby-value">0</span> )        )  ) <span class="ruby-comment"># .round(13) # test</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># GPhysオブジェクト化</span>
      <span class="ruby-comment"># 軸の設定</span>
      <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">gj</span>.<span class="ruby-identifier">grid_copy</span> <span class="ruby-comment">#入力GPhysオブジェクトのグリッド情報を取得</span>
      <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
      <span class="ruby-identifier">twn</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">indgen!</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;total wave number&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;wave number&quot;</span>},<span class="ruby-string">&quot;twn&quot;</span>)
      <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">twn</span>
      <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">yaxis</span>) <span class="ruby-comment">#第 0 軸を置き換える</span>

      <span class="ruby-comment"># 変数の設定</span>
      <span class="ruby-identifier">sname</span> = <span class="ruby-identifier">gj</span>.<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">lname</span> = <span class="ruby-identifier">gj</span>.<span class="ruby-identifier">long_name</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gj</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>

      <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">sn</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">lname</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">sname</span>)
      <span class="ruby-identifier">gphys_sn</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mu2deg" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mu2deg</span><span
            class="method-args">(mu)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="mu2deg-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 58</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mu2deg</span>(<span class="ruby-identifier">mu</span>)
  <span class="ruby-identifier">lat</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">asin</span>(<span class="ruby-identifier">mu</span>)<span class="ruby-operator">*</span><span class="ruby-value">180.0</span><span class="ruby-operator">/</span><span class="ruby-constant">PI</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-multiply_cos" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">multiply_cos</span><span
            class="method-args">(gphys, num=1)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>cos(lat)をかける</p>
          
          

          
          <div class="method-source-code" id="multiply_cos-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 606</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">multiply_cos</span>(<span class="ruby-identifier">gphys</span>, <span class="ruby-identifier">num</span>=<span class="ruby-value">1</span>)
  <span class="ruby-comment"># モジュール変数を利用する方法（高速）</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@coslat</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gshape</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">shape</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span><span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>.<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@coslat</span>.<span class="ruby-identifier">rank</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">3</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">10</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># 上記が使えない場合（低速）</span>
        <span class="ruby-comment"># 緯度軸を見つける</span>
        <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">copy</span>
    <span class="ruby-identifier">axarray</span> = <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">axnames</span>
   <span class="ruby-identifier">latpos</span> = <span class="ruby-value">999</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">ln</span> <span class="ruby-keyword">in</span> [<span class="ruby-string">&quot;lat&quot;</span>, <span class="ruby-string">&quot;Lat&quot;</span>, <span class="ruby-string">&quot;LAT&quot;</span>, <span class="ruby-string">&quot;latitude&quot;</span>, <span class="ruby-string">&quot;Latitude&quot;</span>, <span class="ruby-string">&quot;LATITUDE&quot;</span>, <span class="ruby-string">&quot;y&quot;</span>]
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">axarray</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">ln</span>)) <span class="ruby-keyword">then</span>
                        <span class="ruby-identifier">lat</span> =  <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ln</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
                        <span class="ruby-identifier">latpos</span> = <span class="ruby-identifier">axarray</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">ln</span>)
                        <span class="ruby-keyword">break</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">999</span>) <span class="ruby-keyword">then</span>
                                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;It seems that the GPhys object does not have lat axis.&quot;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># cos(lat) 作成</span>
        <span class="ruby-identifier">coslat</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>)
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
<span class="ruby-comment">#               lat.size.times{|j| gresult[j, false] = gphys[j, false]*coslat[j]**num        }</span>
    <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-identifier">coslat</span><span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-identifier">gresult</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gphys</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">coslat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> }
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">gresult</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gphys</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">coslat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
                }
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">gresult</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gphys</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">coslat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
                }
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;lat should be within 4th dimension&quot;</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-multiply_sin" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">multiply_sin</span><span
            class="method-args">(gphys, num=1)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>sin(lat)をかける</p>
          
          

          
          <div class="method-source-code" id="multiply_sin-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 682</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">multiply_sin</span>(<span class="ruby-identifier">gphys</span>, <span class="ruby-identifier">num</span>=<span class="ruby-value">1</span>)
  <span class="ruby-comment"># モジュール変数を利用する方法（高速）</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@sinlat</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gshape</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">shape</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span><span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>.<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@sinlat</span>.<span class="ruby-identifier">rank</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">3</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">10</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gshape</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">shape</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># 上記が使えない場合（低速）</span>
        <span class="ruby-comment"># 緯度軸を見つける</span>
        <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">copy</span>
    <span class="ruby-identifier">axarray</span> = <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">axnames</span>
   <span class="ruby-identifier">latpos</span> = <span class="ruby-value">999</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">ln</span> <span class="ruby-keyword">in</span> [<span class="ruby-string">&quot;lat&quot;</span>, <span class="ruby-string">&quot;Lat&quot;</span>, <span class="ruby-string">&quot;LAT&quot;</span>, <span class="ruby-string">&quot;latitude&quot;</span>, <span class="ruby-string">&quot;Latitude&quot;</span>, <span class="ruby-string">&quot;LATITUDE&quot;</span>, <span class="ruby-string">&quot;y&quot;</span>]
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">axarray</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">ln</span>)) <span class="ruby-keyword">then</span>
                        <span class="ruby-identifier">lat</span> =  <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ln</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
                        <span class="ruby-identifier">latpos</span> = <span class="ruby-identifier">axarray</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">ln</span>)
                        <span class="ruby-keyword">break</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">999</span>) <span class="ruby-keyword">then</span>
                                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;It seems that the GPhys object does not have lat axis.&quot;</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># sin(lat) 作成</span>
        <span class="ruby-identifier">sinlat</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>)
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
<span class="ruby-comment">#               lat.size.times{|j| gresult[j, false] = gphys[j, false]*sinlat[j]**num }</span>
    <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">gphys</span><span class="ruby-operator">*</span><span class="ruby-identifier">sinlat</span><span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">gresult</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gphys</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">sinlat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
<span class="ruby-comment">#                       gresult[true, j, false] = gphys[true, j, false]*0.0 + sinlat[j]**num</span>
                }
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">gresult</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gphys</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">sinlat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
                }
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">latpos</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
                        <span class="ruby-identifier">gresult</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gphys</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">sinlat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">**</span><span class="ruby-identifier">num</span>
                }
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;lat should be within 4th dimension&quot;</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-p_m_nT" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">p_m_nT</span><span
            class="method-args">(x, mmax)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>gslを使って、ルジャンドル陪関数 P^m_n を求める (三角切断；P^m_nがない要素は欠損値とする)</p>
          
          

          
          <div class="method-source-code" id="p_m_nT-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 64</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">p_m_nT</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">mmax</span>)
    <span class="ruby-identifier">mmax</span> = <span class="ruby-identifier">mmax</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">len</span> = <span class="ruby-identifier">x</span>.<span class="ruby-identifier">length</span>
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">pmn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">len</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+2</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+2</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>) <span class="ruby-comment">#微分計算のために n 方向に１つ余分に作っておく。m方向の余分はダミー(ゼロ)。</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">pmn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">len</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+2</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+2</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>) <span class="ruby-comment">#微分計算のために n 方向に１つ余分に作っておく</span>
    <span class="ruby-keyword">end</span>

<span class="ruby-comment">#    for m in 0..mmax</span>
    <span class="ruby-identifier">np</span> = (<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;OMP_NUM_THREADS&#39;</span>]<span class="ruby-operator">||</span> <span class="ruby-value">4</span>).<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">pn_ary</span> = <span class="ruby-constant">Parallel</span>.<span class="ruby-identifier">map</span>(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">mmax</span>, <span class="ruby-value">in_progress:</span><span class="ruby-identifier">np</span>, <span class="ruby-value">:progress</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;progress&quot;</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">fact</span> = <span class="ruby-identifier">sqrt</span>(<span class="ruby-value">4.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">-1.0</span>)<span class="ruby-operator">**</span><span class="ruby-identifier">m</span> <span class="ruby-comment"># GSLで計算されるP^m_nを2で正規化したものに変換する係数</span>

      <span class="ruby-comment"># 全てのルジャンドル陪関数をGSLで計算する方法（切断波数が高いと低速）</span>
      <span class="ruby-comment"># for l in m..mmax+1</span>
      <span class="ruby-comment">#   for j in 0..len-1</span>
      <span class="ruby-comment">#     # pmn[j, m, m..mmax+1] = (GSL::Sf::legendre_sphPlm_array(mmax+1, m, x[j]).to_na)*fact</span>
      <span class="ruby-comment">#     pmn[j, m, l] =  (GSL::Sf::legendre_sphPlm(l, m, x[j]))*fact</span>
      <span class="ruby-comment">#   end</span>
      <span class="ruby-comment"># end</span>

      <span class="ruby-comment"># 一部のルジャンドル陪関数をGSLで計算し、残りは３項漸化式を用いて計算する方法（高速）</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">len</span><span class="ruby-value">-1</span>
        <span class="ruby-comment"># pmn[j, m, m..mmax+1] = (GSL::Sf::legendre_sphPlm_array(mmax+1, m, x[j]).to_na)*fact</span>
        <span class="ruby-identifier">l</span> = <span class="ruby-identifier">m</span>  ; <span class="ruby-identifier">pmn</span>[<span class="ruby-identifier">j</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">l</span>] =  (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_sphPlm</span>(<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">x</span>[<span class="ruby-identifier">j</span>]))<span class="ruby-operator">*</span><span class="ruby-identifier">fact</span>
        <span class="ruby-identifier">l</span> = <span class="ruby-identifier">m</span><span class="ruby-value">+1</span>; <span class="ruby-identifier">pmn</span>[<span class="ruby-identifier">j</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">l</span>] =  (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Sf</span><span class="ruby-operator">::</span><span class="ruby-identifier">legendre_sphPlm</span>(<span class="ruby-identifier">l</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">x</span>[<span class="ruby-identifier">j</span>]))<span class="ruby-operator">*</span><span class="ruby-identifier">fact</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># ３項漸化式（石岡 2004, p.120）</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">l</span> <span class="ruby-keyword">in</span> (<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">mmax</span>)
        <span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-identifier">l</span><span class="ruby-value">+1</span>] = <span class="ruby-identifier">sqrt</span>( (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">l</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">l</span><span class="ruby-value">+3.0</span>)<span class="ruby-operator">/</span>((<span class="ruby-identifier">l</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">l</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">-</span><span class="ruby-identifier">m</span><span class="ruby-operator">*</span><span class="ruby-identifier">m</span>) )<span class="ruby-operator">*</span><span class="ruby-identifier">x</span><span class="ruby-operator">*</span><span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-identifier">l</span>] \
                      <span class="ruby-operator">-</span> <span class="ruby-identifier">sqrt</span>( (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">l</span><span class="ruby-value">+3.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">l</span><span class="ruby-value">-1.0</span>) <span class="ruby-operator">*</span> (<span class="ruby-identifier">l</span><span class="ruby-operator">*</span><span class="ruby-identifier">l</span><span class="ruby-operator">-</span><span class="ruby-identifier">m</span><span class="ruby-operator">*</span><span class="ruby-identifier">m</span>)<span class="ruby-operator">/</span>((<span class="ruby-identifier">l</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">l</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">-</span><span class="ruby-identifier">m</span><span class="ruby-operator">*</span><span class="ruby-identifier">m</span>) )<span class="ruby-operator">*</span><span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-identifier">l</span><span class="ruby-value">-1</span>]
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">true</span>]
    }


    <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">mmax</span>
      <span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">true</span>] = <span class="ruby-identifier">pn_ary</span>[<span class="ruby-identifier">m</span>]
    <span class="ruby-keyword">end</span>

<span class="ruby-comment">#    end</span>
    <span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>] = <span class="ruby-value">1.0</span>
    <span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>] = <span class="ruby-value">0.0</span> <span class="ruby-comment"># ダミー</span>

    <span class="ruby-comment"># ルジャンドル陪関数の微分の計算</span>

    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dpmn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">len</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
      <span class="ruby-identifier">emn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+2</span>)    <span class="ruby-comment"># 係数を計算しておく</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dpmn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">len</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">-9.99E36</span>)
      <span class="ruby-identifier">emn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">mmax</span><span class="ruby-value">+2</span>)    <span class="ruby-comment"># 係数を計算しておく</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">mmax</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> (<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>)
               <span class="ruby-identifier">emn</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>] = <span class="ruby-identifier">sqrt</span>( (<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">m</span><span class="ruby-operator">*</span><span class="ruby-identifier">m</span>)<span class="ruby-operator">/</span>((<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1.0</span>)) )
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">x_tmp</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">/</span>(<span class="ruby-value">1.0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">x</span><span class="ruby-operator">*</span><span class="ruby-identifier">x</span>)
    <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">mmax</span>
      <span class="ruby-identifier">dpmn</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">m</span>] = ( <span class="ruby-operator">-</span> <span class="ruby-identifier">m</span><span class="ruby-operator">*</span><span class="ruby-identifier">emn</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>]) <span class="ruby-operator">*</span><span class="ruby-identifier">x_tmp</span> <span class="ruby-comment"># m = n の場合</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> (<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)<span class="ruby-operator">..</span><span class="ruby-identifier">mmax</span>
        <span class="ruby-identifier">dpmn</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>] = ((<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">emn</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">emn</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>]) <span class="ruby-operator">*</span><span class="ruby-identifier">x_tmp</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

<span class="ruby-comment">#    binding.pry</span>
<span class="ruby-comment">#    return pmn, dpmn, emn</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">pmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>], <span class="ruby-identifier">dpmn</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>]
  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_divergence" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_divergence</span><span
            class="method-args">(u, v, a=1.0, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>u, v から水平発散を計算（グリッド → グリッド）</p>
          
          

          
          <div class="method-source-code" id="sh_divergence-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1123</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_divergence</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
        <span class="ruby-comment"># v にcoslatをかける</span>
        <span class="ruby-identifier">vcoslat</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v</span>, <span class="ruby-value">1</span>)
        <span class="ruby-identifier">ucoslat</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u</span>, <span class="ruby-value">1</span>)

  <span class="ruby-comment">#微分をどのタイミングで行うかによって、結果が微妙に変わるのだが、なぜ？</span>

        <span class="ruby-comment">#グリッド→スペクトル</span>
         <span class="ruby-identifier">su</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">ucoslat</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
         <span class="ruby-identifier">sv</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">vcoslat</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-comment"># #スペクトル→グリッド（経度微分：d/dlon）</span>
         <span class="ruby-identifier">u_dlon</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">su</span>, <span class="ruby-value">1</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-comment"># #スペクトル→グリッド（緯度微分：d/dmu）</span>
         <span class="ruby-identifier">v_dlat</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">sv</span>, <span class="ruby-keyword">false</span>, <span class="ruby-value">1</span>, <span class="ruby-identifier">only</span>)

        <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u_dlon</span>, <span class="ruby-value">-2</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">a</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">v_dlat</span><span class="ruby-operator">/</span><span class="ruby-identifier">a</span>

        <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;Div&quot;</span>)
        <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;Divergence&quot;</span>)
        <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span> ,<span class="ruby-string">&quot;s-1&quot;</span>)

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_dlat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_dlat</span><span
            class="method-args">(gphys)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>緯度微分d/dmu（グリッド→スペクトルー(緯度微分)→グリッド） 引数：GPhysオブジェクト</p>
          
          

          
          <div class="method-source-code" id="sh_dlat-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 871</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_dlat</span>(<span class="ruby-identifier">gphys</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">gphys</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">false</span>, <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-1</span>)
        <span class="ruby-comment">#スペクトル→グリッド（緯度微分：d/dmu）</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>, <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-1</span>)


<span class="ruby-comment">#   スペクトル→ cos^2(lat)*d/dmu の スペクトル</span>
    <span class="ruby-comment">#グリッド/cos^2(lat)→スペクトル/cos^2(lat)</span>
    <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">gphys</span><span class="ruby-operator">/</span>(<span class="ruby-ivar">@coslat</span><span class="ruby-operator">*</span><span class="ruby-ivar">@coslat</span>), <span class="ruby-keyword">false</span>, <span class="ruby-keyword">false</span>, <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-1</span>)
    <span class="ruby-comment">#スペクトル/cos^2(lat)→スペクトル（緯度微分：d/dmu）</span>
    <span class="ruby-identifier">d_smn</span> = <span class="ruby-identifier">sp_dmu_cos2</span>(<span class="ruby-identifier">smn</span>)
    <span class="ruby-comment">#スペクトル（緯度微分：d/dmu）→グリッド（緯度微分：d/dmu）</span>
    <span class="ruby-identifier">d_gij</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">d_smn</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">false</span>, <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">d_gij</span>

<span class="ruby-comment">#       return d_gij/(@coslat*@coslat)</span>

  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans_multi</span>(<span class="ruby-identifier">gphys</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;arg must be GPhys or Array of GPhyses which are same shape)&quot;</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_dlon" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_dlon</span><span
            class="method-args">(gphys, dn=1)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>経度微分d/dlon（グリッド→スペクトルー(経度微分)→グリッド） <a href="経度微分の階数">引数：GPhysオブジェクト、Pmn、ガウス重み、</a></p>
          
          

          
          <div class="method-source-code" id="sh_dlon-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 853</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_dlon</span>(<span class="ruby-identifier">gphys</span>, <span class="ruby-identifier">dn</span>=<span class="ruby-value">1</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">gphys</span>)
<span class="ruby-comment">#    smn[true,-1,false]=0.0 # test</span>
        <span class="ruby-comment">#スペクトル→グリッド（経度微分：d/dlon）</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">smn</span>,<span class="ruby-identifier">dn</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">gphys</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">smn</span>,<span class="ruby-identifier">dn</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;arg must be GPhys or Array of GPhyses which are same shape)&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_dlon_and_dlat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_dlon_and_dlat</span><span
            class="method-args">(gphys)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>経度微分d/dlonしたものと緯度微分d/dmしたものを同時に出力（d^2/dmudlon ではない） 入力が [x,y,z] のとき、出力は [dxdlon, dydlon, dzdlon,dxdlat, dydlat, dzdlat] となる</p>
          
          

          
          <div class="method-source-code" id="sh_dlon_and_dlat-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1010</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_dlon_and_dlat</span>(<span class="ruby-identifier">gphys</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">gphys</span>)
        <span class="ruby-comment">#スペクトル→グリッド [緯度微分：d/dmu, 緯度微分：d/dmu]</span>
        <span class="ruby-keyword">return</span> [<span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>), <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>)]
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans_multi</span>(<span class="ruby-identifier">gphys</span>)
    <span class="ruby-keyword">return</span> [<span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">false</span>), <span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">true</span>)].<span class="ruby-identifier">flatten</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;arg must be GPhys or Array of GPhyses which are same shape)&quot;</span>
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_energyspectrum" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_energyspectrum</span><span
            class="method-args">(u, v, a=1.0, comp_ary=[&quot;total&quot;], vor_div_given=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>NOTE 係数 0.25, 0.125は２倍しなければならないはず。</p>
          
          

          
          <div class="method-source-code" id="sh_energyspectrum-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1264</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_energyspectrum</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">comp_ary</span>=[<span class="ruby-string">&quot;total&quot;</span>], <span class="ruby-identifier">vor_div_given</span>=<span class="ruby-keyword">false</span>)
<span class="ruby-comment"># 参照：Burgess, Erler, and Shepherd (2013) The Troposphere-to-Stratosphere Transition in Kinetic Energy Spectra and Nonlinear Spectral Fluxes as Seen in ECMWF Analyses, JAS, vol. 70, pp. 669-687</span>
        <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">vor_div_given</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Note: U &amp; V must be given.\n&quot;</span>
    <span class="ruby-identifier">flag_vor</span> = <span class="ruby-keyword">false</span>; <span class="ruby-identifier">flag_div</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">comp</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">comp</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;total&quot;</span>)
        <span class="ruby-identifier">flag_vor</span> = <span class="ruby-keyword">true</span>; <span class="ruby-identifier">flag_div</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">comp</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;rot&quot;</span>)
        <span class="ruby-identifier">flag_vor</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">comp</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;div&quot;</span>)
        <span class="ruby-identifier">flag_div</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;the 4th argument must be Array of &#39;total&#39; (default), &#39;total_u&#39;, &#39;total_v&#39;, &#39;rot&#39;, &#39;rot_u&#39;, &#39;rot_v&#39;, &#39;div&#39;, &#39;div_u&#39;, and/or &#39;div_v&#39;.&quot;</span>
      <span class="ruby-keyword">end</span>
    }
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">flag_vor</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vor</span> = <span class="ruby-identifier">sh_vorticity</span>( <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span> )
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Vorticity caluculated.\n&quot;</span>
                <span class="ruby-identifier">svor</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">vor</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Vorticity trasformed.\n&quot;</span>
                <span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">svor</span>.<span class="ruby-identifier">shape</span>
                <span class="ruby-identifier">svorval</span> = <span class="ruby-identifier">svor</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">flag_div</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">div</span> = <span class="ruby-identifier">sh_divergence</span>( <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span> )
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Divergence calculated.\n&quot;</span>
                <span class="ruby-identifier">sdiv</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">div</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Divergence transformed.\n&quot;</span>
                <span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">sdiv</span>.<span class="ruby-identifier">shape</span>
                <span class="ruby-identifier">sdivval</span> = <span class="ruby-identifier">sdiv</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">vor_div_given</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Note: Vorticity &amp; Divergence must be given.\n&quot;</span>
    <span class="ruby-identifier">vor</span> = <span class="ruby-identifier">u</span>; <span class="ruby-identifier">div</span> = <span class="ruby-identifier">v</span>
    <span class="ruby-identifier">svor</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">vor</span>)
    <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Vorticity transformed.\n&quot;</span>
    <span class="ruby-identifier">sdiv</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">div</span>)
    <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Divergence transformed.\n&quot;</span>
    <span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">sdiv</span>.<span class="ruby-identifier">shape</span>
    <span class="ruby-identifier">sdivval</span> = <span class="ruby-identifier">sdiv</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">svorval</span> = <span class="ruby-identifier">svor</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;the 5th argument must be true (vor &amp; div are given) or false (u &amp; v are given; default)&quot;</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-identifier">gphys_es_ary</span> = []
  <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">comp</span><span class="ruby-operator">|</span>

    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">es</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">0.0</span>).<span class="ruby-identifier">all_invalid</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">es</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">0.0</span>).<span class="ruby-identifier">all_invalid</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">es</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">0.0</span>).<span class="ruby-identifier">all_invalid</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 5&quot;</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">es</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">0.0</span>).<span class="ruby-identifier">all_invalid</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">es</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">0.0</span>).<span class="ruby-identifier">all_invalid</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">es</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>]).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">0.0</span>).<span class="ruby-identifier">all_invalid</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 5&quot;</span>
        <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">es_rank</span> = <span class="ruby-identifier">es</span>.<span class="ruby-identifier">rank</span>

        <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>
                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.0</span>
                <span class="ruby-keyword">case</span> <span class="ruby-identifier">comp</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-identifier">svorval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot_u&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>) <span class="ruby-operator">-</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>))<span class="ruby-operator">*</span>(<span class="ruby-identifier">svorval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot_v&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">svorval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>

                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-identifier">sdivval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div_u&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">sdivval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div_v&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>) <span class="ruby-operator">-</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>))<span class="ruby-operator">*</span>(<span class="ruby-identifier">sdivval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>

                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;total&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-identifier">svorval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">sdivval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;total_u&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>) <span class="ruby-operator">-</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>))<span class="ruby-operator">*</span>(<span class="ruby-identifier">svorval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span> \
                                                                       <span class="ruby-operator">+</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">sdivval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;total_v&quot;</span> <span class="ruby-keyword">then</span>
                        <span class="ruby-keyword">for</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">in</span> <span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>
                                <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>]  <span class="ruby-operator">+</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>) <span class="ruby-operator">-</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>))<span class="ruby-operator">*</span>(<span class="ruby-identifier">sdivval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span> \
                                                                       <span class="ruby-operator">+</span> (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span>.<span class="ruby-identifier">abs</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">svorval</span>[<span class="ruby-identifier">m</span>, <span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">abs</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>
                        <span class="ruby-keyword">end</span>
                        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">to_na</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">a</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1.0</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">es</span>[<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">es_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">#GPhysオブジェクト化</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">comp</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot&quot;</span>, <span class="ruby-string">&quot;total&quot;</span>, <span class="ruby-string">&quot;rot_u&quot;</span>, <span class="ruby-string">&quot;total_u&quot;</span>, <span class="ruby-string">&quot;rot_v&quot;</span>, <span class="ruby-string">&quot;total_v&quot;</span> <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">vor</span>.<span class="ruby-identifier">grid_copy</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div&quot;</span>, <span class="ruby-string">&quot;div_u&quot;</span>, <span class="ruby-string">&quot;div_v&quot;</span> <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">div</span>.<span class="ruby-identifier">grid_copy</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">twn</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">indgen!</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;total wave number&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;wave number&quot;</span>},<span class="ruby-string">&quot;twn&quot;</span>)
        <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">twn</span>
        <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">yaxis</span>).<span class="ruby-identifier">delete_axes</span>(<span class="ruby-value">0</span>) <span class="ruby-comment">#第1軸を置き換える、第0軸を消去する</span>

        <span class="ruby-keyword">case</span> <span class="ruby-identifier">comp</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (rot)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectRot&quot;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot_u&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (rot_u)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectRot_u&quot;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rot_v&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (rot_v)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectRot_v&quot;</span>)

        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (div)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectDiv&quot;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div_u&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (div_u)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectDiv_u&quot;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;div_v&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (div_v)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectDiv_v&quot;</span>)

        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;total&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (total)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectTotal&quot;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;total_u&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (total_u)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectTotal_u&quot;</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;total_v&quot;</span> <span class="ruby-keyword">then</span>
           <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">es</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;Energy Spectrum (total_v)&quot;</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m2 s-2&quot;</span>}, <span class="ruby-string">&quot;EngySpectTotal_v&quot;</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">gphys_es</span>= <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)
    <span class="ruby-identifier">gphys_es_ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gphys_es</span>
  }

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys_es_ary</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_init" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_init</span><span
            class="method-args">(lon, lat = lon.size/2, mmax = ((lat.size*2-1)/3), gp=nil, precision=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>初期化：Pmnとガウス重みを求める 引数：経度(Deg), 緯度(Deg), [切断波数：与えなければ緯度格子の数をもとに自動で計算する]</p>

<pre class="ruby"><span class="ruby-identifier">変換するGPhysサンプル（次元を参照する）、変換精度（single</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">double）</span>
</pre>

<p>ガウス緯度を内部計算する場合は、第２引数に、緯度方向の格子点数を与える。 また、第２引数に何も与えなければ、lon/2を緯度方向の格子点数とする。</p>
          
          

          
          <div class="method-source-code" id="sh_init-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 765</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_init</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">lon</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>, <span class="ruby-identifier">mmax</span> = ((<span class="ruby-identifier">lat</span>.<span class="ruby-identifier">size</span><span class="ruby-operator">*</span><span class="ruby-value">2</span><span class="ruby-value">-1</span>)<span class="ruby-operator">/</span><span class="ruby-value">3</span>), <span class="ruby-identifier">gp</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">precision</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Truncation wavenumber is #{mmax}.\n&quot;</span>

   <span class="ruby-comment"># 倍精度/単精度の選択</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">precision</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@precision</span> = <span class="ruby-identifier">precision</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">ntype</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;float&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@precision</span> = <span class="ruby-string">&quot;double&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;sfloat&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@precision</span> = <span class="ruby-string">&quot;single&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@precision</span> = <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-comment">#デフォルトの精度</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lat</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Integer</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># ガウス緯度を内部計算</span>
    <span class="ruby-ivar">@mu</span>, <span class="ruby-ivar">@gw</span> = <span class="ruby-identifier">gauss_w</span>(<span class="ruby-identifier">lat</span>) <span class="ruby-comment"># ガウス緯度・重み</span>
    <span class="ruby-ivar">@lon</span> = <span class="ruby-identifier">lon</span>;  <span class="ruby-ivar">@lat</span> = <span class="ruby-identifier">mu2deg</span>(<span class="ruby-ivar">@mu</span>)
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># 与えられた、緯度を用いる。ただし、サイン緯度・重みの計算には精確なガウス緯度を計算する。</span>
    <span class="ruby-ivar">@lon</span> = <span class="ruby-identifier">lon</span>;  <span class="ruby-ivar">@lat</span> = <span class="ruby-identifier">lat</span>
    <span class="ruby-ivar">@mu</span>, <span class="ruby-ivar">@gw</span> = <span class="ruby-identifier">gauss_w</span>(<span class="ruby-identifier">lat</span>) <span class="ruby-comment">#ガウス重み</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Gaussian weight and latitude generated.\n&quot;</span>

  <span class="ruby-ivar">@pmn</span>, <span class="ruby-ivar">@dpmn</span>, <span class="ruby-ivar">@emn</span> = <span class="ruby-identifier">p_m_nT</span>(<span class="ruby-ivar">@mu</span>, <span class="ruby-identifier">mmax</span>) <span class="ruby-comment">#三角切断 P^m_n, dP^m_n</span>
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;P^m_n, dP^m_n generated.\n&quot;</span>

  <span class="ruby-comment"># モジュール変数の作成</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@coslat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span>
    <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@coslat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">j</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>)}
    <span class="ruby-ivar">@sinlat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span>
    <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@sinlat</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">j</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>)}
    <span class="ruby-comment">#     @Cp05 = gp.val*0.0 + 0.5 #定数配列 0.5</span>
    <span class="ruby-comment">#     @Cm05 = -@Cp05 # 定数配列</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@complex_im</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@complex_im</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>)
  <span class="ruby-keyword">end</span>
  (<span class="ruby-identifier">mmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@complex_im</span>[<span class="ruby-identifier">m</span>] = <span class="ruby-constant">Complex</span><span class="ruby-operator">::</span><span class="ruby-constant">I</span><span class="ruby-operator">*</span><span class="ruby-identifier">m</span> }

<span class="ruby-comment">#  binding.pry</span>

  <span class="ruby-keyword">return</span> <span class="ruby-ivar">@gw</span>, <span class="ruby-ivar">@pmn</span>, <span class="ruby-ivar">@dpmn</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_invlaplacian" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_invlaplacian</span><span
            class="method-args">(gphys)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sh_invlaplacian-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1069</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_invlaplacian</span>(<span class="ruby-identifier">gphys</span>)
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">s</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">gphys</span>)
    (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">s</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">s</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>))
    }
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">s</span> = <span class="ruby-identifier">sh_trans_multi</span>(<span class="ruby-identifier">gphys</span>)
    <span class="ruby-identifier">s</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">s</span>[<span class="ruby-identifier">i</span>][<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">s</span>[<span class="ruby-identifier">i</span>][<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>))
      }
    }
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;arg must be GPhys or Array of GPhyses which are same shape)&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_invtrans" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_invtrans</span><span
            class="method-args">(smn, dlon=false, dlat=false, only=false, nmax=@pmn[0,0,true].size-2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>球面調和逆変換 引数：スペクトルデータ、P_n^m、経度(Deg) 、緯度(Deg) 第8引数に正整数を与えると、その数(only)の全波数のみ計算する。</p>
          
          

          
          <div class="method-source-code" id="sh_invtrans-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 326</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_invtrans</span>(<span class="ruby-identifier">smn</span>, <span class="ruby-identifier">dlon</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">dlat</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">nmax</span>=<span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>)
  <span class="ruby-identifier">jmax</span> = <span class="ruby-ivar">@lat</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">imax</span> = <span class="ruby-ivar">@lon</span>.<span class="ruby-identifier">size</span>
<span class="ruby-comment">#  mmax = @pmn[0,true,0].size</span>
  <span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>
  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       gij = NArrayMiss.float(imax, jmax).fill!(0.0)</span>
  <span class="ruby-comment">#       gmj = NArrayMiss.complex(imax, jmax).fill!(0.0)</span>
          <span class="ruby-identifier">gij</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>)<span class="ruby-comment">#.fill!(0.0)</span>
          <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>)<span class="ruby-comment">#.fill!(0.0)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       gij = NArrayMiss.float(imax, jmax, shapes[2]).fill!(0.0)</span>
  <span class="ruby-comment">#       gmj = NArrayMiss.complex(imax, jmax, shapes[2]).fill!(0.0)</span>
          <span class="ruby-identifier">gij</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(0.0)</span>
          <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(0.0)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       gij = NArrayMiss.float(imax, jmax, shapes[2], shapes[3]).fill!(0.0)</span>
  <span class="ruby-comment">#       gmj = NArrayMiss.complex(imax, jmax, shapes[2], shapes[3]).fill!(0.0)</span>
          <span class="ruby-identifier">gij</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])<span class="ruby-comment">#.fill!(0.0)</span>
          <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])<span class="ruby-comment">#.fill!(0.0)</span>
    <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 5&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       gij = NArrayMiss.sfloat(imax, jmax).fill!(0.0)</span>
  <span class="ruby-comment">#       gmj = NArrayMiss.scomplex(imax, jmax).fill!(0.0)</span>
          <span class="ruby-identifier">gij</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>)<span class="ruby-comment">#.fill!(0.0)</span>
          <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>)<span class="ruby-comment">#.fill!(0.0)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       gij = NArrayMiss.sfloat(imax, jmax, shapes[2]).fill!(0.0)</span>
  <span class="ruby-comment">#       gmj = NArrayMiss.scomplex(imax, jmax, shapes[2]).fill!(0.0)</span>
          <span class="ruby-identifier">gij</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(0.0)</span>
          <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(0.0)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       gij = NArrayMiss.sfloat(imax, jmax, shapes[2], shapes[3]).fill!(0.0)</span>
  <span class="ruby-comment">#       gmj = NArrayMiss.scomplex(imax, jmax, shapes[2], shapes[3]).fill!(0.0)</span>
          <span class="ruby-identifier">gij</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])<span class="ruby-comment">#.fill!(0.0)</span>
          <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">jmax</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])<span class="ruby-comment">#.fill!(0.0)</span>
    <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 5&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">smn_tmp</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">val</span>

  <span class="ruby-comment"># ルジェンドル逆変換</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlat</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span> ) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@pmn</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">pmn_na</span> = <span class="ruby-ivar">@pmn</span>.<span class="ruby-identifier">to_na</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">pmn_na</span> = <span class="ruby-ivar">@pmn</span>
        <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span> <span class="ruby-comment">#三角切断</span>
                  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">only</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>) <span class="ruby-keyword">then</span>
                          <span class="ruby-identifier">gmj</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] =  <span class="ruby-identifier">pmn_na</span>[<span class="ruby-identifier">j</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>].<span class="ruby-identifier">mul_add</span>(<span class="ruby-identifier">smn_tmp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-keyword">false</span>], <span class="ruby-value">1</span>)
        <span class="ruby-identifier">gmj</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span>), <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gmj</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">nmax</span>), <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
                  <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">gmj</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] =  <span class="ruby-identifier">pmn_na</span>[<span class="ruby-identifier">j</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">only</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-identifier">smn_tmp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">only</span>, <span class="ruby-keyword">false</span>])
        <span class="ruby-identifier">gmj</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gmj</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
                  <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">elsif</span> ( <span class="ruby-identifier">dlat</span> ) <span class="ruby-keyword">then</span> <span class="ruby-comment">#緯度微分を作用させたルジャンドル逆変換</span>

               <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@pmn</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
                 <span class="ruby-identifier">dpmn_na</span> = <span class="ruby-ivar">@dpmn</span>.<span class="ruby-identifier">to_na</span>
          <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">dpmn_na</span> = <span class="ruby-ivar">@dpmn</span>
    <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">for</span> <span class="ruby-identifier">j</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">jmax</span><span class="ruby-value">-1</span> <span class="ruby-comment">#三角切断</span>
                  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">only</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>) <span class="ruby-keyword">then</span>
                          <span class="ruby-identifier">gmj</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] =  <span class="ruby-identifier">dpmn_na</span>[<span class="ruby-identifier">j</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>].<span class="ruby-identifier">mul_add</span>( <span class="ruby-identifier">smn_tmp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-keyword">false</span>], <span class="ruby-value">1</span>)
                          <span class="ruby-identifier">gmj</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span>),<span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gmj</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">nmax</span>),<span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
                  <span class="ruby-keyword">else</span> <span class="ruby-comment">#if (m &lt;= only) then # 特定の全波数 n だけ変換する場合</span>
        <span class="ruby-identifier">gmj</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] =  <span class="ruby-identifier">dpmn_na</span>[<span class="ruby-identifier">j</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">only</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-identifier">smn_tmp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>, <span class="ruby-identifier">only</span>, <span class="ruby-keyword">false</span>])
                          <span class="ruby-identifier">gmj</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">only</span>,<span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gmj</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">only</span>,<span class="ruby-identifier">j</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
                  <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># 経度微分をする場合</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlon</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">dlon</span> = <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Integer</span>)
                        <span class="ruby-identifier">dlon</span>.<span class="ruby-identifier">times</span>{
                        <span class="ruby-identifier">gmj</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">nmax</span>),<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gmj</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">nmax</span>),<span class="ruby-keyword">false</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-ivar">@complex_im</span>) <span class="ruby-comment"># I は虚数単位</span>
        <span class="ruby-identifier">gmj</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span>), <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gmj</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">nmax</span>), <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
                        }
<span class="ruby-comment">#      binding.pry</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># 逆FFT</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gmj</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
                <span class="ruby-identifier">gij</span> = <span class="ruby-constant">FFTW3</span>.<span class="ruby-identifier">fft</span>(<span class="ruby-identifier">gmj</span>.<span class="ruby-identifier">to_na</span>, <span class="ruby-value">1</span>, <span class="ruby-value">0</span>).<span class="ruby-identifier">real</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">gij</span> = <span class="ruby-constant">FFTW3</span>.<span class="ruby-identifier">fft</span>(<span class="ruby-identifier">gmj</span>, <span class="ruby-value">1</span>, <span class="ruby-value">0</span>).<span class="ruby-identifier">real</span>
        <span class="ruby-keyword">end</span>

<span class="ruby-comment">#  print gij[true,0,0].mean,&quot;, &quot;, gmj[0,0,0],&quot;, &quot;,  smn.name, smn.units, &quot;\n&quot;</span>

  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gij</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-string">&quot;sfloat&quot;</span>) <span class="ruby-comment">#FFTW3は倍精度計算なので、単精度に戻す</span>
  <span class="ruby-keyword">end</span>




        <span class="ruby-comment">#GPhysオブジェクト化</span>
        <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">grid_copy</span>
        <span class="ruby-identifier">xaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">vlon</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@lon</span>,{<span class="ruby-string">&quot;longitude&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot; &quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;deg&quot;</span>},<span class="ruby-string">&quot;lon&quot;</span>)
        <span class="ruby-identifier">xaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">vlon</span>
        <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">vlat</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@lat</span>,{<span class="ruby-string">&quot;latitude&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot; &quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;deg&quot;</span>},<span class="ruby-string">&quot;lat&quot;</span>)
        <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">vlat</span>
        <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">xaxis</span>).<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">yaxis</span>) <span class="ruby-comment">#第0, 1軸を置き換える</span>

        <span class="ruby-comment"># 変数の設定</span>
        <span class="ruby-identifier">sname</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">name</span>
        <span class="ruby-identifier">lname</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">long_name</span>
        <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>

  <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gij</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">lname</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">sname</span>)
        <span class="ruby-identifier">gphys_gmj</span>= <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys_gmj</span>
  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_invtrans_multi" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_invtrans_multi</span><span
            class="method-args">(smnarray, dlon=false, dlat=false, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sh_invtrans_multi-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 836</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_invtrans_multi</span>(<span class="ruby-identifier">smnarray</span>, <span class="ruby-identifier">dlon</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">dlat</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-comment">#p ObjectSpace.memsize_of(gparray)</span>
  <span class="ruby-identifier">num</span> = <span class="ruby-identifier">smnarray</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">gij</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">smnarray</span>, <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">indgen!</span>, <span class="ruby-string">&quot;tmp_axis&quot;</span>), <span class="ruby-identifier">dlon</span>, <span class="ruby-identifier">dlat</span>, <span class="ruby-identifier">only</span>)
  <span class="ruby-identifier">gijarray</span> = []
  <span class="ruby-identifier">num</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">gijarray</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-string">&quot;tmp_axis&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">n</span>)
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gijarray</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_laplacian" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_laplacian</span><span
            class="method-args">(gphys)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sh_laplacian-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1038</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_laplacian</span>(<span class="ruby-identifier">gphys</span>)
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">s</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-identifier">gphys</span>)
    (<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">s</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">s</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)
    }
<span class="ruby-comment">#    s[true,-1,false] = 0.0 # test</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">s</span> = <span class="ruby-identifier">sh_trans_multi</span>(<span class="ruby-identifier">gphys</span>)
    <span class="ruby-identifier">s</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      (<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">s</span>[<span class="ruby-identifier">i</span>][<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">s</span>[<span class="ruby-identifier">i</span>][<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)
      }
    }
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">sh_invtrans_multi</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;arg must be GPhys or Array of GPhyses which are same shape)&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_trans" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_trans</span><span
            class="method-args">(gij, dlon=false, only=false, nmax=@pmn[0,0,true].size-2 )</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>球面調和正変換 引数：グリッドデータ、P_n^m、ガウス重み グリッドデータgijは1次元目がlon、2次元目がlatでなければならない。 第4引数に正整数を与えると、その数(only)の全波数のみ計算する。</p>
          
          

          
          <div class="method-source-code" id="sh_trans-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 222</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_trans</span>(<span class="ruby-identifier">gij</span>, <span class="ruby-identifier">dlon</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">nmax</span>=<span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span> )
  <span class="ruby-identifier">shapes</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">shape</span>
  <span class="ruby-identifier">imax</span> = <span class="ruby-identifier">shapes</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">jmax</span> = <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>]

  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       smn = NArrayMiss.complex(imax, nmax+1).fill!(-9.99E36).all_invalid</span>
          <span class="ruby-identifier">smn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)<span class="ruby-comment">#.fill!(-9.99E36)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       smn = NArrayMiss.complex(imax, nmax+1, shapes[2]).fill!(-9.99E36).all_invalid</span>
          <span class="ruby-identifier">smn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(-9.99E36)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       smn = NArrayMiss.complex(imax, nmax+1, shapes[2], shapes[3]).fill!(-9.99E36).all_invalid</span>
          <span class="ruby-identifier">smn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])<span class="ruby-comment">#.fill!(-9.99E36)</span>
    <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 5&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       smn = NArrayMiss.scomplex(imax, nmax+1).fill!(-9.99E36).all_invalid</span>
          <span class="ruby-identifier">smn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)<span class="ruby-comment">#.fill!(-9.99E36)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       smn = NArrayMiss.scomplex(imax, nmax+1, shapes[2]).fill!(-9.99E36).all_invalid</span>
          <span class="ruby-identifier">smn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>])<span class="ruby-comment">#.fill!(-9.99E36)</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-comment">#       smn = NArrayMiss.scomplex(imax, nmax+1, shapes[2], shapes[3]).fill!(-9.99E36).all_invalid</span>
          <span class="ruby-identifier">smn</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">imax</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])<span class="ruby-comment">#.fill!(-9.99E36)</span>
    <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;number of input grid data dimension must be less than 5&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># FFT</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shapes</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment">#サイズの大きな配列に対応するため。</span>
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@precision</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;double&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">shapes</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;single&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gmj</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">scomplex</span>(<span class="ruby-identifier">shapes</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>])
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">shapes</span>[<span class="ruby-value">3</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">gmj</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">t</span>] = <span class="ruby-identifier">gij</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">t</span>].<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>, <span class="ruby-value">0</span>).<span class="ruby-identifier">val</span>
    }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">gmj</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>, <span class="ruby-value">0</span>).<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">gjm</span> = <span class="ruby-identifier">gmj</span>.<span class="ruby-identifier">transpose</span>(<span class="ruby-value">1</span>,<span class="ruby-value">0</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gmj</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
  <span class="ruby-identifier">gjm</span> = <span class="ruby-identifier">gmj</span>.<span class="ruby-identifier">transpose</span>(<span class="ruby-value">1</span>,<span class="ruby-value">0</span>,<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gmj</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>

  <span class="ruby-comment"># ルジェンドル正変換</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@pmn</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">pmn_na</span> = <span class="ruby-ivar">@pmn</span>.<span class="ruby-identifier">to_na</span>
  <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">pmn_na</span> = <span class="ruby-ivar">@pmn</span>
  <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span> <span class="ruby-comment"># 三角切断</span>
<span class="ruby-comment">#      smn[true,n,false] = Complex(0,0)   #値を代入すると有効化される</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">only</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>) <span class="ruby-keyword">then</span>
<span class="ruby-comment">#        print smn.shape, &quot;, &quot;, gjm.shape, &quot;, &quot; ,pmn_na.shape, &quot;\n&quot;</span>
      <span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = ( (<span class="ruby-identifier">gjm</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">mul_add</span>(<span class="ruby-identifier">pmn_na</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">n</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-ivar">@gw</span>[<span class="ruby-keyword">true</span>]), <span class="ruby-value">0</span> )).<span class="ruby-identifier">mul!</span>(<span class="ruby-value">0.5</span>) ) <span class="ruby-comment">#.round(13) # test</span>
          <span class="ruby-identifier">smn</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">smn</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">n</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>)
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">n</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">only</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 特定の全波数 n だけ変換する場合</span>
          <span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>] = (<span class="ruby-identifier">gjm</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">mul_add</span>(<span class="ruby-identifier">pmn_na</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">n</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-ivar">@gw</span>[<span class="ruby-keyword">true</span>]), <span class="ruby-value">0</span> )).<span class="ruby-identifier">mul!</span>(<span class="ruby-value">0.5</span>)
          <span class="ruby-identifier">smn</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">smn</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">n</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">n</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>)
    <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># 経度微分をする場合</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlon</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">dlon</span> = <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Integer</span>)
                <span class="ruby-identifier">dlon</span>.<span class="ruby-identifier">times</span>{
        <span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>] = <span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-ivar">@complex_im</span>)
              <span class="ruby-identifier">smn</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span>), <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">smn</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">nmax</span>), <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
                }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># GPhysオブジェクト化</span>
        <span class="ruby-comment"># 軸の設定</span>
        <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">grid_copy</span> <span class="ruby-comment">#入力GPhysオブジェクトのグリッド情報を取得</span>
        <span class="ruby-identifier">xaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">zwn</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">imax</span>).<span class="ruby-identifier">indgen!</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;zonal wave number&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;wave number&quot;</span>},<span class="ruby-string">&quot;zwn&quot;</span>)
        <span class="ruby-identifier">xaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">zwn</span>
        <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">twn</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">indgen!</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;total wave number&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;wave number&quot;</span>},<span class="ruby-string">&quot;twn&quot;</span>)
        <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">twn</span>
        <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">0</span>, <span class="ruby-identifier">xaxis</span>).<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">yaxis</span>) <span class="ruby-comment">#第0, 1軸を置き換える</span>

        <span class="ruby-comment"># 変数の設定</span>
        <span class="ruby-identifier">sname</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">name</span>
        <span class="ruby-identifier">lname</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">long_name</span>
        <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gij</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>

        <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">smn</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">lname</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">sname</span>)
        <span class="ruby-identifier">gphys_smn</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys_smn</span>
  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_trans_multi" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_trans_multi</span><span
            class="method-args">(gijarray, dlon=false, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sh_trans_multi-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 825</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_trans_multi</span>(<span class="ruby-identifier">gijarray</span>, <span class="ruby-identifier">dlon</span>=<span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-comment">#p ObjectSpace.memsize_of(gparray)</span>
  <span class="ruby-identifier">num</span> = <span class="ruby-identifier">gijarray</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">sh_trans</span>(<span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">gijarray</span>, <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">indgen!</span>, <span class="ruby-string">&quot;tmp_axis&quot;</span>), <span class="ruby-identifier">dlon</span>, <span class="ruby-identifier">only</span>)
  <span class="ruby-identifier">smnarray</span> = []
  <span class="ruby-identifier">num</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">smnarray</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-string">&quot;tmp_axis&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">n</span>)
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">smnarray</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_uvcomps" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_uvcomps</span><span
            class="method-args">(u, v, a=1.0, comp_ary=[&quot;u_rot&quot;])</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>水平風(u,v)の回転成分・発散成分を求める</p>
          
          

          
          <div class="method-source-code" id="sh_uvcomps-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1223</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_uvcomps</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">comp_ary</span>=[<span class="ruby-string">&quot;u_rot&quot;</span>])
        <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">2</span>

  <span class="ruby-comment"># 渦度・発散のスペクトル → 逆ラプラシアン（渦度→流線関数、発散→速度ポテンシャル）</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;u_rot&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;v_rot&quot;</span>)) <span class="ruby-keyword">then</span> 
    <span class="ruby-identifier">psi_s</span> = <span class="ruby-identifier">sp_invlaplacian</span>( <span class="ruby-identifier">sp_vorticity</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-identifier">a</span>) )
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;u_div&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;v_div&quot;</span>)) <span class="ruby-keyword">then</span> 
    <span class="ruby-identifier">chi_s</span> = <span class="ruby-identifier">sp_invlaplacian</span>( <span class="ruby-identifier">sp_divergence</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-identifier">a</span>) )
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># 水平風の回転成分・発散成分</span>
  <span class="ruby-identifier">gphys_es_ary</span> = []
  <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">comp</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">comp</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;u_rot&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">sp_cos2_dmu</span>(<span class="ruby-identifier">psi_s</span>))<span class="ruby-operator">/</span>(<span class="ruby-ivar">@coslat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">a</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;u_rot&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;u (rot. comp.)&quot;</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;u_div&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">sp_dlon</span>(<span class="ruby-identifier">chi_s</span>))<span class="ruby-operator">/</span>(<span class="ruby-ivar">@coslat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">a</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;u_div&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;u (div. comp.)&quot;</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;v_rot&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">sp_dlon</span>(<span class="ruby-identifier">psi_s</span>))<span class="ruby-operator">/</span>(<span class="ruby-ivar">@coslat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">a</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;v_rot&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;v (rot. comp.)&quot;</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;v_div&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">sp_cos2_dmu</span>(<span class="ruby-identifier">chi_s</span>))<span class="ruby-operator">/</span>(<span class="ruby-ivar">@coslat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">a</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;v_div&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;v (div. comp.)&quot;</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">gphys_es_ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gp</span>
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys_es_ary</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_vor_and_div" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_vor_and_div</span><span
            class="method-args">(u, v, a=1.0, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sh_vor_and_div-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1147</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_vor_and_div</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
        <span class="ruby-comment"># u にcoslatをかける</span>
        <span class="ruby-identifier">ucoslat</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u</span>)
        <span class="ruby-identifier">vcoslat</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v</span>)

        <span class="ruby-comment">#グリッド→スペクトル</span>
  <span class="ruby-identifier">su</span>, <span class="ruby-identifier">sv</span> = <span class="ruby-identifier">sh_trans_multi</span>([<span class="ruby-identifier">ucoslat</span>, <span class="ruby-identifier">vcoslat</span>], <span class="ruby-keyword">false</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-comment">#スペクトル→グリッド（経度微分：d/dlon）</span>
  <span class="ruby-identifier">u_dlon</span>, <span class="ruby-identifier">v_dlon</span> = <span class="ruby-identifier">sh_invtrans_multi</span>([<span class="ruby-identifier">su</span>,<span class="ruby-identifier">sv</span>],<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>,<span class="ruby-identifier">only</span>)
        <span class="ruby-comment">#スペクトル→グリッド（緯度微分：d/dmu）</span>
  <span class="ruby-identifier">u_dlat</span>, <span class="ruby-identifier">v_dlat</span> = <span class="ruby-identifier">sh_invtrans_multi</span>([<span class="ruby-identifier">su</span>,<span class="ruby-identifier">sv</span>],<span class="ruby-keyword">false</span>,<span class="ruby-value">1</span>,<span class="ruby-identifier">only</span>)

        <span class="ruby-identifier">gvor</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v_dlon</span>, <span class="ruby-value">-2</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">a</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">u_dlat</span><span class="ruby-operator">/</span><span class="ruby-identifier">a</span>
        <span class="ruby-identifier">gvor</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;Vor&quot;</span>)
        <span class="ruby-identifier">gvor</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span> , <span class="ruby-string">&quot;Vorticity&quot;</span>)
        <span class="ruby-identifier">gvor</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span> , <span class="ruby-string">&quot;s-1&quot;</span>)

  <span class="ruby-identifier">gdiv</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u_dlon</span>, <span class="ruby-value">-2</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">a</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">v_dlat</span><span class="ruby-operator">/</span><span class="ruby-identifier">a</span>
        <span class="ruby-identifier">gdiv</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;Div&quot;</span>)
        <span class="ruby-identifier">gdiv</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;Divergence&quot;</span>)
        <span class="ruby-identifier">gdiv</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span> ,<span class="ruby-string">&quot;s-1&quot;</span>)

        <span class="ruby-keyword">return</span> [<span class="ruby-identifier">gvor</span>, <span class="ruby-identifier">gdiv</span>]

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sh_vorticity" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sh_vorticity</span><span
            class="method-args">(u, v, a=1.0, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>u, v から鉛直渦度を計算（グリッド → グリッド）</p>
          
          

          
          <div class="method-source-code" id="sh_vorticity-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1102</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sh_vorticity</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
        <span class="ruby-comment"># u にcoslatをかける</span>
        <span class="ruby-identifier">ucoslat</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u</span>)
        <span class="ruby-identifier">vcoslat</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v</span>)
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">su</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">ucoslat</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-identifier">sv</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">vcoslat</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)

        <span class="ruby-comment">#スペクトル→グリッド（経度微分：d/dlon）</span>
        <span class="ruby-identifier">v_dlon</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">sv</span>, <span class="ruby-value">1</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-comment">#スペクトル→グリッド（緯度微分：d/dmu）</span>
        <span class="ruby-identifier">u_dlat</span> = <span class="ruby-identifier">sh_invtrans</span>(<span class="ruby-identifier">su</span>, <span class="ruby-keyword">false</span>, <span class="ruby-value">1</span>, <span class="ruby-identifier">only</span>)

        <span class="ruby-identifier">gresult</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v_dlon</span>, <span class="ruby-value">-2</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">a</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">u_dlat</span><span class="ruby-operator">/</span><span class="ruby-identifier">a</span>
        <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;Vor&quot;</span>)
        <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span> , <span class="ruby-string">&quot;Vorticity&quot;</span>)
        <span class="ruby-identifier">gresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span> , <span class="ruby-string">&quot;s-1&quot;</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sinlat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sinlat</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sinlat-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 821</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sinlat</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-ivar">@sinlat</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_cos2_dmu" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_cos2_dmu</span><span
            class="method-args">(gphys_smn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>スペクトルデータから、そのcos^2(lat)*mu微分 (mu = sin(lat)) のスペクトルを求める。</p>
          
          

          
          <div class="method-source-code" id="sp_cos2_dmu-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 911</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_cos2_dmu</span>(<span class="ruby-identifier">gphys_smn</span>)
  <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">val</span>

  <span class="ruby-identifier">imax</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span> <span class="ruby-comment">## smn.shape[1] - 1 # 切断波数</span>

<span class="ruby-comment">#  sval = NArray.complex(imax,nmax+2,1)</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">sval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+2</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">shape_ary</span> = [<span class="ruby-identifier">imax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
    <span class="ruby-identifier">sval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">shape_ary</span>)
  <span class="ruby-keyword">end</span>


<span class="ruby-comment">#binding.pry</span>
  <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = (<span class="ruby-value">2</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-value">1</span>]
  <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>
    <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = (<span class="ruby-identifier">n</span><span class="ruby-value">+2</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>] <span class="ruby-operator">-</span> (<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">nmax</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># smn[true,nmax+1] がない場合</span>
    <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>]
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># smn[true,nmax+1] がある場合</span>
<span class="ruby-comment">#    binding.pry</span>
    <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>] = (<span class="ruby-identifier">nmax</span><span class="ruby-value">+2</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>]<span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>]

  <span class="ruby-identifier">sval</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sval</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span>


  <span class="ruby-comment"># GPhysオブジェクト化</span>
        <span class="ruby-comment"># 軸の設定</span>
        <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">grid_copy</span> <span class="ruby-comment">#入力GPhysオブジェクトのグリッド情報を取得</span>
        <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">twn</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+2</span>).<span class="ruby-identifier">indgen!</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;total wave number&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;wave number&quot;</span>},<span class="ruby-string">&quot;twn&quot;</span>)
        <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">twn</span>
        <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">yaxis</span>) <span class="ruby-comment">#第0, 1軸を置き換える</span>

        <span class="ruby-comment"># 変数の設定</span>
        <span class="ruby-identifier">sname</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">name</span>
        <span class="ruby-identifier">lname</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">long_name</span>
        <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>

        <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">sval</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">lname</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">sname</span>)
        <span class="ruby-identifier">gphys_smn_new</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys_smn_new</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_divergence" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_divergence</span><span
            class="method-args">(u, v, a=1.0, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>u, v から水平発散を計算（グリッド → スペクトル）</p>
          
          

          
          <div class="method-source-code" id="sp_divergence-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1198</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_divergence</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-comment"># 切断波数</span>
  <span class="ruby-identifier">nmax</span>=<span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>
        <span class="ruby-comment"># u, v にcos^-1(lat)をかける</span>
        <span class="ruby-identifier">ucoslat_1</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u</span>, <span class="ruby-value">-1</span>)
        <span class="ruby-identifier">vcoslat_1</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v</span>, <span class="ruby-value">-1</span>)
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">su</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">ucoslat_1</span>,  <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-identifier">sv</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">vcoslat_1</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)
        <span class="ruby-comment">#スペクトル→スペクトル（経度微分：d/dlon）</span>
        <span class="ruby-identifier">su_dlon</span> = <span class="ruby-identifier">sp_dlon</span>(<span class="ruby-identifier">su</span>)
        <span class="ruby-comment">#スペクトル→スペクトル（緯度微分：d(g*cos^2(lat))/dmu）</span>
        <span class="ruby-identifier">sv_dlat</span> = <span class="ruby-identifier">sp_dmu_cos2</span>(<span class="ruby-identifier">sv</span>)

  <span class="ruby-identifier">sresult</span> = (<span class="ruby-identifier">su_dlon</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sv_dlat</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">a</span>
  <span class="ruby-identifier">sresult</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;Div&quot;</span>)
  <span class="ruby-identifier">sresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;Divergence&quot;</span>)
  <span class="ruby-identifier">sresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span> , <span class="ruby-string">&quot;s-1&quot;</span>)

        <span class="ruby-comment"># return sh_invtrans(sresult,false,false,false,nmax)</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">sresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_dlon" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_dlon</span><span
            class="method-args">(gphys_smn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>スペクトルデータから、その経度微分のスペクトルを求める。</p>
          
          

          
          <div class="method-source-code" id="sp_dlon-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 900</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_dlon</span>(<span class="ruby-identifier">gphys_smn</span>)
  <span class="ruby-identifier">d_gphys_smn</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">copy</span>
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@complex_im</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">val</span>
        <span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">mul!</span>(<span class="ruby-ivar">@complex_im</span>) <span class="ruby-comment"># I は虚数単位</span>
  <span class="ruby-identifier">smn</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">nmax</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">smn</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span> <span class="ruby-comment"># m &lt; 0 部分の値</span>
  <span class="ruby-identifier">d_gphys_smn</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">smn</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">d_gphys_smn</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_dmu_cos2" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_dmu_cos2</span><span
            class="method-args">(gphys_smn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>スペクトルデータから、d(g*cos^2(lat))/dmu  (mu = sin(lat)) のスペクトルを求める。</p>
          
          

          
          <div class="method-source-code" id="sp_dmu_cos2-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 961</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_dmu_cos2</span>(<span class="ruby-identifier">gphys_smn</span>)
  <span class="ruby-identifier">smn</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">val</span>

  <span class="ruby-identifier">imax</span> = <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span> <span class="ruby-comment">## smn.shape[1] - 1 # 切断波数</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">sval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-identifier">imax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">shape_ary</span> = [<span class="ruby-identifier">imax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
    <span class="ruby-identifier">sval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">complex</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">shape_ary</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">0.0</span>
  <span class="ruby-keyword">for</span> <span class="ruby-identifier">n</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>
    <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">n</span><span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">nmax</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">smn</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># smn[true,nmax+1] がない場合</span>
    <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>]
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># smn[true,nmax+1] がある場合</span>
<span class="ruby-comment">#    binding.pry</span>
    <span class="ruby-identifier">sval</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">nmax</span><span class="ruby-operator">*</span><span class="ruby-identifier">smn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@emn</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-comment">#  sval[0..nmax,nmax+1,false] = -(nmax+2)*smn[0..nmax,nmax,false]*@emn[0..nmax,nmax+1]</span>

  <span class="ruby-identifier">sval</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sval</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">conj</span>


  <span class="ruby-comment"># GPhysオブジェクト化</span>
        <span class="ruby-comment"># 軸の設定</span>
        <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">grid_copy</span> <span class="ruby-comment">#入力GPhysオブジェクトのグリッド情報を取得</span>
        <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-identifier">twn</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">indgen!</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;total wave number&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;wave number&quot;</span>},<span class="ruby-string">&quot;twn&quot;</span>)
        <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">twn</span>
        <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-value">1</span>, <span class="ruby-identifier">yaxis</span>) <span class="ruby-comment">#第0, 1軸を置き換える</span>

        <span class="ruby-comment"># 変数の設定</span>
        <span class="ruby-identifier">sname</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">name</span>
        <span class="ruby-identifier">lname</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">long_name</span>
        <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gphys_smn</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>

        <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">sval</span>, {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">lname</span>, <span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">sname</span>)
        <span class="ruby-identifier">gphys_smn_new</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">va</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gphys_smn_new</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_invlaplacian" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_invlaplacian</span><span
            class="method-args">(s)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sp_invlaplacian-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1090</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_invlaplacian</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>
  <span class="ruby-identifier">sout</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">copy</span>
  (<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">nmax</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sout</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">s</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">/</span>(<span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>))
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">sout</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_laplacian" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_laplacian</span><span
            class="method-args">(s)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="sp_laplacian-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1060</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_laplacian</span>(<span class="ruby-identifier">s</span>)
  <span class="ruby-identifier">sout</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">copy</span>
  <span class="ruby-identifier">nmax</span> = <span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>
  (<span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sout</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">s</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">n</span><span class="ruby-value">+1</span>)
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">sout</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sp_vorticity" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sp_vorticity</span><span
            class="method-args">(u, v, a=1.0, only=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>u, v から鉛直渦度を計算（グリッド → スペクトル）</p>
          
          

          
          <div class="method-source-code" id="sp_vorticity-source">
            <pre><span class="ruby-comment"># File src/gpv_spherical_harmonics_next.rb, line 1174</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sp_vorticity</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">a</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">only</span>=<span class="ruby-keyword">false</span>)
  <span class="ruby-comment"># 切断波数</span>
  <span class="ruby-identifier">nmax</span>=<span class="ruby-ivar">@pmn</span>[<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>].<span class="ruby-identifier">size</span><span class="ruby-value">-2</span>
        <span class="ruby-comment"># u, v にcos^-1(lat)をかける</span>
        <span class="ruby-identifier">ucoslat_1</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">u</span>, <span class="ruby-value">-1</span>)
        <span class="ruby-identifier">vcoslat_1</span> = <span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">v</span>, <span class="ruby-value">-1</span>)
        <span class="ruby-comment">#グリッド→スペクトル</span>
        <span class="ruby-identifier">su</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">ucoslat_1</span>,  <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>, <span class="ruby-identifier">nmax</span><span class="ruby-value">+1</span>)
        <span class="ruby-identifier">sv</span> = <span class="ruby-identifier">sh_trans</span>( <span class="ruby-identifier">vcoslat_1</span>, <span class="ruby-keyword">false</span>, <span class="ruby-identifier">only</span>)
        <span class="ruby-comment">#スペクトル→スペクトル（経度微分：d/dlon）</span>
        <span class="ruby-identifier">sv_dlon</span> = <span class="ruby-identifier">sp_dlon</span>(<span class="ruby-identifier">sv</span>)
        <span class="ruby-comment">#スペクトル→スペクトル（緯度微分：d(g*cos^2(lat))/dmu）</span>
        <span class="ruby-identifier">su_dlat</span> = <span class="ruby-identifier">sp_dmu_cos2</span>(<span class="ruby-identifier">su</span>)

  <span class="ruby-identifier">sresult</span> = (<span class="ruby-identifier">sv_dlon</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">su_dlat</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">a</span>
  <span class="ruby-identifier">sresult</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;Vor&quot;</span>)
  <span class="ruby-identifier">sresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;Vorticity&quot;</span>)
  <span class="ruby-identifier">sresult</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span> , <span class="ruby-string">&quot;s-1&quot;</span>)

        <span class="ruby-comment"># return sh_invtrans(sresult)</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">sresult</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

