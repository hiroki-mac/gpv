<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>class GPV - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link"><a href="Object.html">Object</a>
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="GPV/GGraph.html">GPV::GGraph</a>
  
  
  
    <li><a class="include" href="SphericalHarmonics.html">SphericalHarmonics</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-__set_options">#__set_options</a>
    
    <li ><a href="#method-i-__split_range">#__split_range</a>
    
    <li ><a href="#method-i-addingup">#addingup</a>
    
    <li ><a href="#method-i-auto_write">#auto_write</a>
    
    <li ><a href="#method-i-check_dclopts">#check_dclopts</a>
    
    <li ><a href="#method-i-common_blocks">#common_blocks</a>
    
    <li ><a href="#method-i-common_chars">#common_chars</a>
    
    <li ><a href="#method-i-composite">#composite</a>
    
    <li ><a href="#method-i-corelation">#corelation</a>
    
    <li ><a href="#method-i-counter">#counter</a>
    
    <li ><a href="#method-i-covariance">#covariance</a>
    
    <li ><a href="#method-i-csv2gphys">#csv2gphys</a>
    
    <li ><a href="#method-i-cut_slice_thinning">#cut_slice_thinning</a>
    
    <li ><a href="#method-i-cyclic_extension">#cyclic_extension</a>
    
    <li ><a href="#method-i-data_thinning">#data_thinning</a>
    
    <li ><a href="#method-i-date_diff">#date_diff</a>
    
    <li ><a href="#method-i-dcl_set_params">#dcl_set_params</a>
    
    <li ><a href="#method-i-div_on_meridional_plane">#div_on_meridional_plane</a>
    
    <li ><a href="#method-i-draw">#draw</a>
    
    <li ><a href="#method-i-draw_linearline">#draw_linearline</a>
    
    <li ><a href="#method-i-draw_multi_vars">#draw_multi_vars</a>
    
    <li ><a href="#method-i-draw_setup">#draw_setup</a>
    
    <li ><a href="#method-i-draw_text">#draw_text</a>
    
    <li ><a href="#method-i-each_along_dims">#each_along_dims</a>
    
    <li ><a href="#method-i-epflux">#epflux</a>
    
    <li ><a href="#method-i-extend_backward_along">#extend_backward_along</a>
    
    <li ><a href="#method-i-find_axisnames">#find_axisnames</a>
    
    <li ><a href="#method-i-fits2gphys">#fits2gphys</a>
    
    <li ><a href="#method-i-float_string-3F">#float_string?</a>
    
    <li ><a href="#method-i-func">#func</a>
    
    <li ><a href="#method-i-g_epflux">#g_epflux</a>
    
    <li ><a href="#method-i-get_calendar">#get_calendar</a>
    
    <li ><a href="#method-i-gglat">#gglat</a>
    
    <li ><a href="#method-i-grad_sy">#grad_sy</a>
    
    <li ><a href="#method-i-highpass">#highpass</a>
    
    <li ><a href="#method-i-ifunc">#ifunc</a>
    
    <li ><a href="#method-i-interpolate_pole">#interpolate_pole</a>
    
    <li ><a href="#method-i-invalidation">#invalidation</a>
    
    <li ><a href="#method-i-line_fill">#line_fill</a>
    
    <li ><a href="#method-i-lowpass">#lowpass</a>
    
    <li ><a href="#method-i-main">#main</a>
    
    <li ><a href="#method-i-maskshading">#maskshading</a>
    
    <li ><a href="#method-i-mstrmfunc_on_z">#mstrmfunc_on_z</a>
    
    <li ><a href="#method-i-open_gturl">#open_gturl</a>
    
    <li ><a href="#method-i-open_gturl_wildcard">#open_gturl_wildcard</a>
    
    <li ><a href="#method-i-output_csv">#output_csv</a>
    
    <li ><a href="#method-i-parse_gturl">#parse_gturl</a>
    
    <li ><a href="#method-i-powerspectra">#powerspectra</a>
    
    <li ><a href="#method-i-pv_on_z">#pv_on_z</a>
    
    <li ><a href="#method-i-reflectance">#reflectance</a>
    
    <li ><a href="#method-i-regrid">#regrid</a>
    
    <li ><a href="#method-i-reopen">#reopen</a>
    
    <li ><a href="#method-i-reverse">#reverse</a>
    
    <li ><a href="#method-i-rgn">#rgn</a>
    
    <li ><a href="#method-i-set_calendar">#set_calendar</a>
    
    <li ><a href="#method-i-set_dims">#set_dims</a>
    
    <li ><a href="#method-i-set_draw_range">#set_draw_range</a>
    
    <li ><a href="#method-i-set_vpsize">#set_vpsize</a>
    
    <li ><a href="#method-i-sig2p">#sig2p</a>
    
    <li ><a href="#method-i-sig2z">#sig2z</a>
    
    <li ><a href="#method-i-solar_zenith_angle">#solar_zenith_angle</a>
    
    <li ><a href="#method-i-split_axis">#split_axis</a>
    
    <li ><a href="#method-i-step_shape">#step_shape</a>
    
    <li ><a href="#method-i-title">#title</a>
    
    <li ><a href="#method-i-tone_full">#tone_full</a>
    
    <li ><a href="#method-i-visualize_and_output">#visualize_and_output</a>
    
    <li ><a href="#method-i-window_setup">#window_setup</a>
    
    <li ><a href="#method-i-wnf_analysis">#wnf_analysis</a>
    
    <li ><a href="#method-i-write_netcdf4">#write_netcdf4</a>
    
    <li ><a href="#method-i-ymd2date">#ymd2date</a>
    
    <li ><a href="#method-i-ymd2time">#ymd2time</a>
    
    <li ><a href="#method-i-zonal_shift_on_sphere">#zonal_shift_on_sphere</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-GPV">
  <h1 id="class-GPV" class="class">
    class GPV
  </h1>

  <section class="description">
    
  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-__set_options" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">__set_options</span><span
            class="method-args">(opts=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>↑↑See this source code for available options↑↑</p>
          
          

          
          <div class="method-source-code" id="__set_options-source">
            <pre><span class="ruby-comment"># File gpv_main.rb, line 38</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">__set_options</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opts</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">prev_argv</span> = <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">clone</span>
    <span class="ruby-keyword">while</span> (<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>])
      <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">opts</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot; &quot;</span>))
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment">## options for DCL</span>
  <span class="ruby-identifier">check_dclopts</span>
  <span class="ruby-comment">## parse options</span>
  <span class="ruby-identifier">parser</span> = <span class="ruby-constant">GetoptLong</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">parser</span>.<span class="ruby-identifier">set_options</span>(




<span class="ruby-comment">###</span>
<span class="ruby-comment">### global options ###</span>
<span class="ruby-comment">###</span>
  [<span class="ruby-string">&#39;--var&#39;</span>,     <span class="ruby-comment">#                             | set the variable name and slicing parameters.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--vf&#39;</span>,      <span class="ruby-comment">#                             | use variable whose name is included in the filename.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--pry&#39;</span>,     <span class="ruby-comment">#                             | start pry after drawing the first figure</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--auto_pry&#39;</span>,<span class="ruby-comment"># &lt;args&gt;                      | automatically execute the given scripts like as in pry after drawing the first figure.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--list&#39;</span>,    <span class="ruby-comment">#                             | execute gplist instead of any other options.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--silent&#39;</span>,  <span class="ruby-comment">#                             | show only calculated values. do not show any messages.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--parallel&#39;</span>,<span class="ruby-comment">#                             | use parallel anyway.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--help&#39;</span>,    <span class="ruby-comment">#</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],



<span class="ruby-comment">###</span>
<span class="ruby-comment">### visualize options ###</span>
<span class="ruby-comment">###</span>
  [<span class="ruby-string">&#39;--clrmap&#39;</span>,  <span class="ruby-comment"># &lt;1- or filename&gt;            | set colormap to draw tone/contour. filename of DCL colormap is acceptable.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--itr&#39;</span>,     <span class="ruby-comment"># &lt;1-4,5-7,10-15,20-23,30-33&gt; | set axis scale. default is 1.</span>
                <span class="ruby-comment">#                             | 1 : linear scale for x/y axis</span>
                <span class="ruby-comment">#                             | 2 : linear scale for x , log scale for y axis</span>
                <span class="ruby-comment">#                             | 3 : log scale for x , linear scale for y axis</span>
                <span class="ruby-comment">#                             | 4 : log scale for x/y axis</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--similar&#39;</span>, <span class="ruby-comment"># &lt;simfac,vxoff,vyoff&gt;        | (for 5&lt;=itr&lt;=7) set similarity parameters which are fed in DCL.grssim.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--map_axis&#39;</span>,<span class="ruby-comment"># &lt;uxc,uyc,rot&gt;               | (for 10&lt;=itr&lt;=33) set mapping parameters which are fed in DCL.umpcnt.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--map_radius&#39;</span>, <span class="ruby-comment"># &lt;radius&gt;                 | (for itr&gt;=20) set clipping radius (degree) around the tangential point. Deafault=90.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--xcoord&#39;</span>,  <span class="ruby-comment"># &lt;xcoord&gt;                    | name of x-coordinate (use for associate coordinates)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ycoord&#39;</span>,  <span class="ruby-comment"># &lt;ycoord&gt;                    | name of y-coordinate (use for associate coordinates)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--title&#39;</span>,   <span class="ruby-comment"># &lt;title&gt;                     | set title of figure</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--notitle&#39;</span>, <span class="ruby-comment">#                             | do not print title. equivalent to --title &quot;&quot;</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--aspect&#39;</span>,  <span class="ruby-comment"># &lt;aspect&gt;                    | set aspect ratio of Viewport. default is 2.0.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--anim&#39;</span>, <span class="ruby-string">&#39;--animate&#39;</span>, <span class="ruby-comment"># &lt;dim&gt;             | plot animation along &lt;dim&gt;. &lt;dim&gt; must be name of dimension.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--noannotate&#39;</span>, <span class="ruby-comment">#                          | not draw annotations.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--alternate&#39;</span>, <span class="ruby-string">&#39;--Ga&#39;</span>, <span class="ruby-comment">#                   | enable to backing store.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nowait&#39;</span>, <span class="ruby-string">&#39;--Gw&#39;</span>, <span class="ruby-comment">#                      | not wait for any actions if animate</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--smooth&#39;</span>, <span class="ruby-string">&#39;--Gaw&#39;</span>, <span class="ruby-comment">#                     | equal to --anlternate &amp;&amp; --nowait</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--reverse&#39;</span>, <span class="ruby-string">&#39;--Gr&#39;</span>, <span class="ruby-comment">#                     | plot animation reversible if animate</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--exch&#39;</span>, <span class="ruby-comment">#                                | exchange(transpose) x/y axis.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--map&#39;</span>, <span class="ruby-string">&#39;--m&#39;</span>, <span class="ruby-comment"># &lt;map_type&gt;               | plot map. itr number must be set. this option is neglect if itr number is 1-4.</span>
                   <span class="ruby-comment">#                          | abailable map type is coast_world, border_world, plate_world, state_usa, coast_japan, pref_japan</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--time_ax&#39;</span>,    <span class="ruby-comment"># &lt;nil|false|h|ymd&gt;        | specify type of calendar-type time axis:</span>
                   <span class="ruby-comment">#                          |  nil   (=&gt; auto slection)</span>
                   <span class="ruby-comment">#                          | false (=&gt; do not use the time axis even if</span>
                   <span class="ruby-comment">#                          |           the units of the axis is a time one with since field)</span>
                   <span class="ruby-comment">#                          | &quot;h&quot;   (=&gt; like nil, but always use the hour-resolving datetime_ax method</span>
                   <span class="ruby-comment">#                          |           in dclext_datetime_ax.rb)</span>
                   <span class="ruby-comment">#                          | &quot;ymd&quot; (=&gt; like &quot;h&quot; but for y-m-d type using DCL.uc[xy]acl)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sldiv&#39;</span>,      <span class="ruby-comment"># &lt;&lt;y|t&gt;,m,n&gt;              | split the drawing window into multiple panel.</span>
                   <span class="ruby-comment">#                          | argument should be provied in DCL.sldiv form.</span>
                   <span class="ruby-comment">#                          | e.g., --sldiv y,2,2 make 2x2 window.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--scatter&#39;</span>,    <span class="ruby-comment"># [xtitle,ytitle]          | make scatter plot with provided 2 gturls.</span>
                   <span class="ruby-comment">#                          | 1st and 2nd gturls will be used for x- and y-axes, respectively.</span>
                   <span class="ruby-comment">#                          | titles of x- and y- axes can be specified by arguments xtitle,ytitle (optional)</span>
                   <span class="ruby-comment">#                          | range of each axis can be specified by option --range [xmin:xmax,ymin:ymax] format.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--color_scatter&#39;</span>, <span class="ruby-comment"># [xtitle,ytitle]       | make color scatter plot with provided 3 gturls.</span>
                      <span class="ruby-comment">#                       | 1st and 2nd gturls are used for x- and y-axes, respectively.</span>
                      <span class="ruby-comment">#                       | 3rd gturl is used for color of marks.</span>
                      <span class="ruby-comment">#                       | titles of x- and y- axes can be specified by arguments xtitle,ytitle (optional)</span>
                      <span class="ruby-comment">#                       | range of each axis and color can be specified by option --range [xmin:xmax,ymin:ymax,zmin:zmax] format</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--cot&#39;</span>,           <span class="ruby-comment">#                       | contour over tone. draw tone with 1st gturl and overplot contour with 2nd gturl.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--histogram&#39;</span>,     <span class="ruby-comment"># [any]                 | draw 1D histogram.</span>
                      <span class="ruby-comment">#                       | options &quot;--int -n&quot; and &quot;--range xmin:xmax[,ymin:ymax]&quot; can be used to set bins number and range.</span>
                      <span class="ruby-comment">#                       | options &quot;--exch&quot;, &quot;--title&quot;, and &quot;--overplot n&quot; also can be used.</span>
                      <span class="ruby-comment">#                       | if any argument is given, histogram are shown in percentage (%) not in numbers.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--histogram2D&#39;</span>,   <span class="ruby-comment"># [any]                 | draw 2D histogram with two gtulrs.</span>
                      <span class="ruby-comment">#                       | if any argument is given, histogram are shown in percentage (%) not in numbers.</span>
                      <span class="ruby-comment">#                       | options &quot;--int -n&quot; and &quot;--range xmin:xmax[,ymin:ymax]&quot; can be used to set bins number and range.</span>
                      <span class="ruby-comment">#                       | options &quot;--sint [-]n&quot; and &quot;--srange xmin:xmax&quot; can be used to set tone interval[number] and range.</span>
                      <span class="ruby-comment">#                       | options &quot;--exch&quot; and &quot;--title&quot; also can be used.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--rmap&#39;</span>,          <span class="ruby-comment"># &lt;dim&gt;                 | draw 2D map of correaltion between 1st and 2nd gturls along &lt;dim&gt; axis.</span>
                      <span class="ruby-comment">#                       | &lt;dim&gt; can be axis name (string) or dimension number (integer), but only one</span>
                      <span class="ruby-comment">#                       | axis is acceptable.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--linearline&#39;</span>,    <span class="ruby-comment"># &lt;arg&gt;                 | draw linear line expressed bay &lt;arg&gt;.</span>
                      <span class="ruby-comment">#                       | &lt;arg&gt; should be &quot;x=&lt;value&gt;&quot;, &quot;y=&lt;value&gt;&quot;, &quot;x=y&quot;, or &quot;y=x&quot;, where &lt;value&gt; is integer or float.</span>
                      <span class="ruby-comment">#                       | multiple lines can be drawn by setting multiple args separated by comma, such as &quot;x=0,y=0&quot;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--land&#39;</span>,          <span class="ruby-comment">#                       | mask data with land info, https://www.ncl.ucar.edu/Applications/Data/cdf/landsea.nc.</span>
                      <span class="ruby-comment">#                       | you need to download landsea.nc and place it on correct dir.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ocean&#39;</span>,         <span class="ruby-comment">#                       | mask data with ocean info, https://www.ncl.ucar.edu/Applications/Data/cdf/landsea.nc.</span>
                      <span class="ruby-comment">#                       | you need to download landsea.nc and place it on correct dir.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--line&#39;</span>,          <span class="ruby-comment">#                       | make line plot forced. (about first 1D)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--mark&#39;</span>,          <span class="ruby-comment">#                       | make mark plot forced. (about first 1D)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--index&#39;</span>,         <span class="ruby-comment"># &lt;index_num&gt;           | set DCL line index, which set the color/thickness of the line primitive. please see DCL documents.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--type&#39;</span>,          <span class="ruby-comment"># &lt;type_num&gt;            | set line type.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--overplot&#39;</span>,      <span class="ruby-comment"># &lt;num&gt;                 | set number of lines on each figure with color.</span>
                      <span class="ruby-comment">#                       | use with --nocolor if you want to distinguish by line type.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nocolor&#39;</span>,       <span class="ruby-comment">#                       | draw without using color.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--right_axis&#39;</span>,    <span class="ruby-comment">#                       | use with &quot;--overplot 2&quot; and draw 2nd y-axis in right side for 2nd gturl.</span>
                      <span class="ruby-comment">#                       | range of 2nd y-axis can be specified by --range left_min1:left_max,right_min:right_max.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--top_axis&#39;</span>,      <span class="ruby-comment">#                       | 使い方を忘れた...</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--overplot_rm&#39;</span>,   <span class="ruby-comment"># &lt;span&gt;                | overplot the running mean with thick line. running mean span is required.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--overplot_stddev&#39;</span>,<span class="ruby-comment">#                      | overplot the mean +/- stddev (like errorbars). this must be used with &quot;--mean&quot; option.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  <span class="ruby-comment">### tone or cont option ###</span>
  [<span class="ruby-string">&#39;--nocont&#39;</span>,        <span class="ruby-comment">#                       | make tone plot, without contour.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--noshade&#39;</span>,       <span class="ruby-comment">#                       | make contour plot, without tone.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--log_int&#39;</span>,       <span class="ruby-comment">#                       | use log interval in contour/tone.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--range&#39;</span>,         <span class="ruby-comment"># &lt;min:max&gt;             | set min/max value for contour/tone/line/mark plot. min or max must be set.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--crange&#39;</span>,        <span class="ruby-comment"># &lt;min:max&gt;             | set min/max value for contour plot. this is more dominant than --range</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--srange&#39;</span>,        <span class="ruby-comment"># &lt;min:max&gt;             | set min/max value for tone plot. this is more dominant than --interval/int</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--interval&#39;</span>, <span class="ruby-string">&#39;--int&#39;</span>,  <span class="ruby-comment"># &lt;num&gt;            | set interval value for contour/tone plot. set the number of lines if you set negative value.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--cint&#39;</span>,          <span class="ruby-comment"># &lt;num&gt;                 | set interval value for contour plot. this is more dominant than --interval/int</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sint&#39;</span>,          <span class="ruby-comment"># &lt;num&gt;                 | set interval value for tone plot. this is more dominant than --interval/int.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--levels&#39;</span>,        <span class="ruby-comment"># &lt;val1,val2,val3,...&gt;  | set values of contour/tone levels.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--clevels&#39;</span>,       <span class="ruby-comment"># &lt;val1,val2,val3,...&gt;  | set values of contour levels.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--slevels&#39;</span>,       <span class="ruby-comment"># &lt;val1,val2,val3,...&gt;  | set values of tone levels.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--patterns&#39;</span>,      <span class="ruby-comment"># &lt;pattern1,pattern2,..&gt;| set each patterns for tone plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--tone&#39;</span>,          <span class="ruby-comment"># &lt;a|e|f|b|c&gt;           | set tone subroutine:</span>
                      <span class="ruby-comment">#                       | a (=&gt; tone routine is selected automatically depending on the datasize)</span>
                      <span class="ruby-comment">#                       | e (=&gt; DCL.uetone is used)</span>
                      <span class="ruby-comment">#                       | f (=&gt; DCL.uetonf is used)</span>
                      <span class="ruby-comment">#                       | b (=&gt; DCL.uetonb is used)</span>
                      <span class="ruby-comment">#                       | c (=&gt; DCL.uetonc is used)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--udsfmt&#39;</span>,        <span class="ruby-comment"># &lt;strings&gt;             | change contour label format. see UDCNTR/DCL manual for the format.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nocolorbar&#39;</span>,    <span class="ruby-comment">#                       | do not draw color bar.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nozero&#39;</span>,        <span class="ruby-comment">#                       | do not draw zero contour.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nodraw&#39;</span>,        <span class="ruby-comment">#                       | do not draw any figures.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--file&#39;</span>,       <span class="ruby-comment"># &lt;png|eps|pdf&gt;[,filename] | raw in file with given format. available formats are png, eps, and pdf.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--crop&#39;</span>,       <span class="ruby-comment">#                          | crop (trim) output png or pdf.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--title_array&#39;</span>,<span class="ruby-comment"># &lt;string,string,...&gt;      | set multiple titles given as --title_array hoge,foo,bar; this gives the title &quot;hoge&quot; to</span>
                   <span class="ruby-comment">#                          | the 1st figure, &quot;foo&quot; to the 2nd one, and &quot;bar&quot; to the 3rd one.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--miscindex&#39;</span>,  <span class="ruby-comment"># &lt;num&gt;                    | set line index (color and width) of title, label, frame, etc.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--index_array&#39;</span>,<span class="ruby-comment"># &lt;index1,index2,...&gt;      | set array of index used for 1st, 2nd,... lines/mark.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--type_array&#39;</span>, <span class="ruby-comment"># &lt;index1,index2,...&gt;      | set array of type index used for 1st, 2nd,... lines/mark.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--subtitle&#39;</span>,   <span class="ruby-comment"># &lt;string&gt;                 | set subtitle, which locates just below the title and is common for multple figures.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--irange&#39;</span>,     <span class="ruby-comment"># &lt;min:max&gt;                | same as --range but with +/- infinity for both boundaries. use with --int is recomended.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--xrange&#39;</span>,     <span class="ruby-comment"># &lt;min:max&gt;                | set the range of x-axis for line plot and 2D plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--yrange&#39;</span>,     <span class="ruby-comment"># &lt;min:max&gt;                | set the range of y-axis for line plot and 2D plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--clr_range&#39;</span>,  <span class="ruby-comment"># &lt;min:max&gt;                | set color range. maximum range is 10:99. default is 15:94.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--wm&#39;</span>,         <span class="ruby-comment">#                          | alias for --itr 10 --map coast_world --nocont.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--size&#39;</span>,       <span class="ruby-comment"># &lt;num&gt;                    | set the size factor of x-window (default: 1.25)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--fullcolor&#39;</span>,  <span class="ruby-comment"># &lt;1|2&gt;                    | draw fullcolor fig. --fullcolor 1 draws with 1 var.</span>
                   <span class="ruby-comment">#                          | --fullcolor 2 draws with 2 vars; 1st gturl is used for color (hue) and</span>
                   <span class="ruby-comment">#                          | 2nd one is used for brightness (value).</span>
                   <span class="ruby-comment">#                          | option of --range xmin:xmax,ymin:ymax can be used.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--step&#39;</span>,       <span class="ruby-comment">#                          | make 1D line plot to step shape.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--zerocenter&#39;</span>, <span class="ruby-comment"># [max]                    | set y-axis center in line plot figure to zero.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--vector&#39;</span>,     <span class="ruby-comment">#                          | draw a vector plot.</span>
                   <span class="ruby-comment">#                          | When 2 gturls are given, 1st one and 2nd one are used for x- and y-components of the vectors.</span>
                   <span class="ruby-comment">#                          | When 3 or 4 gturls are given, 2nd one and 3rd one are used for x- and y-components of the vectors,</span>
                   <span class="ruby-comment">#                          | and tone of 1st one and counter of 4th one are overlaid.</span>
                   <span class="ruby-comment">#                          | If the 1st dim is lon or lat and the 2nd dim is not lon or lat, vectors are scaled by the geometry aspect ratio.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--vfact&#39;</span>,      <span class="ruby-comment"># &lt;factor&gt;                 | use with &quot;--vector&quot; to change the size of the vector by &lt;factor&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--vint&#39;</span>,       <span class="ruby-comment"># &lt;int&gt;                    | use with &quot;--vector&quot; to change the gird-interval to draw vectors.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--vkeep&#39;</span>,      <span class="ruby-comment">#                          | use with &quot;--vector&quot; to keep the size of unit vector as that of the first plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nolegend&#39;</span>,   <span class="ruby-comment">#                          | do not draw legend of line plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--textbox&#39;</span>,    <span class="ruby-comment"># &lt;text&gt;,&lt;num&gt;,[l|c]       | draw textbox, legends, and/or color bar in frame #&lt;num&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--fact&#39;</span>,       <span class="ruby-comment"># &lt;fact&gt;                   | factor for charcter size</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--xmean&#39;</span>,      <span class="ruby-comment">#                          | draw line plot of mean along x-axis on the right hand side of the tone/contour plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ymean&#39;</span>,      <span class="ruby-comment">#                          | draw line plot of mean along y-axis below the tone/contour plot.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--maskshading&#39;</span>,<span class="ruby-comment"># &lt;gturl,maskval,ipat&gt;     | draw a mask for values less than or equal to maskval (optional; defalult is 0)</span>
                   <span class="ruby-comment">#                          | with given gturl (optional; default is same as previously drawn GPhys)</span>
                   <span class="ruby-comment">#                          | by ipat pattern number (optional; defalult is 1515).</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nolabels&#39;</span>,   <span class="ruby-comment">#                          | do not draw labels.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--fill&#39;</span>,       <span class="ruby-comment">#                          | fill regions between plotted line and zero (or min or max) line. if histogram, fill the boxes.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--lwf&#39;</span>,        <span class="ruby-comment"># &lt;float&gt;                  | set line with factor for pdf drawing. defalut is 999, which looks like DISP drawing.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--axis_options&#39;</span>,<span class="ruby-comment"># &lt;var1=val1,var2=val2&gt;,..| set some axis options of USPACK (i.e., xoff/yoff, xfac/yfac, dxt/dyt, dxl,dyl)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--bothsides&#39;</span>,   <span class="ruby-comment">#                         | draw bothsides of the planet when itr = 30</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--xint&#39;</span>,  <span class="ruby-comment"># &lt;xlabelint[:division]&gt;        | set x-axis&#39; label-tickmark interval and number of number of division between two label-tickmarks</span>
              <span class="ruby-comment">#                               | e.g., --xint 10:5 draws label interval with 10 and sub-tickmark interval of 2 (=10/5).</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--yint&#39;</span>,  <span class="ruby-comment"># &lt;ylabelint[:division]&gt;        | same as --xint but for y-axis.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--panelfit&#39;</span>, <span class="ruby-comment"># [margin]                   | force the figure to fit into the panel. margin can be given by ratio [0-1].</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
<span class="ruby-comment">###</span>
<span class="ruby-comment">### analysis options ###</span>
<span class="ruby-comment">###</span>
  [<span class="ruby-string">&#39;--mean&#39;</span>,   <span class="ruby-comment"># &lt;dim&gt;                        | mean along axis &lt;dim&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--stddev&#39;</span>, <span class="ruby-comment"># &lt;dim&gt;                        | standard deviation along axis &lt;dim&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--eddy&#39;</span>,   <span class="ruby-comment"># &lt;dim&gt;                        | deviation from mean along axis &lt;dim&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--diff&#39;</span>,   <span class="ruby-comment">#                              | calculate 1st gturl - 2nd gturl</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--divide&#39;</span>, <span class="ruby-comment">#                              | calculate 1st gturl / 2nd gturl</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--add&#39;</span>,    <span class="ruby-comment">#                              | calculate the sum of multiple variables.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--operation&#39;</span>,  <span class="ruby-comment"># &lt;math_func&gt;              | operation of the specified math function on the data.</span>
                   <span class="ruby-comment">#                          | &lt;math_func&gt; should be a math function with one argument such as log10, sqrt, sin, etc.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--running_mean&#39;</span>,<span class="ruby-string">&#39;--rm&#39;</span>, <span class="ruby-comment"># &lt;dim&gt;:&lt;span&gt;[:&lt;skip&gt;][,&lt;dim&gt;:&lt;span&gt;[:&lt;skip&gt;]]</span>
                            <span class="ruby-comment">#                 | calculate the running mean along &lt;dim&gt; with a window of &lt;span&gt;.</span>
                            <span class="ruby-comment">#                 | multiple dims are not supported.</span>
                            <span class="ruby-comment">#                 | if integer &lt;skip&gt; is given, the date thinning is performed to the running mean.</span>
                            <span class="ruby-comment">#                 | for example, --rm t,12,12 to monthly data gives annual mean series (one value per year).</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--global_mean&#39;</span>,<span class="ruby-string">&#39;--gm&#39;</span>,  <span class="ruby-comment">#                 | calculate the global mean considering the weight along latitude.</span>
                            <span class="ruby-comment">#                 | dims of longitude and latitude must be the 1st and 2nd dims, respectivly.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ensemble_mean&#39;</span>,<span class="ruby-string">&#39;--em&#39;</span>, <span class="ruby-comment"># [num]          | calculate the ensemble mean.</span>
                             <span class="ruby-comment">#                | you must provide two or more gturls whose size and dimension are same.</span>
                             <span class="ruby-comment">#                | if &lt;num&gt; is given, ensemble mean will be calculated for each &lt;num&gt; gturls.</span>
                             <span class="ruby-comment">#                | if &quot;concat&quot; is given for &lt;num&gt;, provided gturls are concatenated along new dimension &quot;member&quot;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--normalize&#39;</span>,           <span class="ruby-comment"># [ |mean|float]  | normalize data by initial (when no arg.) or mean or given value when data is one-dimension.</span>
                            <span class="ruby-comment">#                 | normalization for other data is not implemented yet.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--lowpass&#39;</span>,<span class="ruby-string">&#39;--lp&#39;</span>,      <span class="ruby-comment"># &lt;dim&gt;,&lt;wn&gt;      | apply lowpass filter to &lt;dim&gt;-th dimension with wavenumber &lt;wn&gt; using fft.</span>
                            <span class="ruby-comment">#                 | i.e., this cut off the wavenumbers greater than &lt;wn&gt;.</span>
                            <span class="ruby-comment">#                 | &lt;dim&gt; must be integer. dimname is not supported yet.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--highpass&#39;</span>,<span class="ruby-string">&#39;--hp&#39;</span>,     <span class="ruby-comment"># &lt;dim&gt;,&lt;wn&gt;      | apply highpass filter to &lt;dim&gt;-th dimension with wavenumber &lt;wn&gt; using fft.</span>
                            <span class="ruby-comment">#                 | i.e., this cut off the wavenumbers less than &lt;wn&gt;.</span>
                            <span class="ruby-comment">#                 | &lt;dim&gt; must be integer 0, 1, 2, or 3. dimnames and dim &gt; 3 are not supported yet.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--power_spectra&#39;</span>,<span class="ruby-string">&#39;--ps&#39;</span>,<span class="ruby-comment"># &lt;dim&gt;[,any]     | calculate power spectra using fft along &lt;dim&gt;-th dimension.</span>
                            <span class="ruby-comment">#                 | by default, wavenumber is used for axis.</span>
                            <span class="ruby-comment">#                 | if any argument is given after comma, wavelength or period is used for axis.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--derivative&#39;</span>,          <span class="ruby-comment"># &lt;dim&gt;           | calculate the derivative alog axis &lt;dim&gt;. GPhys.threepoint_O2nd_deriv is used.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--srot&#39;</span>,                <span class="ruby-comment">#                 | calculate rotation on sphere with 1st gturl and 2nd gturl. radius can be set by --radius.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sdiv&#39;</span>,                <span class="ruby-comment">#                 | calculate divergence on sphere with 1st gturl and 2nd gturl. radius can be set by --radius.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sht&#39;</span>,                 <span class="ruby-comment">#                 | use spherical_harmonics_next module for srot, sdiv.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--HKE&#39;</span>,                 <span class="ruby-comment">#                 | calculate horizontal Kinetic energy with 1st gturl and 2nd gturl.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--integrate&#39;</span>, <span class="ruby-comment"># &lt;dims&gt;                    | calculate integration along &lt;dims&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sum&#39;</span>,       <span class="ruby-comment"># &lt;dims&gt;                    | calculate sum along &lt;dims&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--addingup&#39;</span>,  <span class="ruby-comment"># &lt;dim&gt;[,&lt;dim&gt;,...]         | adding up values along &lt;dim&gt;; i.e., val[i] =  val[0..i].sum</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--max&#39;</span>,       <span class="ruby-comment"># &lt;dims&gt;                    | max values along axis &lt;dims&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--min&#39;</span>,       <span class="ruby-comment"># &lt;dims&gt;                    | min values along axis &lt;dims&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ES&#39;</span>,        <span class="ruby-comment"># [total|rot|div][,vor_div_given]</span>
                  <span class="ruby-comment">#                           | calculate Horizontal Kinetic Energy Spectra from U given as 1st gturl</span>
                  <span class="ruby-comment">#                           | and V given as 2nd gturl. output total, rot, and/or div component.</span>
                  <span class="ruby-comment">#                           | if &quot;vor_div_given&quot; is given, 1st and 2nd gturls must be Vor and Div, respectivly,</span>
                  <span class="ruby-comment">#                           | and they will be used for calculation (faster).</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--wnf_analysis&#39;</span>,<span class="ruby-comment"># &lt;sym|asym|bg|sym/bg|asym/bg|log_sym/bg|log_asym/bg&gt;</span>
                    <span class="ruby-comment">#                         | calculate time-space spectra following Wheeler and Kiladis (1999)</span>
                    <span class="ruby-comment">#                         | name of component to be output has to be given.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--mvo&#39;</span>,  <span class="ruby-comment"># &lt;mathematical operation&gt;       | mathematical operation for multiple gturls. For mathematical operation,</span>
             <span class="ruby-comment">#                                | 1st gturl must be indicated by &quot;x&quot;, 2nd by &quot;y&quot;, 3rd by &quot;z&quot;, 4th by &quot;u&quot;,</span>
             <span class="ruby-comment">#                                | 5th by &quot;v&quot;, 6th by &quot;w&quot;. This cannot treat vars more than 6.</span>
             <span class="ruby-comment">#                                | Also, this cannot be used repeatedly.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--mvo_only&#39;</span>,   <span class="ruby-comment">#                          | use with &quot;--mvo&quot; to execute &quot;multi variable operation&quot; only.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],





<span class="ruby-comment">###</span>
<span class="ruby-comment">### data/constants arrange options ###</span>
<span class="ruby-comment">###</span>
  [<span class="ruby-string">&#39;--cut&#39;</span>,<span class="ruby-comment"># dimname=pos1[:pos2[:thinning_intv]][,dimname=...]: | apply cut, slice, and/or thinning after mathmatical operation.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--radius&#39;</span>,  <span class="ruby-comment"># &lt;raidus&gt;                    | set planetary radius.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--Omega&#39;</span>,   <span class="ruby-comment"># &lt;Omega&gt;                     | set planetary rotation rate [s-1].</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--rename&#39;</span>,  <span class="ruby-comment"># &lt;varname&gt;                   | rename the output variable name by &lt;varname&gt;. if --long_name is not used, &quot;long_name&quot; is also renamed.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--long_name&#39;</span>, <span class="ruby-comment"># &lt;long_name&gt;               | rename the output variable &quot;long_name&quot; by &lt;long_name&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--regrid&#39;</span>,  <span class="ruby-comment"># &lt;latgrid_num&gt;               | interpolate to the Gausian latitude and cooresponding longitude.</span>
                <span class="ruby-comment">#                             | number of lat-grid points is required and available numbers are</span>
                <span class="ruby-comment">#                             | 8, 16, 32, 64, 94, 96, 120, 128, 160, 240, 256, 320, 480, 640. gglat.rb required [TODO: 自前計算にする]</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--GLAT&#39;</span>,
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--read_csv&#39;</span>,  <span class="ruby-comment"># &lt;num&gt;                     | read csv file. the first column is used for the axis and the other columns are used for data values.</span>
                  <span class="ruby-comment">#                           | &lt;num&gt; specifies how many data columns you want to read.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--composite&#39;</span>,  <span class="ruby-comment"># &lt;dim&gt;,&lt;span&gt;,&lt;skip&gt;      | if &lt;skip&gt; is not given or zero, calculate mean with interval &lt;span&gt;.</span>
                   <span class="ruby-comment">#                          | i.e., --composite time,12 calculates mean of each month from monthly mean data.</span>
                   <span class="ruby-comment">#                          | if &lt;skip&gt; is given, calculate composite mean for dimension &lt;dim&gt;</span>
                   <span class="ruby-comment">#                          | with length &lt;span&gt; with interval of &lt;skip&gt;.</span>
                   <span class="ruby-comment">#                          | i.e., --composite time,3,9 calculates mean for time=0,1,2,12,13,14,24,...</span>
                   <span class="ruby-comment">#                          | this can be used to calculate seasonal mean such as DJF from mounthly mean data.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--split_axis&#39;</span>,<span class="ruby-comment"># &lt;dim&gt;,&lt;span&gt;,[newaxisname]| split the &lt;dim&gt; axis with &lt;span&gt;.</span>
                  <span class="ruby-comment">#                           | for example, --split_axis time,12 applied to monthly data splits the time axis</span>
                  <span class="ruby-comment">#                           | to year and month axis. name of the new axis can be given by [newnaxisname]</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--calendar360&#39;</span>,  <span class="ruby-comment">#                        | set the calendar type to &quot;360_day calendar&quot;. normally, this will be set automatically.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--calendar365&#39;</span>,  <span class="ruby-comment">#                        | set the calendar type to &quot;365_day calendar&quot;. normally, this will be set automatically.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--flip_data&#39;</span>,    <span class="ruby-comment"># &lt;dim[,dim,..]&gt;         | flip (turn over) the data and axis of &lt;dim&gt;th dimension. &lt;dim&gt; must by given by integer(s).</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--interpolate_pole&#39;</span>, <span class="ruby-comment">#                    | extend the latitude axis to have grid points on each pole (-90/+90 deg), and</span>
                         <span class="ruby-comment">#                    | interpolate the pole values by mean of values on surrounding grid points.</span>
                         <span class="ruby-comment">#                    | this assumes the data has lon and lat in its first and second dimension, respectivly.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--set_missing_value&#39;</span>,<span class="ruby-comment"># [float]            | replace the missing values to given value and validate then. default: 0.0.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ignoreunit&#39;</span>,       <span class="ruby-comment">#                    | ignore unit</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--set_assoc_coords&#39;</span>, <span class="ruby-comment"># &lt;gturl&gt;            | set &lt;gturl&gt; as an associate coordinate.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sig2p&#39;</span>, <span class="ruby-comment"># &lt;gturl of surface pressure&gt;   | transform sigma coordinate to pressure coordinate. gturl of surface pressure must be given.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--sig2z&#39;</span>, <span class="ruby-comment"># &lt;gturl of Temperature&gt;        | transform sigma coordinate to z (not log_p) coordinate. gturl of Temperature must be given.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--interpolate&#39;</span>, <span class="ruby-comment"># &lt;args&gt;                  |   interpolate after operations.</span>
                    <span class="ruby-comment">#                         | &lt;args&gt; can be axis_name=90 or axis_name=[0,90,180,270] or axis_name=0:360:4 for example.</span>
                    <span class="ruby-comment">#                         | 1) axis_name=90 style gives interpolation at the location and rank shrinks.</span>
                    <span class="ruby-comment">#                         | 2) axis_name=[0,90,180,270] style gives interpolation for multiple location and use then as an axis.</span>
                    <span class="ruby-comment">#                         | 3) axis_name=0:360:4 style similar to (2) but 0:360:4 means from 0 to 360 with separation of (360-0)/4.</span>
                    <span class="ruby-comment">#                         | multiple interpolation is not supported yet.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--extrapolation&#39;</span>,   <span class="ruby-comment">#                     | enable extrapolation, when using --interpolate option.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--unit&#39;</span>,        <span class="ruby-comment"># &lt;unit&gt;                  | set the operated variable&#39;s unit.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--invalidation&#39;</span>,<span class="ruby-comment"># &lt;num or range&gt;          | invalidate the given value or range.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--join&#39;</span>,        <span class="ruby-comment">#                         | join muliple gturls along with an axis whose values are continual across the gturls and are not duplicate.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--extend_backward_along&#39;</span>, <span class="ruby-comment"># &lt;dim&gt;,&lt;len&gt;[,&lt;value&gt;] | extend backward the object along &lt;dim&gt;-axis for &lt;len&gt; numbers with &lt;value&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--thinning&#39;</span>, <span class="ruby-comment"># &lt;num&gt;                      | data thinning by picking up data with &lt;num&gt; interval</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nothinning&#39;</span>, <span class="ruby-comment">#                          | prevent auto data thinning.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--read_fits&#39;</span>,  <span class="ruby-comment">#                          | read fits format image. automatically added if file extension is .fits. (RubyFits required)</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--offset&#39;</span>,     <span class="ruby-comment"># &lt;float&gt;                  | offset the data by &lt;float&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--cyclic_extension&#39;</span>,<span class="ruby-comment"># &lt;dim:num[,dim:num]&gt; | extend the data along &lt;dim&gt; with &lt;num&gt; number cyclically. e.g., --cyclic_extension x:4,y:4.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--axis_units_name&#39;</span>, <span class="ruby-comment"># &lt;axdim:unit[:axname:operation]&gt;[,axdim:unit:axname:operation]</span>
                        <span class="ruby-comment">#                     | change unit (and name) of axis. multiple axes can be given as</span>
                        <span class="ruby-comment">#                     | --axis_units_name ax0:deg:lon,ax2:km:height:/1000  for example.</span>
                        <span class="ruby-comment">#                     | mathematical operation can be applied to the axis values.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--replace_axis&#39;</span>,<span class="ruby-comment">#&lt;axN:val1,val2,val3,...&gt; | replace the value of the axis &lt;axN&gt; (N is 0, 1, 2,...) with given Array [val1, val2, val3, val4,...]</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--zonal_shift&#39;</span>, <span class="ruby-comment">#&lt;speed at equator in m/s&gt;| shift entire field zonally as it is advected by the solid body rotation of &lt;speed at equator in m/s&gt;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],







<span class="ruby-comment">###</span>
<span class="ruby-comment">### output options ###</span>
<span class="ruby-comment">###</span>
  [<span class="ruby-string">&#39;--nc&#39;</span>,    <span class="ruby-comment"># [outfilename]                 | output operated GPhys object as NetCDF file. output file name can be specified.</span>
              <span class="ruby-comment">#                               | Default name is &quot;out.nc&quot;.</span>
              <span class="ruby-comment">#                               | if used with &quot;--anim&quot;, GPhys object for last shown figure is outputtedd.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nc4&#39;</span>,   <span class="ruby-comment"># [outfilename]                 | output operated GPhys object as NetCDF ver 4 with compression.</span>
              <span class="ruby-comment">#                               | may take longer time to write out.</span>
              <span class="ruby-comment">#                               | output file name can be specified. Default name is &quot;out.nc&quot;.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--nc4a&#39;</span>,  <span class="ruby-comment"># [outfilename]                 | output operated gphys continually with along time dim.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--csv&#39;</span>,   <span class="ruby-comment"># [outfilename]                 | output operated GPhys object (1 dim only) as CSV file. output file name can be specified.</span>
              <span class="ruby-comment">#                               | Default name is &quot;out.csv&quot;.</span>
              <span class="ruby-comment">#                               | if used with &quot;--anim&quot;, GPhys object for last shown figure is outputtedd.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--produce&#39;</span>, <span class="ruby-comment"># &lt;something&gt;                 | produce &lt;something&gt;. &lt;something&gt; can be &quot;solar_zenith_angle&quot;</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--output_assoc_coords&#39;</span>,  <span class="ruby-comment">#                | use with --nc4 or --nc to output associate coordinate as netcdf file.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--gif&#39;</span>,   <span class="ruby-comment">#                               | output gif animation. this must be used with --anim and --file png options.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">NO_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--mp4&#39;</span>,   <span class="ruby-comment"># [number of frames per second] | output mp4 animation. frame rate can be given. this must be used with --anim and --file png options.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">OPTIONAL_ARGUMENT</span>],
  [<span class="ruby-string">&#39;--ntype&#39;</span>, <span class="ruby-comment"># &lt;type&gt;                        | convert type of values. &lt;type&gt; should be &quot;sfloat&quot;, &quot;float&quot;, etc.</span>
    <span class="ruby-constant">GetoptLong</span><span class="ruby-operator">::</span><span class="ruby-constant">REQUIRED_ARGUMENT</span>],

  <span class="ruby-comment">#                   [&#39;--dlon&#39;,                     GetoptLong::NO_ARGUMENT],</span>
  <span class="ruby-comment">#                   [&#39;--dlat&#39;,                     GetoptLong::NO_ARGUMENT],</span>
  <span class="ruby-comment">#                   [&#39;--version&#39;,                  GetoptLong::NO_ARGUMENT]  # to be defined</span>

                     )
  <span class="ruby-ivar">@USED_OPTIONS</span> = []
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">parser</span>.<span class="ruby-identifier">each_option</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;@OPT_#{name.sub(/^--/, &#39;&#39;).gsub(/-/, &#39;_&#39;)} = &#39;#{arg}&#39;&quot;</span>  <span class="ruby-comment"># strage option value to @OPT_val</span>
      <span class="ruby-ivar">@USED_OPTIONS</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;OPT_#{name.sub(/^--/, &#39;&#39;).gsub(/-/, &#39;_&#39;)}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-identifier">help</span>
    <span class="ruby-identifier">raise</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">prev_argv</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">prev_argv</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-__split_range" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">__split_range</span><span
            class="method-args">(range)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="__split_range-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 569</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">__split_range</span>(<span class="ruby-identifier">range</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-regexp">/(.*):(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">range</span>
    <span class="ruby-keyword">if</span> <span class="ruby-node">$1</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>
      <span class="ruby-identifier">min</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">min</span> = <span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-node">$2</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>
      <span class="ruby-identifier">max</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">max</span> = <span class="ruby-node">$2</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">range</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">min</span> = <span class="ruby-identifier">max</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;invalid range: variable subset specification error. split range with &#39;:&#39;\n\n&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">min</span>, <span class="ruby-identifier">max</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-addingup" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">addingup</span><span
            class="method-args">(gp, dim)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Adding up along the given dimension.</p>
          
          

          
          <div class="method-source-code" id="addingup-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 170</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">addingup</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">gpaxes</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dim</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">d</span> = <span class="ruby-keyword">nil</span>; <span class="ruby-identifier">gpaxes</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">d</span> = <span class="ruby-identifier">i</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gpaxes</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">dim</span>}; <span class="ruby-identifier">dimname</span> = <span class="ruby-identifier">dim</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Error::dimension of #{dim} for addingup was not found.&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">else</span> <span class="ruby-identifier">d</span> = <span class="ruby-identifier">dim</span>; <span class="ruby-identifier">dimname</span> = <span class="ruby-identifier">gpaxes</span>[<span class="ruby-identifier">d</span>] <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">newdata</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span>
  <span class="ruby-identifier">len</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-identifier">d</span>]
  <span class="ruby-identifier">gpval</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">gpval</span>.<span class="ruby-identifier">sum</span>(<span class="ruby-identifier">d</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.0</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gpval</span>[<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>];  <span class="ruby-identifier">newdata</span>[<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sum</span> }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gpval</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>];  <span class="ruby-identifier">newdata</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sum</span> }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gpval</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>];  <span class="ruby-identifier">newdata</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sum</span> }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gpval</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>];  <span class="ruby-identifier">newdata</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sum</span> }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gpval</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>];  <span class="ruby-identifier">newdata</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sum</span> }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">d</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sum</span> = <span class="ruby-identifier">sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gpval</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>];  <span class="ruby-identifier">newdata</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sum</span> }
  <span class="ruby-keyword">else</span> <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;rank greater than 6 is not supported&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">varray</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">newdata</span>,<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; addingup along &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">dimname</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">grid</span>, <span class="ruby-identifier">varray</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-auto_write" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">auto_write</span><span
            class="method-args">(outfilename, gary, index, compress=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="auto_write-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 330</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">auto_write</span>(<span class="ruby-identifier">outfilename</span>, <span class="ruby-identifier">gary</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">compress</span>=<span class="ruby-keyword">false</span>) <span class="ruby-comment"># 出力ファイル名, Array of GPhys, 時刻のindex, 圧縮の可否</span>
  <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">creation_format</span>=(<span class="ruby-constant">NetCDF</span><span class="ruby-operator">::</span><span class="ruby-constant">NC_NETCDF4</span> <span class="ruby-operator">|</span> <span class="ruby-constant">NetCDF</span><span class="ruby-operator">::</span><span class="ruby-constant">NC_CLASSIC_MODEL</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">compress</span>

  <span class="ruby-identifier">gary</span> = [<span class="ruby-identifier">gary</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>
  <span class="ruby-identifier">udname</span> = <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axnames</span>[<span class="ruby-value">-1</span>] <span class="ruby-comment"># UNLIMITED次元の名前</span>
  <span class="ruby-identifier">udval</span> = <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">udname</span>).<span class="ruby-identifier">val</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">index</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 初期設定</span>
    <span class="ruby-identifier">outncfile</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">outfilename</span>)
    <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">a</span> = <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">n</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">n</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">udname</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">def_dim</span>(<span class="ruby-identifier">n</span>, <span class="ruby-value">0</span>) <span class="ruby-comment"># 次元定義 [UNLIMITED次元]</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">def_dim</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">length</span>) <span class="ruby-comment"># 次元定義</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">def_var</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">ntype</span>, [<span class="ruby-identifier">n</span>]) <span class="ruby-comment"># 次元変数定義</span>
      <span class="ruby-identifier">a</span>.<span class="ruby-identifier">att_names</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">n</span>).<span class="ruby-identifier">put_att</span>(<span class="ruby-identifier">m</span>, <span class="ruby-identifier">a</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-identifier">m</span>), <span class="ruby-keyword">nil</span>) } <span class="ruby-comment"># 次元変数属性の設定</span>
    }
    <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">def_var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">g</span>.<span class="ruby-identifier">ntype</span>, <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axnames</span>) <span class="ruby-comment"># 変数定義</span>
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">deflate</span>(<span class="ruby-value">1</span>, <span class="ruby-keyword">true</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">compress</span> <span class="ruby-comment"># set commpression level and shuffle.</span>
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">att_names</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put_att</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-identifier">n</span>), <span class="ruby-keyword">nil</span>) } <span class="ruby-comment"># 変数属性の設定</span>
    }

    <span class="ruby-comment"># set global atts if used in gpv.rb</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@sources</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@sources</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sources</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;.nc&quot;</span>)) <span class="ruby-keyword">then</span> <span class="ruby-comment"># copy the global atts of the source file.</span>
        <span class="ruby-identifier">old_nc</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">open</span>(<span class="ruby-ivar">@sources</span>[<span class="ruby-value">0</span>], <span class="ruby-string">&quot;r&quot;</span>)
        <span class="ruby-identifier">old_nc</span>.<span class="ruby-identifier">each_att</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">at</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-identifier">at</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">at</span>.<span class="ruby-identifier">get</span>) }
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;sources&quot;</span>, <span class="ruby-ivar">@sources</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>))
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;command&quot;</span>, <span class="ruby-ivar">@commandline</span> )
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;working_directory&quot;</span>, <span class="ruby-ivar">@current_dir</span> )
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;process_date&quot;</span>, <span class="ruby-node">&quot;#{Time.now}&quot;</span> )
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">enddef</span> <span class="ruby-comment"># 定義モード終了</span>
    <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axnames</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">n</span>).<span class="ruby-identifier">put</span>(<span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">n</span>).<span class="ruby-identifier">val</span>) <span class="ruby-comment"># 次元変数の値代入</span>
    }
    <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">close</span> <span class="ruby-comment"># 一旦閉じる</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">outncfile</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">outfilename</span>, <span class="ruby-string">&quot;a&quot;</span>) <span class="ruby-comment"># 追記モードで開く</span>
  <span class="ruby-identifier">st</span> = <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">dim</span>(<span class="ruby-identifier">udname</span>).<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">et</span> = <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">dim</span>(<span class="ruby-identifier">udname</span>).<span class="ruby-identifier">length</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">udval</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>)
  <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">udname</span>).<span class="ruby-identifier">put</span>(<span class="ruby-identifier">udval</span>,  <span class="ruby-string">&quot;start&quot;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">st</span>], <span class="ruby-string">&quot;end&quot;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">et</span>]) <span class="ruby-comment"># UNLIMITED次元の値代入</span>

  <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">sta</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">rank</span><span class="ruby-value">-1</span>,<span class="ruby-value">0</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">st</span>
    <span class="ruby-identifier">eta</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">rank</span><span class="ruby-value">-1</span>,<span class="ruby-value">-1</span>) <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">et</span>
    <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>, <span class="ruby-string">&quot;start&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">sta</span>,<span class="ruby-string">&quot;end&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">eta</span>) <span class="ruby-comment"># 変数の値代入</span>
  }
  <span class="ruby-identifier">outncfile</span>.<span class="ruby-identifier">close</span> <span class="ruby-comment"># 処理の途中でも、別プロセスで可視化できるように毎回閉じる。</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-check_dclopts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">check_dclopts</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="check_dclopts-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1909</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_dclopts</span>
  <span class="ruby-identifier">indices</span> = []
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">each_index</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-regexp">/^-(.)(.):(.*)=(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-identifier">i</span>]
      <span class="ruby-identifier">indices</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">i</span>
    <span class="ruby-keyword">end</span>
    }

  <span class="ruby-identifier">dclopts</span> = []
    <span class="ruby-identifier">indices</span>.<span class="ruby-identifier">reverse_each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">dclopts</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-identifier">i</span>]
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">slice!</span>(<span class="ruby-identifier">i</span>)
    }

  <span class="ruby-identifier">dclopts</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">opt</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">pkg</span> = <span class="ruby-identifier">opt</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>]
    <span class="ruby-identifier">name</span> = <span class="ruby-identifier">opt</span>[<span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;=&#39;</span>)[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">value</span> = <span class="ruby-identifier">opt</span>[<span class="ruby-value">4</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;=&#39;</span>)[<span class="ruby-value">1</span>]
    <span class="ruby-identifier">dcl_set_params</span>(<span class="ruby-identifier">pkg</span>,<span class="ruby-identifier">name</span>,<span class="ruby-identifier">value</span>)
  }

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-common_blocks" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">common_blocks</span><span
            class="method-args">(str_ary)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="common_blocks-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 198</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">common_blocks</span>(<span class="ruby-identifier">str_ary</span>)
  <span class="ruby-identifier">spstr_ary</span> = <span class="ruby-identifier">str_ary</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;_&quot;</span>)}
  <span class="ruby-identifier">length_ary</span> = <span class="ruby-identifier">spstr_ary</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">length</span>}
  <span class="ruby-identifier">lmin</span> = <span class="ruby-identifier">length_ary</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">com_block</span> = []
  <span class="ruby-identifier">lmin</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">com_block</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">i</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">spstr_ary</span>.<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>[<span class="ruby-identifier">i</span>]<span class="ruby-operator">==</span><span class="ruby-identifier">spstr_ary</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">i</span>]}
  }
  <span class="ruby-identifier">com_block</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">spstr_ary</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">i</span>]}
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">com_block</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-common_chars" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">common_chars</span><span
            class="method-args">(str_ary)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="common_chars-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">common_chars</span>(<span class="ruby-identifier">str_ary</span>)
  <span class="ruby-identifier">flag_scom</span> = <span class="ruby-keyword">true</span>; <span class="ruby-identifier">flag_ecom</span> = <span class="ruby-keyword">true</span>; <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>; <span class="ruby-identifier">j</span> = <span class="ruby-value">-1</span>
  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">flag_scom</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">flag_ecom</span>)
    <span class="ruby-identifier">flag_scom</span> = <span class="ruby-identifier">str_ary</span>.<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>[<span class="ruby-identifier">i</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">str_ary</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">i</span>]}
    <span class="ruby-identifier">i</span> = <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">flag_scom</span>
    <span class="ruby-identifier">flag_ecom</span> = <span class="ruby-identifier">str_ary</span>.<span class="ruby-identifier">all?</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>[<span class="ruby-identifier">j</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">str_ary</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">j</span>]}
    <span class="ruby-identifier">j</span> = <span class="ruby-identifier">j</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">flag_ecom</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">scom</span> = (<span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">str_ary</span>[<span class="ruby-value">0</span>][<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)]
  <span class="ruby-identifier">ecom</span> = (<span class="ruby-identifier">j</span> <span class="ruby-operator">==</span><span class="ruby-value">-1</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">str_ary</span>[<span class="ruby-value">0</span>][(<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">scom</span>, <span class="ruby-identifier">ecom</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-composite" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">composite</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Composite mean.</p>
          
          

          
          <div class="method-source-code" id="composite-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 40</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">composite</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">comp_dim</span>, <span class="ruby-identifier">comp_span</span>, <span class="ruby-identifier">comp_skip</span> = (<span class="ruby-ivar">@OPT_composite</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">comp_dim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span>  <span class="ruby-operator">==</span> <span class="ruby-identifier">comp_dim</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">comp_dim</span> = <span class="ruby-identifier">comp_dim</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">comp_span</span> = <span class="ruby-identifier">comp_span</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">comp_skip</span> = <span class="ruby-identifier">comp_skip</span>.<span class="ruby-identifier">to_i</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">comp_skip</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>)
    <span class="ruby-identifier">tmp</span> = <span class="ruby-value">0.0</span>
    (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">comp_dim</span>).<span class="ruby-identifier">length</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">comp_span</span><span class="ruby-operator">+</span><span class="ruby-identifier">comp_skip</span>)).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">sp</span> = <span class="ruby-identifier">i</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">comp_span</span><span class="ruby-operator">+</span><span class="ruby-identifier">comp_skip</span>)
      <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">tmp</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>[{<span class="ruby-identifier">comp_dim</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">sp</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">sp</span><span class="ruby-operator">+</span><span class="ruby-identifier">comp_span</span><span class="ruby-value">-1</span>)}].<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">comp_dim</span>)
    }
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">tmp</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">tmp</span> = <span class="ruby-value">0.0</span>
    (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">comp_dim</span>).<span class="ruby-identifier">length</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">comp_span</span>)).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">sp</span> = <span class="ruby-identifier">i</span><span class="ruby-operator">*</span><span class="ruby-identifier">comp_span</span>
      <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">tmp</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>[{<span class="ruby-identifier">comp_dim</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">sp</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">sp</span><span class="ruby-operator">+</span><span class="ruby-identifier">comp_span</span><span class="ruby-value">-1</span>)}]
    }
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">comp_dim</span>).<span class="ruby-identifier">length</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">comp_span</span>)
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">tmp</span> <span class="ruby-operator">/</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">comp_dim</span>).<span class="ruby-identifier">length</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">comp_span</span>))
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-corelation" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">corelation</span><span
            class="method-args">(gphys0, gphys1, *dims)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="corelation-source">
            <pre><span class="ruby-comment"># File gpv_gphysmod.rb, line 190</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">corelation</span>(<span class="ruby-identifier">gphys0</span>, <span class="ruby-identifier">gphys1</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
  <span class="ruby-identifier">val0</span> = <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">val1</span> = <span class="ruby-identifier">gphys1</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
    <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">get_mask</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">byte</span>(<span class="ruby-operator">*</span>(<span class="ruby-identifier">val0</span>.<span class="ruby-identifier">shape</span>)).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">1</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
    <span class="ruby-identifier">mask2</span> = <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">get_mask</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">mask2</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">byte</span>(<span class="ruby-operator">*</span>(<span class="ruby-identifier">val1</span>.<span class="ruby-identifier">shape</span>)).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">1</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">mask</span>.<span class="ruby-identifier">mul!</span>(<span class="ruby-identifier">mask2</span>)
  <span class="ruby-identifier">val0</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">val0</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
  <span class="ruby-identifier">val1</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">val1</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
  <span class="ruby-identifier">val0</span> = <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">set_mask</span>(<span class="ruby-identifier">mask</span>)
  <span class="ruby-identifier">val1</span> = <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">set_mask</span>(<span class="ruby-identifier">mask2</span>)
  <span class="ruby-identifier">p</span> <span class="ruby-identifier">val0</span>,<span class="ruby-identifier">val1</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@DEBUG</span>
  <span class="ruby-identifier">gphys0</span> = <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">copy</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">val0</span>)
  <span class="ruby-identifier">gphys1</span> = <span class="ruby-identifier">gphys1</span>.<span class="ruby-identifier">copy</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">val1</span>)

  <span class="ruby-identifier">covar</span>, <span class="ruby-identifier">ndiv</span> = <span class="ruby-identifier">covariance</span>(<span class="ruby-identifier">gphys0</span>, <span class="ruby-identifier">gphys1</span>,<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
<span class="ruby-comment">#  return covar/(gphys0.stddev(*dims)*gphys1.stddev(*dims)), mask.to_type(NArray::LINT).sum(*dims)</span>
  <span class="ruby-identifier">cor</span> = <span class="ruby-identifier">covar</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">stddev</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">gphys1</span>.<span class="ruby-identifier">stddev</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>))
  <span class="ruby-identifier">cor</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;correlation&quot;</span>)
  <span class="ruby-identifier">cor</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-node">&quot;R(#{gphys0.name},#{gphys1.name}) along &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>])
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">cor</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-counter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">counter</span><span
            class="method-args">(string1, init=0.0, delta=1.0, string2=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="counter-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 101</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">counter</span>(<span class="ruby-identifier">string1</span>, <span class="ruby-identifier">init</span>=<span class="ruby-value">0.0</span>, <span class="ruby-identifier">delta</span>=<span class="ruby-value">1.0</span>, <span class="ruby-identifier">string2</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-ivar">@counter</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@counter</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">now</span> = <span class="ruby-identifier">init</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">delta</span><span class="ruby-operator">*</span><span class="ruby-ivar">@counter</span>
  <span class="ruby-identifier">string</span> = <span class="ruby-identifier">string1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sprintf</span>(<span class="ruby-string">&quot;%2.2f&quot;</span>,<span class="ruby-identifier">now</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">string2</span>

  <span class="ruby-comment"># for time day and hour</span>
    <span class="ruby-comment"># binding.pry</span>
    <span class="ruby-identifier">day</span> = (<span class="ruby-identifier">now</span><span class="ruby-operator">/</span><span class="ruby-value">24</span>).<span class="ruby-identifier">floor</span>; <span class="ruby-identifier">hour</span> = <span class="ruby-identifier">now</span><span class="ruby-operator">%</span><span class="ruby-value">24</span>
    <span class="ruby-identifier">string</span> = <span class="ruby-identifier">string1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sprintf</span>(<span class="ruby-string">&quot;%2.0f&quot;</span>,<span class="ruby-identifier">day</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; Eday &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sprintf</span>(<span class="ruby-string">&quot;%2.0f&quot;</span>,<span class="ruby-identifier">hour</span>).<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; h&quot;</span>



  <span class="ruby-identifier">title</span>(<span class="ruby-identifier">string</span>, <span class="ruby-value">0.5</span>)
  <span class="ruby-ivar">@counter</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-covariance" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">covariance</span><span
            class="method-args">(gphys0, gphys1, *dims)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>File ../../lib/numru/ganalysis/covariance.rb, line 8</p>
          
          

          
          <div class="method-source-code" id="covariance-source">
            <pre><span class="ruby-comment"># File gpv_gphysmod.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">covariance</span>(<span class="ruby-identifier">gphys0</span>, <span class="ruby-identifier">gphys1</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
  <span class="ruby-keyword">unless</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">===</span><span class="ruby-identifier">gphys0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">===</span><span class="ruby-identifier">gphys1</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;gphys0 and gphys1 must be GPhys&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">shape</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gphys1</span>.<span class="ruby-identifier">shape</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;gphys0 and gphys1 must have the same shape&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">units</span> = <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">units</span><span class="ruby-operator">*</span><span class="ruby-identifier">gphys1</span>.<span class="ruby-identifier">units</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">dims</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">dims</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">rank</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dims</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">i</span> }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">dims</span> = <span class="ruby-identifier">dims</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">dim_index</span>(<span class="ruby-identifier">dim</span>) }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">val0</span> = <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">val1</span> = <span class="ruby-identifier">gphys1</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
      <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">get_mask</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">get_mask</span>
      <span class="ruby-identifier">ndiv</span> = <span class="ruby-identifier">mask</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-constant">NArray</span><span class="ruby-operator">::</span><span class="ruby-constant">LINT</span>).<span class="ruby-identifier">accum</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
      <span class="ruby-identifier">val0</span> = <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">set_mask</span>(<span class="ruby-identifier">mask</span>)
      <span class="ruby-identifier">val1</span> = <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">set_mask</span>(<span class="ruby-identifier">mask</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">ndiv</span> = <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-constant">NArray</span><span class="ruby-operator">::</span><span class="ruby-constant">LINT</span>).<span class="ruby-identifier">accum</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
      <span class="ruby-identifier">val1</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">val1</span>,<span class="ruby-identifier">val0</span>.<span class="ruby-identifier">get_mask</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArrayMiss</span>)
    <span class="ruby-identifier">ndiv</span> = <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-constant">NArray</span><span class="ruby-operator">::</span><span class="ruby-constant">LINT</span>).<span class="ruby-identifier">accum</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
    <span class="ruby-identifier">val0</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">val0</span>,<span class="ruby-identifier">val1</span>.<span class="ruby-identifier">get_mask</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">ndiv</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">each_with_index</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">ndiv</span> <span class="ruby-operator">*=</span> <span class="ruby-identifier">s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">dims</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>)
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">val0</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">accum</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>).<span class="ruby-identifier">div!</span>(<span class="ruby-identifier">ndiv</span>)
  <span class="ruby-identifier">val1</span> <span class="ruby-operator">-=</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">accum</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>).<span class="ruby-identifier">div!</span>(<span class="ruby-identifier">ndiv</span>)
  <span class="ruby-identifier">nary</span> = <span class="ruby-identifier">val0</span>.<span class="ruby-identifier">mul_add</span>(<span class="ruby-identifier">val1</span>,<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-constant">Float</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">nary</span>
    <span class="ruby-identifier">ndiv</span> = <span class="ruby-identifier">ndiv</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">ndiv</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">NArray</span>)
    <span class="ruby-identifier">nary</span> <span class="ruby-operator">/=</span> (<span class="ruby-identifier">ndiv</span><span class="ruby-value">-1</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nary</span>, <span class="ruby-identifier">units</span>), <span class="ruby-identifier">ndiv</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">nary</span> = <span class="ruby-identifier">nary</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">ndiv</span>.<span class="ruby-identifier">sum</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims</span>)<span class="ruby-value">-1</span>)
    <span class="ruby-identifier">vary</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nary</span>,
                      {<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;covariance&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>},
                      <span class="ruby-string">&quot;covariance&quot;</span>)
    <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">gphys0</span>.<span class="ruby-identifier">grid</span>.<span class="ruby-identifier">delete_axes</span>(<span class="ruby-identifier">dims</span>, <span class="ruby-string">&quot;covariance&quot;</span>).<span class="ruby-identifier">copy</span>
    <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>,<span class="ruby-identifier">vary</span>), <span class="ruby-identifier">ndiv</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-csv2gphys" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">csv2gphys</span><span
            class="method-args">(gturl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO: 複数ファイル・変数への対応</p>
          
          

          
          <div class="method-source-code" id="csv2gphys-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 236</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csv2gphys</span>(<span class="ruby-identifier">gturl</span>)
  <span class="ruby-identifier">csvfile</span>, <span class="ruby-identifier">vcol</span> = <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)
  <span class="ruby-identifier">array</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">csvfile</span>) <span class="ruby-comment"># csvの読み込み</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 開く列を数字で指定している場合。</span>
    <span class="ruby-comment">#ヘッダーの有無を調べ、ある場合は変数名等に使う。ヘッダーは1行目の場合のみ対応。</span>
    <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">float_string?</span>(<span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-value">0</span>])) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 数値の文字列じゃない場合はヘッダーだと判断</span>
      <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-value">0</span>]; <span class="ruby-identifier">varname</span> = <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_i</span>]; <span class="ruby-identifier">longname</span> = <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_i</span>]
      <span class="ruby-identifier">array</span> = <span class="ruby-identifier">array</span>.<span class="ruby-identifier">drop</span>(<span class="ruby-value">1</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">axname</span> = <span class="ruby-string">&quot;x&quot;</span>; <span class="ruby-identifier">varname</span> = <span class="ruby-string">&quot;v&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_s</span>; <span class="ruby-identifier">longname</span> =<span class="ruby-string">&quot;value&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># 開く列を変数名で指定している場合は、必ずヘッダーがあるはず。</span>
    <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">i</span>].<span class="ruby-identifier">strip</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">vcol</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">vcol</span> = <span class="ruby-identifier">i</span>; <span class="ruby-keyword">break</span>; <span class="ruby-keyword">end</span>
    }
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Including var names are #{array[0][1..-1].join(&quot;, &quot;)}. You can also use natural numbers to specify the column number.&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-value">0</span>]; <span class="ruby-identifier">varname</span> = <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">vcol</span>]; <span class="ruby-identifier">longname</span> = <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">vcol</span>]
    <span class="ruby-identifier">array</span> = <span class="ruby-identifier">array</span>.<span class="ruby-identifier">drop</span>(<span class="ruby-value">1</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">array</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-identifier">j</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">to_f</span>}} <span class="ruby-comment"># 要素の数値化</span>
  <span class="ruby-identifier">narray</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">array</span>).<span class="ruby-identifier">transpose</span>(<span class="ruby-value">1</span>,<span class="ruby-value">0</span>) <span class="ruby-comment"># NArray化</span>
  <span class="ruby-identifier">xaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">xaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">narray</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>],<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">axname</span>)
  <span class="ruby-identifier">grid</span> = <span class="ruby-constant">Grid</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">xaxis</span>)
  <span class="ruby-identifier">varray</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">narray</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">vcol</span>.<span class="ruby-identifier">to_i</span>],{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">longname</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>},<span class="ruby-identifier">varname</span>)
  <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>,<span class="ruby-identifier">varray</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cut_slice_thinning" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cut_slice_thinning</span><span
            class="method-args">(gp, var)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="cut_slice_thinning-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 222</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cut_slice_thinning</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">var</span>)
  <span class="ruby-identifier">slice</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">cut_slice</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">thinning</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">var_descr</span> = <span class="ruby-identifier">var</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/,/</span>)
  <span class="ruby-identifier">var_descr</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-regexp">/(.*)=(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">s</span>
      <span class="ruby-identifier">dimname</span> = <span class="ruby-node">$1</span>
      <span class="ruby-identifier">subset</span> = <span class="ruby-node">$2</span>
      <span class="ruby-identifier">subset</span> = <span class="ruby-identifier">ymd2date</span>(<span class="ruby-identifier">subset</span>)      <span class="ruby-comment"># convert y????m??d?? expression to Date.parser</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">subset</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\^(.*):(.*):(.*)/</span>
        <span class="ruby-identifier">slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
        <span class="ruby-identifier">thinning</span>[<span class="ruby-identifier">dimname</span>] = {(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>) <span class="ruby-operator">=&gt;</span> <span class="ruby-node">$3</span>.<span class="ruby-identifier">to_i</span>}
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\^(.*):(.*)/</span>
        <span class="ruby-identifier">slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\^(.*)/</span>
        <span class="ruby-identifier">slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/(.*):(.*):(.*)/</span>
        <span class="ruby-identifier">cut_slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
        <span class="ruby-identifier">thinning</span>[<span class="ruby-identifier">dimname</span>] = {(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>) <span class="ruby-operator">=&gt;</span> <span class="ruby-node">$3</span>.<span class="ruby-identifier">to_i</span>}
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/(.*):(.*)/</span>
        <span class="ruby-identifier">cut_slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">cut_slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">subset</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;invalid URL: variable subset specification error\n\n&quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;URL format: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GTURLfmt</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">slice</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">slice</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">cut_slice</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cut_slice</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">thinning</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">thinning</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>

    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-identifier">slice</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">slice</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">cut_slice</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">cut_slice</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-identifier">thinning</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">thinning</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-cyclic_extension" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cyclic_extension</span><span
            class="method-args">(gp,dim,n=1)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Extend the data cyclically.</p>
          
          

          
          <div class="method-source-code" id="cyclic_extension-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 151</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">cyclic_extension</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">dim</span>,<span class="ruby-identifier">n</span>=<span class="ruby-value">1</span>)
  <span class="ruby-identifier">dim</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">dim</span>.<span class="ruby-identifier">to_i</span>]  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">dim</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">dim</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Fixnum</span>)
  <span class="ruby-identifier">ndim</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">index</span>(<span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">gaxis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">dx</span> = (<span class="ruby-identifier">gaxis</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">gaxis</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>]).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">mean</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">n</span><span class="ruby-operator">==</span><span class="ruby-value">1</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 長さ 1 のVArray/GPhysは仕様が複雑なので、以下のように回避する</span>
    <span class="ruby-identifier">gal</span> = <span class="ruby-identifier">gaxis</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">1</span>]; <span class="ruby-identifier">gar</span> = <span class="ruby-identifier">gaxis</span>[<span class="ruby-value">-2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
    <span class="ruby-identifier">sl</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-keyword">true</span>); <span class="ruby-identifier">sl</span>[<span class="ruby-identifier">ndim</span>]=(<span class="ruby-value">-2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>)
    <span class="ruby-identifier">sr</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-keyword">true</span>); <span class="ruby-identifier">sr</span>[<span class="ruby-identifier">ndim</span>]=(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">1</span>)
    <span class="ruby-identifier">sc</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-keyword">true</span>); <span class="ruby-identifier">sc</span>[<span class="ruby-identifier">ndim</span>]=(<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>)
    <span class="ruby-identifier">gple</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">sl</span>];  <span class="ruby-identifier">gpre</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">sr</span>]
    <span class="ruby-identifier">gple</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ndim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">gal</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">dx</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)
    <span class="ruby-identifier">gpre</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ndim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">gar</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dx</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>([<span class="ruby-identifier">gple</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">gpre</span>])[<span class="ruby-operator">*</span><span class="ruby-identifier">sc</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">gal</span> = <span class="ruby-identifier">gaxis</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>)]; <span class="ruby-identifier">gar</span> = <span class="ruby-identifier">gaxis</span>[<span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
    <span class="ruby-identifier">sl</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-keyword">true</span>); <span class="ruby-identifier">sl</span>[<span class="ruby-identifier">ndim</span>]=(<span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>)
    <span class="ruby-identifier">sr</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-keyword">true</span>); <span class="ruby-identifier">sr</span>[<span class="ruby-identifier">ndim</span>]=(<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>))
    <span class="ruby-identifier">gple</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">sl</span>];  <span class="ruby-identifier">gpre</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">sr</span>]
    <span class="ruby-identifier">gple</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ndim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">gal</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">dx</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
    <span class="ruby-identifier">gpre</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ndim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">gar</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dx</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>([<span class="ruby-identifier">gple</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">gpre</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-data_thinning" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">data_thinning</span><span
            class="method-args">(gp, num)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Thinning the data</p>
          
          

          
          <div class="method-source-code" id="data_thinning-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 177</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">data_thinning</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">num</span>)
  <span class="ruby-identifier">att</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">attr_copy</span> <span class="ruby-comment"># copy attributes</span>
  <span class="ruby-identifier">step</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">max</span><span class="ruby-operator">/</span><span class="ruby-identifier">num</span>
  <span class="ruby-identifier">shape</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>; <span class="ruby-identifier">index</span> = []
  <span class="ruby-identifier">shape</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shape</span>[<span class="ruby-identifier">i</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">step</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">index</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-identifier">i</span>]<span class="ruby-operator">/</span><span class="ruby-identifier">step</span>).<span class="ruby-identifier">indgen!</span><span class="ruby-operator">*</span><span class="ruby-identifier">step</span>).<span class="ruby-identifier">to_a</span>
    <span class="ruby-keyword">else</span> <span class="ruby-identifier">index</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">index</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>]]; <span class="ruby-identifier">grid</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">grid</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>]]
  <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span>]]; <span class="ruby-identifier">grid</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">grid</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span>]]
  <span class="ruby-keyword">when</span> <span class="ruby-value">3</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">2</span>]]; <span class="ruby-identifier">grid</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">grid</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">2</span>]]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">2</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">3</span>],<span class="ruby-keyword">false</span>]
    <span class="ruby-identifier">grid</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">grid</span>[<span class="ruby-identifier">index</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">2</span>],<span class="ruby-identifier">index</span>[<span class="ruby-value">3</span>],<span class="ruby-keyword">false</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;NOTE: Input data is thinned to #{grid.shape} (from #{gp.shape}).\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;      Use --nothinning to prevent data thinning.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>, <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">val</span>, <span class="ruby-identifier">att</span>, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-date_diff" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">date_diff</span><span
            class="method-args">(date1, date2, unit=&quot;day&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="date_diff-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 145</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">date_diff</span>(<span class="ruby-identifier">date1</span>, <span class="ruby-identifier">date2</span>, <span class="ruby-identifier">unit</span>=<span class="ruby-string">&quot;day&quot;</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_calendar360</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">day1</span> = (<span class="ruby-identifier">date1</span>.<span class="ruby-identifier">year</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-value">360.0</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">date1</span>.<span class="ruby-identifier">month</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-value">30.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">date1</span>.<span class="ruby-identifier">day</span>
    <span class="ruby-identifier">day2</span> = (<span class="ruby-identifier">date2</span>.<span class="ruby-identifier">year</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-value">360.0</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">date2</span>.<span class="ruby-identifier">month</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-value">30.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">date2</span>.<span class="ruby-identifier">day</span>
    <span class="ruby-identifier">diff</span> = <span class="ruby-identifier">day1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">day2</span> <span class="ruby-comment"># diff in days</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_calendar365</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">day1</span> = (<span class="ruby-identifier">date1</span>.<span class="ruby-identifier">year</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-value">365.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">date1</span>.<span class="ruby-identifier">yday</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-identifier">day2</span> = (<span class="ruby-identifier">date2</span>.<span class="ruby-identifier">year</span><span class="ruby-value">-1</span>)<span class="ruby-operator">*</span><span class="ruby-value">365.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">date2</span>.<span class="ruby-identifier">yday</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-identifier">day1</span> = <span class="ruby-identifier">day1</span> <span class="ruby-operator">-</span> <span class="ruby-value">1.0</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">date1</span>.<span class="ruby-identifier">leap?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date1</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>) <span class="ruby-comment">#閏年で3月以降なら2月29日分を除く</span>
    <span class="ruby-identifier">day2</span> = <span class="ruby-identifier">day2</span> <span class="ruby-operator">-</span> <span class="ruby-value">1.0</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">date2</span>.<span class="ruby-identifier">leap?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">date2</span>.<span class="ruby-identifier">month</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>)
    <span class="ruby-identifier">diff</span> = <span class="ruby-identifier">day1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">day2</span> <span class="ruby-comment"># diff in days</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">diff</span> = (<span class="ruby-identifier">date1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">date2</span>).<span class="ruby-identifier">to_f</span> <span class="ruby-comment"># diff in days</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">unit</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;day&quot;</span>,<span class="ruby-string">&quot;days&quot;</span>,<span class="ruby-string">&quot;d&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">diff</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;month&quot;</span>,<span class="ruby-string">&quot;months&quot;</span>,<span class="ruby-string">&quot;m&quot;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;not supported yet&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;year&quot;</span>,<span class="ruby-string">&quot;years&quot;</span>,<span class="ruby-string">&quot;y&quot;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;not supported yet&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;hour&quot;</span>,<span class="ruby-string">&quot;hours&quot;</span>,<span class="ruby-string">&quot;h&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">diff</span><span class="ruby-operator">*</span><span class="ruby-value">24.0</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;min&quot;</span>,<span class="ruby-string">&quot;minit&quot;</span>,<span class="ruby-string">&quot;minits&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">diff</span><span class="ruby-operator">*</span><span class="ruby-value">24</span><span class="ruby-operator">*</span><span class="ruby-value">60.0</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;sec&quot;</span>,<span class="ruby-string">&quot;second&quot;</span>,<span class="ruby-string">&quot;seconds&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">diff</span><span class="ruby-operator">*</span><span class="ruby-value">24</span><span class="ruby-operator">*</span><span class="ruby-value">60.0</span>
  <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;not supported yet&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-dcl_set_params" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">dcl_set_params</span><span
            class="method-args">(pkg,name,value)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="dcl_set_params-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1932</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">dcl_set_params</span>(<span class="ruby-identifier">pkg</span>,<span class="ruby-identifier">name</span>,<span class="ruby-identifier">value</span>)
  <span class="ruby-identifier">set</span> = <span class="ruby-string">&#39;stx&#39;</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">name</span>
  <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^c/i</span>
    <span class="ruby-identifier">eval</span>( <span class="ruby-node">&quot;DCL.#{pkg}c#{set}(name,value.to_s)&quot;</span> )
  <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^l/i</span>
    <span class="ruby-keyword">if</span> <span class="ruby-regexp">/(.*)(T|t)(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">value</span>
      <span class="ruby-identifier">eval</span>( <span class="ruby-node">&quot;DCL.#{pkg}l#{set}(name,true)&quot;</span> )
    <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">if</span> <span class="ruby-regexp">/(.*)(F|f)(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">value</span>
      <span class="ruby-identifier">eval</span>( <span class="ruby-node">&quot;DCL.#{pkg}l#{set}(name,false)&quot;</span> )
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;value of logical parameter must include &#39;t&#39; or &#39;f&#39;&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[i-n]/i</span>
    <span class="ruby-identifier">eval</span>( <span class="ruby-node">&quot;DCL.#{pkg}i#{set}(name,value.to_i)&quot;</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">eval</span>( <span class="ruby-node">&quot;DCL.#{pkg}r#{set}(name,value.to_f)&quot;</span> )
  <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-div_on_meridional_plane" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">div_on_meridional_plane</span><span
            class="method-args">(v, w)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Divergence on meridional plane</p>
          
          

          
          <div class="method-source-code" id="div_on_meridional_plane-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 446</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">div_on_meridional_plane</span>(<span class="ruby-identifier">v</span>, <span class="ruby-identifier">w</span>)
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;numru/gphys/ep_flux&quot;</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">radius</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">rot_period</span>=<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">omega</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">g_forces</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span>.<span class="ruby-identifier">g</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">p00</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">P00</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">gas_const</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">R</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">cp</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">Cp</span>

  <span class="ruby-identifier">div</span> = <span class="ruby-operator">-</span><span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span><span class="ruby-operator">::</span><span class="ruby-identifier">div_sphere</span>(<span class="ruby-identifier">v</span>, <span class="ruby-identifier">w</span>)
  <span class="ruby-identifier">div</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-node">&quot;div_#{v.name}_#{w.name}&quot;</span>)
  <span class="ruby-identifier">div</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-node">&quot;divergence of (#{v.name}, #{w.name})&quot;</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">div</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-draw" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw</span><span
            class="method-args">(gp, draw_flag)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="draw-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 486</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">draw</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">draw_flag</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;nofig&quot;</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>)
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">val</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment">## open work station and setup draw parameters</span>
  <span class="ruby-identifier">window_setup</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>)

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>  <span class="ruby-comment"># itr &gt;= 5 (地図投影)</span>
    <span class="ruby-identifier">title</span> = <span class="ruby-ivar">@OPT_title</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">long_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span> <span class="ruby-comment"># タイトルの自動選択はしない</span>
    <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># draw hontai</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">draw_flag</span>
<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;line&quot;</span>, <span class="ruby-string">&quot;mark&quot;</span>
    <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> )
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_top_axis</span>)
        <span class="ruby-identifier">rsizet1</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&quot;RSIZET1&quot;</span>); <span class="ruby-identifier">rsizet2</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&quot;RSIZET2&quot;</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;RSIZET1&quot;</span>,<span class="ruby-value">0</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;RSIZET2&quot;</span>,<span class="ruby-value">0</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYL&#39;</span>,<span class="ruby-keyword">false</span>); <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYR&#39;</span>,<span class="ruby-keyword">false</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXT&#39;</span>,<span class="ruby-keyword">false</span>);<span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXB&#39;</span>,<span class="ruby-keyword">false</span>) <span class="ruby-comment">#; DCL.uscget(&quot;cyfmt&quot;)</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_range</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-ivar">@OPT_right_axis</span> = (<span class="ruby-ivar">@OPT_range</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> (<span class="ruby-ivar">@OPT_range</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)[<span class="ruby-value">1</span>] <span class="ruby-operator">:</span> <span class="ruby-string">&quot;&quot;</span>
          <span class="ruby-ivar">@OPT_range</span>      = (<span class="ruby-ivar">@OPT_range</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)[<span class="ruby-value">0</span>]
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">set_draw_range</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_xrange</span>  <span class="ruby-comment">#line plot で横軸の範囲を設定する場合</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_zerocenter</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">max</span> = [<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">min</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">abs</span>, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">max</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">abs</span>].<span class="ruby-identifier">max</span>;  <span class="ruby-ivar">@OPT_range</span> = <span class="ruby-node">&quot;#{-max}:#{max}&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_zerocenter</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">max</span> = <span class="ruby-ivar">@OPT_zerocenter</span>.<span class="ruby-identifier">to_f</span>;  <span class="ruby-ivar">@OPT_range</span> = <span class="ruby-node">&quot;#{-max}:#{max}&quot;</span>
      <span class="ruby-keyword">end</span>


      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_axis_options</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;line&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>((<span class="ruby-ivar">@OPT_step</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">step_shape</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">gp</span>),<span class="ruby-keyword">true</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>],
                    <span class="ruby-string">&quot;legend&quot;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_nolegend</span>)

      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;mark&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">mark</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">true</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>])

        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_line</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">false</span>,
                      <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                      <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                      <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                      <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>)
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_axis_options</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-ivar">@OPT_axis_options</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">var</span>, <span class="ruby-identifier">val</span> = <span class="ruby-identifier">i</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;=&quot;</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uspset</span>(<span class="ruby-identifier">var</span>, <span class="ruby-identifier">val</span>)
        }
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;LR&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;BT&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_exch</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;LR&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;BT&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_exch</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@Overplot</span>)
        <span class="ruby-ivar">@Overplot_ymin</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">max</span>.<span class="ruby-identifier">val</span>;  <span class="ruby-ivar">@Overplot_ymax</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">min</span>.<span class="ruby-identifier">val</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-comment"># x軸が時間でカレンダー属性を持つ場合、時間軸の単位(since)を合わせる。</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;calendar&quot;</span>)) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">get_calendar</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-value">0</span>)
      <span class="ruby-keyword">end</span>


      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_top_axis</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;ROFFXT&quot;</span>,<span class="ruby-value">0.0</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;RSIZET1&quot;</span>,<span class="ruby-identifier">rsizet1</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;RSIZET2&quot;</span>,<span class="ruby-identifier">rsizet2</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYL&#39;</span>, <span class="ruby-keyword">true</span>); <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXB&#39;</span>, <span class="ruby-keyword">true</span>)
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_top_axis</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;L&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;BT&quot;</span>)
        <span class="ruby-keyword">elsif</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@OPT_top_axis</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;LR&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;B&quot;</span>)
        <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-keyword">and</span> <span class="ruby-ivar">@OPT_top_axis</span>)
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;L&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;B&quot;</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_top_axis</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># これ何する機能だっけ？</span>
          <span class="ruby-comment">#xmin = DCL.sgpget(&quot;UXMIN&quot;)  ; xmax = DCL.sgpget(&quot;UXMAX&quot;); old_axis = gp.axis(0).pos.val</span>
          <span class="ruby-comment"># gp.axis(0).set_pos(VArray.new(NMath::sin(old_axis*PI/180.0), nil, &quot;&quot;)); new_axis = gp.axis(0).pos.val</span>
          <span class="ruby-comment"># #DCL.grstrn(1)</span>
          <span class="ruby-comment"># DCL.uscset(&quot;cxfmt&quot;,&quot;&quot;); DCL.usrset(&quot;xfac&quot;,&quot;-999&quot;) ;DCL.usrset(&quot;xoff&quot;,&quot;-999&quot;)</span>
          <span class="ruby-comment"># DCL.sgpset(&quot;UXMIN&quot;,new_axis.min)  ; DCL.sgpset(&quot;UXMAX&quot;,new_axis.max)</span>
          <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXT&#39;</span>, <span class="ruby-keyword">true</span>)
          <span class="ruby-comment"># GGraph.axes(gp.axis(0).to_gphys,gp,&quot;yside&quot;=&gt;&quot;n&quot;,&quot;xside&quot;=&gt;&quot;T&quot;,&quot;xtickint&quot;=&gt;-999,&quot;xlabelint&quot;=&gt;-999)</span>
          <span class="ruby-identifier">xmin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>); <span class="ruby-identifier">xmax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>);
          <span class="ruby-identifier">dxt</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uspget</span>(<span class="ruby-string">&quot;dxt&quot;</span>); <span class="ruby-identifier">dxl</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uspget</span>(<span class="ruby-string">&quot;dxl&quot;</span>); <span class="ruby-identifier">bx</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">rgnlt</span>(<span class="ruby-identifier">xmin</span>)
          <span class="ruby-identifier">ux1</span> = []; <span class="ruby-identifier">ux2</span> = []; <span class="ruby-identifier">ch</span> = []
          <span class="ruby-keyword">if</span> (<span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">xmin</span><span class="ruby-operator">*</span><span class="ruby-identifier">xmax</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment">#ゼロを含まない場合</span>
              ((<span class="ruby-identifier">xmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">xmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">dxt</span><span class="ruby-value">+2</span>).<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ux1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">bx</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">bx</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">xmin</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">bx</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-operator">&lt;</span><span class="ruby-identifier">xmax</span>) }
              ((<span class="ruby-identifier">xmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">xmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">dxl</span><span class="ruby-value">+2</span>).<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ux2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">bx</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxl</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">bx</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxl</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-operator">&gt;</span><span class="ruby-identifier">xmin</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">bx</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxl</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-operator">&lt;</span><span class="ruby-identifier">xmax</span>) }
            <span class="ruby-keyword">else</span> <span class="ruby-comment">#ゼロを含む場合</span>
              <span class="ruby-identifier">ux1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">0</span>; <span class="ruby-identifier">ux2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">0</span>; <span class="ruby-identifier">i</span> = <span class="ruby-value">1</span>
              <span class="ruby-keyword">while</span> (<span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> [<span class="ruby-identifier">xmin</span>.<span class="ruby-identifier">abs</span>, <span class="ruby-identifier">xmax</span>.<span class="ruby-identifier">abs</span>].<span class="ruby-identifier">max</span>)
                <span class="ruby-identifier">ux1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>; <span class="ruby-identifier">ux1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>; <span class="ruby-identifier">ux2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">dxl</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>; <span class="ruby-identifier">ux2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">dxl</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>; <span class="ruby-identifier">i</span>=<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>
              <span class="ruby-keyword">end</span>
              <span class="ruby-identifier">ux1</span>.<span class="ruby-identifier">select!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">max</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&gt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">min</span>  }
              <span class="ruby-identifier">ux2</span>.<span class="ruby-identifier">select!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">max</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&gt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">min</span>  }
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">elsif</span> (<span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">nxmin</span> = <span class="ruby-identifier">func</span>(<span class="ruby-identifier">xmin</span>); <span class="ruby-identifier">nxmax</span> = <span class="ruby-identifier">func</span>(<span class="ruby-identifier">xmax</span>); <span class="ruby-identifier">i</span> = <span class="ruby-value">0</span>
            <span class="ruby-identifier">bx1</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">rgnlt</span>([<span class="ruby-identifier">nxmin</span>,<span class="ruby-identifier">nxmax</span>].<span class="ruby-identifier">min</span>); <span class="ruby-identifier">bx2</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">rgngt</span>([<span class="ruby-identifier">nxmin</span>,<span class="ruby-identifier">nxmax</span>].<span class="ruby-identifier">min</span>); <span class="ruby-identifier">dxt</span> = (<span class="ruby-identifier">bx1</span><span class="ruby-operator">-</span><span class="ruby-identifier">bx2</span>).<span class="ruby-identifier">abs</span><span class="ruby-operator">*</span><span class="ruby-value">0.5</span>
            <span class="ruby-identifier">r</span> = [((<span class="ruby-identifier">nxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">nxmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">/</span><span class="ruby-value">10</span>).<span class="ruby-identifier">round</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">max</span> <span class="ruby-comment"># 大きい目盛の割合</span>
            <span class="ruby-comment"># p bx1, dxt</span>
            <span class="ruby-keyword">while</span> (<span class="ruby-identifier">bx1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> [<span class="ruby-identifier">nxmax</span>,<span class="ruby-identifier">nxmin</span>].<span class="ruby-identifier">max</span>)
              <span class="ruby-identifier">ux2</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ifunc</span>(<span class="ruby-identifier">bx1</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span><span class="ruby-operator">%</span><span class="ruby-identifier">r</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
              <span class="ruby-identifier">ux1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ifunc</span>(<span class="ruby-identifier">bx1</span><span class="ruby-operator">+</span><span class="ruby-identifier">dxt</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>)
              <span class="ruby-comment">#ii = log10(((bx1+dxt*i)/bx1).abs).to_i  + 1#桁数-1</span>
              <span class="ruby-comment">#p bx1+dxt*i</span>
              <span class="ruby-identifier">i</span> = <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-comment">#10**(ii-1)</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">ux1</span>.<span class="ruby-identifier">select!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">max</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&gt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">min</span>  }
            <span class="ruby-identifier">ux2</span>.<span class="ruby-identifier">select!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&lt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">max</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">a</span> <span class="ruby-operator">&gt;=</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>].<span class="ruby-identifier">min</span>  }
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">ch</span>  = <span class="ruby-identifier">ux2</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">func</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">round</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_s</span>}
          <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uxaxlb</span>(<span class="ruby-string">&quot;T&quot;</span>,<span class="ruby-identifier">ux1</span>,<span class="ruby-identifier">ux2</span>,<span class="ruby-identifier">ch</span>,<span class="ruby-value">1</span>)
          <span class="ruby-comment"># DCL.usrset(&quot;xfac&quot;,&quot;-999&quot;);DCL.usrset(&quot;xoff&quot;,&quot;-999&quot;);DCL.uscset(&quot;cxfmt&quot;,&quot;&quot;)</span>
          <span class="ruby-comment"># DCL.sgpset(&quot;UXMIN&quot;,xmin)  ; DCL.sgpset(&quot;UXMAX&quot;,xmax)</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_overplot_rm</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">running_mean</span>(<span class="ruby-value">0</span>,<span class="ruby-ivar">@OPT_overplot_rm</span>.<span class="ruby-identifier">to_i</span>,<span class="ruby-value">10</span>,<span class="ruby-ivar">@OPT_overplot_rm</span>.<span class="ruby-identifier">to_i</span>),<span class="ruby-keyword">false</span>,
                  <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>)<span class="ruby-value">+3</span>,
                  <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_overplot_stddev</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span><span class="ruby-operator">+</span><span class="ruby-ivar">@stddev</span>,<span class="ruby-keyword">false</span>,
                  <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                  <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">3</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span><span class="ruby-operator">-</span><span class="ruby-ivar">@stddev</span>,<span class="ruby-keyword">false</span>,
                  <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                  <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">3</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">line_fill</span>((<span class="ruby-ivar">@OPT_step</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">step_shape</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">gp</span>)) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_fill</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>)

<span class="ruby-comment">#-----OVERPLOT----------------------------</span>
<span class="ruby-comment">#    elsif ( @OPT_overplot_color || @OPT_Opc )</span>
    <span class="ruby-keyword">elsif</span> ( <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_nocolor</span> )
      <span class="ruby-ivar">@Overplot_ymin</span> = [<span class="ruby-ivar">@Overplot_ymin</span>, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">min</span>.<span class="ruby-identifier">val</span>].<span class="ruby-identifier">min</span>
      <span class="ruby-ivar">@Overplot_ymax</span> = [<span class="ruby-ivar">@Overplot_ymax</span>, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">max</span>.<span class="ruby-identifier">val</span>].<span class="ruby-identifier">max</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;MIN: #{@Overplot_ymin}, MAX: #{@Overplot_ymax} \n&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@Overplot_max</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span>)
        <span class="ruby-identifier">ymin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>); <span class="ruby-identifier">ymax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)
        <span class="ruby-identifier">gpmin</span> = (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">min</span>.<span class="ruby-identifier">val</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_right_axis</span>)[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">gpmax</span> = (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">max</span>.<span class="ruby-identifier">val</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_right_axis</span>)[<span class="ruby-value">1</span>]
        <span class="ruby-comment"># scale = (ymax - ymin)/(gpmax-gpmin); offset = gpmin - ymin</span>
        <span class="ruby-comment"># gp = (gp - gpmin)*scale + ymin</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>,<span class="ruby-identifier">gpmin</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>,<span class="ruby-identifier">gpmax</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;R&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;n&quot;</span>,<span class="ruby-string">&quot;ytickint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>,<span class="ruby-string">&quot;ylabelint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">set_calendar</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-value">0</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@Calendar</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;line&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>((<span class="ruby-ivar">@OPT_step</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">step_shape</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">gp</span>), <span class="ruby-keyword">false</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>],
                    <span class="ruby-string">&quot;legend&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_nolegend</span>
                    )
      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;mark&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">mark</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">false</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>])

        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_line</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">false</span>,
                      <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                      <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                      <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                      <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>)
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYR&#39;</span>, <span class="ruby-keyword">true</span>)
        <span class="ruby-comment">#  DCL::uzrset(&#39;YFACT&#39;, 1.0/scale);  DCL::uzrset(&#39;YOFFSET&#39;, gpmin-ymin/scale)</span>
        <span class="ruby-comment"># -999は未定義を表し、内部で決める。前の軸の値が残っているので、改めて未定義 -999 を入れる必要がある。</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">usrset</span>(<span class="ruby-string">&quot;yfac&quot;</span>,<span class="ruby-string">&quot;-999&quot;</span>);<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">usrset</span>(<span class="ruby-string">&quot;yoff&quot;</span>,<span class="ruby-string">&quot;-999&quot;</span>);<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uscset</span>(<span class="ruby-string">&quot;cyfmt&quot;</span>,<span class="ruby-string">&quot;&quot;</span>)
        <span class="ruby-comment">#  DCL.uzpset(&#39;indext1&#39;, DCL.uzpget(&#39;indext1&#39;)+@OPT_index) # 小さい座標軸の目盛</span>
        <span class="ruby-comment">#  DCL.uzpset(&#39;indext2&#39;, DCL.uzpget(&#39;indext2&#39;)+@OPT_index) # 大きい座標軸の目盛</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&#39;indexl1&#39;</span>, <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&#39;indexl1&#39;</span>)<span class="ruby-operator">+</span>((<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">/</span><span class="ruby-value">10</span>)<span class="ruby-operator">*</span><span class="ruby-value">10</span>) <span class="ruby-comment"># 小さいラベル、タイトル</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;R&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;n&quot;</span>,<span class="ruby-string">&quot;ytickint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>,<span class="ruby-string">&quot;ylabelint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&#39;indexl1&#39;</span>, <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&#39;indexl1&#39;</span>)<span class="ruby-operator">-</span>((<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">/</span><span class="ruby-value">10</span>)<span class="ruby-operator">*</span><span class="ruby-value">10</span>) <span class="ruby-comment"># 小さいラベル、タイトル</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_overplot_rm</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">running_mean</span>(<span class="ruby-value">0</span>,<span class="ruby-ivar">@OPT_overplot_rm</span>.<span class="ruby-identifier">to_i</span>,<span class="ruby-value">10</span>,<span class="ruby-ivar">@OPT_overplot_rm</span>.<span class="ruby-identifier">to_i</span>),<span class="ruby-keyword">false</span>,
                <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>((<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-value">+3</span>),
                <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_overplot_stddev</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span><span class="ruby-operator">+</span><span class="ruby-ivar">@stddev</span>,<span class="ruby-keyword">false</span>,
                <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span>),
                <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">3</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span><span class="ruby-operator">-</span><span class="ruby-ivar">@stddev</span>,<span class="ruby-keyword">false</span>,
                <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>((<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)),
                <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">3</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_fill</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
<span class="ruby-comment">#      if (@OPT_fill) then</span>
        <span class="ruby-identifier">line_fill</span>((<span class="ruby-ivar">@OPT_step</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">step_shape</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">gp</span>)) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_fill</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>)
        <span class="ruby-identifier">line_fill</span>([<span class="ruby-ivar">@prev_gp</span>,<span class="ruby-identifier">gp</span>]) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_fill</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@Overplot</span>.<span class="ruby-identifier">to_s</span>))
      <span class="ruby-keyword">end</span>



    <span class="ruby-keyword">else</span> <span class="ruby-comment">#OVERPLOT WITH NOCOLOR</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span>)
        <span class="ruby-identifier">ymin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>); <span class="ruby-identifier">ymax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)
        <span class="ruby-identifier">gpmin</span> = (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">min</span>.<span class="ruby-identifier">val</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_right_axis</span>)[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">gpmax</span> = (<span class="ruby-ivar">@OPT_right_axis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">max</span>.<span class="ruby-identifier">val</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_right_axis</span>)[<span class="ruby-value">1</span>]
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>,<span class="ruby-identifier">gpmin</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>,<span class="ruby-identifier">gpmax</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;R&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;n&quot;</span>,<span class="ruby-string">&quot;ytickint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>,<span class="ruby-string">&quot;ylabelint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;line&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>((<span class="ruby-ivar">@OPT_step</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">step_shape</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">gp</span>),
                    <span class="ruby-keyword">false</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-ivar">@Overplot</span>),
                    <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>],
                    <span class="ruby-string">&quot;legend&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_nolegend</span>
                    )
      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;mark&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">mark</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">false</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-ivar">@Overplot</span>),
                    <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>]
                    )
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_right_axis</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYR&#39;</span>, <span class="ruby-keyword">true</span>)
        <span class="ruby-comment"># -999は未定義を表し、内部で決める。前の軸の値が残っているので、改めて未定義 -999 を入れる必要がある。</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">usrset</span>(<span class="ruby-string">&quot;yfac&quot;</span>,<span class="ruby-string">&quot;-999&quot;</span>);<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">usrset</span>(<span class="ruby-string">&quot;yoff&quot;</span>,<span class="ruby-string">&quot;-999&quot;</span>);<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uscset</span>(<span class="ruby-string">&quot;cyfmt&quot;</span>,<span class="ruby-string">&quot;&quot;</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">axes</span>(<span class="ruby-keyword">nil</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-string">&quot;yside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;R&quot;</span>,<span class="ruby-string">&quot;xside&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;n&quot;</span>,<span class="ruby-string">&quot;ytickint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>,<span class="ruby-string">&quot;ylabelint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-999</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_overplot_rm</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">running_mean</span>(<span class="ruby-value">0</span>,<span class="ruby-ivar">@OPT_overplot_rm</span>.<span class="ruby-identifier">to_i</span>,<span class="ruby-value">10</span>,<span class="ruby-ivar">@OPT_overplot_rm</span>.<span class="ruby-identifier">to_i</span>),<span class="ruby-keyword">false</span>,
                  <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>)<span class="ruby-value">+3</span>,
                  <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-ivar">@Overplot</span>),<span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@Overplot_max</span> )
      <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@Overplot</span> = <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>

<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;full&quot;</span>, <span class="ruby-string">&quot;nocont&quot;</span>, <span class="ruby-string">&quot;noshade&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">new_page</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">new_page</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xmean</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ymean</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">vxmax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">1</span>]; <span class="ruby-identifier">vymin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">2</span>]; <span class="ruby-identifier">vymax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">3</span>]
      <span class="ruby-identifier">vxlen</span> = <span class="ruby-identifier">vxmax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vxmin</span>; <span class="ruby-identifier">vylen</span> = <span class="ruby-identifier">vymax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vymin</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vylen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymax</span>])
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_ymean</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXB&quot;</span>,<span class="ruby-keyword">false</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpset</span>(<span class="ruby-string">&quot;lmsg&quot;</span>,<span class="ruby-keyword">false</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;noshade&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">cont_tf</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-identifier">mj</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpget</span>(<span class="ruby-string">&#39;indxmj&#39;</span>); <span class="ruby-identifier">mn</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpget</span>(<span class="ruby-string">&#39;indxmn&#39;</span>)
      <span class="ruby-identifier">title</span> = <span class="ruby-ivar">@OPT_title</span>       ; <span class="ruby-identifier">annotate</span> = <span class="ruby-ivar">@annotate</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">cont_tf</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">set_draw_range</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xrange</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_yrange</span>)

    <span class="ruby-identifier">gp2D</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">copy</span>

<span class="ruby-comment">#    gp2D = cyclic_extension(gp2D, @OPT_cyclic_extension,4) if @OPT_cyclic_extension</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_bothsides</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">vxmax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">1</span>]; <span class="ruby-identifier">vymin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">2</span>]; <span class="ruby-identifier">vymax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">3</span>]
      <span class="ruby-identifier">vxlen</span> = <span class="ruby-identifier">vxmax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vxmin</span>; <span class="ruby-identifier">vylen</span> = <span class="ruby-identifier">vymax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vymin</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.5</span> , <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>])
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;full&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;nocont&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gp2D</span>,<span class="ruby-identifier">new_page</span>,
                  <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                  <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                  <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                  <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                  <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                  <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                  <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>,
                  <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>,
                  <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                  <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                  <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                  <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                  <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;full&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;noshade&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">contour</span>(<span class="ruby-identifier">gp2D</span>, <span class="ruby-identifier">cont_tf</span>,
             <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">title</span>,
             <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">annotate</span>,
             <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
             <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_clevels</span>,
             <span class="ruby-string">&quot;nozero&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_nozero</span>,
             <span class="ruby-string">&quot;label&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_label</span>,
             <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
             <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
             <span class="ruby-string">&quot;color&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>,
             <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span> )
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_bothsides</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">other_side</span> =  [<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&#39;plx&#39;</span>)<span class="ruby-value">+180</span>, <span class="ruby-operator">-</span><span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&#39;ply&#39;</span>), <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&#39;plrot&#39;</span>)] <span class="ruby-comment"># 惑星の裏側</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;map_axis&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">other_side</span>,<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.5</span>, <span class="ruby-identifier">vxmax</span>, <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>], <span class="ruby-string">&quot;new_frame&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gp2D</span>,<span class="ruby-identifier">new_page</span>,
                  <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                  <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                  <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                  <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                  <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                  <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                  <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>,
                  <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>,
                  <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                  <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                  <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                  <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                  <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgsvpt</span>(<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmax</span>, <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># テスト</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-keyword">false</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp2D</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">val</span>
      <span class="ruby-identifier">max</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">max</span>
      <span class="ruby-identifier">min</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">min</span>
      <span class="ruby-identifier">xm</span>, <span class="ruby-identifier">ym</span> = <span class="ruby-identifier">gp2D</span>.<span class="ruby-identifier">shape</span>
      <span class="ruby-identifier">data</span> = (<span class="ruby-identifier">gp2D</span>.<span class="ruby-identifier">to_na</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">min</span>) <span class="ruby-operator">/</span> (<span class="ruby-identifier">max</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">min</span>) <span class="ruby-operator">*</span> <span class="ruby-value">255</span>
      <span class="ruby-identifier">xcoord</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">val</span>
      <span class="ruby-identifier">ycoord</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">val</span>
      <span class="ruby-identifier">xm</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ym</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">vx0</span>, <span class="ruby-identifier">vy0</span>  = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">stftrf</span>(<span class="ruby-identifier">xcoord</span>[[<span class="ruby-value">0</span>, <span class="ruby-identifier">i</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">max</span>],<span class="ruby-identifier">ycoord</span>[<span class="ruby-identifier">j</span>])
          <span class="ruby-identifier">vx1</span>, <span class="ruby-identifier">vy1</span>  = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">stftrf</span>(<span class="ruby-identifier">xcoord</span>[<span class="ruby-identifier">i</span>],<span class="ruby-identifier">ycoord</span>[<span class="ruby-identifier">j</span>])
          <span class="ruby-identifier">vx2</span>, <span class="ruby-identifier">vy2</span>  = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">stftrf</span>(<span class="ruby-identifier">xcoord</span>[[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>, <span class="ruby-identifier">xm</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">min</span>],<span class="ruby-identifier">ycoord</span>[<span class="ruby-identifier">j</span>])
          <span class="ruby-identifier">vr1</span> = ((<span class="ruby-identifier">vx1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vx0</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">vy1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vy0</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">**</span><span class="ruby-value">0.5</span>
          <span class="ruby-identifier">vr2</span> = ((<span class="ruby-identifier">vx2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vx1</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">vy2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vy1</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">**</span><span class="ruby-value">0.5</span>
          <span class="ruby-identifier">vr</span> = [<span class="ruby-identifier">vr1</span>, <span class="ruby-identifier">vr2</span>].<span class="ruby-identifier">max</span><span class="ruby-operator">*</span><span class="ruby-value">1.1</span>
          <span class="ruby-identifier">rgb</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">isgrgb</span>(<span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>],<span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>],<span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>])
          <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpmxu</span>([<span class="ruby-identifier">xcoord</span>[<span class="ruby-identifier">i</span>]],[<span class="ruby-identifier">ycoord</span>[<span class="ruby-identifier">j</span>]],<span class="ruby-value">11</span>,<span class="ruby-value">7</span>,<span class="ruby-identifier">rgb</span>,<span class="ruby-identifier">vr</span>)
        }
      }
    <span class="ruby-keyword">end</span>



    <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@Overplot_max</span> )
      <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@Overplot</span> = <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>



<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;fullcolor&quot;</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xmean</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ymean</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">vxmax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">1</span>]; <span class="ruby-identifier">vymin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">2</span>]; <span class="ruby-identifier">vymax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">3</span>]
      <span class="ruby-identifier">vxlen</span> = <span class="ruby-identifier">vxmax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vxmin</span>; <span class="ruby-identifier">vylen</span> = <span class="ruby-identifier">vymax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vymin</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vylen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymax</span>])
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_ymean</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXB&quot;</span>,<span class="ruby-keyword">false</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpset</span>(<span class="ruby-string">&quot;lmsg&quot;</span>,<span class="ruby-keyword">false</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">set_draw_range</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xrange</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_yrange</span>)

    <span class="ruby-identifier">zmin</span>, <span class="ruby-identifier">zmax</span> = <span class="ruby-identifier">tone_full</span>(<span class="ruby-identifier">gp</span>,
                <span class="ruby-keyword">true</span>,
                <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>,
                <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>]
                )
    <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_nocont</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">contour</span>(<span class="ruby-identifier">gp</span>,
                     <span class="ruby-keyword">false</span>,
                     <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                     <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_clevels</span>,
                     <span class="ruby-string">&quot;nozero&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_nozero</span>,
                     <span class="ruby-string">&quot;label&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_label</span>,
                     <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                     <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                     <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>)
    <span class="ruby-keyword">end</span>

<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;histogram1D&quot;</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_range</span>)
        <span class="ruby-identifier">ranges</span> = (<span class="ruby-ivar">@OPT_range</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
        <span class="ruby-identifier">xmin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">1</span>]
        <span class="ruby-identifier">ymin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">1</span>])[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">1</span>])[<span class="ruby-value">1</span>]
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">nb</span> = <span class="ruby-operator">-</span>(<span class="ruby-ivar">@OPT_int</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> ((<span class="ruby-ivar">@OPT_int</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>)
      <span class="ruby-identifier">gph</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">histogram</span>(<span class="ruby-string">&quot;nbins&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">nb</span>,<span class="ruby-string">&quot;min&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xmin</span>,<span class="ruby-string">&quot;max&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xmax</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_histogram</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span>)
        <span class="ruby-identifier">gph</span> = <span class="ruby-identifier">gph</span><span class="ruby-operator">/</span><span class="ruby-identifier">gph</span>.<span class="ruby-identifier">sum</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>
        <span class="ruby-identifier">gph</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;ratio (%) of bins&quot;</span>)
        <span class="ruby-identifier">gph</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;%&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uusfri</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>) <span class="ruby-comment">#index of box</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uusfrt</span>(<span class="ruby-ivar">@OPT_type</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>) <span class="ruby-comment">#type of box</span>
      <span class="ruby-identifier">ci</span> = (<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1.0</span>)<span class="ruby-operator">/</span><span class="ruby-value">10</span>; <span class="ruby-identifier">wi</span> = (<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1.0</span>)<span class="ruby-operator">%</span><span class="ruby-value">10</span>; <span class="ruby-identifier">pi</span> = (<span class="ruby-ivar">@Overplot</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-value">7</span>
      <span class="ruby-identifier">fi</span> = <span class="ruby-identifier">ci</span><span class="ruby-operator">*</span><span class="ruby-value">1000</span><span class="ruby-operator">+</span><span class="ruby-identifier">pi</span><span class="ruby-operator">*</span><span class="ruby-value">100</span><span class="ruby-operator">+</span><span class="ruby-identifier">wi</span><span class="ruby-operator">*</span><span class="ruby-value">10</span><span class="ruby-value">+2</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">histogram</span>(<span class="ruby-identifier">gph</span>,
                       <span class="ruby-keyword">true</span>,
                       <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                       <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                       <span class="ruby-string">&quot;window&quot;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>,<span class="ruby-identifier">ymin</span>,<span class="ruby-identifier">ymax</span>],
                       <span class="ruby-string">&quot;fill&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_fill</span>,
                       <span class="ruby-string">&quot;fill_pattern&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">fi</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_range</span>)
        <span class="ruby-identifier">ranges</span> = (<span class="ruby-ivar">@OPT_range</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
        <span class="ruby-identifier">xmin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">1</span>]
        <span class="ruby-identifier">ymin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">1</span>])[<span class="ruby-value">0</span>]
        <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">1</span>])[<span class="ruby-value">1</span>]
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">nb</span> = <span class="ruby-operator">-</span>(<span class="ruby-ivar">@OPT_int</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> ((<span class="ruby-ivar">@OPT_int</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>)
      <span class="ruby-identifier">gph</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">histogram</span>(<span class="ruby-string">&quot;nbins&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">nb</span>,<span class="ruby-string">&quot;min&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xmin</span>,<span class="ruby-string">&quot;max&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xmax</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_histogram</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span>)
        <span class="ruby-identifier">gph</span> = <span class="ruby-identifier">gph</span><span class="ruby-operator">/</span><span class="ruby-identifier">gph</span>.<span class="ruby-identifier">sum</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>
        <span class="ruby-identifier">gph</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;ratio (%) of bins&quot;</span>)
        <span class="ruby-identifier">gph</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;%&quot;</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uusfri</span>((<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)) <span class="ruby-comment">#index of box</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uusfrt</span>(<span class="ruby-ivar">@OPT_type</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>) <span class="ruby-comment">#type of box</span>
      <span class="ruby-identifier">ci</span> = (<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">/</span><span class="ruby-value">10</span>; <span class="ruby-identifier">wi</span> = (<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">%</span><span class="ruby-value">10</span>; <span class="ruby-identifier">pi</span> = (<span class="ruby-ivar">@Overplot</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-value">7</span>
      <span class="ruby-identifier">fi</span> = <span class="ruby-identifier">ci</span><span class="ruby-operator">*</span><span class="ruby-value">1000</span><span class="ruby-operator">+</span><span class="ruby-identifier">pi</span><span class="ruby-operator">*</span><span class="ruby-value">100</span><span class="ruby-operator">+</span><span class="ruby-identifier">wi</span><span class="ruby-operator">*</span><span class="ruby-value">10</span><span class="ruby-value">+2</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">histogram</span>(<span class="ruby-identifier">gph</span>,<span class="ruby-keyword">false</span>,
                       <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                       <span class="ruby-string">&quot;fill&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_fill</span>,
                       <span class="ruby-string">&quot;fill_pattern&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">fi</span>
                       )
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">&lt;</span> <span class="ruby-ivar">@Overplot_max</span> )
      <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@Overplot</span> = <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span> <span class="ruby-comment">#end case</span>

<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
  <span class="ruby-comment"># plot linear line</span>
  <span class="ruby-identifier">draw_linearline</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_linearline</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">title</span>(<span class="ruby-identifier">title</span>)
    <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-identifier">title</span>
    <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">long_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># lon-lat axis for itr=10</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">10</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uxaxdv</span>(<span class="ruby-string">&quot;T&quot;</span>,<span class="ruby-value">10</span>,<span class="ruby-value">30</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uxaxdv</span>(<span class="ruby-string">&quot;B&quot;</span>,<span class="ruby-value">10</span>,<span class="ruby-value">30</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uyaxdv</span>(<span class="ruby-string">&quot;L&quot;</span>,<span class="ruby-value">10</span>,<span class="ruby-value">20</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uyaxdv</span>(<span class="ruby-string">&quot;R&quot;</span>,<span class="ruby-value">10</span>,<span class="ruby-value">20</span>)
    <span class="ruby-keyword">end</span>



  <span class="ruby-identifier">title</span>(<span class="ruby-ivar">@OPT_subtitle</span>, <span class="ruby-value">1</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_subtitle</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>

  <span class="ruby-comment"># test for counter</span>
  <span class="ruby-comment"># counter(&quot;t = &quot;, 0.0, 1.00, &quot; Earth days&quot;)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.135 , 0.3725, &quot;90&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.865 , 0.3725, &quot;90&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.3255 , 0.185, &quot;0&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.676 , 0.185, &quot;0&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.3255 , 0.56, &quot;180&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.676 , 0.56, &quot;180&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
  <span class="ruby-comment"># DCL::sgtxzr(0.5 , 0.375, &quot;270&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 993)</span>

<span class="ruby-comment">#---small window below the figure for y-mean line plot</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_ymean</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">itr</span> =  (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>) <span class="ruby-operator">?</span> <span class="ruby-value">3</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">mdim</span> = <span class="ruby-ivar">@OPT_exch</span> <span class="ruby-operator">?</span> <span class="ruby-value">0</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vylen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span><span class="ruby-value">-0.01</span>],
                    <span class="ruby-string">&quot;new_frame&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;itr&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">itr</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;xtitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">nil</span>, <span class="ruby-string">&quot;ytitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">mdim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; mean&quot;</span>, <span class="ruby-string">&quot;xunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">nil</span>, <span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vylen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span><span class="ruby-value">-0.01</span>],
                    <span class="ruby-string">&quot;new_frame&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;itr&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">itr</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;xtitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;ytitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">mdim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; mean&quot;</span>, <span class="ruby-string">&quot;xunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">nil</span>, <span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>,
                       <span class="ruby-string">&quot;xtickint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">10.0</span>, <span class="ruby-string">&quot;xlabelint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">90.0</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXB&#39;</span>, <span class="ruby-keyword">true</span>)
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">mdim</span>),<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>,
                <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>],
                <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>), <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>)
                )

    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&quot;viewport&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@VIEWPORT</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-comment"># color bar</span>
    <span class="ruby-keyword">if</span> ( ( <span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;full&quot;</span>) <span class="ruby-operator">||</span> ( <span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;nocont&quot;</span>) ) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@colorbar</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_aspect</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">2.0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">4</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_aspect</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;units&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;[&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>)
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;units&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;[&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;units&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;[&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>)
      <span class="ruby-keyword">end</span>
  <span class="ruby-comment">#                      &quot;vlength&quot; =&gt; 0.55</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">draw_flag</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;fullcolor&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@colorbar</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vx0</span>, <span class="ruby-identifier">vx1</span>, <span class="ruby-identifier">vy0</span>, <span class="ruby-identifier">vy1</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgqvpt</span> <span class="ruby-comment"># viewportの記憶</span>
      <span class="ruby-identifier">aspect</span> = (<span class="ruby-identifier">vx1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vx0</span>) <span class="ruby-operator">/</span> (<span class="ruby-identifier">vy1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vy0</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">aspect</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2.0</span>)
        <span class="ruby-identifier">offset</span> = <span class="ruby-identifier">vy0</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.1875</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uixbar</span>(<span class="ruby-value">0.35</span>,<span class="ruby-value">0.65</span>,<span class="ruby-value">0.035</span><span class="ruby-operator">+</span><span class="ruby-identifier">offset</span>,<span class="ruby-value">0.0575</span><span class="ruby-operator">+</span><span class="ruby-identifier">offset</span>,<span class="ruby-identifier">zmin</span>,<span class="ruby-identifier">zmax</span>,<span class="ruby-string">&quot;B&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXB&quot;</span>,<span class="ruby-keyword">false</span>);  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYL&quot;</span>,<span class="ruby-keyword">false</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uiybar</span>(<span class="ruby-identifier">vx1</span><span class="ruby-value">+0.02</span>,<span class="ruby-identifier">vx1</span><span class="ruby-value">+0.045</span>,<span class="ruby-identifier">vy0</span>,<span class="ruby-identifier">vy0</span><span class="ruby-value">+0.3</span>,<span class="ruby-identifier">zmin</span>,<span class="ruby-identifier">zmax</span>,<span class="ruby-string">&quot;R&quot;</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uxsttl</span>(<span class="ruby-string">&quot;T&quot;</span>, <span class="ruby-string">&quot;[&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>, <span class="ruby-value">-1</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYR&quot;</span>,<span class="ruby-keyword">true</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzinit</span>; <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">usdaxs</span>
        <span class="ruby-comment">#DCL.uzpset(&quot;ROFFYR&quot;,0); DCL.uzpset(&quot;IROTCYR&quot;,4)</span>
        <span class="ruby-comment">#DCL.uysttl(&quot;R&quot;, &quot;[&quot;+gp.units.to_s+&quot;]&quot;, 1)</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgsvpt</span>(<span class="ruby-identifier">vx0</span>, <span class="ruby-identifier">vx1</span>, <span class="ruby-identifier">vy0</span>, <span class="ruby-identifier">vy1</span>) <span class="ruby-comment"># viewportを戻す</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXB&quot;</span>,<span class="ruby-keyword">true</span>);  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYL&quot;</span>,<span class="ruby-keyword">true</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXT&quot;</span>,<span class="ruby-keyword">false</span>);  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYR&quot;</span>,<span class="ruby-keyword">false</span>)
    <span class="ruby-keyword">end</span>

<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-comment"># mask shading</span>
    <span class="ruby-identifier">maskshading</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_maskshading</span>
<span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>






<span class="ruby-comment"># ---- small window on right side for x-mean line plot</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xmean</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">itr</span> =  (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-operator">?</span> <span class="ruby-value">2</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span><span class="ruby-value">+0.01</span>, <span class="ruby-identifier">vxmax</span>,   <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vylen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span> , <span class="ruby-identifier">vymax</span>],
                      <span class="ruby-string">&quot;new_frame&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;itr&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">itr</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;xtitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;ytitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;xunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span><span class="ruby-value">+0.01</span>, <span class="ruby-identifier">vxmax</span>,   <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vylen</span><span class="ruby-operator">*</span><span class="ruby-value">0.8</span><span class="ruby-value">+0.00325</span> , <span class="ruby-identifier">vymax</span><span class="ruby-value">-0.00325</span>],
                      <span class="ruby-string">&quot;new_frame&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;itr&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">itr</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;xtitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;ytitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;xunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>,
                         <span class="ruby-string">&quot;ytickint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">10.0</span>, <span class="ruby-string">&quot;ylabelint&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">20.0</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXB&#39;</span>, <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_nolabels</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYL&#39;</span>, <span class="ruby-keyword">false</span>)
      <span class="ruby-identifier">mdim</span> = <span class="ruby-ivar">@OPT_exch</span> <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">mdim</span>),<span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;exch&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>,
                  <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">0</span>],
                  <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)[<span class="ruby-value">1</span>],
                  <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>), <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">1</span>)
                  )
      <span class="ruby-keyword">if</span> ( <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>)<span class="ruby-operator">*</span><span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>) <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-value">0</span>,<span class="ruby-value">0</span>],[<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>),<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)],<span class="ruby-value">3</span>,<span class="ruby-value">1</span>) <span class="ruby-comment"># ゼロ線を描く</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">title</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">mdim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; mean&quot;</span>, <span class="ruby-value">1</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_title</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYL&#39;</span>, <span class="ruby-keyword">true</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&quot;viewport&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@VIEWPORT</span>)
    <span class="ruby-keyword">end</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-draw_linearline" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_linearline</span><span
            class="method-args">(gp=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="draw_linearline-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1529</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">draw_linearline</span>(<span class="ruby-identifier">gp</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">unit_0</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">flag_0</span> = <span class="ruby-identifier">unit_0</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>)
    <span class="ruby-identifier">unit_1</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>
    <span class="ruby-identifier">flag_1</span> = <span class="ruby-identifier">unit_1</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">index</span> = <span class="ruby-value">1</span>; <span class="ruby-identifier">type</span>  = <span class="ruby-value">1</span>
  <span class="ruby-identifier">line_paras</span> = (<span class="ruby-ivar">@OPT_linearline</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
  <span class="ruby-identifier">line_paras</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">lp</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">axis</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">lp</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*=\s*/</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">axis</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;i&quot;</span>)
      <span class="ruby-identifier">index</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">axis</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;t&quot;</span>)
      <span class="ruby-identifier">type</span>  = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">lp</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;x=y&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">lp</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;y=x&quot;</span>)
      <span class="ruby-identifier">minval</span> = [<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>), <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>)].<span class="ruby-identifier">max</span>
      <span class="ruby-identifier">maxval</span> = [<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>), <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)].<span class="ruby-identifier">min</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-identifier">minval</span>,<span class="ruby-identifier">maxval</span>],[<span class="ruby-identifier">minval</span>,<span class="ruby-identifier">maxval</span>],<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>)
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">lp</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;x^&quot;</span>))
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;linear c*x^p line can be drawn only when itr = 4 (log-log plot)&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>
      <span class="ruby-identifier">cn</span>, <span class="ruby-identifier">pn</span> = <span class="ruby-identifier">lp</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;x^&quot;</span>);<span class="ruby-identifier">pn</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">pn</span>).<span class="ruby-identifier">to_f</span>; <span class="ruby-identifier">cn</span> = ((<span class="ruby-identifier">eval</span> <span class="ruby-identifier">cn</span>) <span class="ruby-operator">||</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">spx</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>); <span class="ruby-identifier">epx</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>); <span class="ruby-identifier">spy</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)
      <span class="ruby-identifier">spy</span> = <span class="ruby-identifier">cn</span><span class="ruby-operator">*</span><span class="ruby-identifier">spx</span><span class="ruby-operator">**</span><span class="ruby-identifier">pn</span>; <span class="ruby-identifier">epy</span> = <span class="ruby-identifier">cn</span><span class="ruby-operator">*</span><span class="ruby-identifier">epx</span><span class="ruby-operator">**</span><span class="ruby-identifier">pn</span>
      <span class="ruby-identifier">ymax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>); <span class="ruby-identifier">ymin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">spy</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ymin</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">spy</span> = <span class="ruby-identifier">ymin</span>; <span class="ruby-identifier">spx</span> = (<span class="ruby-identifier">ymin</span><span class="ruby-operator">/</span><span class="ruby-identifier">cn</span>)<span class="ruby-operator">**</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">pn</span>) <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">epy</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ymin</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">epy</span> = <span class="ruby-identifier">ymin</span>; <span class="ruby-identifier">epx</span> = (<span class="ruby-identifier">ymin</span><span class="ruby-operator">/</span><span class="ruby-identifier">cn</span>)<span class="ruby-operator">**</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">pn</span>) <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">spy</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ymax</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">spy</span> = <span class="ruby-identifier">ymax</span>; <span class="ruby-identifier">spx</span> = (<span class="ruby-identifier">ymax</span><span class="ruby-operator">/</span><span class="ruby-identifier">cn</span>)<span class="ruby-operator">**</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">pn</span>) <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">epy</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ymax</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">epy</span> = <span class="ruby-identifier">ymax</span>; <span class="ruby-identifier">epx</span> = (<span class="ruby-identifier">ymax</span><span class="ruby-operator">/</span><span class="ruby-identifier">cn</span>)<span class="ruby-operator">**</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">pn</span>) <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-identifier">spx</span>,<span class="ruby-identifier">epx</span>],[<span class="ruby-identifier">spy</span>,<span class="ruby-identifier">epy</span>],<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>)
<span class="ruby-comment">#    elsif (axis.include?(&quot;x&quot;) &amp;&amp; value.include?(&quot;y&quot;))</span>
<span class="ruby-comment">#    elsif (axis.include?(&quot;y&quot;) &amp;&amp; value.include?(&quot;x&quot;))</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">axis</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;x&quot;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">ymd2time</span>(<span class="ruby-identifier">unit_0</span>, <span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_exch</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_exch</span>
        <span class="ruby-comment"># ↑ DCL::sgplzuだと、UXMINから1年365日のスケールで座標が取られているみたい。</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_exch</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">ymd2time</span>(<span class="ruby-identifier">unit_1</span>, <span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_1</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_1</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">ymd2time</span>(<span class="ruby-identifier">unit_0</span>, <span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-identifier">value</span>,<span class="ruby-identifier">value</span>],[<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>),<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)],<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>)
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">axis</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;y&quot;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">ymd2time</span>(<span class="ruby-identifier">unit_0</span>, <span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_exch</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_exch</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_exch</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">ymd2time</span>(<span class="ruby-identifier">unit_0</span>, <span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_0</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-identifier">ymd2time</span>(<span class="ruby-identifier">unit_1</span>, <span class="ruby-identifier">value</span>)
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_1</span>
        <span class="ruby-identifier">value</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">value</span> <span class="ruby-operator">-</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>))<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">flag_1</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>),<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>)],[<span class="ruby-identifier">value</span>,<span class="ruby-identifier">value</span>],<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>)
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">axis</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;dx&quot;</span>)
      <span class="ruby-identifier">x</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>); <span class="ruby-identifier">xmax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>); <span class="ruby-identifier">dx</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">x</span> = <span class="ruby-identifier">x</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dx</span>
      <span class="ruby-keyword">while</span> (<span class="ruby-identifier">x</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">xmax</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-identifier">x</span>,<span class="ruby-identifier">x</span>],[<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>),<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)],<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>)
        <span class="ruby-identifier">x</span> = <span class="ruby-identifier">x</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dx</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">axis</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;dy&quot;</span>)
      <span class="ruby-identifier">y</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>); <span class="ruby-identifier">ymax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>); <span class="ruby-identifier">dy</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">y</span> = <span class="ruby-identifier">y</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dy</span>
      <span class="ruby-keyword">while</span> (<span class="ruby-identifier">y</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ymax</span>)
        <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgplzu</span>([<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>),<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>)],[<span class="ruby-identifier">y</span>,<span class="ruby-identifier">y</span>],<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>)
        <span class="ruby-identifier">y</span> = <span class="ruby-identifier">y</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dy</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-draw_multi_vars" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_multi_vars</span><span
            class="method-args">(gp, draw_flag)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="draw_multi_vars-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1138</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">draw_multi_vars</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">draw_flag</span>)

  <span class="ruby-comment">## open work station and setup draw parameters</span>
  <span class="ruby-identifier">window_setup</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>)

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_range</span> <span class="ruby-keyword">and</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_rmap</span>)
    <span class="ruby-identifier">ranges</span> = (<span class="ruby-ivar">@OPT_range</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
    <span class="ruby-identifier">xmin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">1</span>]
    <span class="ruby-identifier">ymin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">1</span>])[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">1</span>])[<span class="ruby-value">1</span>]
    <span class="ruby-identifier">zmin</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">2</span>])[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">zmax</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-identifier">ranges</span>[<span class="ruby-value">2</span>])[<span class="ruby-value">1</span>]
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&quot;window&quot;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>,<span class="ruby-identifier">ymin</span>,<span class="ruby-identifier">ymax</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_fullcolor</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>  <span class="ruby-comment"># itr &gt;= 5 (地図投影)</span>
    <span class="ruby-identifier">title</span> = <span class="ruby-ivar">@OPT_title</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">long_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">name</span> <span class="ruby-comment"># タイトルの自動選択はしない</span>
    <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_anim</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">adim</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axis</span>(<span class="ruby-ivar">@OPT_anim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>
    <span class="ruby-identifier">adim</span> = <span class="ruby-identifier">adim</span>.<span class="ruby-identifier">reverse</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_reverse</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_Gr</span>
    <span class="ruby-identifier">gp_all</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">clone</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">adim</span> = [<span class="ruby-value">1</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">anim_counter</span> = <span class="ruby-value">0</span>

  <span class="ruby-keyword">while</span> (<span class="ruby-identifier">adim</span>[<span class="ruby-value">0</span>])
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_anim</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp_all</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-ivar">@OPT_anim</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">adim</span>[<span class="ruby-value">0</span>]) }
      <span class="ruby-identifier">anim_counter</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">adim</span>.<span class="ruby-identifier">shift</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">draw_flag</span>
  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;scatter&quot;</span>
      <span class="ruby-identifier">xtitle</span>, <span class="ruby-identifier">ytitle</span> = (<span class="ruby-ivar">@OPT_scatter</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;xtitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xtitle</span>, <span class="ruby-string">&quot;ytitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ytitle</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">scatter</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],
                     <span class="ruby-keyword">true</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-ivar">@index_array</span>[<span class="ruby-value">0</span>]),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-ivar">@type_array</span>[<span class="ruby-value">0</span>]),
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;correlation&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">regression_line</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],<span class="ruby-string">&quot;annot_intercept&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>, <span class="ruby-string">&quot;annot_slope&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@annotate</span>, <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-ivar">@index_array</span>[<span class="ruby-value">0</span>])) <span class="ruby-comment"># 回帰直線を引く</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">/</span><span class="ruby-value">2</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">/</span><span class="ruby-value">2</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">scatter</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+2</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+3</span>],
                         <span class="ruby-keyword">true</span>,
                        <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@index_array</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]<span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                        <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@type_array</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]<span class="ruby-operator">||</span><span class="ruby-value">2</span>),
                        <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                        <span class="ruby-string">&quot;correlation&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>)
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">regression_line</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+2</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+3</span>],<span class="ruby-string">&quot;annot_intercept&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,<span class="ruby-string">&quot;annot_slope&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@annotate</span>,  <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@index_array</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>])) <span class="ruby-comment"># 回帰直線を引く</span>

        }
      <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;color_scatter&quot;</span>
      <span class="ruby-identifier">xtitle</span>, <span class="ruby-identifier">ytitle</span> = (<span class="ruby-ivar">@OPT_color_scatter</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_axes</span>(<span class="ruby-string">&quot;xtitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xtitle</span>, <span class="ruby-string">&quot;ytitle&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ytitle</span>)

      <span class="ruby-comment"># tmp = NArray.float(gp[2].length).indgen!+2020</span>
      <span class="ruby-comment"># gp[2].replace_val(tmp)</span>
      <span class="ruby-comment"># gp[5].replace_val(tmp)</span>
      <span class="ruby-comment"># gp[8].replace_val(tmp)</span>


      <span class="ruby-comment"># --color_scatterのときに、2つのgturlしかないときは、最初のgturlの</span>
      <span class="ruby-comment"># ２つ目の軸(緯度を想定), なければ１つめの軸（時間を想定）の値で色付けする。</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">gp</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">length</span>).<span class="ruby-identifier">indgen!</span> <span class="ruby-operator">+</span> <span class="ruby-value">2021</span>)
      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">==</span><span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">gp</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">==</span><span class="ruby-keyword">nil</span>)
        <span class="ruby-identifier">gp</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">color_scatter</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span>],
                     <span class="ruby-keyword">true</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                    <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_index</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                    <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_type</span> <span class="ruby-operator">||</span><span class="ruby-value">2</span>),
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">zmin</span>,
                    <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">zmax</span>,
                    <span class="ruby-string">&quot;nlev&quot;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-ivar">@OPT_sint</span>   <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_interval</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_int</span> ),
                    <span class="ruby-string">&quot;correlation&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>
                     )
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">regression_line</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],<span class="ruby-string">&quot;annot_intercept&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>) <span class="ruby-comment"># 回帰直線を引く</span>

      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">color_bar</span>( <span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">false</span>)

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">/</span><span class="ruby-value">3</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">/</span><span class="ruby-value">3</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
          <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">color_scatter</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+3</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+4</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+5</span>],
                              <span class="ruby-keyword">false</span>,
                              <span class="ruby-string">&quot;index&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@index_array</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]<span class="ruby-operator">||</span><span class="ruby-value">1</span>),
                              <span class="ruby-string">&quot;type&quot;</span> <span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@type_array</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]<span class="ruby-operator">||</span><span class="ruby-value">2</span>),
                              <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                              <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">zmin</span>,
                              <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">zmax</span>,
                              <span class="ruby-string">&quot;correlation&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)
        }
      <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;contour_over_tone&quot;</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_bothsides</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">vxmin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">vxmax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">1</span>]; <span class="ruby-identifier">vymin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">2</span>]; <span class="ruby-identifier">vymax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">3</span>]
        <span class="ruby-identifier">vxlen</span> = <span class="ruby-identifier">vxmax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vxmin</span>; <span class="ruby-identifier">vylen</span> = <span class="ruby-identifier">vymax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vymin</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.5</span> , <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>])
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">title</span> = <span class="ruby-ivar">@OPT_notitle</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &amp; &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">name</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],
                  <span class="ruby-keyword">true</span>,
                  <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">title</span>,
                  <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                  <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                  <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                  <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                  <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                  <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>,
                  <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>,
                  <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                  <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                  <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                  <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                  <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>
                  )
        <span class="ruby-comment"># GGraph.contour(gp[0],</span>
              <span class="ruby-comment">#             true, &quot;title&quot;=&gt;&quot;&quot;,</span>
              <span class="ruby-comment">#             &quot;transpose&quot;=&gt;@OPT_exch,</span>
              <span class="ruby-comment">#             &quot;levels&quot;=&gt;@OPT_slevels,</span>
              <span class="ruby-comment">#             &quot;nozero&quot;=&gt;@OPT_nozero,</span>
        <span class="ruby-comment">#             &quot;label&quot;=&gt;@OPT_label,</span>
        <span class="ruby-comment">#             &quot;xcoord&quot;=&gt;@OPT_xcoord,</span>
        <span class="ruby-comment">#             &quot;ycoord&quot;=&gt;@OPT_ycoord,</span>
        <span class="ruby-comment">#             &quot;log&quot;=&gt;@log_int,</span>
        <span class="ruby-comment">#             &quot;coloring&quot;=&gt;true</span>
        <span class="ruby-comment">#             )</span>


<span class="ruby-comment">#      DCL.sgscmn(5) # 色コンターの色番号</span>
<span class="ruby-comment">#       DCL.udpset(&#39;indxmj&#39;, 25) #計曲線</span>
<span class="ruby-comment">#       DCL.udpset(&#39;indxmn&#39;, 27) #主曲線</span>

      <span class="ruby-identifier">min_crange</span>, <span class="ruby-identifier">max_crange</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_crange</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_linear_contour_options</span>(<span class="ruby-string">&#39;int&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@OPT_cint</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-string">&#39;min&#39;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-identifier">min_crange</span>,<span class="ruby-string">&#39;max&#39;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-identifier">max_crange</span>)
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">contour</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>], <span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_clevels</span>,
                          <span class="ruby-string">&quot;nozero&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_nozero</span>, <span class="ruby-string">&quot;label&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_label</span>, <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                  <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>, <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>, <span class="ruby-string">&quot;coloring&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>)<span class="ruby-comment">#,</span>
<span class="ruby-comment">#                  &quot;clr_min&quot;=&gt;50, &quot;clr_max&quot;=&gt;60, &quot;line_type&quot;=&gt;3 )</span>

<span class="ruby-comment">#      GGraph.contour(gp[2], false, &quot;title&quot;=&gt;&quot;&quot;, &quot;transpose&quot;=&gt;@OPT_exch, &quot;levels&quot;=&gt;@OPT_clevels,</span>
<span class="ruby-comment">#                   &quot;nozero&quot;=&gt;@OPT_nozero, &quot;label&quot;=&gt;@OPT_label, &quot;xcoord&quot;=&gt;@OPT_xcoord,</span>
<span class="ruby-comment">#                   &quot;ycoord&quot;=&gt;@OPT_ycoord, &quot;log&quot;=&gt;@log_int, &quot;coloring&quot;=&gt;true)#,</span>
<span class="ruby-comment">#                   &quot;clr_min&quot;=&gt;50, &quot;clr_max&quot;=&gt;60, &quot;line_type&quot;=&gt;3 )</span>


      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgscmn</span>(<span class="ruby-ivar">@OPT_clrmap</span><span class="ruby-operator">||</span><span class="ruby-value">63</span>) <span class="ruby-comment"># カラーマップ戻す</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_bothsides</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">other_side</span> =  [<span class="ruby-ivar">@map_axis</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+180</span>, <span class="ruby-operator">-</span><span class="ruby-ivar">@map_axis</span>[<span class="ruby-value">1</span>], <span class="ruby-ivar">@map_axis</span>[<span class="ruby-value">2</span>]] <span class="ruby-comment"># 惑星の裏側</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&#39;map_axis&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">other_side</span>,<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxlen</span><span class="ruby-operator">*</span><span class="ruby-value">0.5</span>, <span class="ruby-identifier">vxmax</span>, <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>], <span class="ruby-string">&quot;new_frame&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>)
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],
                    <span class="ruby-keyword">true</span>,
                    <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>,
                    <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                    <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                    <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                    <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                    <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                    <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>,
                    <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>,
                    <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                    <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                    <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                    <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                    <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>
                    )
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgscmn</span>(<span class="ruby-value">5</span>) <span class="ruby-comment"># 白黒コンター</span>
        <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">contour</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],
                          <span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>,
                          <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                          <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_clevels</span>,
                          <span class="ruby-string">&quot;nozero&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_nozero</span>,
                    <span class="ruby-string">&quot;label&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_label</span>,
                    <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                    <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                    <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>,
                    <span class="ruby-string">&quot;coloring&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>
                    )
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgscmn</span>(<span class="ruby-ivar">@OPT_clrmap</span><span class="ruby-operator">||</span><span class="ruby-value">63</span>) <span class="ruby-comment"># カラーマップ戻す</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgsvpt</span>(<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmax</span>, <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">maskshading</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_maskshading</span>

      <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_nocolorbar</span>
<span class="ruby-comment">#      GGraph::color_bar(&quot;left&quot;=&gt; false,&quot;landscape&quot; =&gt; false)</span>
      <span class="ruby-comment"># test for counter</span>
<span class="ruby-comment">#      counter(&quot;t = &quot;, 0.0, 1.00, &quot; Earth days&quot;)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.135 , 0.3725, &quot;90&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.865 , 0.3725, &quot;90&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.3255 , 0.185, &quot;0&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.676 , 0.185, &quot;0&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.3255 , 0.56, &quot;180&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.676 , 0.56, &quot;180&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.5 , 0.375, &quot;270&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 993)</span>
<span class="ruby-comment">#      DCL::sgtxzr(0.72 , 0.1475, &quot;[m s-1]&quot;, DCL.uzpget(&#39;rsizec1&#39;)*0.75, 0, 0, 3)</span>


  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;histogram2D&quot;</span>
      <span class="ruby-identifier">nb</span> = <span class="ruby-operator">-</span>(<span class="ruby-ivar">@OPT_int</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> ((<span class="ruby-ivar">@OPT_int</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>)
      <span class="ruby-identifier">gph</span> = <span class="ruby-constant">GAnalysis</span>.<span class="ruby-identifier">histogram2D</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],<span class="ruby-string">&quot;nbins0&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">nb</span>,<span class="ruby-string">&quot;nbins1&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">nb</span>,
                                             <span class="ruby-string">&quot;min0&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xmin</span>,<span class="ruby-string">&quot;max0&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xmax</span>,
                                             <span class="ruby-string">&quot;min1&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ymin</span>,<span class="ruby-string">&quot;max1&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ymax</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_histogram2D</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span>)
        <span class="ruby-identifier">gph</span> = <span class="ruby-identifier">gph</span><span class="ruby-operator">/</span><span class="ruby-identifier">gph</span>.<span class="ruby-identifier">sum</span><span class="ruby-operator">*</span><span class="ruby-value">100</span>
        <span class="ruby-identifier">gph</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;ratio (%) of bins&quot;</span>)
        <span class="ruby-identifier">gph</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;%&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gph</span>,<span class="ruby-keyword">true</span>,
                  <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                  <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                  <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                  <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                  <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                  <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_srange</span>)[<span class="ruby-value">0</span>],
                  <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_srange</span>)[<span class="ruby-value">1</span>],
                  <span class="ruby-string">&quot;nlev&quot;</span><span class="ruby-operator">=&gt;</span> (<span class="ruby-ivar">@OPT_sint</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-operator">-</span><span class="ruby-ivar">@OPT_sint</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>),
                  <span class="ruby-string">&quot;interval&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_sint</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@OPT_sint</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>),
                  <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,
                  <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>
                  )
      <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)

    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;rmap&quot;</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_rmap</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@OPT_rmap</span> ) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">dim</span> = <span class="ruby-ivar">@OPT_rmap</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">dim</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">index</span>(<span class="ruby-ivar">@OPT_rmap</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">gprmap</span>, <span class="ruby-identifier">ndiv</span> = <span class="ruby-identifier">corelation</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">dim</span>)
  <span class="ruby-comment">#    gprmap.set_att(&quot;long_name&quot;,&quot;correlation along &quot;+gp[0].axnames[dim])</span>
      <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gprmap</span>,<span class="ruby-keyword">true</span>,
                  <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                  <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                  <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                  <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                  <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                  <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                  <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>,
                  <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>,
                  <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                  <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                  <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                  <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                  <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>
                  )
      <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>)

    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;fullcolor2&quot;</span>


      <span class="ruby-identifier">tone_full</span>(<span class="ruby-identifier">gp</span>,
                  <span class="ruby-keyword">true</span>,
                  <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>,
                  <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                  <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                  <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                  <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>,
                  <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                  <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                  <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>,
                  <span class="ruby-string">&quot;min&quot;</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">ymin</span>],
                  <span class="ruby-string">&quot;max&quot;</span> <span class="ruby-operator">=&gt;</span> [<span class="ruby-identifier">xmax</span>,<span class="ruby-identifier">ymax</span>]
                  )
      <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;vector&quot;</span>
        <span class="ruby-identifier">londim</span>, <span class="ruby-identifier">latdim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>])
        <span class="ruby-ivar">@xintv</span>, <span class="ruby-ivar">@yintv</span> = <span class="ruby-ivar">@OPT_vint</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_vint</span>
        <span class="ruby-ivar">@xintv</span> = (<span class="ruby-ivar">@xintv</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">30</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_i</span>
        <span class="ruby-ivar">@yintv</span> = (<span class="ruby-ivar">@yintv</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-ivar">@xintv</span><span class="ruby-operator">*</span>(<span class="ruby-ivar">@OPT_aspect</span><span class="ruby-operator">||</span><span class="ruby-value">2</span>).<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">to_i</span>
        <span class="ruby-ivar">@vfact</span> = (<span class="ruby-ivar">@OPT_vfact</span> <span class="ruby-operator">||</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_f</span>
        <span class="ruby-ivar">@vkeep</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">anim_counter</span> <span class="ruby-operator">!=</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_vkeep</span> )
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span> <span class="ruby-operator">==</span> <span class="ruby-string">&#39;5&#39;</span>) <span class="ruby-keyword">then</span>
           <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">vector</span>( <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>], <span class="ruby-keyword">true</span>,
                         <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>, <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>,
                         <span class="ruby-string">&quot;flow_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>,  <span class="ruby-string">&quot;flow_itr5&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,     <span class="ruby-string">&quot;xintv&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@xintv</span>,
                         <span class="ruby-string">&quot;yintv&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@yintv</span>,     <span class="ruby-string">&quot;factor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vfact</span>,      <span class="ruby-string">&quot;unit_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,
                         <span class="ruby-string">&quot;max_unit_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>, <span class="ruby-string">&quot;ux_unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@ux_unit</span>, <span class="ruby-string">&quot;uy_unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@uy_unit</span>,
                         <span class="ruby-string">&quot;keep&quot;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vkeep</span>)

        <span class="ruby-keyword">elsif</span> ( (<span class="ruby-identifier">londim</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">latdim</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-operator">||</span> (<span class="ruby-identifier">londim</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">latdim</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>) ) <span class="ruby-keyword">then</span> <span class="ruby-comment"># meridonal vector plot</span>
          <span class="ruby-identifier">require</span> <span class="ruby-string">&#39;numru/ggraph_on_merdional_section&#39;</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># vectors only</span>
            <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">vector_on_merdional_section</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>], <span class="ruby-keyword">true</span>,
                              <span class="ruby-string">&#39;fact&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vfact</span>, <span class="ruby-string">&#39;xintv&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">6</span>, <span class="ruby-string">&#39;yintv&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1</span>,<span class="ruby-string">&#39;unit&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>, <span class="ruby-string">&#39;annot&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;use_before_scale&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@vkeep</span>)
          <span class="ruby-keyword">else</span>
            <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-keyword">true</span>,
                              <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                              <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                              <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>, <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                              <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>, <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>, <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                              <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                              <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>, <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                              <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>
                              )
            <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_nocolorbar</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span>]) <span class="ruby-keyword">then</span>
              <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_linear_contour_options</span>(<span class="ruby-string">&#39;int&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@OPT_cint</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-string">&#39;min&#39;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-identifier">min_crange</span>,<span class="ruby-string">&#39;max&#39;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-identifier">max_crange</span>)
              <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">contour</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span>], <span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_clevels</span>,
                            <span class="ruby-string">&quot;nozero&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_nozero</span>, <span class="ruby-string">&quot;label&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_label</span>, <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                            <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>, <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>, <span class="ruby-string">&quot;coloring&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span> )
            <span class="ruby-keyword">end</span>
            <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">vector_on_merdional_section</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span>], <span class="ruby-keyword">false</span>,
                              <span class="ruby-string">&#39;fact&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vfact</span>, <span class="ruby-string">&#39;xintv&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@xintv</span>, <span class="ruby-string">&#39;yintv&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@yintv</span>,<span class="ruby-string">&#39;unit&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>, <span class="ruby-string">&#39;annot&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;use_before_scale&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@vkeep</span>)

            <span class="ruby-comment"># DCL.ugpset(&#39;index&#39;,13) # ベクトルのラインインデックス</span>
            <span class="ruby-comment"># GGraph.vector_on_merdional_section(gp[1]*gp[2].le(0), gp[2]*gp[2].le(0), false,</span>
            <span class="ruby-comment">#                   &#39;fact&#39;=&gt;@vfact, &#39;xintv&#39;=&gt;6, &#39;yintv&#39;=&gt;1,&#39;unit&#39;=&gt;true, &#39;annot&#39;=&gt;false, &quot;use_before_scale&quot; =&gt; (anim_counter != 1))</span>
            <span class="ruby-comment"># DCL.ugpset(&#39;index&#39;,23) # ベクトルのラインインデックス</span>
            <span class="ruby-comment"># GGraph.vector_on_merdional_section(gp[1]*gp[2].ge(0), gp[2]*gp[2].ge(0), false,</span>
            <span class="ruby-comment">#                   &#39;fact&#39;=&gt;@vfact, &#39;xintv&#39;=&gt;6, &#39;yintv&#39;=&gt;1,&#39;unit&#39;=&gt;true, &#39;annot&#39;=&gt;false, &quot;use_before_scale&quot; =&gt; true)</span>

                              <span class="ruby-identifier">min_crange</span>, <span class="ruby-identifier">max_crange</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_crange</span>)
          <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">else</span> <span class="ruby-comment"># horizontal vector plots</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># vectors only</span>
            <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">vector</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>], <span class="ruby-keyword">true</span>,
                             <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                             <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;flow_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,
                             <span class="ruby-string">&quot;xintv&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@xintv</span>, <span class="ruby-string">&quot;yintv&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@yintv</span>,
                             <span class="ruby-string">&quot;factor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vfact</span>, <span class="ruby-string">&quot;unit_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,
                             <span class="ruby-string">&quot;max_unit_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;ux_unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@ux_unit</span>,
                             <span class="ruby-string">&quot;uy_unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@uy_unit</span>, <span class="ruby-string">&quot;keep&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vkeep</span>
                             )
          <span class="ruby-keyword">else</span>
            <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>],<span class="ruby-keyword">true</span>,
                              <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                              <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_slevels</span>,
                              <span class="ruby-string">&quot;patterns&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_patterns</span>, <span class="ruby-string">&quot;auto&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@auto</span>,
                              <span class="ruby-string">&quot;tonf&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonf</span>, <span class="ruby-string">&quot;tonb&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonb</span>, <span class="ruby-string">&quot;tonc&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tonc</span>,
                              <span class="ruby-string">&quot;fullcolor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@tone_fullcolor</span>,
                              <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>, <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>,
                              <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>
                              )
            <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;left&quot;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_nocolorbar</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span>]) <span class="ruby-keyword">then</span>
              <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_linear_contour_options</span>(<span class="ruby-string">&#39;int&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@OPT_cint</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-string">&#39;min&#39;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-identifier">min_crange</span>,<span class="ruby-string">&#39;max&#39;</span> <span class="ruby-operator">=&gt;</span><span class="ruby-identifier">max_crange</span>)
              <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">contour</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">3</span>], <span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>, <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;levels&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_clevels</span>,
                            <span class="ruby-string">&quot;nozero&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_nozero</span>, <span class="ruby-string">&quot;label&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_label</span>, <span class="ruby-string">&quot;xcoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_xcoord</span>,
                            <span class="ruby-string">&quot;ycoord&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_ycoord</span>, <span class="ruby-string">&quot;log&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@log_int</span>, <span class="ruby-string">&quot;coloring&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span> )
            <span class="ruby-keyword">end</span>
            <span class="ruby-comment"># DCL.ugpset(&quot;index&quot;,995)</span>
            <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">vector</span>( <span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">gp</span>[<span class="ruby-value">2</span>], <span class="ruby-keyword">false</span>,
                            <span class="ruby-string">&quot;title&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_title</span>, <span class="ruby-string">&quot;annotate&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@annotate</span>,
                            <span class="ruby-string">&quot;exchange&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>, <span class="ruby-string">&quot;flow_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,
                            <span class="ruby-string">&quot;xintv&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@xintv</span>, <span class="ruby-string">&quot;yintv&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@yintv</span>,
                            <span class="ruby-string">&quot;factor&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vfact</span>, <span class="ruby-string">&quot;unit_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,
                            <span class="ruby-string">&quot;max_unit_vect&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;ux_unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@ux_unit</span>,
                            <span class="ruby-string">&quot;uy_unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@uy_unit</span>, <span class="ruby-string">&quot;keep&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@vkeep</span>
                            )
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">maskshading</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_maskshading</span>

    <span class="ruby-keyword">end</span> <span class="ruby-comment"># end case</span>
  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
    <span class="ruby-identifier">draw_linearline</span>(<span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_linearline</span>
  <span class="ruby-comment">#-------------------------------------------------------------------------------------------------</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">5</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">title</span>(<span class="ruby-identifier">title</span>)
        <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-identifier">title</span>
        <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">long_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">title</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">name</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">title</span>(<span class="ruby-ivar">@OPT_subtitle</span>, <span class="ruby-value">1</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_subtitle</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># end while (for anim loop)</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-draw_setup" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_setup</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="draw_setup-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 151</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">draw_setup</span>

  <span class="ruby-comment"># set missing value</span>
  <span class="ruby-constant">DCLExt</span>.<span class="ruby-identifier">gl_set_params</span>(<span class="ruby-string">&#39;lmiss&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)<span class="ruby-comment">#, &#39;rmiss&#39;=&gt;-999)</span>

  <span class="ruby-comment"># fontsize</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&#39;lcntl&#39;</span>, <span class="ruby-keyword">true</span>)
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&#39;lfull&#39;</span>, <span class="ruby-keyword">true</span>)               <span class="ruby-comment"># use full area in the window</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&#39;lfprop&#39;</span>,<span class="ruby-keyword">true</span>)               <span class="ruby-comment"># use proportional font</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uscset</span>(<span class="ruby-string">&#39;cyspos&#39;</span>, <span class="ruby-string">&#39;B&#39;</span> )              <span class="ruby-comment"># move unit y axis</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgiset</span>(<span class="ruby-string">&#39;ifont&#39;</span>, <span class="ruby-value">2</span>)
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzfact</span>(<span class="ruby-value">0.6</span><span class="ruby-operator">*</span> (<span class="ruby-ivar">@OPT_fact</span><span class="ruby-operator">||</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_f</span> ) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">$flag_uzfact</span>
  <span class="ruby-identifier">$flag_uzfact</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">$flag_uzfact</span>

<span class="ruby-comment">#  DCL.udpset(&#39;icycle&#39;, 5)</span>
 <span class="ruby-comment">#  DCL.udpset(&#39;label&#39;, false) #ラベルの有無</span>
 <span class="ruby-comment">#  DCL.udpset(&#39;lmsg&#39;, false) #等値線間隔表示の有無</span>
 <span class="ruby-comment"># DCL.udpset(&#39;indxmj&#39;, 1) #計曲線</span>
 <span class="ruby-comment"># DCL.udpset(&#39;indxmn&#39;, 1) #主曲線</span>


  <span class="ruby-comment"># 線の色と太さの設定</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_miscindex</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-comment"># マージン</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&#39;index&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>)
    <span class="ruby-comment"># 等値線</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpset</span>(<span class="ruby-string">&#39;indxmj&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#計曲線</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpset</span>(<span class="ruby-string">&#39;indxmn&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#主曲線</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpset</span>(<span class="ruby-string">&#39;label&#39;</span>, <span class="ruby-keyword">false</span>) <span class="ruby-comment">#ラベルの有無</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udpset</span>(<span class="ruby-string">&#39;ldash&#39;</span>, <span class="ruby-keyword">false</span>) <span class="ruby-comment">#負を破線にするかどうか</span>

    <span class="ruby-comment"># ベクトル図</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">ugpset</span>(<span class="ruby-string">&#39;index&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#ベクトル</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">ugpset</span>(<span class="ruby-string">&#39;iuindx&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#単位ベクトルのタイトル</span>
    <span class="ruby-comment"># 折れ線図</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&#39;indexc&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#ラベル</span>
    <span class="ruby-comment"># 直交直線軸</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&#39;indext1&#39;</span>,<span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment"># 小さい座標軸の目盛</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&#39;indext2&#39;</span>,<span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment"># 大きい座標軸の目盛</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&#39;indexl1&#39;</span>,<span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment"># 小さいラベル、タイトル</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&#39;indexl2&#39;</span>,<span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment"># 大きいラベル、タイトル</span>
  <span class="ruby-comment">#  DCL.uzpset(&#39;rsizec2&#39;, 0.01)</span>
    <span class="ruby-comment"># 地図</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&#39;indexmj&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#計曲線</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&#39;indexmn&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#主曲線</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&#39;indexbnd&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#地図のふち</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&#39;indexout&#39;</span>, <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-comment">#海岸線</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&#39;lgridmj&#39;</span>,<span class="ruby-keyword">true</span>) <span class="ruby-comment"># 緯経線(major)</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&#39;lgridmn&#39;</span>,<span class="ruby-keyword">true</span>) <span class="ruby-comment"># 緯経線(minor)</span>

  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># viewport size</span>
  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&#39;viewport&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@VIEWPORT</span>)

  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>( <span class="ruby-string">&#39;itr&#39;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_itr</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>) <span class="ruby-operator">?</span> <span class="ruby-value">1</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@OPT_itr</span>.<span class="ruby-identifier">to_i</span> )
  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&quot;xrev&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;units:mb,units:hPa,units:millibar,positive:down&quot;</span>,
                 <span class="ruby-string">&quot;yrev&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;units:mb,units:hPa,units:millibar,positive:down&quot;</span>)

  <span class="ruby-comment"># viewport layout</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sldiv</span>)
    <span class="ruby-identifier">sldiv_ary</span> = <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sldiv</span>(<span class="ruby-identifier">sldiv_ary</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">sldiv_ary</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>,<span class="ruby-identifier">sldiv_ary</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># margin size</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">slmgn</span>(<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0.05</span>,<span class="ruby-value">0</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_panelfit</span>


  <span class="ruby-comment"># set options</span>
  <span class="ruby-identifier">min_range</span>,  <span class="ruby-identifier">max_range</span>  = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_range</span>)
  <span class="ruby-identifier">min_crange</span>, <span class="ruby-identifier">max_crange</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_crange</span>)
  <span class="ruby-identifier">min_srange</span>, <span class="ruby-identifier">max_srange</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_srange</span>)
  <span class="ruby-identifier">min_irange</span>, <span class="ruby-identifier">max_irange</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_irange</span>)

  <span class="ruby-identifier">min_clr</span>, <span class="ruby-identifier">max_clr</span> = <span class="ruby-identifier">__split_range</span>(<span class="ruby-ivar">@OPT_clr_range</span>)

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_clr_range</span>) <span class="ruby-comment"># set color range</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uepset</span>(<span class="ruby-string">&quot;icolor1&quot;</span>, <span class="ruby-identifier">min_clr</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uepset</span>(<span class="ruby-string">&quot;icolor2&quot;</span>,<span class="ruby-identifier">max_clr</span>)
  <span class="ruby-keyword">end</span>


  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_linear_contour_options</span>(
                                    <span class="ruby-string">&#39;int&#39;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-ivar">@OPT_cint</span>   <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_interval</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_int</span> ).<span class="ruby-identifier">to_f</span>,
                                    <span class="ruby-string">&#39;min&#39;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-identifier">min_crange</span>  <span class="ruby-operator">||</span> <span class="ruby-identifier">min_range</span> ),
                                    <span class="ruby-string">&#39;max&#39;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-identifier">max_crange</span>  <span class="ruby-operator">||</span> <span class="ruby-identifier">max_range</span> )
                                    )
  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_linear_tone_options</span>(
                                    <span class="ruby-string">&#39;int&#39;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-ivar">@OPT_sint</span>   <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_interval</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_int</span> ).<span class="ruby-identifier">to_f</span>,
                                    <span class="ruby-string">&#39;min&#39;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-identifier">min_srange</span>  <span class="ruby-operator">||</span> <span class="ruby-identifier">min_irange</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">min_range</span>),
                                    <span class="ruby-string">&#39;max&#39;</span> <span class="ruby-operator">=&gt;</span> ( <span class="ruby-identifier">max_srange</span>  <span class="ruby-operator">||</span> <span class="ruby-identifier">max_irange</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">max_range</span>),
                                    <span class="ruby-string">&#39;inf_max&#39;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@OPT_irange</span>, <span class="ruby-string">&#39;inf_min&#39;</span><span class="ruby-operator">=&gt;</span> <span class="ruby-ivar">@OPT_irange</span>,
                                    <span class="ruby-string">&#39;lbound&#39;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-ivar">@OPT_srange</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_irange</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_range</span>) <span class="ruby-comment"># if false, min and/or max may be shifted automatically.</span>
                                 )
  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@OPT_clevels</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_levels</span> )
    <span class="ruby-ivar">@OPT_label</span>=(<span class="ruby-ivar">@OPT_clevels</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_levels</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)
<span class="ruby-comment">#    @OPT_label=[&quot;10|-10\&quot;&quot;,&quot;&quot;,&quot;10|-8\&quot;&quot;,&quot;&quot;,&quot;10|-6\&quot;&quot;,&quot;&quot;,&quot;10|-4\&quot;&quot;,&quot;&quot;,&quot;10|-2\&quot;&quot;,&quot;&quot;,&quot;10|0\&quot;&quot;,&quot;&quot;,&quot;10|2\&quot;&quot;,&quot;&quot;,&quot;10|4\&quot;&quot;]</span>
    <span class="ruby-ivar">@OPT_clevels</span>=(<span class="ruby-ivar">@OPT_clevels</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_levels</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>).<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_f</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@OPT_slevels</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_levels</span> )
    <span class="ruby-ivar">@OPT_slevels</span>=(<span class="ruby-ivar">@OPT_slevels</span><span class="ruby-operator">||</span><span class="ruby-ivar">@OPT_levels</span>).<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>).<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_f</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@OPT_patterns</span> )
    <span class="ruby-ivar">@OPT_patterns</span>=<span class="ruby-ivar">@OPT_patterns</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>).<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_f</span> }
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># set tone levels and pattern with +/- infinity =&gt; # not used since gphys 1.5.0.1</span>
  <span class="ruby-comment"># if (@OPT_irange) then</span>
  <span class="ruby-comment">#   min_range,  max_range  = __split_range(@OPT_irange)</span>
  <span class="ruby-comment">#   if (@OPT_int) then</span>
  <span class="ruby-comment">#     if (@OPT_int.to_f &gt; 0) then</span>
  <span class="ruby-comment">#       dx = @OPT_int.to_f</span>
  <span class="ruby-comment">#       nlev = ((max_range - min_range)/dx).to_i</span>
  <span class="ruby-comment">#     elsif (@OPT_int.to_i &lt; 0) then</span>
  <span class="ruby-comment">#       nlev = -@OPT_int.to_i</span>
  <span class="ruby-comment">#       dx = (max_range - min_range)/nlev</span>
  <span class="ruby-comment">#     end</span>
  <span class="ruby-comment">#   else</span>
  <span class="ruby-comment">#     nlev = 10 # default number of patterns within given range</span>
  <span class="ruby-comment">#     dx = (max_range - min_range)/nlev</span>
  <span class="ruby-comment">#   end</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   levels = Array.new(nlev+1)</span>
  <span class="ruby-comment">#   (nlev+1).times{|i| levels[i] = min_range + dx*i }</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment">#   dx = (DCL.uepget(&quot;icolor2&quot;).to_f-DCL.uepget(&quot;icolor1&quot;).to_f)/(nlev+1)</span>
  <span class="ruby-comment">#   patterns = Array.new(nlev+2)</span>
  <span class="ruby-comment">#   (nlev+2).times{|i| patterns[i] = (DCL.uepget(&quot;icolor1&quot;).to_i + (dx*i).to_i)*1000 + 999 }</span>
  <span class="ruby-comment">#   @OPT_slevels = levels</span>
  <span class="ruby-comment">#   @OPT_patterns = patterns</span>
  <span class="ruby-comment">#   @OPT_clevels = levels unless (@OPT_clevels or @OPT_cint)</span>
  <span class="ruby-comment"># end</span>




  <span class="ruby-comment"># similar projection</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_similar</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-regexp">/([\d\-.]*),([\d\-.]*),([\d\-.]*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@OPT_similar</span>
      <span class="ruby-identifier">similar</span>=[<span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-node">$2</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-node">$3</span>.<span class="ruby-identifier">to_f</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-regexp">/([\d\-.]*),([\d\-.]*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@OPT_similar</span>
      <span class="ruby-identifier">similar</span>=[<span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-node">$2</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-value">0</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-regexp">/([\d\-.]*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@OPT_similar</span>
      <span class="ruby-identifier">similar</span>=[<span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&#39;similar&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">similar</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># similar projection</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_map_axis</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-regexp">/([\d\-.]*),([\d\-.]*),([\d\-.]*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@OPT_map_axis</span>
      <span class="ruby-ivar">@map_axis</span>=[<span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-node">$2</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-node">$3</span>.<span class="ruby-identifier">to_f</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-regexp">/([\d\-.]*),([\d\-.]*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@OPT_map_axis</span>
      <span class="ruby-ivar">@map_axis</span>=[<span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-node">$2</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-value">0</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-regexp">/([\d\-.]*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-ivar">@OPT_similar</span>
      <span class="ruby-ivar">@map_axis</span>=[<span class="ruby-node">$1</span>.<span class="ruby-identifier">to_f</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&#39;map_axis&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@map_axis</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># clipping parameter</span>
  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@OPT_map_radius</span> )
    <span class="ruby-identifier">map_radius</span>=<span class="ruby-ivar">@OPT_map_radius</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">map_radius</span>=<span class="ruby-value">90.0</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_fig</span>(<span class="ruby-string">&#39;map_radius&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">map_radius</span>)

  <span class="ruby-comment"># map</span>
  <span class="ruby-keyword">if</span> ( <span class="ruby-ivar">@OPT_m</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_map</span>)
    <span class="ruby-identifier">map_type</span> = <span class="ruby-string">&quot;coast_world&quot;</span>     <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_m</span>
    <span class="ruby-identifier">map_type</span> = <span class="ruby-ivar">@OPT_map</span>          <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_map</span>
    <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">set_map</span>(<span class="ruby-identifier">map_type</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&quot;lgridmj&quot;</span>,<span class="ruby-keyword">false</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&quot;lgridmn&quot;</span>,<span class="ruby-keyword">false</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&quot;indexmj&quot;</span>,<span class="ruby-value">1</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpset</span>(<span class="ruby-string">&quot;itypemn&quot;</span>,<span class="ruby-value">1</span>)

    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">umpmap</span>(<span class="ruby-identifier">map_type</span>)
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># time axis</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_time_ax</span>)
    <span class="ruby-ivar">@OPT_time_ax</span> = <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_time_ax</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;false&quot;</span>
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_axes</span>(<span class="ruby-string">&#39;time_ax&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_time_ax</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xint</span>)
    <span class="ruby-identifier">xint</span>, <span class="ruby-identifier">xint_div</span> = <span class="ruby-ivar">@OPT_xint</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>); <span class="ruby-identifier">xint_div</span> = <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">xint_div</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_axes</span>(<span class="ruby-string">&#39;xtickint&#39;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-identifier">xint</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">xint_div</span>.<span class="ruby-identifier">to_i</span> )); <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_axes</span>(<span class="ruby-string">&#39;xlabelint&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">xint</span>.<span class="ruby-identifier">to_f</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_yint</span>)
    <span class="ruby-identifier">yint</span>, <span class="ruby-identifier">yint_div</span> = <span class="ruby-ivar">@OPT_yint</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>); <span class="ruby-identifier">yint_div</span> = <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">yint_div</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_axes</span>(<span class="ruby-string">&#39;ytickint&#39;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-identifier">yint</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">yint_div</span>.<span class="ruby-identifier">to_i</span> )); <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_axes</span>(<span class="ruby-string">&#39;ylabelint&#39;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">yint</span>.<span class="ruby-identifier">to_f</span>)
  <span class="ruby-keyword">end</span>


  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nolabels</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">set_axes</span>(<span class="ruby-string">&quot;yunits&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;&quot;</span>)
    <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYL&#39;</span>,<span class="ruby-keyword">false</span>); <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELYR&#39;</span>,<span class="ruby-keyword">false</span>)
    <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXT&#39;</span>,<span class="ruby-keyword">false</span>);<span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">uzlset</span>(<span class="ruby-string">&#39;LABELXB&#39;</span>,<span class="ruby-keyword">false</span>)
  <span class="ruby-keyword">end</span>



  <span class="ruby-comment"># DCL::sgiset(&#39;NBITS&#39;, 32) # ラインタイプの指定を32bitに</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-draw_text" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">draw_text</span><span
            class="method-args">(text, gary)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="draw_text-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1765</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">draw_text</span>(<span class="ruby-identifier">text</span>, <span class="ruby-identifier">gary</span>)
  <span class="ruby-identifier">vxmin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">vxmax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">1</span>]; <span class="ruby-identifier">vymin</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">2</span>]; <span class="ruby-identifier">vymax</span> = <span class="ruby-ivar">@VIEWPORT</span>[<span class="ruby-value">3</span>]
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">grfrm</span> ; <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">grstrn</span>(<span class="ruby-value">1</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">grsvpt</span>(<span class="ruby-identifier">vxmin</span>,<span class="ruby-identifier">vxmax</span>,<span class="ruby-identifier">vymin</span>,<span class="ruby-identifier">vymax</span>)
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">grswnd</span>(<span class="ruby-value">0</span>,<span class="ruby-value">1</span>,<span class="ruby-value">0</span>,<span class="ruby-value">1</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">grstrf</span>
  <span class="ruby-identifier">rsizel1</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&quot;rsizel1&quot;</span>); <span class="ruby-identifier">charsize</span> = <span class="ruby-value">0.025</span>; <span class="ruby-identifier">charindex</span> = <span class="ruby-value">3</span>
  <span class="ruby-identifier">charfact</span> = <span class="ruby-identifier">charsize</span><span class="ruby-operator">/</span><span class="ruby-identifier">rsizel1</span>; <span class="ruby-identifier">offset</span> = <span class="ruby-value">0.0</span>

  <span class="ruby-comment"># large horizontal color bar</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@textbox_lc</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gary</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">GGraph</span><span class="ruby-operator">::</span><span class="ruby-identifier">color_bar</span>(<span class="ruby-string">&quot;top&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;landscape&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">true</span>,<span class="ruby-string">&quot;title&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;[&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gary</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>,
                        <span class="ruby-string">&quot;voff&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">-0.01</span>, <span class="ruby-string">&quot;vlength&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-identifier">vxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vxmin</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.80</span>, <span class="ruby-string">&quot;vwidth&quot;</span><span class="ruby-operator">=&gt;</span>(<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.1</span>,
                        <span class="ruby-string">&quot;charfact&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">charfact</span>)
      <span class="ruby-identifier">offset</span> = (<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">charsize</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># large legend of line plot</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gary</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">com_block</span> = <span class="ruby-identifier">common_blocks</span>(<span class="ruby-ivar">@sources</span>[<span class="ruby-operator">-</span><span class="ruby-ivar">@Overplot_max</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-ivar">@Overplot_max</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">i</span><span class="ruby-operator">==</span><span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">first</span> = <span class="ruby-keyword">true</span>; <span class="ruby-identifier">vy</span>=<span class="ruby-identifier">vymax</span>; <span class="ruby-identifier">vx</span>=<span class="ruby-identifier">vxmin</span><span class="ruby-operator">*</span><span class="ruby-value">1.1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">first</span> = <span class="ruby-keyword">false</span>; <span class="ruby-identifier">vy</span>=<span class="ruby-keyword">nil</span>; <span class="ruby-identifier">vx</span>=<span class="ruby-identifier">vxmin</span><span class="ruby-operator">*</span><span class="ruby-value">1.1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nocolor</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">index</span> = <span class="ruby-value">3</span>; <span class="ruby-identifier">type</span> =<span class="ruby-ivar">@type_array</span>[<span class="ruby-identifier">i</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">index</span>=<span class="ruby-ivar">@index_array</span>[<span class="ruby-identifier">i</span>]<span class="ruby-value">+2</span>; <span class="ruby-identifier">type</span> = <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">line</span> = (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_mark</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span>
        <span class="ruby-identifier">size</span>=<span class="ruby-identifier">charsize</span>; <span class="ruby-identifier">dx</span>=<span class="ruby-keyword">nil</span>; <span class="ruby-identifier">mark_size</span>=<span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">legend</span> = <span class="ruby-ivar">@sources</span>[<span class="ruby-operator">-</span><span class="ruby-ivar">@Overplot_max</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span>]
        <span class="ruby-identifier">com_block</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">legend</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-identifier">s</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">sub!</span>(<span class="ruby-string">&quot;__&quot;</span>,<span class="ruby-string">&quot;_&quot;</span>) }
        <span class="ruby-identifier">legend</span> = <span class="ruby-identifier">legend</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">legend</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;_&quot;</span>
        <span class="ruby-identifier">legend</span> = <span class="ruby-identifier">legend</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">legend</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&quot;_&quot;</span>
        <span class="ruby-constant">DCLExt</span><span class="ruby-operator">::</span><span class="ruby-identifier">legend</span>(<span class="ruby-identifier">legend</span>,<span class="ruby-identifier">type</span>,<span class="ruby-identifier">index</span>,<span class="ruby-identifier">line</span>,<span class="ruby-identifier">size</span>,<span class="ruby-identifier">vx</span>,<span class="ruby-identifier">dx</span>,<span class="ruby-identifier">vy</span>,<span class="ruby-identifier">first</span>)
    }
    <span class="ruby-identifier">offset</span> = (<span class="ruby-ivar">@Overplot_max</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">charsize</span><span class="ruby-operator">*</span><span class="ruby-value">1.5</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">charsize</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span> <span class="ruby-identifier">offset</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgtxzv</span>(<span class="ruby-identifier">vxmin</span>,<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">offset</span>,<span class="ruby-identifier">text</span>,<span class="ruby-identifier">charsize</span>,<span class="ruby-value">0</span>,<span class="ruby-value">0</span>,<span class="ruby-identifier">charindex</span>) <span class="ruby-comment"># draw text</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-each_along_dims" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">each_along_dims</span><span
            class="method-args">(gphys, loopdim) { |cut(dimname=&gt;x)| ... }</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="each_along_dims-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 5</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">each_along_dims</span>(<span class="ruby-identifier">gphys</span>, <span class="ruby-identifier">loopdim</span>)

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>,<span class="ruby-string">&quot;1st argument must be an GPhys.&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">GPhys</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">loopdim</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
    <span class="ruby-identifier">dimname</span> = <span class="ruby-identifier">loopdim</span>
  <span class="ruby-keyword">elsif</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">loopdim</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">dimname</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">loopdim</span>).<span class="ruby-identifier">name</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">dimname</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">loopdim</span>).<span class="ruby-identifier">name</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>,<span class="ruby-string">&quot;loopdims must consist of Integer and/or String&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">loopdim_na</span> = <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">dimname</span>).<span class="ruby-identifier">val</span>                      <span class="ruby-comment"># get coord ary</span>
  <span class="ruby-identifier">loopdim_na</span> = <span class="ruby-identifier">loopdim_na</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_reverse</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_Gr</span>  <span class="ruby-comment"># reverse</span>
  <span class="ruby-identifier">loopdim_na</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">yield</span>( <span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">dimname</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">x</span>) )
  }
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-epflux" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">epflux</span><span
            class="method-args">(gp_u,gp_v,gp_omega,gp_t)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>EP-flux</p>
          
          

          
          <div class="method-source-code" id="epflux-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 300</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">epflux</span>(<span class="ruby-identifier">gp_u</span>,<span class="ruby-identifier">gp_v</span>,<span class="ruby-identifier">gp_omega</span>,<span class="ruby-identifier">gp_t</span>)
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Caution: EP-flux calculation requires *** p-coordinate *** for vertical axis. \n&quot;</span>
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;numru/gphys/ep_flux&quot;</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">radius</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">rot_period</span>=<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">omega</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">g_forces</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span>.<span class="ruby-identifier">g</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">p00</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">P00</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">gas_const</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">R</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">cp</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">Cp</span>
<span class="ruby-comment">#  GPhys::EP_Flux.scale_height=UNumeric.new(16000.0,  &quot;m&quot;) # set scale_height if needed</span>
  <span class="ruby-identifier">ofile</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">create</span>(<span class="ruby-string">&quot;epflux.nc&quot;</span>)

  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;         Scale height of #{GPhys::EP_Flux.scale_height} is used.\n&quot;</span>

  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">each_along_dims_write</span>([<span class="ruby-identifier">gp_u</span>, <span class="ruby-identifier">gp_v</span>, <span class="ruby-identifier">gp_omega</span>, <span class="ruby-identifier">gp_t</span>], <span class="ruby-identifier">ofile</span>, <span class="ruby-value">-1</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">omega</span>, <span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">epflx_y</span>, <span class="ruby-identifier">epflx_z</span>, <span class="ruby-identifier">v_rmean</span>, <span class="ruby-identifier">w_rmean</span>, <span class="ruby-identifier">gp_lat</span>, <span class="ruby-identifier">gp_z</span>, <span class="ruby-identifier">u_mean</span>, <span class="ruby-identifier">theta_mean</span>,
          <span class="ruby-identifier">uv_dash</span>, <span class="ruby-identifier">vt_dash</span>, <span class="ruby-identifier">uw_dash</span>, <span class="ruby-identifier">dtheta_dz</span> = <span class="ruby-identifier">ary</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span><span class="ruby-operator">::</span><span class="ruby-identifier">ep_full_sphere</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">omega</span>, <span class="ruby-identifier">t</span>, <span class="ruby-keyword">true</span>) <span class="ruby-comment"># false if potential temperature</span>

    <span class="ruby-identifier">epflx_div</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span><span class="ruby-operator">::</span><span class="ruby-identifier">div_sphere</span>(<span class="ruby-identifier">epflx_y</span>, <span class="ruby-identifier">epflx_z</span>)
    <span class="ruby-identifier">strm_rmean</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span><span class="ruby-operator">::</span><span class="ruby-identifier">strm_rmean</span>(<span class="ruby-identifier">v_rmean</span>)
    [ <span class="ruby-identifier">epflx_y</span>, <span class="ruby-identifier">epflx_z</span>, <span class="ruby-identifier">v_rmean</span>, <span class="ruby-identifier">w_rmean</span>, <span class="ruby-identifier">strm_rmean</span>, <span class="ruby-identifier">epflx_div</span>, <span class="ruby-identifier">u_mean</span>, <span class="ruby-identifier">theta_mean</span>, <span class="ruby-identifier">uv_dash</span>, <span class="ruby-identifier">vt_dash</span>, <span class="ruby-identifier">uw_dash</span>, <span class="ruby-identifier">dtheta_dz</span> ]
  }

  <span class="ruby-identifier">ofile</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-identifier">abort</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-extend_backward_along" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">extend_backward_along</span><span
            class="method-args">(gp,dim,len,value=0.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Extend the data backward.</p>
          
          

          
          <div class="method-source-code" id="extend_backward_along-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 140</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">extend_backward_along</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">dim</span>,<span class="ruby-identifier">len</span>,<span class="ruby-identifier">value</span>=<span class="ruby-value">0.0</span>)
  <span class="ruby-identifier">dim</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">dim</span>.<span class="ruby-identifier">to_i</span>]  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">ax_val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">copy</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">ext_gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">dim</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ax_val</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">..</span><span class="ruby-identifier">ax_val</span>[<span class="ruby-identifier">len</span><span class="ruby-value">-1</span>])
  <span class="ruby-identifier">dif</span> = <span class="ruby-identifier">ax_val</span>[<span class="ruby-identifier">len</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">ax_val</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">ext_gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">ext_gp</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">dim</span>)<span class="ruby-operator">-</span><span class="ruby-identifier">dif</span>)
  <span class="ruby-identifier">ext_gp</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">ext_gp</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span><span class="ruby-operator">+</span><span class="ruby-identifier">value</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>([<span class="ruby-identifier">ext_gp</span>,<span class="ruby-identifier">gp</span>])
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_axisnames" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_axisnames</span><span
            class="method-args">(gturl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_axisnames-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 591</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_axisnames</span>(<span class="ruby-identifier">gturl</span>)
  <span class="ruby-identifier">file</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">slice</span>, <span class="ruby-identifier">cut_slice</span>, <span class="ruby-identifier">thinning</span>  = <span class="ruby-identifier">parse_gturl</span>(<span class="ruby-identifier">gturl</span>) <span class="ruby-comment"># GPhys::IO.parse_gturl(gturl)</span>
  <span class="ruby-identifier">axes</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">var</span>).<span class="ruby-identifier">axnames</span>
  <span class="ruby-identifier">axes</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-constant">AX</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">to_s</span>, <span class="ruby-identifier">axes</span>[<span class="ruby-identifier">i</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;,&quot;</span><span class="ruby-operator">+</span><span class="ruby-constant">AX</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">to_s</span>)
        }
      <span class="ruby-identifier">gturl</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-fits2gphys" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">fits2gphys</span><span
            class="method-args">(gturl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO 複数ファイル・変数への対応</p>
          
          

          
          <div class="method-source-code" id="fits2gphys-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 211</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">fits2gphys</span>(<span class="ruby-identifier">gturl</span>)
<span class="ruby-comment">#  require &quot;RubyFits&quot;</span>
  <span class="ruby-identifier">file</span>, <span class="ruby-identifier">num</span> = <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)
  <span class="ruby-identifier">f</span>=<span class="ruby-constant">FitsFile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">file</span>)
  <span class="ruby-identifier">hdu</span>=<span class="ruby-identifier">f</span>.<span class="ruby-identifier">hdu</span>(<span class="ruby-identifier">num</span>.<span class="ruby-identifier">to_i</span>)
  <span class="ruby-identifier">imageArray</span>=<span class="ruby-identifier">hdu</span>.<span class="ruby-identifier">getAsArray</span>()
  <span class="ruby-identifier">na</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">imageArray</span>).<span class="ruby-identifier">transpose</span>(<span class="ruby-value">1</span>,<span class="ruby-value">0</span>) <span class="ruby-comment"># NArray化</span>
  <span class="ruby-identifier">xaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">xaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">hdu</span>.<span class="ruby-identifier">getXSize</span>).<span class="ruby-identifier">indgen!</span>,<span class="ruby-keyword">nil</span>,<span class="ruby-string">&quot;x&quot;</span>)
  <span class="ruby-identifier">yaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">yaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">hdu</span>.<span class="ruby-identifier">getYSize</span>).<span class="ruby-identifier">indgen!</span>,<span class="ruby-keyword">nil</span>,<span class="ruby-string">&quot;y&quot;</span>)
  <span class="ruby-identifier">grid</span> = <span class="ruby-constant">Grid</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">xaxis</span>, <span class="ruby-identifier">yaxis</span>)
  <span class="ruby-identifier">nam</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">na</span>, <span class="ruby-identifier">na</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-identifier">na</span>)).<span class="ruby-identifier">set_missing_value</span>(<span class="ruby-value">-9.99e33</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">na</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Float</span>
  <span class="ruby-identifier">nam</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">na</span>, <span class="ruby-identifier">na</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-identifier">na</span>)).<span class="ruby-identifier">set_missing_value</span>(<span class="ruby-value">-999</span>)     <span class="ruby-keyword">if</span> <span class="ruby-identifier">na</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Fixnum</span>
  <span class="ruby-comment">#nam = na</span>
  <span class="ruby-identifier">varray</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nam</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">hdu</span>.<span class="ruby-identifier">getName</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">hdu</span>.<span class="ruby-identifier">getHeader</span>(<span class="ruby-value">17</span>).<span class="ruby-identifier">toString</span>}, <span class="ruby-identifier">hdu</span>.<span class="ruby-identifier">getName</span>)
  <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>,<span class="ruby-identifier">varray</span>)

  <span class="ruby-comment">#  binding.pry</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-float_string-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">float_string?</span><span
            class="method-args">(str)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Float()で変換できれば数値、例外発生したら違う cf. <a href="http://taro-tnk.hatenablog.com/entry/2012/12/17/001552">taro-tnk.hatenablog.com/entry/2012/12/17/001552</a></p>
          
          

          
          <div class="method-source-code" id="float_string-3F-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 178</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">float_string?</span>(<span class="ruby-identifier">str</span>)
  <span class="ruby-constant">Float</span>(<span class="ruby-identifier">str</span>)
  <span class="ruby-keyword">true</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span>
  <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-func" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">func</span><span
            class="method-args">(x)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="func-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 473</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">func</span>(<span class="ruby-identifier">x</span>)
  <span class="ruby-comment">#y = sin(x*PI/180.0)</span>
  <span class="ruby-identifier">y</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-ivar">@OPT_top_axis</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">0</span>])
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">y</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-g_epflux" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">g_epflux</span><span
            class="method-args">(gp_u,gp_v,gp_omega,gp_t)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Generalized EP flux derived from Vallis (2006) texts. See Kashimura(Yamamoto)&#39;s Master Thesis&#39;</p>
          
          

          
          <div class="method-source-code" id="g_epflux-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 328</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">g_epflux</span>(<span class="ruby-identifier">gp_u</span>,<span class="ruby-identifier">gp_v</span>,<span class="ruby-identifier">gp_omega</span>,<span class="ruby-identifier">gp_t</span>)
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;Caution: EP-flux calculation requires *** p-coordinate *** for vertical axis. \n&quot;</span>
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;numru/gphys/ep_flux&quot;</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">radius</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">rot_period</span>=<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">omega</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">g_forces</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span>.<span class="ruby-identifier">g</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">p00</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">P00</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">gas_const</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">R</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">cp</span>=<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">Cp</span>
  <span class="ruby-comment"># t_s =</span>
  <span class="ruby-comment"># GPhys::EP_Flux.scale_height=UNumeric.new((GPhys::EP_Flux.gas_const*t_s/GPhys::EP_Flux.g_forces),  &quot;m&quot;) # set scale_height if needed</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;         Scale height of #{GPhys::EP_Flux.scale_height} is used.\n&quot;</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;         [Note] You should multiply by a*rho_s = a*p_s/(gH) = #{@Radius*GPhys::EP_Flux.p00/(GPhys::EP_Flux.g_forces*GPhys::EP_Flux.scale_height)} to convert to Andrews et al.&#39;s (1987) form.\n&quot;</span>
  <span class="ruby-identifier">scale_height</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">scale_height</span>
  <span class="ruby-identifier">ofile</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">create</span>(<span class="ruby-string">&quot;g_epflux.nc&quot;</span>)
  <span class="ruby-identifier">flag_temp_or_theta</span> = <span class="ruby-keyword">true</span> <span class="ruby-comment"># false if potential temperature</span>

  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">each_along_dims_write</span>([<span class="ruby-identifier">gp_u</span>, <span class="ruby-identifier">gp_v</span>, <span class="ruby-identifier">gp_omega</span>, <span class="ruby-identifier">gp_t</span>], <span class="ruby-identifier">ofile</span>, <span class="ruby-value">-1</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">omega</span>, <span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">xyzdims</span> = [<span class="ruby-value">0</span>,<span class="ruby-value">1</span>,<span class="ruby-value">2</span>]
    <span class="ruby-identifier">ax_lon</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">xyzdims</span>[<span class="ruby-value">0</span>]) <span class="ruby-comment"># Axis of longitude</span>
    <span class="ruby-identifier">ax_lat</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">xyzdims</span>[<span class="ruby-value">1</span>]) <span class="ruby-comment"># Axis of latitude</span>
    <span class="ruby-identifier">ax_z</span> =   <span class="ruby-identifier">u</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">xyzdims</span>[<span class="ruby-value">2</span>]) <span class="ruby-comment"># Axis of vertical</span>
    <span class="ruby-identifier">lon_nm</span>, <span class="ruby-identifier">lat_nm</span>, <span class="ruby-identifier">z_nm</span> = <span class="ruby-identifier">ax_lon</span>.<span class="ruby-identifier">pos</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">ax_lat</span>.<span class="ruby-identifier">pos</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">ax_z</span>.<span class="ruby-identifier">pos</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">gp_lon</span>, <span class="ruby-identifier">gp_lat</span>, <span class="ruby-identifier">gp_z</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">make_gphys</span>(<span class="ruby-identifier">ax_lon</span>, <span class="ruby-identifier">ax_lat</span>, <span class="ruby-identifier">ax_z</span>)

    <span class="ruby-comment">## convert axes</span>
    <span class="ruby-identifier">gp_z</span>   = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">to_z_if_pressure</span>(<span class="ruby-identifier">gp_z</span>)     <span class="ruby-comment"># P =&gt; z=-H*log(P/P00) (units-based)</span>
    <span class="ruby-identifier">gp_lon</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">to_rad_if_deg</span>(<span class="ruby-identifier">gp_lon</span>)    <span class="ruby-comment"># deg =&gt; rad (unit convesion)</span>
    <span class="ruby-identifier">gp_lat</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">to_rad_if_deg</span>(<span class="ruby-identifier">gp_lat</span>)    <span class="ruby-comment"># deg =&gt; rad (unit convesion)</span>
    <span class="ruby-identifier">w</span>      = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">to_w_if_omega</span>(<span class="ruby-identifier">omega</span>, <span class="ruby-identifier">gp_z</span>)  <span class="ruby-comment"># dP/dt =&gt; dz/dt (units-based)</span>
    <span class="ruby-identifier">t</span>      = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">to_theta_if_temperature</span>(<span class="ruby-identifier">t</span>, <span class="ruby-identifier">gp_z</span>, <span class="ruby-identifier">flag_temp_or_theta</span>)
                  <span class="ruby-comment"># temperature =&gt; potential temperature (if flag is true)</span>
<span class="ruby-comment">#    gp_lon.units=(&quot;radian&quot;); gp_lat.units=(&quot;radian&quot;)</span>

    <span class="ruby-comment">## replace grid (without duplicating data)</span>
    <span class="ruby-identifier">grid</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">grid_copy</span>
    <span class="ruby-identifier">old_grid</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">grid_copy</span>                 <span class="ruby-comment"># saved to use in outputs</span>
    <span class="ruby-identifier">grid</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lon_nm</span>).<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">gp_lon</span>.<span class="ruby-identifier">data</span>       <span class="ruby-comment"># in radian</span>
    <span class="ruby-identifier">grid</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_nm</span>).<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">gp_lat</span>.<span class="ruby-identifier">data</span>       <span class="ruby-comment"># in radian</span>
    <span class="ruby-identifier">grid</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">z_nm</span>).<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">gp_z</span>.<span class="ruby-identifier">data</span>           <span class="ruby-comment"># log-p height</span>
    <span class="ruby-identifier">u</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>, <span class="ruby-identifier">u</span>.<span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">v</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>, <span class="ruby-identifier">v</span>.<span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">w</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>, <span class="ruby-identifier">w</span>.<span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">t</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">data</span>)
    <span class="ruby-comment">## get each term</span>
    <span class="ruby-comment">#  needed in F_y and F_z</span>
    <span class="ruby-identifier">uv_dash</span>, <span class="ruby-identifier">vt_dash</span>, <span class="ruby-identifier">uw_dash</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">eddy_products</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">w</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">lon_nm</span>)
    <span class="ruby-identifier">wt_dash</span> = (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">eddy</span>(<span class="ruby-identifier">lon_nm</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">w</span>.<span class="ruby-identifier">eddy</span>(<span class="ruby-identifier">lon_nm</span>)).<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">lon_nm</span>)
    <span class="ruby-identifier">wt_dash</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;W&#39;T&#39;&quot;</span>); <span class="ruby-identifier">wt_dash</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">rename!</span>(<span class="ruby-string">&quot;wt_dash&quot;</span>)
    <span class="ruby-identifier">theta_mean</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">lon_nm</span>)
    <span class="ruby-identifier">dtheta_dz</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">deriv</span>(<span class="ruby-identifier">theta_mean</span>, <span class="ruby-identifier">z_nm</span>)
    <span class="ruby-comment"># dtheta_dz * dtheta_dz.gt(0) # to eliminate negative value</span>
<span class="ruby-comment">#    binding.pry</span>

    <span class="ruby-identifier">cos_lat</span> = <span class="ruby-identifier">gp_lat</span>.<span class="ruby-identifier">cos</span>
    <span class="ruby-identifier">a_cos_lat</span> = <span class="ruby-ivar">@Radius</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">cos_lat</span>
    <span class="ruby-identifier">a_cos_lat</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">rename!</span>(<span class="ruby-string">&#39;a_cos_lat&#39;</span>)
    <span class="ruby-identifier">a_cos_lat</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;radius * cos_lat&#39;</span>)
    <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">remove_0_at_poles</span>(<span class="ruby-identifier">a_cos_lat</span>)
    <span class="ruby-comment">#  needed in F_y only</span>
    <span class="ruby-identifier">u_mean</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">lon_nm</span>)
    <span class="ruby-identifier">du_dz</span>  = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">deriv</span>(<span class="ruby-identifier">u_mean</span>, <span class="ruby-identifier">z_nm</span>)
    <span class="ruby-comment">#  needed in F_z only</span>
    <span class="ruby-identifier">f_cor</span> = <span class="ruby-value">2</span> <span class="ruby-operator">*</span> <span class="ruby-ivar">@Omega</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">gp_lat</span>.<span class="ruby-identifier">sin</span>
    <span class="ruby-identifier">f_cor</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">rename!</span>(<span class="ruby-string">&#39;f_cor&#39;</span>)
    <span class="ruby-identifier">f_cor</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;Coriolis parameter&#39;</span>)
    <span class="ruby-identifier">dtheta_dphi</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">deriv</span>( <span class="ruby-identifier">theta_mean</span>, <span class="ruby-identifier">lat_nm</span>)
    <span class="ruby-identifier">ducos_dphi</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">deriv</span>( <span class="ruby-identifier">u_mean</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">cos_lat</span>, <span class="ruby-identifier">lat_nm</span>)
    <span class="ruby-identifier">avort</span> = (<span class="ruby-operator">-</span><span class="ruby-identifier">ducos_dphi</span><span class="ruby-operator">/</span><span class="ruby-identifier">a_cos_lat</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">f_cor</span>        <span class="ruby-comment"># -- absolute vorticity</span>
    <span class="ruby-identifier">avort</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">units</span> = <span class="ruby-string">&quot;s-1&quot;</span>
    <span class="ruby-identifier">avort</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">rename!</span>(<span class="ruby-string">&#39;avort&#39;</span>)
    <span class="ruby-identifier">avort</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;zonal mean absolute vorticity&#39;</span>)

    <span class="ruby-comment"># calculate psi (see Eq. C.45 in Kashimura(Yamamoto)&#39;s Master Thesis)</span>
    <span class="ruby-comment"># [note] psi can be approximated to vt_dash/dtheta_dz in typical Earth cases.</span>
    <span class="ruby-identifier">psi</span> = (<span class="ruby-identifier">vt_dash</span><span class="ruby-operator">*</span><span class="ruby-identifier">dtheta_dz</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">wt_dash</span><span class="ruby-operator">*</span><span class="ruby-identifier">dtheta_dphi</span><span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span>)<span class="ruby-operator">/</span>((<span class="ruby-identifier">dtheta_dphi</span><span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">dtheta_dz</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)

    <span class="ruby-comment">## F_y, F_z</span>
    <span class="ruby-identifier">sigma</span> = (<span class="ruby-operator">-</span><span class="ruby-identifier">gp_z</span><span class="ruby-operator">/</span><span class="ruby-identifier">scale_height</span>).<span class="ruby-identifier">exp</span>
    <span class="ruby-identifier">epflx_y</span> = ( <span class="ruby-operator">-</span> <span class="ruby-identifier">uv_dash</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">du_dz</span><span class="ruby-operator">*</span><span class="ruby-identifier">psi</span> ) <span class="ruby-operator">*</span> <span class="ruby-identifier">cos_lat</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">sigma</span>
    <span class="ruby-identifier">epflx_z</span> = ( <span class="ruby-operator">-</span> <span class="ruby-identifier">uw_dash</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">avort</span><span class="ruby-operator">*</span><span class="ruby-identifier">psi</span> ) <span class="ruby-operator">*</span> <span class="ruby-identifier">cos_lat</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">sigma</span>
    <span class="ruby-identifier">epflx_y</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&quot;epflx_y&quot;</span>; <span class="ruby-identifier">epflx_z</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&quot;epflx_z&quot;</span>
    <span class="ruby-identifier">epflx_y</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;Generalized EP flux y component&quot;</span>)
    <span class="ruby-identifier">epflx_z</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;Generalized EP flux z component&quot;</span>)

    <span class="ruby-comment">## v_rmean, w_rmean</span>
    <span class="ruby-identifier">z_nm</span> = <span class="ruby-identifier">gp_z</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">name</span>    <span class="ruby-comment"># change z_nm from pressure to z</span>
    <span class="ruby-identifier">v_mean</span> = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">lon_nm</span>); <span class="ruby-identifier">w_mean</span> = <span class="ruby-identifier">w</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">lon_nm</span>)
    <span class="ruby-identifier">v_rmean</span> = ( <span class="ruby-identifier">v_mean</span> <span class="ruby-operator">-</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">deriv</span>( (<span class="ruby-identifier">psi</span><span class="ruby-operator">*</span><span class="ruby-identifier">sigma</span>), <span class="ruby-identifier">z_nm</span> )<span class="ruby-operator">/</span><span class="ruby-identifier">sigma</span> )
    <span class="ruby-identifier">w_rmean</span> = ( <span class="ruby-identifier">w_mean</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span>.<span class="ruby-identifier">deriv</span>( (<span class="ruby-identifier">psi</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos_lat</span>), <span class="ruby-identifier">lat_nm</span> )<span class="ruby-operator">/</span><span class="ruby-identifier">a_cos_lat</span> )
    <span class="ruby-identifier">v_rmean</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&quot;v_rmean&quot;</span>; <span class="ruby-identifier">w_rmean</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">name</span> = <span class="ruby-string">&quot;w_rmean&quot;</span>
    <span class="ruby-identifier">v_rmean</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;residual zonal mean V&quot;</span>)
    <span class="ruby-identifier">w_rmean</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;residual zonal mean W&quot;</span>)

    <span class="ruby-comment">## convert with past grid</span>
      <span class="ruby-identifier">gp_ary</span> = [] <span class="ruby-comment"># grid convertes gphyss into</span>
      <span class="ruby-identifier">grid_xmean</span> = <span class="ruby-identifier">old_grid</span>.<span class="ruby-identifier">delete_axes</span>(<span class="ruby-identifier">lon_nm</span>)
      [<span class="ruby-identifier">epflx_y</span>, <span class="ruby-identifier">epflx_z</span>, <span class="ruby-identifier">v_rmean</span>, <span class="ruby-identifier">w_rmean</span>, <span class="ruby-identifier">gp_lat</span>, <span class="ruby-identifier">gp_z</span>, <span class="ruby-identifier">u_mean</span>, <span class="ruby-identifier">theta_mean</span>, <span class="ruby-identifier">uv_dash</span>, <span class="ruby-identifier">vt_dash</span>, <span class="ruby-identifier">wt_dash</span>, <span class="ruby-identifier">uw_dash</span>, <span class="ruby-identifier">dtheta_dz</span>, <span class="ruby-identifier">dtheta_dphi</span><span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span>].<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">grid_xmean</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">size</span>
          <span class="ruby-identifier">gp_ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">g</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">gp_ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid_xmean</span>, <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>) <span class="ruby-comment">#back to the original grid</span>
        <span class="ruby-keyword">end</span>
    }

    <span class="ruby-identifier">gp_ary</span>[<span class="ruby-value">5</span>] = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span><span class="ruby-operator">::</span><span class="ruby-identifier">div_sphere</span>(<span class="ruby-identifier">gp_ary</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">gp_ary</span>[<span class="ruby-value">1</span>])
    <span class="ruby-identifier">gp_ary</span>[<span class="ruby-value">4</span>] = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">EP_Flux</span><span class="ruby-operator">::</span><span class="ruby-identifier">strm_rmean</span>(<span class="ruby-identifier">gp_ary</span>[<span class="ruby-value">2</span>])

<span class="ruby-comment">#    [ epflx_y, epflx_z, v_rmean, w_rmean, strm_rmean, epflx_div, u_mean, theta_mean, uv_dash, vt_dash, uw_dash, dtheta_dz ]</span>
<span class="ruby-comment">#   binding.pry</span>
    <span class="ruby-identifier">gp_ary</span>
  }

  <span class="ruby-identifier">ofile</span>.<span class="ruby-identifier">close</span>
  <span class="ruby-identifier">abort</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-get_calendar" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_calendar</span><span
            class="method-args">(gp, dim)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="get_calendar-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 117</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">get_calendar</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">gp_axis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">to_gphys</span>
  <span class="ruby-ivar">@Calendar</span> = <span class="ruby-identifier">gp_axis</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;calendar&quot;</span>)
  <span class="ruby-ivar">@Units</span> = <span class="ruby-identifier">gp_axis</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;units&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-gglat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">gglat</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Interpolate to Gaussian latitudes.</p>
          
          

          
          <div class="method-source-code" id="gglat-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 8</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">gglat</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;gglat&quot;</span>
  <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">lat_n</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">nlat</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-constant">GGLA</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lat_n</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">GGLA</span>[<span class="ruby-identifier">n</span>].<span class="ruby-identifier">length</span> )
      <span class="ruby-identifier">nlat</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-constant">GGLA</span>[<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">sort</span>)
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;nlat = NArray.to_na(GGLA#{@OPT_GLAT}.sort)&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_GLAT</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>)
  <span class="ruby-identifier">vlat</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nlat</span>,{<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;degree_north&quot;</span>},<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">lat_dim</span>])
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">lat_dim</span><span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">vlat</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lon_dim</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">nlon</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)
    (<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nlon</span>[<span class="ruby-identifier">i</span>] = <span class="ruby-value">360.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">i</span> }
    <span class="ruby-identifier">vlon</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nlon</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;degree_east&quot;</span>},<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">lon_dim</span>])
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cyclic_ext</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">lon_dim</span><span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">vlon</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-grad_sy" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">grad_sy</span><span
            class="method-args">(gp,lat=0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Gradient along lat direction on sphere.</p>
          
          

          
          <div class="method-source-code" id="grad_sy-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 462</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">grad_sy</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">lat</span>=<span class="ruby-value">0</span>)
  <span class="ruby-identifier">lam</span>, <span class="ruby-identifier">phi</span>, <span class="ruby-identifier">lond</span>, <span class="ruby-identifier">latd</span>  = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">get_lambda_phi</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">cos_phi</span> = <span class="ruby-identifier">phi</span>.<span class="ruby-identifier">cos</span>
  <span class="ruby-identifier">ys</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cderiv</span>(<span class="ruby-identifier">latd</span>,<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">latbc</span>(<span class="ruby-identifier">phi</span>),<span class="ruby-identifier">phi</span>) <span class="ruby-operator">/</span> <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ys</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-highpass" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">highpass</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Highpass filter using FFT.</p>
          
          

          
          <div class="method-source-code" id="highpass-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 26</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">highpass</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">hp_dim</span> = <span class="ruby-ivar">@OPT_highpass</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">hp_wn</span> = <span class="ruby-ivar">@OPT_highpass</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">sp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>,<span class="ruby-identifier">hp_dim</span>)
  <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">sp</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">real</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-value">0.0</span>)
  <span class="ruby-identifier">mask</span>[<span class="ruby-identifier">hp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">hp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">1.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">mask</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">hp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">hp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">1.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">mask</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">hp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">hp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">1.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
  <span class="ruby-identifier">mask</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">hp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">hp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">1.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">hp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
  <span class="ruby-identifier">gp</span> = (<span class="ruby-identifier">sp</span><span class="ruby-operator">*</span><span class="ruby-identifier">mask</span>).<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">true</span>,<span class="ruby-identifier">hp_dim</span>).<span class="ruby-identifier">real</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ifunc" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ifunc</span><span
            class="method-args">(y)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="ifunc-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 479</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ifunc</span>(<span class="ruby-identifier">y</span>)
  <span class="ruby-comment">#x = asin(y)*180.0/PI</span>
  <span class="ruby-identifier">x</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-ivar">@OPT_top_axis</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>])
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">x</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interpolate_pole" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interpolate_pole</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>緯度座標軸に極の上 -/+90 deg の格子点を付け加える。データの値は元々の最南/最北点の経度平均値とする。</p>

<pre class="ruby"><span class="ruby-identifier">これだとベクトル量には使ってはいけない。スカラー量にのみ使える。</span>
</pre>
          
          

          
          <div class="method-source-code" id="interpolate_pole-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interpolate_pole</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">abs</span> <span class="ruby-operator">==</span> <span class="ruby-value">90.0</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">packed_from_south</span> = (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>) <span class="ruby-operator">?</span> <span class="ruby-keyword">true</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">false</span> <span class="ruby-comment">#緯度の格納順を調べる</span>
    <span class="ruby-comment"># 緯度軸を拡張する</span>
    <span class="ruby-identifier">new_axis_va</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">data</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">packed_from_south</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">new_axis_ar</span> = <span class="ruby-identifier">new_axis_va</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-value">-90.0</span>).<span class="ruby-identifier">push</span>(<span class="ruby-value">90.0</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">new_axis_ar</span> = <span class="ruby-identifier">new_axis_va</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-value">90.0</span>).<span class="ruby-identifier">push</span>(<span class="ruby-value">-90.0</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">new_axis_na</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">new_axis_ar</span>)
    <span class="ruby-identifier">new_axis_va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_axis_na</span>,{<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;degree_north&quot;</span>},<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">lat_dim</span>])
    <span class="ruby-comment"># interpolateメソッドでgphysオブジェクトを拡張する</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">lat_dim</span><span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">new_axis_va</span>)
    <span class="ruby-comment"># interpolate メソッドでは極で欠損値になるので、改めて値を設定する</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">sp_val</span> = <span class="ruby-identifier">val</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">mean</span>(<span class="ruby-value">0</span>) <span class="ruby-comment"># lon, latの次元の位置を仮定している</span>
    <span class="ruby-identifier">np_val</span> = <span class="ruby-identifier">val</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">-2</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">mean</span>(<span class="ruby-value">0</span>)
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">val</span>[<span class="ruby-identifier">i</span>, <span class="ruby-value">0</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">sp_val</span>
      <span class="ruby-identifier">val</span>[<span class="ruby-identifier">i</span>,<span class="ruby-value">-1</span>, <span class="ruby-keyword">false</span>] = <span class="ruby-identifier">np_val</span>
    }
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">val</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-invalidation" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">invalidation</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="invalidation-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 204</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">invalidation</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">rmiss</span> = <span class="ruby-value">-999.0</span>
  <span class="ruby-identifier">miss_val</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-ivar">@OPT_invalidation</span>)
  <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">val</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">miss_val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Float</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">miss_val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Fixnum</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-identifier">miss_val</span>).<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>) <span class="ruby-comment">#note mask must be 0 or 1; other value causes strange value</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">miss_val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Range</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">ge</span>(<span class="ruby-identifier">miss_val</span>.<span class="ruby-identifier">min</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">val</span>.<span class="ruby-identifier">le</span>(<span class="ruby-identifier">miss_val</span>.<span class="ruby-identifier">max</span>).<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;invalidation value must be given by Float (1.0) or Fixnum (1) or Range (0..1)&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">val</span>.<span class="ruby-identifier">set_mask</span>(<span class="ruby-identifier">mask</span>)
  <span class="ruby-identifier">new_gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">copy</span> ; <span class="ruby-identifier">new_gp</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">val</span>)
<span class="ruby-comment">#  new_gp.set_att(&quot;missing_value&quot;,[miss_val])</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-line_fill" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">line_fill</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="line_fill-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1631</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">line_fill</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">ci</span> = (<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">/</span><span class="ruby-value">10</span>; <span class="ruby-identifier">wi</span> = (<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">%</span><span class="ruby-value">10</span>; <span class="ruby-identifier">pi</span> = (<span class="ruby-ivar">@Overplot</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-value">7</span>
    <span class="ruby-identifier">wi</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">fi</span> = <span class="ruby-identifier">ci</span><span class="ruby-operator">*</span><span class="ruby-value">1000</span><span class="ruby-operator">+</span><span class="ruby-identifier">pi</span><span class="ruby-operator">*</span><span class="ruby-value">100</span><span class="ruby-operator">+</span><span class="ruby-identifier">wi</span><span class="ruby-operator">*</span><span class="ruby-value">10</span><span class="ruby-value">+4</span>; <span class="ruby-comment">#fi = ci*1000+999 #べた塗り</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uusarp</span>(<span class="ruby-identifier">fi</span>, <span class="ruby-identifier">fi</span>)
    <span class="ruby-identifier">xmin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMIN&quot;</span>); <span class="ruby-identifier">ymin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMIN&quot;</span>)
    <span class="ruby-identifier">xmax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UXMAX&quot;</span>); <span class="ruby-identifier">ymax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;UYMAX&quot;</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">xmin</span><span class="ruby-operator">*</span><span class="ruby-identifier">xmax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">xline</span> = <span class="ruby-value">0.0</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">xmax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">xline</span> = <span class="ruby-identifier">xmax</span>
    <span class="ruby-keyword">else</span> <span class="ruby-identifier">xline</span> = <span class="ruby-identifier">xmin</span>  <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ymin</span><span class="ruby-operator">*</span><span class="ruby-identifier">ymax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">yline</span> = <span class="ruby-value">0.0</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">ymax</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">yline</span> = <span class="ruby-identifier">ymax</span>
    <span class="ruby-keyword">else</span> <span class="ruby-identifier">yline</span> = <span class="ruby-identifier">ymin</span> <span class="ruby-keyword">end</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uvdif</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-value">0</span><span class="ruby-operator">+</span><span class="ruby-identifier">yline</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_exch</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uhdif</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-value">0</span><span class="ruby-operator">+</span><span class="ruby-identifier">xline</span>,<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_exch</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">ci</span> = (<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">/</span><span class="ruby-value">10</span>; <span class="ruby-identifier">wi</span> = (<span class="ruby-ivar">@OPT_index</span> <span class="ruby-operator">||</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">%</span><span class="ruby-value">10</span>; <span class="ruby-identifier">pi</span> = (<span class="ruby-ivar">@Overplot</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-value">7</span>
    <span class="ruby-identifier">wi</span> = <span class="ruby-value">1</span>
    <span class="ruby-identifier">fi</span> = <span class="ruby-identifier">ci</span><span class="ruby-operator">*</span><span class="ruby-value">1000</span><span class="ruby-value">+999</span>   <span class="ruby-comment">#pi*100+wi*10+4; #fi = ci*1000+999 #べた塗り</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uusarp</span>(<span class="ruby-identifier">fi</span>, <span class="ruby-identifier">fi</span>)
    <span class="ruby-identifier">gp0</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">gp1</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span>]
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uvdif</span>(<span class="ruby-identifier">gp0</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp0</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp1</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_exch</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uhdif</span>(<span class="ruby-identifier">gp0</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp1</span>.<span class="ruby-identifier">val</span>,<span class="ruby-identifier">gp0</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_exch</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lowpass" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lowpass</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Lowpass filter using FFT.</p>
          
          

          
          <div class="method-source-code" id="lowpass-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 10</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lowpass</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">lp_dim</span> = <span class="ruby-ivar">@OPT_lowpass</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">lp_wn</span> = (<span class="ruby-ivar">@OPT_lowpass</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>)<span class="ruby-value">+1</span>
  <span class="ruby-identifier">sp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>,<span class="ruby-identifier">lp_dim</span>)
  <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">sp</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">real</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-value">1.0</span>)
  <span class="ruby-identifier">mask</span>[<span class="ruby-identifier">lp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">lp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">0.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">mask</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">lp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">lp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">0.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">mask</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">lp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">lp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">0.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
  <span class="ruby-identifier">mask</span>[<span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-keyword">true</span>, <span class="ruby-identifier">lp_wn</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span><span class="ruby-identifier">lp_wn</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">0.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lp_dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
  <span class="ruby-identifier">gp</span> = (<span class="ruby-identifier">sp</span><span class="ruby-operator">*</span><span class="ruby-identifier">mask</span>).<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">true</span>,<span class="ruby-identifier">lp_dim</span>).<span class="ruby-identifier">real</span>
  <span class="ruby-comment"># rad =&gt; deg for lon</span>
  <span class="ruby-comment"># gp.axis(0).set_pos(VArray.new(gp.coordinate(0).val*R2D, {&quot;units&quot;=&gt;&quot;deg&quot;}, &quot;lon&quot;))</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-main" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">main</span><span
            class="method-args">(gp = nil, argv=nil, window=0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>gp: input GPhys or GPhps Array, argv: string of gpv optiones, window: flag for DCL window (0: open &amp; close, 1: close only, 2: open only, 3: don&#39;t open or close)</p>
          
          

          
          <div class="method-source-code" id="main-source">
            <pre><span class="ruby-comment"># File gpv_main.rb, line 555</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">main</span>(<span class="ruby-identifier">gp</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">argv</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">window</span>=<span class="ruby-value">0</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">argv</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">until</span> (<span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">argv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot; &quot;</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">argv</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@flag_window_open</span> = <span class="ruby-identifier">window</span>


<span class="ruby-comment">#####################################################</span>
<span class="ruby-comment">###++++++           Main Routine            ++++++###</span>
<span class="ruby-comment">## store command line and current directory</span>
<span class="ruby-ivar">@commandline</span> = <span class="ruby-identifier">$0</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;/&quot;</span>)[<span class="ruby-value">-1</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot; &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot; &quot;</span>)
<span class="ruby-ivar">@current_dir</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">pwd</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;/&quot;</span>
<span class="ruby-ivar">@comment</span> = <span class="ruby-ivar">@commandline</span> <span class="ruby-operator">+</span> <span class="ruby-node">&quot; (in #{@current_dir} @ #{Time.now})&quot;</span>

<span class="ruby-comment"># set options</span>
<span class="ruby-identifier">__set_options</span>

<span class="ruby-comment"># store source file names to @sources</span>
<span class="ruby-ivar">@sources</span> = []
<span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@sources</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)[<span class="ruby-value">0</span>] <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)[<span class="ruby-value">0</span>]) }

<span class="ruby-comment">## Print out help message</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_help</span>)
  <span class="ruby-identifier">help</span>
  <span class="ruby-identifier">exit</span>(<span class="ruby-value">1</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-comment">## exec gplist</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_list</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">v</span> = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)[<span class="ruby-value">0</span>];  <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;gplist #{v}&quot;</span>)
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">gtime</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">v</span>,<span class="ruby-string">&quot;time&quot;</span>)
      <span class="ruby-identifier">cal</span> = <span class="ruby-identifier">gtime</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;calendar&quot;</span>)
      <span class="ruby-identifier">sdate</span> = <span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gtime</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">gtime</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">to_datetime</span>(<span class="ruby-value">0.0</span>,<span class="ruby-identifier">cal</span>)
      <span class="ruby-identifier">edate</span> = <span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gtime</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">-1</span>],<span class="ruby-identifier">gtime</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>).<span class="ruby-identifier">to_datetime</span>(<span class="ruby-value">0.0</span>,<span class="ruby-identifier">cal</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;   time is from #{sdate} \n&quot;</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;             to #{edate} in calendar-type &#39;#{cal}&#39;\n&quot;</span>
    <span class="ruby-keyword">rescue</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">vars_and_axes</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">var_names</span>(<span class="ruby-identifier">v</span>); <span class="ruby-identifier">vars</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">var_names_except_coordinates</span>(<span class="ruby-identifier">v</span>)
    <span class="ruby-identifier">vars_and_axes</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">vars</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">a</span>)) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">axis</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">v</span>,<span class="ruby-identifier">a</span>).<span class="ruby-identifier">val</span>
        <span class="ruby-identifier">direction</span> = <span class="ruby-identifier">axis</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">&lt;</span><span class="ruby-identifier">axis</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">?</span> <span class="ruby-string">&quot;POSITIVE&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;NEGATIVE&quot;</span>
        <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;   #{a}-axis is packed from #{axis[0]} to #{axis[-1]} (#{direction} direction). \n&quot;</span>
      <span class="ruby-keyword">end</span>

    }

  }
  <span class="ruby-identifier">exit</span>
<span class="ruby-keyword">end</span>



<span class="ruby-comment">## alias options</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_wm</span>)
  <span class="ruby-ivar">@OPT_itr</span> = <span class="ruby-value">10</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_itr</span>
  <span class="ruby-ivar">@OPT_map</span> = <span class="ruby-string">&quot;coast_world&quot;</span>  <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_map</span>
  <span class="ruby-ivar">@OPT_nocont</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_cint</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_crange</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-ivar">@OPT_title</span> = <span class="ruby-string">&quot;&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_notitle</span>



<span class="ruby-comment">## set radius (defalut is 6370 km)</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_radius</span>)
  <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>=<span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@OPT_radius</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-string">&quot;m&quot;</span>)
  <span class="ruby-ivar">@Radius</span> = <span class="ruby-ivar">@OPT_radius</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Planetary radius is set to #{@Radius} m.\n&quot;</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@Radius</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment">## set planetary rotation rate (defalut is 7.27220521664304e-05 s-1)</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_Omega</span>)
  <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">omega</span>=<span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@OPT_Omega</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-string">&quot;s-1&quot;</span>)
  <span class="ruby-ivar">@Omega</span> = <span class="ruby-ivar">@OPT_Omega</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Omega, plaetary rotation rate, is set to #{@Omega} s-1.\n&quot;</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@Omega</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">omega</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment">## require spherical harmonics library if needed</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sph</span>)
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;spherical_harmonics&quot;</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">SphericalHarmonics</span>
<span class="ruby-keyword">end</span>


<span class="ruby-comment">## set some figure option</span>
<span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">swlset</span>(<span class="ruby-string">&#39;lwait&#39;</span>, <span class="ruby-keyword">false</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nowait</span>    <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_Gw</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_smooth</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_Gaw</span>)
                                           <span class="ruby-comment"># set wait or nowait</span>
<span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">swlset</span>(<span class="ruby-string">&#39;lalt&#39;</span>,  <span class="ruby-keyword">true</span>)  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_alternate</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_Ga</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_smooth</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_Gaw</span>)
                                           <span class="ruby-comment"># set backing store option</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_noannotate</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_panelfit</span>)
  <span class="ruby-ivar">@annotate</span> = <span class="ruby-keyword">false</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@annotate</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>

<span class="ruby-ivar">@Overplot_max</span> = ( <span class="ruby-ivar">@OPT_overplot</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">||</span> <span class="ruby-value">1</span> )
<span class="ruby-ivar">@Overplot</span> = <span class="ruby-value">1</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nocolorbar</span>)
  <span class="ruby-ivar">@colorbar</span> = <span class="ruby-keyword">false</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@colorbar</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_tone</span>)
  <span class="ruby-keyword">case</span> <span class="ruby-ivar">@OPT_tone</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;a&quot;</span>
    <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;e&quot;</span>
    <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;f&quot;</span>
    <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">false</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;b&quot;</span>
    <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;c&quot;</span>
    <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;full&quot;</span>
    <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;The value of option --tone should be &#39;a&#39;,&#39;e&#39;,&#39;f&#39;,&#39;b&#39;,&#39;c&#39;, or &#39;full&#39;.&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@auto</span>, <span class="ruby-ivar">@tonf</span>, <span class="ruby-ivar">@tonb</span>, <span class="ruby-ivar">@tonc</span>, <span class="ruby-ivar">@tone_fullcolor</span> = <span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>,<span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_log_int</span>)
  <span class="ruby-ivar">@log_int</span> = <span class="ruby-keyword">true</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@log_int</span> = <span class="ruby-keyword">false</span>
<span class="ruby-keyword">end</span>


<span class="ruby-comment">## decide VIEWPORT</span>
<span class="ruby-comment">##@VIEWPORT = set_vpsize( VIEWPORT, (@OPT_aspect||2.0) )</span>

<span class="ruby-comment">## tune the size of axis parameters.</span>
<span class="ruby-comment">#DCL.uzfact(0.7)</span>

<span class="ruby-comment">## set the format of contour labels.</span>
<span class="ruby-identifier">udsfmt</span> = (<span class="ruby-ivar">@OPT_udsfmt</span><span class="ruby-operator">||</span><span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udqfmt</span>())
<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">udsfmt</span>(<span class="ruby-identifier">udsfmt</span>)

<span class="ruby-comment">## draw figure</span>
<span class="ruby-identifier">loopdim</span>   = ( <span class="ruby-ivar">@OPT_animate</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_anim</span> )
<span class="ruby-identifier">loopdim</span> = <span class="ruby-identifier">loopdim</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">loopdim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">loopdim</span>
<span class="ruby-identifier">loopdim</span> = <span class="ruby-identifier">loopdim</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">loopdim</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/#{AX}[0-9]/</span>

<span class="ruby-comment">### set colormap</span>
<span class="ruby-comment">#binding.pry</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_clrmap</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-keyword">if</span> ( <span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-ivar">@OPT_clrmap</span>) ) <span class="ruby-keyword">then</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;CLRMAP&quot;</span>, <span class="ruby-ivar">@OPT_clrmap</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgscmn</span>(<span class="ruby-ivar">@OPT_clrmap</span><span class="ruby-operator">||</span><span class="ruby-value">63</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgscmn</span>(<span class="ruby-value">63</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-comment">### set title_array</span>
<span class="ruby-ivar">@title_array</span> = <span class="ruby-ivar">@OPT_title_array</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_title_array</span>

<span class="ruby-comment">### set index_array</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_index_array</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@index_array</span> = <span class="ruby-ivar">@OPT_index_array</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
  <span class="ruby-ivar">@index_array</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">n</span>, <span class="ruby-identifier">t</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;x&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword">then</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">fill</span>(<span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">else</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">end</span>
    }
  <span class="ruby-ivar">@index_array</span>.<span class="ruby-identifier">flatten!</span>
<span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_index</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">10</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># if index &gt;= 10 is set, use same index for all lines.</span>
  <span class="ruby-ivar">@OPT_index</span> = <span class="ruby-ivar">@OPT_index</span>.<span class="ruby-identifier">to_i</span>
<span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_nocolor</span>)
  <span class="ruby-ivar">@OPT_index</span> = <span class="ruby-value">2</span>
<span class="ruby-keyword">else</span> <span class="ruby-comment">#default</span>
  <span class="ruby-ivar">@index_array</span> = [<span class="ruby-value">10</span>,<span class="ruby-value">20</span>,<span class="ruby-value">40</span>,<span class="ruby-value">400</span>,<span class="ruby-value">650</span>,<span class="ruby-value">300</span>,<span class="ruby-value">930</span>,<span class="ruby-value">12</span>,<span class="ruby-value">22</span>,<span class="ruby-value">42</span>,<span class="ruby-value">402</span>,<span class="ruby-value">652</span>,<span class="ruby-value">302</span>,<span class="ruby-value">932</span>]
  <span class="ruby-ivar">@index_array</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> (<span class="ruby-ivar">@OPT_index</span>.<span class="ruby-identifier">to_i</span><span class="ruby-operator">||</span><span class="ruby-value">2</span>)}
<span class="ruby-keyword">end</span>

<span class="ruby-comment">### set type array</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_type_array</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@type_array</span> = <span class="ruby-ivar">@OPT_type_array</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
  <span class="ruby-ivar">@type_array</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">n</span>, <span class="ruby-identifier">t</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;x&quot;</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword">then</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">fill</span>(<span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">else</span> <span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">end</span>
    }
  <span class="ruby-ivar">@type_array</span>.<span class="ruby-identifier">flatten!</span>

<span class="ruby-keyword">else</span>
  <span class="ruby-ivar">@type_array</span> = [<span class="ruby-value">1</span>,<span class="ruby-value">3</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">5</span>]
<span class="ruby-keyword">end</span>
<span class="ruby-comment">### set alphabet array</span>
<span class="ruby-ivar">@alphabet</span> = [<span class="ruby-string">&quot;a&quot;</span>]; <span class="ruby-value">25</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@alphabet</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@alphabet</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">next</span>}


<span class="ruby-comment">#@flag_window_open = false</span>
<span class="ruby-ivar">@flag_margin</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>)

<span class="ruby-comment">#settings for text box</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_textbox</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@OPT_textbox</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@textbox_fnum</span> = <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;l&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;c&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@textbox_lc</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-ivar">@textbox</span> = <span class="ruby-identifier">s</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-ivar">@textbox</span> = <span class="ruby-string">&quot;&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@textbox</span>
  <span class="ruby-ivar">@textbox_fnum</span> = (<span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">size</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">$Overplot_max</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@textbox_fnum</span>
<span class="ruby-keyword">end</span>



<span class="ruby-identifier">gary</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>

<span class="ruby-ivar">@flag_read_csv</span> = <span class="ruby-value">1</span>


<span class="ruby-comment">## set Land/Ocean mask</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_land</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ocean</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_color_scatter</span>)
  <span class="ruby-identifier">landsea</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">open</span>(<span class="ruby-string">&quot;/Users/hiroki/Dropbox/RubyScripts/landsea.nc&quot;</span>,<span class="ruby-string">&quot;LSMASK&quot;</span>).<span class="ruby-identifier">copy</span> <span class="ruby-comment">#海陸マスクを読み込む 0=Ocean, 1=Land, 2=Lake, 3=Small Island, 4=Ice Shelf</span>
  <span class="ruby-identifier">lsgrid</span> = <span class="ruby-identifier">landsea</span>.<span class="ruby-identifier">grid</span>.<span class="ruby-identifier">copy</span>

  <span class="ruby-identifier">land_mask</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">landsea</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">ne</span>(<span class="ruby-value">0</span>)) <span class="ruby-comment"># 0=Ocean, 1=Ocean以外にする</span>
  <span class="ruby-identifier">land_mask</span>.<span class="ruby-identifier">invalidation</span>(<span class="ruby-identifier">landsea</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>))
  <span class="ruby-identifier">lary</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">land_mask</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;land mask&quot;</span>} ,<span class="ruby-string">&quot;lmask&quot;</span>)
  <span class="ruby-identifier">lmask</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">lsgrid</span>, <span class="ruby-identifier">lary</span>)

  <span class="ruby-identifier">ocean_mask</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">landsea</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>)) <span class="ruby-comment"># 0=Ocean, 1=Ocean以外にする</span>
  <span class="ruby-identifier">ocean_mask</span>.<span class="ruby-identifier">invalidation</span>(<span class="ruby-identifier">landsea</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">ne</span>(<span class="ruby-value">0</span>))
  <span class="ruby-identifier">oary</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ocean_mask</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;ocean mask&quot;</span>} ,<span class="ruby-string">&quot;omask&quot;</span>)
  <span class="ruby-identifier">omask</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">lsgrid</span>, <span class="ruby-identifier">oary</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># set ARGV if gp is given</span>
<span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">gp</span>)
<span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">reverse_each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span> <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">g</span>) }
<span class="ruby-keyword">end</span>


<span class="ruby-comment"># preparation for set_assoc_coords</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_set_assoc_coords</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@assoc_coords</span> =  <span class="ruby-identifier">open_gturl</span>(<span class="ruby-ivar">@OPT_set_assoc_coords</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># preparation for sig2p</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sig2p</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@PS</span> = <span class="ruby-identifier">open_gturl</span>(<span class="ruby-ivar">@OPT_sig2p</span>)
  <span class="ruby-ivar">@PS</span> = <span class="ruby-ivar">@PS</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@PS</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment"># 長さ１の鉛直軸を持ってる場合は除去する</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># preparation for sig2z</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sig2z</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@T</span> = <span class="ruby-identifier">open_gturl</span>(<span class="ruby-ivar">@OPT_sig2z</span>) <span class="ruby-comment"># 温度 T が必要</span>
<span class="ruby-keyword">end</span>

<span class="ruby-comment"># enable extrapolation or not</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_extrapolation</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">extrapolation</span>=<span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>



<span class="ruby-comment">#</span>
<span class="ruby-comment">#---------------------------------------------------------------------</span>
<span class="ruby-comment">#      MAIN LOOP</span>
<span class="ruby-comment">#---------------------------------------------------------------------</span>
<span class="ruby-comment">## open netcdf variables</span>
<span class="ruby-keyword">while</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">do</span>

  <span class="ruby-identifier">gturl</span> = <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_read_fits</span> ) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">fits2gphys</span>(<span class="ruby-identifier">gturl</span>)
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-identifier">gturl</span>)
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">gp</span> <span class="ruby-comment"># gp == false なら、つぎのgturlを検索</span>
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">## check whether gp has time axis and its calendar type</span>
  <span class="ruby-identifier">time_axis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">find</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> [<span class="ruby-string">&quot;time&quot;</span>,<span class="ruby-string">&quot;TIME&quot;</span>,<span class="ruby-string">&quot;Time&quot;</span>,<span class="ruby-string">&quot;t&quot;</span>,<span class="ruby-string">&quot;T&quot;</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>)}
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">time_axis</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">calendar</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">time_axis</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;calendar&quot;</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">calendar</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;360_day&quot;</span>, <span class="ruby-string">&quot;uniform30day&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@OPT_calendar360</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;all_leap&quot;</span>, <span class="ruby-string">&quot;366_day&quot;</span> <span class="ruby-keyword">then</span> <span class="ruby-comment">#not implemented yet.</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;noleap&quot;</span>, <span class="ruby-string">&quot;365_day&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@OPT_calendar365</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;gregorian&quot;</span>, <span class="ruby-string">&quot;standard&quot;</span>, <span class="ruby-string">&quot;&quot;</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># replace axis values</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_replace_axis</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">axnum</span>, <span class="ruby-identifier">newaxis</span> = <span class="ruby-ivar">@OPT_replace_axis</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
    <span class="ruby-identifier">num</span> = <span class="ruby-identifier">axnum</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;ax&quot;</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">axary</span> = <span class="ruby-identifier">newaxis</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
    <span class="ruby-identifier">axary</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">to_f</span>}
    <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">axary</span>), {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">axname</span>))
    <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;#{axname}&#39;s value was replaced by #{axary}&quot;</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># force axis unit</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_axis_units_name</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@OPT_axis_units_name</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">it</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">axnum</span>, <span class="ruby-identifier">unit</span>, <span class="ruby-identifier">axname</span>, <span class="ruby-identifier">ope</span> = <span class="ruby-identifier">it</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
      <span class="ruby-identifier">num</span> = <span class="ruby-identifier">axnum</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;ax&quot;</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-comment"># 単位未指定時は変更しない</span>
      <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">axname</span> <span class="ruby-comment"># 軸名未指定時は変更しない</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;axis #{gp.axis(num).name} [#{gp.coord(num).units}] was changed to &quot;</span>
      <span class="ruby-identifier">typecode</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">typecode</span>
      <span class="ruby-identifier">axis_val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-identifier">typecode</span>)
      <span class="ruby-identifier">axis_val</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;axis_val #{ope}&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ope</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">axis_val</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">axname</span>))
<span class="ruby-comment">#      gp.axis(num).set_pos(VArray.new(gp.coordinate(num).val, {&quot;units&quot;=&gt;unit}, axname))</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;#{axname} [#{unit}] \n&quot;</span>
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># cyclic_extension</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_cyclic_extension</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">ary</span> = <span class="ruby-ivar">@OPT_cyclic_extension</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
    <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">dim</span>, <span class="ruby-identifier">num</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
      <span class="ruby-identifier">num</span> = <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">num</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">cyclic_extension</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">dim</span>,<span class="ruby-identifier">num</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">copy</span>
    }
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># check whether gp&#39;s size and if large turn on the regrid option.</span>
  <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_regrid</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_nothinning</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">thres</span> = <span class="ruby-value">180</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_thinning</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">data_thinning</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-ivar">@OPT_thinning</span>.<span class="ruby-identifier">to_i</span>)
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@OPT_nocont</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">max</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">thres</span><span class="ruby-operator">*</span><span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_noshade</span>)
      <span class="ruby-comment">#gp = data_thinning(gp, thres)</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment">## flip data and axis of &lt;dim&gt; th dimension</span>
  <span class="ruby-comment">## standard deviation along any axis (preparation)</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_flip_data</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">dims_flip</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_flip_data</span>)
    <span class="ruby-identifier">dims_flip</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">reverse</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">dim</span>)
    }
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment">## extend gphys object along dim-axis</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_extend_backward_along</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">dim</span>, <span class="ruby-identifier">len</span>, <span class="ruby-identifier">val</span> = <span class="ruby-ivar">@OPT_extend_backward_along</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">extend_backward_along</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">dim</span>, <span class="ruby-identifier">len</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_f</span>)
  <span class="ruby-keyword">end</span>


  <span class="ruby-comment"># interpolate the value on the poles (i.e., lat = -90/+90 deg by the mean of values on surrounding grid points)</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">interpolate_pole</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_interpolate_pole</span>

  <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span>,<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ignoreunit</span>


  <span class="ruby-comment"># preparation to use spherical_harmonics_next module</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sht</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ES</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">true</span>)
    <span class="ruby-identifier">nmax</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">length</span><span class="ruby-operator">/</span><span class="ruby-value">3</span>
    <span class="ruby-identifier">gw</span>, <span class="ruby-identifier">pmn</span>, <span class="ruby-identifier">dpmn</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_init</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">val</span>, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">val</span>, <span class="ruby-identifier">nmax</span>, <span class="ruby-identifier">gp</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_zonal_shift</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">zonal_shift_on_sphere</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-ivar">@OPT_zonal_shift</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_wnf_analysis</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">wnf_analysis</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-keyword">end</span>



  <span class="ruby-comment">## for case of calculating difference of two gphys object</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_diff</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_srot</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_sdiv</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_divide</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_HKE</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ES</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;--diff/rot/div option must be used with even numbers (2, 4, 6,...) of gturls&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">prev_gturl</span> = <span class="ruby-identifier">gturl</span>; <span class="ruby-identifier">prev_gp</span> = <span class="ruby-identifier">gp</span>
    <span class="ruby-identifier">gturl</span> = <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-identifier">gturl</span>)
    <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">gp</span>)
      <span class="ruby-identifier">gturl</span> = <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-identifier">gturl</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span>,<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ignoreunit</span>


    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_diff</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Taking difference: #{prev_gturl} - #{gturl}\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot; - &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">prev_gp</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">gp</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_divide</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Taking division: #{prev_gturl} / #{gturl}\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot; / &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">prev_gp</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">gp</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_srot</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  calculating rot(#{prev_gturl},#{gturl}) on sphere with radius #{@Radius}\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-string">&quot;rot(&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot;,&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span><span class="ruby-node">+&quot;) on sphere with radius #{@Radius}&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">rot_s</span>(<span class="ruby-identifier">prev_gp</span>,<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_sht</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_vorticity</span>(<span class="ruby-identifier">prev_gp</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-ivar">@Radius</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_sht</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_sdiv</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  calculating div(#{prev_gturl},#{gturl}) on sphere with radius #{@Radius}\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-string">&quot;div(&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot;,&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span><span class="ruby-node">+&quot;) on sphere with radius #{@Radius}&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">div_s</span>(<span class="ruby-identifier">prev_gp</span>,<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_sht</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_divergence</span>(<span class="ruby-identifier">prev_gp</span>,<span class="ruby-identifier">gp</span>,<span class="ruby-ivar">@Radius</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_sht</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_HKE</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Calculating Horizontal Kinetic Energy: [(#{prev_gturl})^2 + (#{gturl})^2]/2\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-string">&quot;[(&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot;)^2 + (&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span><span class="ruby-string">+&quot;)^2]/2&quot;</span>
      <span class="ruby-identifier">gp</span> = (<span class="ruby-identifier">prev_gp</span><span class="ruby-operator">*</span><span class="ruby-identifier">prev_gp</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span><span class="ruby-operator">*</span><span class="ruby-identifier">gp</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.5</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-string">&quot;HKE&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-string">&quot;Horizontal Kinetic Energy&quot;</span>)

    <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_ES</span>)
      <span class="ruby-identifier">comp_ary</span> = <span class="ruby-ivar">@OPT_ES</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;vor_div_given&quot;</span>)) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">flag_vor_div_given</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;vor_div_given&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">flag_vor_div_given</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">comp_ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;total&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">comp_ary</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>


      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;  Calculating Energy Spectra \n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-string">&quot;Energy spectra from &quot;</span> <span class="ruby-operator">+</span><span class="ruby-identifier">prev_gturl</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot; and &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gturl</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># use parallel</span>
        <span class="ruby-identifier">prev_gp</span> = <span class="ruby-identifier">prev_gp</span>.<span class="ruby-identifier">copy</span>; <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">copy</span>
        <span class="ruby-identifier">np</span> = (<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;OMP_NUM_THREADS&#39;</span>]<span class="ruby-operator">||</span> <span class="ruby-value">4</span>).<span class="ruby-identifier">to_i</span>
        <span class="ruby-identifier">dname</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-value">-1</span>]
        <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operation is processed along #{dname} dim with #{np} proccesses. This may take a while...\n&quot;</span>
        <span class="ruby-identifier">gpa</span> = <span class="ruby-constant">Parallel</span>.<span class="ruby-identifier">map</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>, <span class="ruby-value">:in_processes</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">np</span>, <span class="ruby-value">:progress</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;progress&quot;</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># #        gp, gturl = open_gturl_wildcard(gturl, true)</span>
    <span class="ruby-comment">#       tmp_gp = reopen(gp).cut_rank_conserving(dims_remained[-1]=&gt;i)</span>
    <span class="ruby-comment">#       if @OPT_set_assoc_coords then</span>
    <span class="ruby-comment">#         tmp_assoc_coords = reopen(@assoc_coords).cut_rank_conserving(dims_remained[-1]=&gt;i)</span>
    <span class="ruby-comment">#         tmp_gp.set_assoc_coords(tmp_assoc_coords)</span>
    <span class="ruby-comment">#       end</span>
          <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_energyspectrum</span>(<span class="ruby-identifier">prev_gp</span>.<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">dname</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">i</span>), <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">dname</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">i</span>) , <span class="ruby-ivar">@Radius</span>, <span class="ruby-identifier">comp_ary</span>, <span class="ruby-identifier">flag_vor_div_given</span>)
        }
        <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gpa</span>.<span class="ruby-identifier">transpose</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">ga</span><span class="ruby-operator">|</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">ga</span>) }
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">gp</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_energyspectrum</span>(<span class="ruby-identifier">prev_gp</span>, <span class="ruby-identifier">gp</span>, <span class="ruby-ivar">@Radius</span>, <span class="ruby-identifier">comp_ary</span>, <span class="ruby-identifier">flag_vor_div_given</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">ARGV</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gp</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]; <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">flatten!</span>
        <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span>]
      <span class="ruby-keyword">end</span>
      <span class="ruby-ivar">@OPT_ES</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>

  <span class="ruby-keyword">end</span>


<span class="ruby-comment">#  gp = GAnalysis::Planet.grad_sx(gp) if @OPT_dlon</span>
<span class="ruby-comment">#  gp = GAnalysis::Planet.grad_sy_cosphifact(gp,1) if @OPT_dlat</span>

  <span class="ruby-comment">## for case of calculating sum of gphys objects</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_add</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ensemble_mean</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;--add/em option must be used with gturls more than one&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Summing up: #{gturl} \n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
    <span class="ruby-identifier">count</span> = <span class="ruby-value">1</span>;
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">regrid</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_regrid</span>
    <span class="ruby-identifier">gpary</span> = [<span class="ruby-identifier">gp</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ensemble_mean</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;concat&quot;</span>
    <span class="ruby-keyword">while</span> (<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">prev_gturl</span> = <span class="ruby-identifier">gturl</span>; <span class="ruby-identifier">prev_gp</span> = <span class="ruby-identifier">gp</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-identifier">gturl</span>)
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">regrid</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_regrid</span>
      <span class="ruby-identifier">gpary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gp</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ensemble_mean</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;concat&quot;</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">prev_gp</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  adding up:   + #{gturl}\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot; + &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span>
      <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-identifier">count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">break</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">count</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@OPT_ensemble_mean</span>.<span class="ruby-identifier">to_i</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_ensemble_mean</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;concat&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">gpary</span>, <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">count</span>).<span class="ruby-identifier">indgen!</span>, <span class="ruby-string">&quot;member&quot;</span>, {<span class="ruby-string">&quot;unit&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;1&quot;</span>, <span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;ensemble member&quot;</span>}).<span class="ruby-identifier">copy</span>
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;  Ensemble members are concatenated.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@OPT_ensemble_mean</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">assoc_coords</span>=<span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">assoc_coords</span>) <span class="ruby-comment"># assoc_coordsがあると演算がうまくいかない</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">count</span>.<span class="ruby-identifier">to_f</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;  Taking the ensemble mean.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">## for case of appling mathematical operation to multiple variables</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_mvo</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_ntype</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sfloat&quot;</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">typecode</span> = <span class="ruby-value">4</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">typecode</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">unused_gturl</span> = []
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;ax0&quot;</span>)
      <span class="ruby-identifier">ax0</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
      <span class="ruby-identifier">ax0</span> = <span class="ruby-identifier">ax0</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-ivar">@OPT_ntype</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ntype</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;ax1&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">ax1_tmp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">ax1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">new</span>((<span class="ruby-identifier">typecode</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ax1_tmp</span>.<span class="ruby-identifier">typecode</span>), <span class="ruby-operator">*</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">first2D</span>.<span class="ruby-identifier">shape</span>)
      <span class="ruby-identifier">ax1</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ax1</span>[<span class="ruby-identifier">i</span>,<span class="ruby-keyword">true</span>] = <span class="ruby-identifier">ax1_tmp</span>}
      <span class="ruby-identifier">ax1</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ax1</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>}, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">name</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;ax2&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">ax2_tmp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">ax2</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">new</span>((<span class="ruby-identifier">typecode</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ax2_tmp</span>.<span class="ruby-identifier">typecode</span>), <span class="ruby-operator">*</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">2</span>])
      <span class="ruby-identifier">ax2</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ax2</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ax2</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>,<span class="ruby-keyword">true</span>] = <span class="ruby-identifier">ax2_tmp</span>}
      }
      <span class="ruby-identifier">ax2</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ax2</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>}, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">name</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;ax3&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">ax3_tmp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">ax3</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">new</span>((<span class="ruby-identifier">typecode</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ax3_tmp</span>.<span class="ruby-identifier">typecode</span>), <span class="ruby-operator">*</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">3</span>])
      <span class="ruby-identifier">ax3</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">ax3</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">ax3</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>].<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ax3</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">true</span>] = <span class="ruby-identifier">ax3_tmp</span>}
        }
      }
      <span class="ruby-identifier">ax3</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">ax3</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>}, <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">3</span>).<span class="ruby-identifier">name</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">ntype</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;sfloat&quot;</span> <span class="ruby-keyword">then</span>  <span class="ruby-identifier">nb</span> = <span class="ruby-value">4</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;float&quot;</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">nb</span> = <span class="ruby-value">8</span>
    <span class="ruby-keyword">else</span> <span class="ruby-identifier">nb</span> = <span class="ruby-value">4</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> ( (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-identifier">nb</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2.2E9</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_parallel</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span> ) <span class="ruby-keyword">then</span> <span class="ruby-comment"># for GPhys ogject larger than 2GB</span>
      <span class="ruby-identifier">np</span> = (<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;OMP_NUM_THREADS&#39;</span>]<span class="ruby-operator">||</span> <span class="ruby-value">4</span>).<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">da_name</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">name</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_parallel</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_parallel</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">da_name</span> = <span class="ruby-ivar">@OPT_parallel</span> <span class="ruby-comment"># 分割処理する軸を陽に指定する</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">da_val_ary</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">da_name</span>).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operation is processed along #{da_name} dim with #{np} proccesses. This may take a while...\n&quot;</span>
      <span class="ruby-identifier">xx</span> = <span class="ruby-identifier">gp</span> ; <span class="ruby-identifier">print</span> <span class="ruby-node">&quot; x : #{gturl}\n&quot;</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">yy</span>, <span class="ruby-identifier">zz</span>, <span class="ruby-identifier">uu</span>, <span class="ruby-identifier">vv</span>, <span class="ruby-identifier">ww</span> = [<span class="ruby-string">&quot;y&quot;</span>,<span class="ruby-string">&quot;z&quot;</span>,<span class="ruby-string">&quot;u&quot;</span>,<span class="ruby-string">&quot;v&quot;</span>,<span class="ruby-string">&quot;w&quot;</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>])
            <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gp</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
            <span class="ruby-identifier">print</span> <span class="ruby-node">&quot; #{i} : #{gturl}\n&quot;</span>
            <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
            <span class="ruby-identifier">gp</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">unused_gturl</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]
            <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>; <span class="ruby-keyword">nil</span>
          <span class="ruby-keyword">end</span>
        }
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">xx</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NetCDF</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># NetCDF4 対策</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">xx</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">format</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span> ) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">xx</span>, <span class="ruby-identifier">yy</span>, <span class="ruby-identifier">zz</span>, <span class="ruby-identifier">uu</span>, <span class="ruby-identifier">vv</span>, <span class="ruby-identifier">ww</span> = [<span class="ruby-identifier">xx</span>, <span class="ruby-identifier">yy</span>, <span class="ruby-identifier">zz</span>, <span class="ruby-identifier">uu</span>, <span class="ruby-identifier">vv</span>, <span class="ruby-identifier">ww</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tt</span><span class="ruby-operator">|</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">tt</span> = (<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">da_val_ary</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">da_name</span>) <span class="ruby-keyword">then</span>
                  <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">da_name</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">da_val_ary</span>[<span class="ruby-identifier">i</span>]).<span class="ruby-identifier">copy</span>
                <span class="ruby-keyword">else</span>
                  <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">copy</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">da_name</span>)
                <span class="ruby-keyword">end</span>
              }
            <span class="ruby-keyword">end</span>
          }
          <span class="ruby-ivar">@flag_on_memory</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;operation: #{@OPT_mvo} \n&quot;</span>
      <span class="ruby-identifier">gpa</span> = <span class="ruby-constant">Parallel</span>.<span class="ruby-identifier">map</span>((<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">da_val_ary</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)).<span class="ruby-identifier">to_a</span>, <span class="ruby-value">:in_processes</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">np</span>, <span class="ruby-value">:progress</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;progress&quot;</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_on_memory</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">x</span> = <span class="ruby-identifier">xx</span>[<span class="ruby-identifier">i</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">x</span> = <span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">xx</span>).<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">da_name</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">i</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">w</span> = [<span class="ruby-identifier">yy</span>, <span class="ruby-identifier">zz</span>, <span class="ruby-identifier">uu</span>, <span class="ruby-identifier">vv</span>, <span class="ruby-identifier">ww</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tt</span><span class="ruby-operator">|</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">tt</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_on_memory</span>) <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">t</span> = <span class="ruby-identifier">tt</span>[<span class="ruby-identifier">i</span>]
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">t</span> = <span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">tt</span>).<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">da_name</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">da_val_ary</span>[<span class="ruby-identifier">i</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">da_name</span>)
              <span class="ruby-identifier">t</span> = <span class="ruby-identifier">tt</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">da_name</span>)
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">t</span> = <span class="ruby-keyword">nil</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">t</span>
        }
        <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;x = #{@OPT_mvo}&quot;</span>; <span class="ruby-identifier">x</span>
      }
      <span class="ruby-identifier">x</span> = <span class="ruby-identifier">xx</span>; <span class="ruby-identifier">y</span> = <span class="ruby-identifier">yy</span>; <span class="ruby-identifier">z</span> = <span class="ruby-identifier">zz</span>; <span class="ruby-identifier">u</span> = <span class="ruby-identifier">uu</span>; <span class="ruby-identifier">v</span> = <span class="ruby-identifier">vv</span>; <span class="ruby-identifier">w</span> = <span class="ruby-identifier">ww</span>
      <span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">w</span> = [<span class="ruby-identifier">x</span>,<span class="ruby-identifier">y</span>,<span class="ruby-identifier">z</span>,<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-identifier">w</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">t</span>[<span class="ruby-value">0</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">t</span>
        <span class="ruby-keyword">end</span>
      }
<span class="ruby-comment">#      @flag_on_memory = nil; @OPT_parallel = false</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nc4a</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-ivar">@flag_mvo_gpa</span> = <span class="ruby-keyword">true</span>; <span class="ruby-ivar">@OPT_parallel</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;combining #{gpa.size} gphys objects... this may take very long time.&quot;</span>
        <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">gpa</span>)
      <span class="ruby-keyword">end</span>


    <span class="ruby-keyword">else</span> <span class="ruby-comment">#single proccess</span>
      <span class="ruby-identifier">x</span> = <span class="ruby-identifier">gp</span> ; <span class="ruby-identifier">print</span> <span class="ruby-node">&quot; x : #{gturl}\n&quot;</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">w</span> = [<span class="ruby-string">&quot;y&quot;</span>,<span class="ruby-string">&quot;z&quot;</span>,<span class="ruby-string">&quot;u&quot;</span>,<span class="ruby-string">&quot;v&quot;</span>,<span class="ruby-string">&quot;w&quot;</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">i</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">empty?</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>) <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>])
              <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gp</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">false</span>
            <span class="ruby-keyword">elsif</span> (<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">gp</span> = <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">print</span> <span class="ruby-node">&quot; #{i} : #{gturl}\n&quot;</span>
            <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
            <span class="ruby-identifier">gp</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">unused_gturl</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]
            <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>; <span class="ruby-keyword">nil</span>
          <span class="ruby-keyword">end</span>
        }
      <span class="ruby-keyword">end</span>
<span class="ruby-comment">#      z = z.copy; z.rename(&quot;theta&quot;)</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;operation: #{@OPT_mvo} \n&quot;</span>
<span class="ruby-comment">#      binding.pry</span>
      <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;gp = #{@OPT_mvo}&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">varname</span> = <span class="ruby-ivar">@OPT_mvo</span>.<span class="ruby-identifier">clone</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/exp/</span>, <span class="ruby-string">&quot;EXP&quot;</span>)
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/ax0/</span>, <span class="ruby-identifier">x</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ax0</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/ax1/</span>, <span class="ruby-identifier">x</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-value">1</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ax1</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/ax2/</span>, <span class="ruby-identifier">x</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ax2</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/ax3/</span>, <span class="ruby-identifier">x</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-value">3</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ax3</span>

    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/x/</span>, <span class="ruby-identifier">x</span>.<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">x</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/y/</span>, <span class="ruby-identifier">y</span>.<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">y</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/z/</span>, <span class="ruby-identifier">z</span>.<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">z</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/u/</span>, <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">u</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/v/</span>, <span class="ruby-identifier">v</span>.<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span>
    <span class="ruby-identifier">varname</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp">/w/</span>, <span class="ruby-identifier">w</span>.<span class="ruby-identifier">name</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">w</span>
    <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">gp</span>; <span class="ruby-identifier">abort</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-identifier">varname</span>)
        <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-identifier">varname</span>)
      <span class="ruby-keyword">rescue</span>

      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-node">&quot;operation: #{varname}&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># put back the unused gturl to ARGV and set @OPT_mvo to false</span>
    <span class="ruby-identifier">unused_gturl</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>  <span class="ruby-constant">ARGV</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">g</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">g</span> }
    <span class="ruby-ivar">@OPT_mvo</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">## for case of calculating sum of gphys objects</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_join</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;--add/em option must be used with gturls more than one&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Joining: #{gturl} \n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
    <span class="ruby-identifier">count</span> = <span class="ruby-value">1</span>
    <span class="ruby-keyword">while</span> (<span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">prev_gturl</span> = <span class="ruby-identifier">gturl</span>; <span class="ruby-identifier">prev_gp</span> = <span class="ruby-identifier">gp</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-constant">ARGV</span>[<span class="ruby-value">0</span>]
      <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-identifier">gturl</span>)
      <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>([<span class="ruby-identifier">prev_gp</span>, <span class="ruby-identifier">gp</span>])
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Joining:   + #{gturl}\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">prev_gturl</span><span class="ruby-string">+&quot; + &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gturl</span>
      <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-identifier">count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 軸の値に重複がないか調べる。あればエラーを返す。</span>
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">axis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">a</span>).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">axis</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">axis</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">length</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;ERROR: joined GPhys object has dupulicate value(s) in axis &#39;#{a}&#39;&#39;&quot;</span>
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>




  <span class="ruby-comment">###---------------------------------------------</span>

  <span class="ruby-comment">## apply composite</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">composite</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_composite</span>)

  <span class="ruby-comment">## apply split axis</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">split_axis</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_split_axis</span>)

  <span class="ruby-comment">## apply lowpass filter</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">lowpass</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_lowpass</span>)

  <span class="ruby-comment">## apply highpass filter</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">highpass</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_highpass</span>)

  <span class="ruby-comment">## interpolate to gausian latitude and correspond longitude</span>
  <span class="ruby-comment">## --regrid requires number of latitude grid poins.</span>
  <span class="ruby-comment">## --GLAT can automatically set the number of grid points.</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gglat</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_GLAT</span>)
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">regrid</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_regrid</span>)


  <span class="ruby-comment">## apply Land/Ocean mask</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_land</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_ocean</span>) <span class="ruby-comment"># or @OPT_color_scatter)</span>
    <span class="ruby-identifier">gp_lon</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">gp_lat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">assoc_coords</span>=<span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">assoc_coords</span>) <span class="ruby-comment"># assoc_coordsがあると演算がうまくいかない</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_land</span>)
      <span class="ruby-identifier">gp_lm</span> = <span class="ruby-identifier">lmask</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">gp_lon</span>,<span class="ruby-identifier">gp_lat</span>)
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span><span class="ruby-operator">*</span><span class="ruby-identifier">gp_lm</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_ocean</span>)
      <span class="ruby-identifier">gp_om</span> = <span class="ruby-identifier">omask</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">gp_lon</span>,<span class="ruby-identifier">gp_lat</span>)
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span><span class="ruby-operator">*</span><span class="ruby-identifier">gp_om</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">## power spectra</span>
  <span class="ruby-comment"># gp = powerspectra(gp) if (@OPT_power_spectra)</span>

  <span class="ruby-comment">## derivative along any axis (preparation)</span>
  <span class="ruby-identifier">dims_deriv</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_derivative</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_derivative</span>

  <span class="ruby-comment">## mean along any axis (preparation)</span>
  <span class="ruby-identifier">dims_mean</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_mean</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_mean</span>)

  <span class="ruby-comment">## running mean along any axis (preparation)</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_running_mean</span>)
    <span class="ruby-identifier">rm_ary</span> = <span class="ruby-ivar">@OPT_running_mean</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
    <span class="ruby-identifier">rm_ary</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">rm_dim</span>, <span class="ruby-identifier">rm_span</span>, <span class="ruby-identifier">rm_skip</span> = <span class="ruby-identifier">a</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*:\s*/</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">rm_dim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span>  <span class="ruby-operator">==</span> <span class="ruby-identifier">rm_dim</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">rm_dim</span> = <span class="ruby-identifier">rm_dim</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">rm_span</span> = <span class="ruby-identifier">rm_span</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-identifier">rm_skip</span> = <span class="ruby-identifier">rm_skip</span>.<span class="ruby-identifier">to_i</span>
      [<span class="ruby-identifier">rm_dim</span>, <span class="ruby-identifier">rm_span</span>, <span class="ruby-identifier">rm_skip</span>]
    }
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">## standard deviation along any axis (preparation)</span>
  <span class="ruby-identifier">dims_stddev</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_stddev</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_stddev</span>)

  <span class="ruby-comment">## max along any axis (preparation)</span>
  <span class="ruby-identifier">dims_max</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_max</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_max</span>)

  <span class="ruby-comment">## min along any axis (preparation)</span>
  <span class="ruby-identifier">dims_min</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_min</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_min</span>)

  <span class="ruby-comment">## deviation from mean along any axis (preparation)</span>
  <span class="ruby-identifier">dims_eddy</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_eddy</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_eddy</span>)

  <span class="ruby-comment">## integration along any axis (preparation)</span>
  <span class="ruby-identifier">dims_integrate</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_integrate</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_integrate</span>)

  <span class="ruby-comment">## sum along any axis (preparation)</span>
  <span class="ruby-identifier">dims_sum</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_sum</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sum</span>)

  <span class="ruby-comment">## adding up along any axis (preparation)</span>
  <span class="ruby-identifier">dims_addingup</span> = <span class="ruby-identifier">set_dims</span>(<span class="ruby-ivar">@OPT_addingup</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_addingup</span>)

  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">margin_info</span>(<span class="ruby-identifier">$0</span>, <span class="ruby-identifier">gturl</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-value">0.0</span>, <span class="ruby-value">0.0</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-value">0.0</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@annotate</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@flag_margin</span> <span class="ruby-comment"># draw margin infomation</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">slsttl</span>(<span class="ruby-identifier">gturl</span>, <span class="ruby-string">&#39;b&#39;</span>,  <span class="ruby-value">1.0</span>, <span class="ruby-value">-1.0</span>, <span class="ruby-value">0.008</span>, <span class="ruby-value">2</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@annotate</span>
  <span class="ruby-ivar">@flag_margin</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-comment"># set missing value to specific value.</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_set_missing_value</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">copy</span>
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">set_missing_value</span>(<span class="ruby-ivar">@OPT_set_missing_value</span>.<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">all_valid</span>)
  <span class="ruby-keyword">end</span>


  <span class="ruby-identifier">ope_string</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_power_spectra</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;power_spectra(#{@OPT_power_spectra})&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@USED_OPTIONS</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">opt</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">opt</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_derivative&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_deriv</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;derivative(#{dim})&quot;</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_running_mean&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">rm_ary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">rm</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;running_mean(#{rm})&quot;</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_mean&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_mean</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;mean(#{dim})&quot;</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_global_mean&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;-&gt;global_mean&quot;</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_stddev&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_stddev</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;stddev(#{dim})&quot;</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_max&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_max</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;max(#{dim})&quot;</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_min&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_min</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;min(#{dim})&quot;</span> }
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_eddy&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_eddy</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;eddy(#{dim})&quot;</span>}
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_integrate&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_integrate</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;integrate(#{dim})&quot;</span>}
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_sum&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_sum</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;sum(#{dim})&quot;</span>}
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;OPT_addingup&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dims_addingup</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span> <span class="ruby-identifier">ope_string</span> = <span class="ruby-identifier">ope_string</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;-&gt;addingup(#{dim})&quot;</span>}
    <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operations:#{ope_string} in this order.\n&quot;</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ope_string</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_silent</span> )

<span class="ruby-comment">#------------------------------------------------------------------------</span>
  <span class="ruby-identifier">proc</span> = <span class="ruby-constant">Proc</span>.<span class="ruby-identifier">new</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">g</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>

      <span class="ruby-comment">## power spectra</span>
      <span class="ruby-identifier">g</span> = <span class="ruby-identifier">powerspectra</span>(<span class="ruby-identifier">g</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_power_spectra</span>)


      <span class="ruby-comment">## simple operation with given order</span>
      <span class="ruby-ivar">@USED_OPTIONS</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">opt</span><span class="ruby-operator">|</span>

        <span class="ruby-comment">## derivative</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_derivative&quot;</span>)
        <span class="ruby-identifier">dims_deriv</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
          <span class="ruby-keyword">begin</span>
            <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">g</span>, <span class="ruby-keyword">true</span>)
          <span class="ruby-keyword">rescue</span>
          <span class="ruby-keyword">end</span>
          <span class="ruby-identifier">dim</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">dim_index</span>(<span class="ruby-identifier">dim</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">dim</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dim</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">lon_dim</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_sht</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># SHTモジュールを使う</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_dlon</span>(<span class="ruby-identifier">g</span>)<span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span> <span class="ruby-comment"># d/dlamda</span>
          <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">dim</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">lat_dim</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_sht</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># SHTモジュールを使う</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_dlat</span>(<span class="ruby-identifier">g</span>)<span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span> <span class="ruby-comment"># d/dmu = cos^-1(phi)*d/dphi</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">multiply_cos</span>(<span class="ruby-identifier">g</span>) <span class="ruby-comment"># cosをかけて d/dphi にする</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">threepoint_O2nd_deriv</span>(<span class="ruby-identifier">dim</span>)
          <span class="ruby-keyword">end</span>
        }
        <span class="ruby-keyword">end</span>


        <span class="ruby-comment">#### running mean</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_running_mean&quot;</span>)
          <span class="ruby-comment"># g = g.running_mean(rm_dim,rm_span,true)</span>
          <span class="ruby-comment"># GPhys付属のメソッド running_mean(dim,span,BC,minimal length)</span>
          <span class="ruby-comment"># BCは 10:SIMPLE, 11:CYCLIC, 12:TRIM</span>
          <span class="ruby-comment"># minmal length は、移動平均区間に有効なデータがその数以下のときに欠損にする。</span>
          <span class="ruby-comment"># 以下の設定で、従来と同じ振る舞いになる。</span>
          <span class="ruby-identifier">rm_ary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">rm</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">rm_dim</span> = <span class="ruby-identifier">rm</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">rm_span</span>=<span class="ruby-identifier">rm</span>[<span class="ruby-value">1</span>]; <span class="ruby-identifier">rm_skip</span>=<span class="ruby-identifier">rm</span>[<span class="ruby-value">2</span>]
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">running_mean</span>(<span class="ruby-identifier">rm_dim</span>,<span class="ruby-identifier">rm_span</span>,<span class="ruby-value">10</span>,<span class="ruby-identifier">rm_span</span>)
            <span class="ruby-keyword">unless</span> <span class="ruby-identifier">rm_skip</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
              <span class="ruby-identifier">thinning</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>; <span class="ruby-identifier">thinning</span>[<span class="ruby-identifier">rm_dim</span>] = {(<span class="ruby-identifier">rm_span</span><span class="ruby-operator">/</span><span class="ruby-value">2</span><span class="ruby-operator">..</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">rm_span</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>))<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">rm_skip</span>}
              <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>[<span class="ruby-identifier">thinning</span>]
            <span class="ruby-keyword">end</span>
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## mean along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_mean&quot;</span>)
            <span class="ruby-ivar">@stddev</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">stddev</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims_mean</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_overplot_stddev</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">dims_mean</span>)
          <span class="ruby-identifier">dims_mean</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-comment"># @stddev = @stddev.stddev(dim) if @OPT_overplot_stddev</span>
            <span class="ruby-comment"># g = g.average(dim)</span>
            <span class="ruby-comment"># g = g.mean(dim)</span>
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">#### global mean</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_global_mean&quot;</span>)
          <span class="ruby-keyword">if</span> (<span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">g</span>, <span class="ruby-keyword">true</span>)
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NMath</span><span class="ruby-operator">::</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">pos</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>), <span class="ruby-keyword">nil</span>, <span class="ruby-string">&quot;sin_lat&quot;</span>) )
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">average</span>(<span class="ruby-string">&quot;sin_lat&quot;</span>) <span class="ruby-comment"># global mean</span>
            <span class="ruby-comment"># g = GAnalysis::Planet.ave_s(g)</span>
          <span class="ruby-keyword">else</span> <span class="ruby-comment"># 経度がない場合</span>
            <span class="ruby-identifier">lat_dim</span> = <span class="ruby-value">0</span>
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-constant">NMath</span><span class="ruby-operator">::</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">pos</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>), <span class="ruby-keyword">nil</span>, <span class="ruby-string">&quot;sin_lat&quot;</span>) )
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">average</span>(<span class="ruby-value">0</span>) <span class="ruby-comment"># global mean</span>
          <span class="ruby-keyword">end</span>

       <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## standard deviation along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_stddev&quot;</span>)
          <span class="ruby-identifier">dims_stddev</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">stddev</span>(<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## max values along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_max&quot;</span>)
          <span class="ruby-identifier">dims_max</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">max</span>(<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## min values along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_min&quot;</span>)
          <span class="ruby-identifier">dims_min</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">min</span>(<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## deviation from mean along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_eddy&quot;</span>)
          <span class="ruby-identifier">dims_eddy</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">eddy</span>(<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## integration along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_integrate&quot;</span>)
          <span class="ruby-identifier">dims_integrate</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">integrate</span>(<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment">## sum along any axis</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_sum&quot;</span>)
          <span class="ruby-identifier">dims_sum</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">sum</span>(<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">opt</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;OPT_addingup&quot;</span>)
          <span class="ruby-identifier">dims_addingup</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">addingup</span>(<span class="ruby-identifier">g</span>,<span class="ruby-identifier">dim</span>)
          }
        <span class="ruby-keyword">end</span>
      } <span class="ruby-comment">## simple operations end</span>



      <span class="ruby-comment">## operation of a mathematical function</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_operation</span>)
        <span class="ruby-identifier">p</span> <span class="ruby-node">&quot;g = g.#{@OPT_operation}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
        <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;g = g.#{@OPT_operation}&quot;</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_normalize</span>)
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">rank</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_normalize</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span><span class="ruby-operator">/</span><span class="ruby-identifier">g</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">val</span>
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>)<span class="ruby-string">+&quot; normalized by init&quot;</span> )
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;1&quot;</span>
          <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_normalize</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;mean&quot;</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span><span class="ruby-operator">/</span><span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">mean</span>
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>)<span class="ruby-string">+&quot; normalized by mean&quot;</span> )
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;1&quot;</span>
          <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_normalize</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;diff&quot;</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">g</span>[<span class="ruby-value">5</span>].<span class="ruby-identifier">val</span>
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>)<span class="ruby-string">+&quot; diff from init&quot;</span> )
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;1&quot;</span>
          <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_normalize</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;absmax&quot;</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span><span class="ruby-operator">/</span><span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">max</span>
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>)<span class="ruby-string">+&quot; diff from init&quot;</span> )
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;1&quot;</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">norm</span> = <span class="ruby-ivar">@OPT_normalize</span>.<span class="ruby-identifier">to_f</span>
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span><span class="ruby-operator">/</span><span class="ruby-identifier">norm</span>
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>)<span class="ruby-string">+&quot; normalized by &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">norm</span>.<span class="ruby-identifier">to_s</span>)
            <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;1&quot;</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">2</span>


        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">norm</span> = <span class="ruby-ivar">@OPT_normalize</span>.<span class="ruby-identifier">to_f</span>
          <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span><span class="ruby-operator">/</span><span class="ruby-identifier">norm</span>
          <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>,<span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>)<span class="ruby-string">+&quot; normalized by &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">norm</span>.<span class="ruby-identifier">to_s</span>)
          <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-string">&quot;1&quot;</span>

        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>


      <span class="ruby-comment">### interpolate after operation</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_interpolate</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sig2p</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># for large file</span>
          <span class="ruby-identifier">dim</span> = (<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">SigmaCoord</span><span class="ruby-operator">::</span><span class="ruby-identifier">find_sigma_d</span>(<span class="ruby-identifier">g</span>) <span class="ruby-operator">||</span> <span class="ruby-value">2</span>) <span class="ruby-comment"># if cannot find sigma axis, assume 3rd axis.</span>
          <span class="ruby-identifier">sig</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">to_gphys</span>
          <span class="ruby-identifier">press</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">SigmaCoord</span><span class="ruby-operator">::</span><span class="ruby-identifier">sig_ps2p</span>(<span class="ruby-ivar">@PS</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">g</span>.<span class="ruby-identifier">shape</span>.<span class="ruby-identifier">index</span>(<span class="ruby-value">1</span>)]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">i</span>), <span class="ruby-identifier">sig</span>, <span class="ruby-identifier">dim</span>)
          <span class="ruby-identifier">press</span>.<span class="ruby-identifier">units</span>=(<span class="ruby-string">&quot;Pa&quot;</span>); <span class="ruby-identifier">press</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;positive&quot;</span>,<span class="ruby-string">&quot;down&quot;</span>)
          <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_assoc_coords</span>([<span class="ruby-identifier">press</span>])
          <span class="ruby-comment"># binding.pry</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">axes</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axnames</span>; <span class="ruby-identifier">assoc_coords</span> = (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">assoccoordnames</span> <span class="ruby-operator">||</span> [] )
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_interpolate</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;=&quot;</span>)) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">cutaxis</span>, <span class="ruby-identifier">val</span> = <span class="ruby-ivar">@OPT_interpolate</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;=&quot;</span>)
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;:&quot;</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">vmin</span>, <span class="ruby-identifier">vmax</span>, <span class="ruby-identifier">step</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
            <span class="ruby-identifier">vmin</span> = <span class="ruby-identifier">vmin</span>.<span class="ruby-identifier">to_f</span>; <span class="ruby-identifier">vmax</span> = <span class="ruby-identifier">vmax</span>.<span class="ruby-identifier">to_f</span>
            <span class="ruby-identifier">step</span> = <span class="ruby-value">30</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">step</span> <span class="ruby-comment"># use default steps if not given</span>
            <span class="ruby-identifier">step</span> = <span class="ruby-identifier">step</span>.<span class="ruby-identifier">to_f</span>
            <span class="ruby-identifier">vwidth</span> = (<span class="ruby-identifier">vmax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">step</span>
            <span class="ruby-identifier">nval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">step</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">indgen!</span><span class="ruby-operator">*</span><span class="ruby-identifier">vwidth</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">vmin</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span>
            <span class="ruby-identifier">nval</span> = <span class="ruby-constant">NumRu</span><span class="ruby-operator">::</span><span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">step</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">indgen!</span><span class="ruby-operator">*</span><span class="ruby-identifier">vwidth</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">vmin</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;bigmem&quot;</span>
          <span class="ruby-keyword">elsif</span>(<span class="ruby-identifier">val</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;auto&quot;</span>)
            <span class="ruby-comment"># set latter</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">val</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">val</span>)
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span> <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">nval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">val</span>).<span class="ruby-identifier">to_type</span>(<span class="ruby-string">&quot;sfloat&quot;</span>)
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">nval</span> = <span class="ruby-constant">NArray</span>[<span class="ruby-identifier">val</span>].<span class="ruby-identifier">to_type</span>(<span class="ruby-string">&quot;sfloat&quot;</span>)
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">if</span> <span class="ruby-identifier">axes</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cutaxis</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">va</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">cutaxis</span>)
            <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nval</span>,{<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">va</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>},<span class="ruby-identifier">cutaxis</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">va</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">cutaxis</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">val</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>)
          <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">assoc_coords</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">cutaxis</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">va</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">assoc_coords</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">cutaxis</span>) <span class="ruby-comment"># assoc_coordsをVArray化</span>
            <span class="ruby-identifier">ax_dim</span> = <span class="ruby-value">0</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">va</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># va[true, 0, 0].stddev.valが最大となる軸が対応する軸だと判断する。</span>
              <span class="ruby-identifier">max</span> = <span class="ruby-value">0</span>
              <span class="ruby-identifier">va</span>.<span class="ruby-identifier">rank</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">cut_array</span> = <span class="ruby-identifier">va</span>.<span class="ruby-identifier">shape_current</span>.<span class="ruby-identifier">clone</span>.<span class="ruby-identifier">fill</span>(<span class="ruby-value">0</span>) ; <span class="ruby-identifier">cut_array</span>[<span class="ruby-identifier">i</span>]=<span class="ruby-keyword">true</span>
                <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">va</span>[<span class="ruby-operator">*</span><span class="ruby-identifier">cut_array</span>].<span class="ruby-identifier">stddev</span>
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">tmp</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">val</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">tmp</span> = <span class="ruby-value">0</span> <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">if</span> (<span class="ruby-identifier">max</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">tmp</span>) <span class="ruby-keyword">then</span>
                  <span class="ruby-identifier">max</span> = <span class="ruby-identifier">tmp</span>; <span class="ruby-identifier">ax_dim</span> = <span class="ruby-identifier">i</span>
                <span class="ruby-keyword">end</span>
              }
            <span class="ruby-keyword">end</span>
            <span class="ruby-keyword">if</span> (<span class="ruby-identifier">val</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;auto&quot;</span>) <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">tmp</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">va</span>.<span class="ruby-identifier">rank</span>).<span class="ruby-identifier">indgen</span>.<span class="ruby-identifier">to_a</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span>
              <span class="ruby-identifier">tmp</span> = <span class="ruby-constant">NumRu</span><span class="ruby-operator">::</span><span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">va</span>.<span class="ruby-identifier">rank</span>).<span class="ruby-identifier">indgen</span>.<span class="ruby-identifier">to_a</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;bigmem&quot;</span>
              <span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">ax_dim</span>)
              <span class="ruby-identifier">aval</span> = <span class="ruby-identifier">rgn</span>(<span class="ruby-identifier">va</span>.<span class="ruby-identifier">mean</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>).<span class="ruby-identifier">val</span>).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">uniq</span> <span class="ruby-comment"># 重複を取り除く</span>
              <span class="ruby-identifier">nval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">aval</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span>
              <span class="ruby-identifier">nval</span> = <span class="ruby-constant">NumRu</span><span class="ruby-operator">::</span><span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-identifier">aval</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;bigmem&quot;</span>
            <span class="ruby-keyword">end</span>
            <span class="ruby-identifier">va</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nval</span>,{<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">va</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>,<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">va</span>.<span class="ruby-identifier">long_name</span>},<span class="ruby-identifier">cutaxis</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">axes</span>[<span class="ruby-identifier">ax_dim</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">va</span>)
            <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">cutaxis</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">val</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>)
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;axis #{cutaxis} is not contained.&quot;</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">end</span>

      <span class="ruby-comment">### add offset</span>
      <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span> <span class="ruby-operator">+</span>  <span class="ruby-ivar">@OPT_offset</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_offset</span>)

      <span class="ruby-comment">### cut, slice, thinning after operation</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_cut</span>)
        <span class="ruby-identifier">g</span> = <span class="ruby-identifier">cut_slice_thinning</span>(<span class="ruby-identifier">g</span>,<span class="ruby-ivar">@OPT_cut</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_produce</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">case</span> <span class="ruby-ivar">@OPT_produce</span>
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;solar_zenith_angle&quot;</span>
          <span class="ruby-identifier">g</span> = <span class="ruby-identifier">solar_zenith_angle</span>(<span class="ruby-identifier">g</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;reflectance&quot;</span>
          <span class="ruby-identifier">g</span> = <span class="ruby-identifier">reflectance</span>(<span class="ruby-identifier">g</span>)
        <span class="ruby-keyword">end</span>


      <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">next</span> <span class="ruby-identifier">g</span> <span class="ruby-comment"># return this object</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">ntype</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;sfloat&quot;</span>
    <span class="ruby-identifier">nb</span> = <span class="ruby-value">4</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;float&quot;</span>
    <span class="ruby-identifier">nb</span> = <span class="ruby-value">8</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">nb</span> = <span class="ruby-value">4</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;missing_value&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">fact</span> = <span class="ruby-value">1.0</span> <span class="ruby-comment"># 欠損値を含んでいると、内部で2GB越えしやすい</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">fact</span> = <span class="ruby-value">1.0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> ((<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-identifier">nb</span><span class="ruby-operator">*</span><span class="ruby-identifier">fact</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2.2E9</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_parallel</span> )<span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">loopdim</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># for GPhys ogject larger than 2GB</span>
    <span class="ruby-identifier">dims_used</span> = [<span class="ruby-identifier">dims_addingup</span>, <span class="ruby-identifier">dims_deriv</span>, <span class="ruby-identifier">dims_eddy</span>, <span class="ruby-identifier">dims_flip</span>, <span class="ruby-identifier">dims_integrate</span>,
                 <span class="ruby-identifier">dims_max</span>, <span class="ruby-identifier">dims_mean</span>, <span class="ruby-identifier">dims_min</span>, <span class="ruby-identifier">dims_stddev</span>, <span class="ruby-identifier">dims_sum</span>].<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">compact</span>
    <span class="ruby-identifier">dims_remained</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">dims_used</span>
    <span class="ruby-identifier">dims_remained</span>.<span class="ruby-identifier">delete_at</span>(<span class="ruby-value">-1</span>) <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dims_remained</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">dims_remained</span>[<span class="ruby-value">-1</span>]).<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">100</span>) <span class="ruby-comment"># 分割数が超えると結合に時間が掛かるので。</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_parallel</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">dims_remained</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-ivar">@OPT_parallel</span>)) <span class="ruby-comment"># 陽に指定する</span>
      <span class="ruby-identifier">dims_remained</span> = [<span class="ruby-ivar">@OPT_parallel</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># multi-proccesses, many memory use.</span>
    <span class="ruby-identifier">np</span> = (<span class="ruby-constant">ENV</span>[<span class="ruby-string">&#39;OMP_NUM_THREADS&#39;</span>]<span class="ruby-operator">||</span> <span class="ruby-value">4</span>).<span class="ruby-identifier">to_i</span>
    <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Required object size is #{(gp.length*nb*fact/1.0E9).round(2)}GB, which is larger than 2GB.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_parallel</span>
    <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operation is processed along #{dims_remained[-1]} dim with #{np} proccesses. This may take a while......\n&quot;</span>
    <span class="ruby-identifier">remaind_dim_val_array</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">dims_remained</span>[<span class="ruby-value">-1</span>]).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_a</span>

    <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_mvo_only</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@flag_mvo_gpa</span>) <span class="ruby-keyword">then</span>

      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NetCDF</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">format</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># NetCDF4 対策</span>
          <span class="ruby-identifier">gpary</span> = (<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">remaind_dim_val_array</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)).<span class="ruby-identifier">to_a</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">dims_remained</span>[<span class="ruby-value">-1</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">remaind_dim_val_array</span>[<span class="ruby-identifier">i</span>]).<span class="ruby-identifier">copy</span>
          }
          <span class="ruby-ivar">@flag_on_memory</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">gpa</span> = <span class="ruby-constant">Parallel</span>.<span class="ruby-identifier">map</span>( (<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">remaind_dim_val_array</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)).<span class="ruby-identifier">to_a</span>, <span class="ruby-value">:in_processes</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">np</span>, <span class="ruby-value">:progress</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;progress&quot;</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
  <span class="ruby-comment">#        gp, gturl = open_gturl_wildcard(gturl, true)</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_mvo_gpa</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@flag_on_memory</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># mvo オペレーションした場合は、ファイルから再読み込みしない。</span>
          <span class="ruby-identifier">tmp_gp</span> = <span class="ruby-identifier">gpary</span>[<span class="ruby-identifier">i</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">tmp_gp</span> = <span class="ruby-identifier">reopen</span>(<span class="ruby-identifier">gp</span>).<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">dims_remained</span>[<span class="ruby-value">-1</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">remaind_dim_val_array</span>[<span class="ruby-identifier">i</span>])
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># force axis unit</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_axis_units_name</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-ivar">@OPT_axis_units_name</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">it</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">axnum</span>, <span class="ruby-identifier">unit</span>, <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">it</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
            <span class="ruby-identifier">num</span> = <span class="ruby-identifier">axnum</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;ax&quot;</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">to_i</span>
            <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">tmp_gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-comment"># 単位未指定時は変更しない</span>
            <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">tmp_gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">axname</span> <span class="ruby-comment"># 軸名未指定時は変更しない</span>
            <span class="ruby-identifier">typecode</span> = <span class="ruby-identifier">tmp_gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">typecode</span>
            <span class="ruby-identifier">tmp_gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">tmp_gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-identifier">typecode</span>), {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">axname</span>))
          }
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_set_assoc_coords</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">tmp_assoc_coords</span> = <span class="ruby-identifier">reopen</span>(<span class="ruby-ivar">@assoc_coords</span>).<span class="ruby-identifier">cut_rank_conserving</span>(<span class="ruby-identifier">dims_remained</span>[<span class="ruby-value">-1</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">remaind_dim_val_array</span>[<span class="ruby-identifier">i</span>])
          <span class="ruby-identifier">tmp_gp</span>.<span class="ruby-identifier">set_assoc_coords</span>(<span class="ruby-identifier">tmp_assoc_coords</span>)
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">tmp_gp</span>, <span class="ruby-identifier">remaind_dim_val_array</span>[<span class="ruby-identifier">i</span>])
      }
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_nc4a</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Joining #{gpa.length} GPhys objects to create a single GPhys object of #{gpa[0].length*gpa.length*nb/1.0E9} GB...\n&quot;</span>
        <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">gpa</span>)
        <span class="ruby-identifier">gary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">visualize_and_output</span>(<span class="ruby-identifier">gp</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span>
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;\n  ***  Error Occurred during visualize and output **** \n&quot;</span>
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;       Operated data size might be too large.\n&quot;</span>
      <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;       Do you want to output operated data &#39;gp&#39; as &#39;tmp.nc&#39; [Y] or start pry [p] or just abort [n]?\n&quot;</span>
        <span class="ruby-identifier">key</span> = <span class="ruby-identifier">$stdin</span>.<span class="ruby-identifier">gets</span>.<span class="ruby-identifier">chomp</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;Y&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-ivar">@OPT_nc4a</span> = <span class="ruby-string">&quot;tmp.nc&quot;</span>
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">key</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;p&quot;</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Abort&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nc4a</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nc4a</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>); <span class="ruby-identifier">outfilename</span> = <span class="ruby-string">&quot;out.nc&quot;</span>; <span class="ruby-keyword">else</span>; <span class="ruby-identifier">outfilename</span> = <span class="ruby-ivar">@OPT_nc4a</span>; <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;large data is being written as #{@OPT_nc4a} ...&quot;</span>
      <span class="ruby-identifier">gpa</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_rename</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_long_name</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_unit</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-comment">#gpa[t] = gpa[t].copy if (gpa[t].data.file != nil || gpa[t].data.file.class == NArray)</span>
          <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">rename</span>(<span class="ruby-ivar">@OPT_rename</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_rename</span>
          <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-ivar">@OPT_long_name</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_long_name</span>
          <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-ivar">@OPT_rename</span>) <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_long_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_rename</span>)
          <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">units</span>=<span class="ruby-ivar">@OPT_unit</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_unit</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_axis_units_name</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-ivar">@OPT_axis_units_name</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>).<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">it</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">axnum</span>, <span class="ruby-identifier">unit</span>, <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">it</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
            <span class="ruby-identifier">num</span> = <span class="ruby-identifier">axnum</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;ax&quot;</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">to_i</span>
            <span class="ruby-identifier">unit</span> = <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-comment"># 単位未指定時は変更しない</span>
            <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">name</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">axname</span> <span class="ruby-comment"># 軸名未指定時は変更しない</span>
            <span class="ruby-identifier">typecode</span> = <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">typecode</span>
            <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">num</span>).<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-identifier">typecode</span>), {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">unit</span>}, <span class="ruby-identifier">axname</span>))
          }
        <span class="ruby-keyword">end</span>



        <span class="ruby-identifier">auto_write</span>(<span class="ruby-identifier">outfilename</span>, <span class="ruby-identifier">gpa</span>[<span class="ruby-identifier">t</span>].<span class="ruby-identifier">to_type</span>(<span class="ruby-string">&quot;sfloat&quot;</span>), <span class="ruby-identifier">t</span>, <span class="ruby-keyword">false</span>) <span class="ruby-comment"># 第４引数は圧縮の有無（圧縮すると読み込みが遅い）</span>
      }
      <span class="ruby-identifier">print</span> <span class="ruby-string">&quot; finished\n&quot;</span>
      <span class="ruby-identifier">exit</span>
    <span class="ruby-keyword">end</span>


  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">loopdim</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-ivar">@OPT_scatter</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_color_scatter</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_histogram2D</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_cot</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_rmap</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_fullcolor</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;2&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_vector</span>) <span class="ruby-keyword">then</span>         <span class="ruby-comment"># animation</span>
    <span class="ruby-identifier">each_along_dims</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">loopdim</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">gp_subset</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">gp_subset</span> = <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">gp_subset</span>, <span class="ruby-value">0</span>)
      <span class="ruby-identifier">gary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">visualize_and_output</span>(<span class="ruby-identifier">gp_subset</span>)
    }
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">proc</span>.<span class="ruby-identifier">call</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-value">0</span>)
    <span class="ruby-identifier">gary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">visualize_and_output</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-keyword">end</span>


  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_textbox</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">draw_text</span>(<span class="ruby-ivar">@textbox</span>, <span class="ruby-identifier">gary</span>) <span class="ruby-keyword">if</span> (<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;nframe&quot;</span>) <span class="ruby-operator">%</span> (<span class="ruby-ivar">@textbox_fnum</span>) <span class="ruby-operator">==</span> <span class="ruby-ivar">@textbox_fnum</span><span class="ruby-value">-1</span>) <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
  <span class="ruby-keyword">end</span>


<span class="ruby-keyword">end</span> <span class="ruby-comment"># end of main loop for given gturl.</span>


<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_scatter</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;scatter&quot;</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_color_scatter</span>) <span class="ruby-keyword">then</span>
<span class="ruby-comment">#  gary &lt;&lt; landsea.cut(gp_lon,gp_lat)</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;color_scatter&quot;</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_cot</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;contour_over_tone&quot;</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_histogram2D</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;histogram2D&quot;</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_rmap</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;rmap&quot;</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_fullcolor</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;2&quot;</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;fullcolor2&quot;</span>)
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_vector</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">draw_multi_vars</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-string">&quot;vector&quot;</span>)
<span class="ruby-keyword">end</span>


<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_pry</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_auto_pry</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;pry&quot;</span>
  <span class="ruby-comment"># ## open work station and setup draw parameters</span>
  <span class="ruby-comment"># if (@flag_window_open == false)</span>
  <span class="ruby-comment">#   DCL.swpset(&#39;lalt&#39;,false) if @OPT_pry</span>
  <span class="ruby-comment">#   DCL.gropn(@OPT_wsn||1)</span>
  <span class="ruby-comment">#   draw_setup</span>
  <span class="ruby-comment">#   @flag_window_open = true</span>
  <span class="ruby-comment"># end</span>

  <span class="ruby-comment">#include GGraph</span>
  <span class="ruby-identifier">g</span> = <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_pry</span>
  <span class="ruby-identifier">p</span> <span class="ruby-ivar">@OPT_auto_pry</span>
  <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;#{@OPT_auto_pry}&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_auto_pry</span>
<span class="ruby-keyword">end</span>



<span class="ruby-comment"># dcl window close</span>
<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">grcls</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&quot;nframe&quot;</span>, <span class="ruby-value">0</span>) <span class="ruby-comment"># フレームの位置を戻す</span>
  <span class="ruby-comment"># DCL.sgpset(&quot;npage&quot;, 0) # ページの初期化は不要？</span>

<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@outncfile</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@outncfile</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;command&quot;</span>,<span class="ruby-ivar">@comment</span>)
  <span class="ruby-ivar">@outncfile</span>.<span class="ruby-identifier">close</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nc4</span>) <span class="ruby-keyword">then</span>
  <span class="ruby-ivar">@OPT_nc4</span> = <span class="ruby-string">&quot;out.nc&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_nc4</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">write_netcdf4</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-ivar">@OPT_nc4</span>)
<span class="ruby-keyword">end</span>


<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_file</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;eps&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-comment">#add comment</span>
  <span class="ruby-identifier">fname</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpget</span>(<span class="ruby-string">&quot;fname&quot;</span>).<span class="ruby-identifier">strip</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;npage&quot;</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">pnum</span> = <span class="ruby-identifier">sprintf</span>(<span class="ruby-string">&quot;%04d&quot;</span>,(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">to_s</span>)
    <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_SSED} -i -e &#39;2i %%Comment: #{@comment}&#39; #{fname}_#{pnum}.eps&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_SSED</span>
  }
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_file</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;png&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-comment"># add comment &amp; crop</span>
  <span class="ruby-comment"># gif アニメを作成する</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_gif</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_CONVERT} -delay 50 -loop 0 dcl_????.png dcl.gif&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_CONVERT</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_mp4</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">frate</span> = <span class="ruby-value">2</span>; <span class="ruby-identifier">frate</span> = <span class="ruby-ivar">@OPT_mp4</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_mp4</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@OPT_mp4</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_FFMPEG} -framerate #{frate} -i dcl_%04d.png -c:v libx264 -r 30 -pix_fmt yuv420p dcl.mp4&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_FFMPEG</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># ImageMagic を使って、png に実行コマンドをメタデータとして記述する。</span>
    <span class="ruby-comment"># exiftool dcl_001.png | grep Comment などで参照可能</span>
    <span class="ruby-identifier">fname</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpget</span>(<span class="ruby-string">&quot;fname&quot;</span>).<span class="ruby-identifier">strip</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;npage&quot;</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">pnum</span> = <span class="ruby-identifier">sprintf</span>(<span class="ruby-string">&quot;%04d&quot;</span>,(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">to_s</span>)
      <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_MOGRIFY}  -comment &#39;#{@comment}&#39; #{fname}_#{pnum}.png&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_MOGRIFY</span>
      <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_MOGRIFY}  -trim +repage #{fname}_#{pnum}.png&quot;</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_crop</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">CMD_MOGRIFY</span>)
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_file</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;pdf&quot;</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-comment"># rotate to landscape &amp; add comment &amp; crop</span>
  <span class="ruby-identifier">fname</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpget</span>(<span class="ruby-string">&quot;fname&quot;</span>).<span class="ruby-identifier">strip</span>
<span class="ruby-comment">#  system (&quot;/opt/local/bin/pdftk #{fname}.pdf cat 1-endeast output #{fname}-tmp.pdf&quot;)</span>
  <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_CPDF} #{fname}.pdf -rotate 90 -o #{fname}-tmp.pdf&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_CPDF</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_crop</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_PDFCROP} #{fname}-tmp.pdf #{fname}.pdf&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_PDFCROP</span>
    <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_RM}  #{fname}-tmp.pdf&quot;</span> )
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_MV} #{fname}-tmp.pdf #{fname}.pdf&quot;</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">system</span> (<span class="ruby-node">&quot;#{CMD_EXIFTOOL} -Title=&#39;#{@comment}&#39; #{fname}.pdf -overwrite_original&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">CMD_EXIFTOOL</span>
<span class="ruby-keyword">end</span>

<span class="ruby-keyword">return</span> <span class="ruby-identifier">gary</span>

<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-maskshading" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">maskshading</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="maskshading-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1610</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">maskshading</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">ary</span> = <span class="ruby-ivar">@OPT_maskshading</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>); <span class="ruby-identifier">newary</span> = []; <span class="ruby-identifier">newary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ary</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ary</span>[<span class="ruby-value">1</span>]) <span class="ruby-keyword">then</span>
    (<span class="ruby-identifier">ary</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-regexp">/^[^\d-]/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">ary</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>] )
        <span class="ruby-identifier">newary</span>[<span class="ruby-value">0</span>] = <span class="ruby-identifier">newary</span>[<span class="ruby-value">0</span>]<span class="ruby-string">+&quot;,&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ary</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">newary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">ary</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-regexp">/\D/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">newary</span>[<span class="ruby-value">0</span>]) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">open_gturl_wildcard</span>(<span class="ruby-identifier">newary</span>[<span class="ruby-value">0</span>])[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">rlev</span> = (<span class="ruby-identifier">newary</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">||</span><span class="ruby-value">0</span>); <span class="ruby-identifier">ipat</span> = (<span class="ruby-identifier">newary</span>[<span class="ruby-value">2</span>]<span class="ruby-operator">||</span><span class="ruby-value">1515</span>)
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uepset</span>(<span class="ruby-string">&quot;rlev&quot;</span>,<span class="ruby-identifier">rlev</span>); <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uepset</span>(<span class="ruby-string">&quot;ipat&quot;</span>,<span class="ruby-identifier">ipat</span>)
  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">tone</span>(<span class="ruby-identifier">mask</span>,<span class="ruby-keyword">false</span>,<span class="ruby-string">&quot;ltone&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-keyword">false</span>, <span class="ruby-string">&quot;transpose&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@OPT_exch</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-mstrmfunc_on_z" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">mstrmfunc_on_z</span><span
            class="method-args">(v, rho)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>z座標での質量流線関数を求める。 Psi = cos(phi) sum (bar{ rho * v })dz を計算して、質量流線関数を求める。 -1/cos(phi) * ∂ψ/∂z = bar{rho * v}, 1/(a*cos(phi)) * ∂ψ/∂φ = bar{rho w} で定義されている。</p>
          
          

          
          <div class="method-source-code" id="mstrmfunc_on_z-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 220</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">mstrmfunc_on_z</span>(<span class="ruby-identifier">v</span>, <span class="ruby-identifier">rho</span>)
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;CAUTION: mstrmfunc_on_z needs data from lowest layer for calculation.\n&quot;</span>
  <span class="ruby-identifier">vrm</span> = (<span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-identifier">rho</span>).<span class="ruby-identifier">mean</span>(<span class="ruby-value">0</span>)
  <span class="ruby-identifier">vrm</span> = <span class="ruby-identifier">vrm</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vrm</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>).<span class="ruby-identifier">cos</span> <span class="ruby-comment"># \bar{rho*v}cos(\phi)</span>
  <span class="ruby-identifier">vrm_na</span> = <span class="ruby-identifier">vrm</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">psi</span> = <span class="ruby-identifier">vrm_na</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span> <span class="ruby-comment"># psi の NArray を用意</span>
  <span class="ruby-identifier">z</span> = <span class="ruby-identifier">vrm</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span> <span class="ruby-comment"># z の NArray</span>

  <span class="ruby-identifier">psi</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = (<span class="ruby-identifier">vrm_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">z</span>[<span class="ruby-value">0</span>] <span class="ruby-comment"># 最下層（下端境界と最下層の間の vrm は vrm[0] に等しいとした。経験的。）</span>
  <span class="ruby-keyword">for</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">z</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>) <span class="ruby-comment"># 積み上げ</span>
    <span class="ruby-identifier">psi</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">psi</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>] <span class="ruby-operator">+</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vrm_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">vrm_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>])<span class="ruby-operator">*</span>(<span class="ruby-identifier">z</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">z</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">vrm</span>.<span class="ruby-identifier">grid</span>.<span class="ruby-identifier">copy</span>,<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">psi</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;mass streamfunction&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;kg.m-1.s-1&quot;</span>},<span class="ruby-string">&quot;mstrm&quot;</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-open_gturl" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">open_gturl</span><span
            class="method-args">(gturl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="open_gturl-source">
            <pre><span class="ruby-comment"># File gpv_gphysmod.rb, line 121</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">open_gturl</span>(<span class="ruby-identifier">gturl</span>)
  <span class="ruby-identifier">file</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">slice</span>, <span class="ruby-identifier">cut_slice</span>, <span class="ruby-identifier">thinning</span> = <span class="ruby-identifier">parse_gturl</span>(<span class="ruby-identifier">gturl</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">var</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Array</span>)
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;This method treats a gturl of a single GPhys object. &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot;Use open_multi_gturl to treat a gturl of multiple objects.&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">file</span>,<span class="ruby-identifier">var</span>)
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-identifier">slice</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">slice</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">cut_slice</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">cut_slice</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>[<span class="ruby-identifier">thinning</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">thinning</span>
  <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-open_gturl_wildcard" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">open_gturl_wildcard</span><span
            class="method-args">(gturl, print=false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="open_gturl_wildcard-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 479</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">open_gturl_wildcard</span>(<span class="ruby-identifier">gturl</span>, <span class="ruby-identifier">print</span>=<span class="ruby-keyword">false</span>)
<span class="ruby-comment">###   Match wildcard expression for variables if &quot;*&quot; and/or &quot;?&quot; is included.</span>
<span class="ruby-comment">###   Matched variables are added to ARGV array.</span>
<span class="ruby-comment">###   Return gphys object and gturl or false; when false &quot;next&quot; should be executed after this function.</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">String</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@Var_array</span> = [] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@Var_array</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_var</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/{(.*)}/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-ivar">@Var_array</span> = <span class="ruby-node">$1</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
      <span class="ruby-ivar">@OPT_var</span> = <span class="ruby-ivar">@OPT_var</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">&quot;{#{$1}}&quot;</span>,<span class="ruby-string">&quot;*&quot;</span>)
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gturl</span> <span class="ruby-operator">+</span> <span class="ruby-string">&#39;@&#39;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@OPT_var</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gturl</span><span class="ruby-string">+&#39;@&#39;</span><span class="ruby-operator">+</span><span class="ruby-ivar">@OPT_var</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_var</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&#39;@&#39;</span>))
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gturl</span><span class="ruby-string">+&#39;@*&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&#39;@&#39;</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># For CSV format</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;.csv@&quot;</span>)) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">csvfile</span>, <span class="ruby-identifier">vcol</span> = <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">vcol</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;*&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">array</span> = <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">csvfile</span>); <span class="ruby-identifier">maxcol</span> =  <span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>
        <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
        <span class="ruby-identifier">maxcol</span>.<span class="ruby-identifier">downto</span>(<span class="ruby-value">1</span>){<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@Var_array</span><span class="ruby-operator">==</span>[] <span class="ruby-keyword">or</span> <span class="ruby-ivar">@Var_array</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword">or</span> <span class="ruby-ivar">@Var_array</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">n</span>])) <span class="ruby-keyword">then</span>
            <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">csvfile</span><span class="ruby-string">+&quot;@&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">n</span>]) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">float_string?</span>(<span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">n</span>])
            <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">csvfile</span><span class="ruby-string">+&quot;@&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">float_string?</span>(<span class="ruby-identifier">array</span>[<span class="ruby-value">0</span>][<span class="ruby-identifier">n</span>])
          <span class="ruby-keyword">end</span>
        }
        <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>, <span class="ruby-identifier">gturl</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">csv2gphys</span>(<span class="ruby-identifier">gturl</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># For file format supported by GPhys.</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gturl</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/(,\w.*)/</span>) <span class="ruby-comment"># convert y????m??d?? expression to Date.parser</span>
      <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-node">$1</span>,<span class="ruby-identifier">ymd2date</span>(<span class="ruby-node">$1</span>))
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">file</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">slice</span>, <span class="ruby-identifier">cut_slice</span>, <span class="ruby-identifier">thinning</span>  = <span class="ruby-identifier">parse_gturl</span>(<span class="ruby-identifier">gturl</span>) <span class="ruby-comment">#GPhys::IO.parse_gturl(gturl)</span>
    <span class="ruby-identifier">file</span> = <span class="ruby-identifier">file</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">if</span> (<span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">var</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-identifier">var</span>.<span class="ruby-identifier">reverse_each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@Var_array</span> <span class="ruby-operator">==</span> [])
          <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_vf</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">file</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">v</span>))
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@Var_array</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">v</span>))
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">gturl_splitted</span> =  <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;@&quot;</span>)
        <span class="ruby-identifier">gtmpary</span> = <span class="ruby-identifier">gturl_splitted</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
        <span class="ruby-comment"># matched variables are converted to gturl and added to ARGV array.</span>
        <span class="ruby-constant">ARGV</span>.<span class="ruby-identifier">unshift</span>( <span class="ruby-identifier">gturl_splitted</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">+</span> <span class="ruby-string">&quot;@&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gturl_splitted</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">sub</span>(<span class="ruby-identifier">gtmpary</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">v</span>) )
      }
      <span class="ruby-comment">#next</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>, <span class="ruby-identifier">gturl</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment">###---------------------------------------------</span>
    <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">find_axisnames</span>(<span class="ruby-identifier">gturl</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;,&quot;</span><span class="ruby-operator">+</span><span class="ruby-constant">AX</span>)
    <span class="ruby-keyword">begin</span>
<span class="ruby-comment">#      p &quot;Date.parse(\&quot;0005-02-01\&quot;)&quot;.to_i</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">gturl</span>
      <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">open_gturl</span>(<span class="ruby-identifier">gturl</span>)
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;  Reading #{gturl}\n&quot;</span> <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_silent</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">print</span>)

    <span class="ruby-keyword">rescue</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;given multiple files cannot be open in one gphys object by #{gturl}. give the variable name.\n&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">invalidation</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_invalidation</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sig2p</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_sig2p</span> <span class="ruby-comment"># change sigma coord to pressure coord</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sig2z</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_sig2z</span> <span class="ruby-comment"># change sigma coord to z coord</span>

    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_assoc_coords</span>([<span class="ruby-ivar">@assoc_coords</span>]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_set_assoc_coords</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gturl</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gturl</span>
    <span class="ruby-identifier">gturl</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;(&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>) <span class="ruby-operator">+</span> <span class="ruby-string">&quot;)&quot;</span>

    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">invalidation</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_invalidation</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sig2p</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_sig2p</span> <span class="ruby-comment"># change sigma coord to pressure coord</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">sig2z</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_sig2z</span> <span class="ruby-comment"># change sigma coord to pressure coord</span>
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_assoc_coords</span>([<span class="ruby-ivar">@assoc_coords</span>]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_set_assoc_coords</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gturl</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;unsupported format.&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-output_csv" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">output_csv</span><span
            class="method-args">(g)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="output_csv-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 268</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">output_csv</span>(<span class="ruby-identifier">g</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_csv</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>); <span class="ruby-identifier">outfilename</span> = <span class="ruby-string">&quot;out.csv&quot;</span>; <span class="ruby-keyword">else</span>; <span class="ruby-identifier">outfilename</span> = <span class="ruby-ivar">@OPT_csv</span>; <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">axis0</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span> <span class="ruby-comment"># get first axis as gphys object</span>
  <span class="ruby-identifier">axis0_units</span> = <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-comment"># get units of the axis as string</span>
  <span class="ruby-identifier">time_axis</span> = []

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">axis0_units</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">cal_unit</span>, <span class="ruby-identifier">start_date</span> = <span class="ruby-identifier">axis0_units</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">cal_unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;year&quot;</span>))
      <span class="ruby-identifier">start_year</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_date</span>)
      <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">y</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">time_axis</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">start_year</span>.<span class="ruby-identifier">next_year</span>(<span class="ruby-identifier">y</span>)
      }
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">cal_unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;month&quot;</span>))
      <span class="ruby-identifier">start_month</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_date</span>)
      <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">time_axis</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">start_month</span>.<span class="ruby-identifier">next_month</span>(<span class="ruby-identifier">m</span>)
      }
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">cal_unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;day&quot;</span>))
      <span class="ruby-identifier">start_day</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_date</span>)
      <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">time_axis</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">start_day</span>.<span class="ruby-identifier">next_day</span>(<span class="ruby-identifier">d</span>)
      }
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">cal_unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;hour&quot;</span>))
      <span class="ruby-identifier">start_hour</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_date</span>)
      <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">time_axis</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_hour</span>.<span class="ruby-identifier">time</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">h</span><span class="ruby-operator">*</span><span class="ruby-value">3600</span>)
      }
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">cal_unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;min&quot;</span>))
      <span class="ruby-identifier">start_min</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_date</span>)
      <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">time_axis</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_min</span>.<span class="ruby-identifier">time</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span><span class="ruby-operator">*</span><span class="ruby-value">60</span>)
      }

    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">cal_unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;sec&quot;</span>))
      <span class="ruby-identifier">start_sec</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_date</span>)
      <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">time_axis</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">start_sec</span>.<span class="ruby-identifier">time</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">s</span>)
      }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;check the unit of time axis&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">ary0</span> = <span class="ruby-identifier">time_axis</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">ary0</span> = <span class="ruby-identifier">axis0</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">ary1</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">ary1_mask</span> = <span class="ruby-identifier">ary1</span>.<span class="ruby-identifier">valid?</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ary1</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;csv&quot;</span>
  <span class="ruby-constant">CSV</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">outfilename</span>, <span class="ruby-string">&quot;wb&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">ary1</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ary1</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ary1_mask</span>[<span class="ruby-identifier">i</span>]
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">ary0</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_s</span>,<span class="ruby-identifier">ary1</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">to_s</span>]
      }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operated GPhys object is written as #{outfilename}.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-parse_gturl" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parse_gturl</span><span
            class="method-args">(gturl)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="parse_gturl-source">
            <pre><span class="ruby-comment"># File gpv_gphysmod.rb, line 43</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">parse_gturl</span>(<span class="ruby-identifier">gturl</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-regexp">/(.*)@(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">gturl</span>
    <span class="ruby-identifier">file</span> = <span class="ruby-node">$1</span>
    <span class="ruby-identifier">var</span> = <span class="ruby-node">$2</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-regexp">/(.*)\/(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">gturl</span>
    <span class="ruby-identifier">file</span> = <span class="ruby-node">$1</span>
    <span class="ruby-identifier">var</span> = <span class="ruby-node">$2</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;invalid URL: &#39;[@|/]&#39; between path &amp; variable is not found\n\n&quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-string">&quot;URL format: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GTURLfmt</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-regexp">/[\*\?]/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">file</span> <span class="ruby-comment">## match file names if wildcard expression included.</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;\n Any files did not match the given expression: \&quot;&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">file</span><span class="ruby-operator">+</span>\
    <span class="ruby-string">&quot;\&quot; \n&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Dir</span>[<span class="ruby-identifier">file</span>].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">file</span> = <span class="ruby-constant">Dir</span>[<span class="ruby-identifier">file</span>].<span class="ruby-identifier">sort</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">exist?</span>(<span class="ruby-identifier">file</span>))
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;File specified by gturl \&quot;#{gturl}\&quot; was not found&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-regexp">/,/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">var</span>
    <span class="ruby-identifier">slice</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">cut_slice</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">thinning</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">var_descr</span> = <span class="ruby-identifier">var</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/,/</span>)
    <span class="ruby-identifier">var</span> = <span class="ruby-identifier">var_descr</span>.<span class="ruby-identifier">shift</span>
    <span class="ruby-identifier">var_descr</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-regexp">/(.*)=(.*)/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">s</span>
        <span class="ruby-identifier">dimname</span> = <span class="ruby-node">$1</span>
        <span class="ruby-identifier">subset</span> = <span class="ruby-node">$2</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">subset</span>
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\^(.*):(.*):(.*)/</span>
          <span class="ruby-identifier">slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
          <span class="ruby-identifier">thinning</span>[<span class="ruby-identifier">dimname</span>] = {(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>) <span class="ruby-operator">=&gt;</span> <span class="ruby-node">$3</span>.<span class="ruby-identifier">to_i</span>}
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\^(.*):(.*)/</span>
          <span class="ruby-identifier">slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\^(.*)/</span>
          <span class="ruby-identifier">slice</span>[<span class="ruby-identifier">dimname</span>] = <span class="ruby-node">$1</span>.<span class="ruby-identifier">to_i</span>
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/(.*):(.*):(.*)/</span>
          <span class="ruby-identifier">cut_slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
          <span class="ruby-identifier">thinning</span>[<span class="ruby-identifier">dimname</span>] = {(<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>) <span class="ruby-operator">=&gt;</span> <span class="ruby-node">$3</span>.<span class="ruby-identifier">to_i</span>}
        <span class="ruby-keyword">when</span> <span class="ruby-regexp">/(.*):(.*)/</span>
          <span class="ruby-identifier">cut_slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-node">$1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">eval</span> <span class="ruby-node">$2</span>)
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">cut_slice</span>[<span class="ruby-identifier">dimname</span>] = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">subset</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;invalid URL: variable subset specification error\n\n&quot;</span> <span class="ruby-operator">+</span>
        <span class="ruby-string">&quot;URL format: &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-constant">GTURLfmt</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">slice</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">slice</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">cut_slice</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cut_slice</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">thinning</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">thinning</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">slice</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">cut_slice</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">thinning</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> <span class="ruby-regexp">/[\*\?]/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">var</span> <span class="ruby-comment">## match var names if wildcard expression included.</span>
    <span class="ruby-identifier">var_reg</span> = <span class="ruby-identifier">var</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;*&quot;</span>,<span class="ruby-string">&quot;.*&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-string">&quot;?&quot;</span>,<span class="ruby-string">&quot;.&quot;</span>) <span class="ruby-comment"># convert to regular exp.</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">file</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">String</span>
      <span class="ruby-identifier">vars</span> = <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">var_names_except_coordinates</span>(<span class="ruby-identifier">file</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Array</span>
      <span class="ruby-identifier">vars_t</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">var_names_except_coordinates</span>(<span class="ruby-identifier">f</span>)}
      <span class="ruby-identifier">vars</span> = <span class="ruby-identifier">vars_t</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">vars_matched</span> = <span class="ruby-identifier">vars</span>.<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/#{var_reg}/</span>)}
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">vars_matched</span>.<span class="ruby-identifier">empty?</span>)
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;\n Any variables in \&quot;#{file}\&quot; did not match the given
      expression: \&quot;#{var}\&quot;.\n Included variable(s): #{vars.join(&quot;, &quot;)}.&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># put the variable name by String if the number of matched variable is</span>
    <span class="ruby-comment"># one, otherwise by Array of Strings.</span>
    <span class="ruby-identifier">var</span> = <span class="ruby-identifier">vars_matched</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">vars_matched</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">:</span> <span class="ruby-identifier">vars_matched</span>
  <span class="ruby-keyword">end</span>
  [<span class="ruby-identifier">file</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">slice</span>, <span class="ruby-identifier">cut_slice</span>, <span class="ruby-identifier">thinning</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-powerspectra" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">powerspectra</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Powerspectra using FFT.</p>
          
          

          
          <div class="method-source-code" id="powerspectra-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 70</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">powerspectra</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">ps_dim</span> = <span class="ruby-ivar">@OPT_power_spectra</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-identifier">flag_wl</span> = <span class="ruby-ivar">@OPT_power_spectra</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>]
  <span class="ruby-identifier">axunit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ps_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>
  <span class="ruby-identifier">axname</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">ps_dim</span>]
  <span class="ruby-identifier">gp</span> = (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>,<span class="ruby-identifier">ps_dim</span>).<span class="ruby-identifier">abs</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>).<span class="ruby-identifier">rawspect2powerspect</span>(<span class="ruby-identifier">ps_dim</span>)
  <span class="ruby-identifier">wn</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-identifier">ps_dim</span>]
  <span class="ruby-identifier">ax</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ps_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">ps_dim</span>]<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">ax</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">..</span><span class="ruby-identifier">ax</span>[<span class="ruby-identifier">wn</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>]) <span class="ruby-comment"># 波数 0 は出さないようにしている</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">flag_wl</span>)
    <span class="ruby-identifier">axunit</span> = <span class="ruby-identifier">axunit</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)[<span class="ruby-value">0</span>] <span class="ruby-keyword">if</span> (<span class="ruby-identifier">axunit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>))
    <span class="ruby-identifier">axat</span> = <span class="ruby-constant">Attribute</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-identifier">axat</span>[<span class="ruby-string">&quot;units&quot;</span>]=<span class="ruby-identifier">axunit</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">axname</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;lon&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">axname</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;lat&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">axname</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;x&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">axname</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;y&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ps_dim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-identifier">ax</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">wn</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>]<span class="ruby-operator">*</span><span class="ruby-value">180</span><span class="ruby-operator">/</span><span class="ruby-constant">PI</span>, <span class="ruby-identifier">axat</span>, <span class="ruby-string">&quot;wavelength - &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">axname</span>))
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">axname</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;time&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">axname</span><span class="ruby-operator">==</span><span class="ruby-string">&quot;t&quot;</span>)
      <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">ps_dim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-identifier">ax</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-identifier">wn</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>], <span class="ruby-identifier">axat</span>, <span class="ruby-string">&quot;period - &quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">axname</span>))
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operation: power spectra along #{axname} is calculated.\n&quot;</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-pv_on_z" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pv_on_z</span><span
            class="method-args">(u,v,theta,rho)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>z座標でのPVを計算する。引数はz座標上の東西風、南北風、温位、密度。 惑星半径と自転角速度は適切に設定する必要がある。 鉛直軸は第３軸と想定。</p>
          
          

          
          <div class="method-source-code" id="pv_on_z-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 201</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">pv_on_z</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-identifier">theta</span>,<span class="ruby-identifier">rho</span>)
  <span class="ruby-identifier">z</span> = <span class="ruby-value">2</span>
  <span class="ruby-identifier">uz</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">threepoint_O2nd_deriv</span>(<span class="ruby-identifier">z</span>); <span class="ruby-identifier">vz</span> = <span class="ruby-identifier">v</span>.<span class="ruby-identifier">threepoint_O2nd_deriv</span>(<span class="ruby-identifier">z</span>)
  <span class="ruby-identifier">thetaz</span> = <span class="ruby-identifier">theta</span>.<span class="ruby-identifier">threepoint_O2nd_deriv</span>(<span class="ruby-identifier">z</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sht</span>) <span class="ruby-comment"># 球面調和関数変換を使う</span>
    <span class="ruby-identifier">absvor</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_vorticity</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-ivar">@Radius</span>) <span class="ruby-operator">+</span> <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sinlat</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-ivar">@Omega</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-identifier">thetax</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_dlon</span>(<span class="ruby-identifier">theta</span>)<span class="ruby-operator">/</span>(<span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">coslat</span><span class="ruby-operator">*</span><span class="ruby-ivar">@Radius</span>.<span class="ruby-identifier">to_f</span>)
    <span class="ruby-identifier">thetay</span> = <span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">sh_dlat</span>(<span class="ruby-identifier">theta</span>)<span class="ruby-operator">*</span>(<span class="ruby-constant">SphericalHarmonics</span><span class="ruby-operator">::</span><span class="ruby-identifier">coslat</span>)<span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-comment"># (注) sh_dlat は d/dmu のこと。</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">absvor</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">absvor_s</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>) <span class="ruby-comment"># 絶対渦度</span>
    <span class="ruby-identifier">thetax</span>, <span class="ruby-identifier">thetay</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">grad_s</span>(<span class="ruby-identifier">theta</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> (<span class="ruby-identifier">absvor</span><span class="ruby-operator">*</span><span class="ruby-identifier">thetaz</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vz</span><span class="ruby-operator">*</span><span class="ruby-identifier">thetax</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">uz</span><span class="ruby-operator">*</span><span class="ruby-identifier">thetay</span> )<span class="ruby-operator">/</span><span class="ruby-identifier">rho</span>
<span class="ruby-comment">#  return (absvor*thetaz + uz*thetay)/rho</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reflectance" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reflectance</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="reflectance-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 510</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reflectance</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-comment"># 浅野正二「大気放射学の基礎」式 6.23</span>
  <span class="ruby-comment"># 入力 gp は 太陽天頂角のGPhysオブジェクト</span>
  <span class="ruby-identifier">mask</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>
  <span class="ruby-identifier">mu0</span> = <span class="ruby-identifier">cos</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>)
  <span class="ruby-comment"># p mu0</span>
  <span class="ruby-comment"># mu0 = cos(80.0*PI/180.0)</span>
  <span class="ruby-identifier">omega</span> = <span class="ruby-value">0.99999</span>; <span class="ruby-identifier">g</span> = <span class="ruby-value">0.5</span>; <span class="ruby-identifier">tau</span> = <span class="ruby-value">0.05</span>
  <span class="ruby-comment"># Eddington近似</span>
  <span class="ruby-identifier">gamma1</span> = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-value">7</span><span class="ruby-operator">-</span><span class="ruby-identifier">omega</span><span class="ruby-operator">*</span>(<span class="ruby-value">4</span><span class="ruby-value">+3</span><span class="ruby-operator">*</span><span class="ruby-identifier">g</span>)); <span class="ruby-identifier">gamma2</span> = <span class="ruby-value">-0.25</span><span class="ruby-operator">*</span>(<span class="ruby-value">1</span><span class="ruby-operator">-</span><span class="ruby-identifier">omega</span><span class="ruby-operator">*</span>(<span class="ruby-value">4</span><span class="ruby-value">-3</span><span class="ruby-operator">*</span><span class="ruby-identifier">g</span>))
  <span class="ruby-identifier">gamma3</span> = <span class="ruby-value">0.25</span><span class="ruby-operator">*</span>(<span class="ruby-value">2</span><span class="ruby-value">-3</span><span class="ruby-operator">*</span><span class="ruby-identifier">g</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu0</span>); <span class="ruby-identifier">gamma4</span> = <span class="ruby-value">1.0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">gamma3</span>
  <span class="ruby-identifier">alpha1</span> = <span class="ruby-identifier">gamma4</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gamma3</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma2</span>; <span class="ruby-identifier">alpha2</span> = <span class="ruby-identifier">gamma3</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gamma4</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma2</span>
  <span class="ruby-identifier">kappa</span> = (<span class="ruby-identifier">gamma1</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">gamma2</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma2</span>)<span class="ruby-operator">**</span><span class="ruby-value">0.5</span>

  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">omega</span><span class="ruby-operator">/</span>(<span class="ruby-value">1.0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu0</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu0</span>)
  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">r</span><span class="ruby-operator">/</span>((<span class="ruby-identifier">kappa</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gamma1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">exp</span>(<span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">tau</span>) <span class="ruby-operator">+</span> (<span class="ruby-identifier">kappa</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">gamma1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">exp</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">tau</span>))
  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">r</span><span class="ruby-operator">*</span>( (<span class="ruby-value">1.0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">alpha2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma3</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">exp</span>(<span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">tau</span>) <span class="ruby-operator">-</span> (<span class="ruby-value">1.0</span><span class="ruby-operator">+</span><span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu0</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">alpha2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma3</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">exp</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span><span class="ruby-identifier">tau</span>) <span class="ruby-operator">-</span> <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">kappa</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">gamma3</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">alpha2</span><span class="ruby-operator">*</span><span class="ruby-identifier">mu0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">exp</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">tau</span><span class="ruby-operator">/</span><span class="ruby-identifier">mu0</span>))
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span><span class="ruby-operator">*</span><span class="ruby-value">0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">r</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-regrid" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">regrid</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Regrid to given horizontal resolition with Gaussian latitudes</p>
          
          

          
          <div class="method-source-code" id="regrid-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 32</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">regrid</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">require</span> <span class="ruby-string">&quot;gglat&quot;</span>
  <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">lat_n</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">nlat</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-constant">GGLA</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lat_n</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-constant">GGLA</span>[<span class="ruby-identifier">n</span>].<span class="ruby-identifier">length</span> )
      <span class="ruby-identifier">nlat</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">to_na</span>(<span class="ruby-constant">GGLA</span>[<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">sort</span>)
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-identifier">eval</span> <span class="ruby-node">&quot;nlat = NArray.to_na(GGLA#{@OPT_regrid}.sort)&quot;</span>
  <span class="ruby-identifier">vlat</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nlat</span>,{<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;degree_north&quot;</span>},<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">lat_dim</span>])
  <span class="ruby-identifier">nlon</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)
  (<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nlon</span>[<span class="ruby-identifier">i</span>] = <span class="ruby-value">360.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">i</span> }
  <span class="ruby-identifier">vlon</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">nlon</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;degree_east&quot;</span>},<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axnames</span>[<span class="ruby-identifier">lon_dim</span>])
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">interpolate_pole</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_interpolate_pole</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">lat_dim</span><span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">vlat</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cyclic_ext</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">lon_dim</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">vlon</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">lon_axis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lon_dim</span>)
    <span class="ruby-identifier">v0</span> = <span class="ruby-identifier">lon_axis</span>.<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">v1</span> = <span class="ruby-identifier">lon_axis</span>.<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">lon_axis</span>.<span class="ruby-identifier">name</span><span class="ruby-operator">=&gt;</span> <span class="ruby-operator">-</span><span class="ruby-identifier">v0</span><span class="ruby-operator">..</span><span class="ruby-identifier">v1</span>).<span class="ruby-identifier">interpolate</span>(<span class="ruby-identifier">lon_dim</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">vlon</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reopen" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reopen</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="reopen-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 387</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reopen</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-comment"># for using in Parallel.map</span>
  <span class="ruby-identifier">file</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">file</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># gp is on memory</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># gp is on file</span>
    <span class="ruby-identifier">filepath</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">path</span>
    <span class="ruby-identifier">varname</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span>
    <span class="ruby-identifier">mapping</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">marshal_dump</span>[<span class="ruby-value">1</span>]
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mapping</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">slicer</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">marshal_dump</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">slicer</span>
      <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span><span class="ruby-operator">::</span><span class="ruby-identifier">open</span>(<span class="ruby-identifier">filepath</span>,<span class="ruby-identifier">varname</span>)[<span class="ruby-operator">*</span><span class="ruby-identifier">slicer</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">return</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span><span class="ruby-operator">::</span><span class="ruby-identifier">open</span>(<span class="ruby-identifier">filepath</span>,<span class="ruby-identifier">varname</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reverse" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reverse</span><span
            class="method-args">(gp,dim)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>次元 dim を反転させる（データ格納の南北方向が逆の場合などに使う）</p>
          
          

          
          <div class="method-source-code" id="reverse-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 79</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">reverse</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;dim must be given by integer: 0,1,2,...&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">dim</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Fixnum</span>
  <span class="ruby-comment"># 値を反転させる</span>
  <span class="ruby-identifier">val_nam</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">val_nam</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">new_mask</span> = <span class="ruby-identifier">val_nam</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">reverse</span>(<span class="ruby-identifier">dim</span>)
    <span class="ruby-identifier">new_na</span> = <span class="ruby-identifier">val_nam</span>.<span class="ruby-identifier">to_na</span>.<span class="ruby-identifier">reverse</span>(<span class="ruby-identifier">dim</span>)
    <span class="ruby-identifier">new_nam</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">new_na</span>, <span class="ruby-identifier">new_mask</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">new_nam</span> = <span class="ruby-identifier">val_nam</span>.<span class="ruby-identifier">reverse</span>(<span class="ruby-identifier">dim</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">new_gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">copy</span>
  <span class="ruby-identifier">new_gp</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">new_nam</span>)

  <span class="ruby-comment"># 軸を反転させる</span>
  <span class="ruby-identifier">new_pos</span> = <span class="ruby-identifier">new_gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">pos</span>
  <span class="ruby-identifier">new_axis_na</span> = <span class="ruby-identifier">new_gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">reverse</span>(<span class="ruby-value">0</span>)
  <span class="ruby-identifier">new_pos</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">new_axis_na</span>)
  <span class="ruby-identifier">new_axis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">new_axis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-identifier">new_pos</span>
  <span class="ruby-identifier">new_grid</span> = <span class="ruby-identifier">new_gp</span>.<span class="ruby-identifier">grid</span>.<span class="ruby-identifier">change_axis</span>(<span class="ruby-identifier">dim</span>,<span class="ruby-identifier">new_axis</span>)
  <span class="ruby-identifier">new_gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_grid</span>, <span class="ruby-identifier">new_gp</span>.<span class="ruby-identifier">data</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-rgn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rgn</span><span
            class="method-args">(na)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="rgn-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 27</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">rgn</span>(<span class="ruby-identifier">na</span>) <span class="ruby-comment"># DCLの関数 RGN** を使って、入力したNArray配列に近いキリのいい数字の配列を返す。</span>
  <span class="ruby-identifier">out</span> = <span class="ruby-identifier">na</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">le</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">rgnle</span>(<span class="ruby-identifier">v</span>); <span class="ruby-identifier">ge</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">rgnge</span>(<span class="ruby-identifier">v</span>)
    (<span class="ruby-identifier">v</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">le</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">ge</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">le</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">ge</span>) <span class="ruby-comment"># より近い方のキリのいい数字を採用する</span>
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">out</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-set_calendar" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_calendar</span><span
            class="method-args">(gp,dim)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="set_calendar-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 123</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_calendar</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">dim</span>)
  <span class="ruby-identifier">gp_axis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">to_gphys</span>
  <span class="ruby-identifier">cal</span> = <span class="ruby-identifier">gp_axis</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;calendar&quot;</span>)
  <span class="ruby-identifier">units</span> = <span class="ruby-identifier">gp_axis</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;units&quot;</span>)

  <span class="ruby-identifier">cal</span> = <span class="ruby-string">&quot;360_day&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cal</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;uniform30day&quot;</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@Calendar</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">cal</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@Units</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">units</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">cal</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">time_array</span> = <span class="ruby-identifier">gp_axis</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">new_time_array</span> = <span class="ruby-identifier">time_array</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">datetime</span> = <span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">i</span>,<span class="ruby-identifier">units</span>).<span class="ruby-identifier">to_datetime</span>(<span class="ruby-value">0.0</span>, <span class="ruby-identifier">cal</span>)
      <span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">from_date</span>(<span class="ruby-identifier">datetime</span>,<span class="ruby-ivar">@Units</span>,<span class="ruby-ivar">@Calendar</span>).<span class="ruby-identifier">to_f</span>
      }
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">new_time_array</span>, {<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-ivar">@Units</span>}, <span class="ruby-ivar">@Units</span>) )
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-set_dims" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_dims</span><span
            class="method-args">(opt_dims)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>dimension preparation</p>
          
          

          
          <div class="method-source-code" id="set_dims-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 601</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_dims</span>(<span class="ruby-identifier">opt_dims</span>)
  <span class="ruby-identifier">dims</span> = (<span class="ruby-identifier">opt_dims</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
  <span class="ruby-identifier">dims</span> = <span class="ruby-identifier">dims</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dim</span><span class="ruby-operator">|</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">dim</span>) <span class="ruby-keyword">then</span>      <span class="ruby-identifier">dim</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">dim</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/#{AX}[0-9]/</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">dim</span>[<span class="ruby-value">-1</span>].<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">else</span> <span class="ruby-identifier">dim</span>
  <span class="ruby-keyword">end</span>
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">dims</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-set_draw_range" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_draw_range</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="set_draw_range-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 436</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_draw_range</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">xmin</span> = <span class="ruby-keyword">nil</span>; <span class="ruby-identifier">xmax</span> = <span class="ruby-keyword">nil</span>; <span class="ruby-identifier">ymin</span> = <span class="ruby-keyword">nil</span>; <span class="ruby-identifier">ymax</span> = <span class="ruby-keyword">nil</span>;
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_xrange</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">xrange</span> = <span class="ruby-identifier">ymd2date</span>(<span class="ruby-ivar">@OPT_xrange</span>)
    <span class="ruby-identifier">xmin</span>, <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">xrange</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
    <span class="ruby-identifier">xmin</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">xmin</span>)
    <span class="ruby-identifier">xmax</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">xmax</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">xmax</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">xmin</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>)
      <span class="ruby-identifier">axis_unit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_exch</span>
      <span class="ruby-identifier">axis_unit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_exch</span>
      <span class="ruby-identifier">since_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">axis_unit</span>.<span class="ruby-identifier">to_s</span>)
      <span class="ruby-identifier">cal_unit</span> = <span class="ruby-identifier">axis_unit</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">xmin</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">xmin</span>, <span class="ruby-identifier">since_date</span>, <span class="ruby-identifier">cal_unit</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">xmin</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>
      <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">xmax</span>, <span class="ruby-identifier">since_date</span>, <span class="ruby-identifier">cal_unit</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">xmax</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>
      <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">xmin</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">xmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">xmin</span>)<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span>
      <span class="ruby-identifier">xmax</span> = <span class="ruby-identifier">xmin</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">xmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">xmin</span>)<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_yrange</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">yrange</span> = <span class="ruby-identifier">ymd2date</span>(<span class="ruby-ivar">@OPT_yrange</span>)
    <span class="ruby-identifier">ymin</span>, <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">yrange</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;:&quot;</span>)
    <span class="ruby-identifier">ymin</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">ymin</span>)
    <span class="ruby-identifier">ymax</span> = (<span class="ruby-identifier">eval</span> <span class="ruby-identifier">ymax</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ymax</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ymin</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>)
      <span class="ruby-identifier">axis_unit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_exch</span>
      <span class="ruby-identifier">axis_unit</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">units</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_exch</span>
      <span class="ruby-identifier">since_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">axis_unit</span>.<span class="ruby-identifier">to_s</span>)
      <span class="ruby-identifier">cal_unit</span> = <span class="ruby-identifier">axis_unit</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-identifier">ymin</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">ymin</span>, <span class="ruby-identifier">since_date</span>, <span class="ruby-identifier">cal_unit</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ymin</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>
      <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">ymax</span>, <span class="ruby-identifier">since_date</span>, <span class="ruby-identifier">cal_unit</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">ymax</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Date</span>
      <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">ymin</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">ymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">ymin</span>)<span class="ruby-operator">/</span><span class="ruby-value">360</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar360</span>
      <span class="ruby-identifier">ymax</span> = <span class="ruby-identifier">ymin</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">ymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">ymin</span>)<span class="ruby-operator">/</span><span class="ruby-value">365</span><span class="ruby-operator">*</span><span class="ruby-value">365.25</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_calendar365</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">GGraph</span>.<span class="ruby-identifier">next_fig</span>(<span class="ruby-string">&quot;window&quot;</span><span class="ruby-operator">=&gt;</span>[<span class="ruby-identifier">xmin</span>,<span class="ruby-identifier">xmax</span>,<span class="ruby-identifier">ymin</span>,<span class="ruby-identifier">ymax</span>])
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-set_vpsize" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">set_vpsize</span><span
            class="method-args">( default_vp, aspect=2.0 )</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="set_vpsize-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1659</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">set_vpsize</span>( <span class="ruby-identifier">default_vp</span>, <span class="ruby-identifier">aspect</span>=<span class="ruby-value">2.0</span> )

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_panelfit</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">vxmin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;vxmin&quot;</span>);    <span class="ruby-identifier">vxmax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;vxmax&quot;</span>)
    <span class="ruby-identifier">vymin</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;vymin&quot;</span>);    <span class="ruby-identifier">vymax</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;vymax&quot;</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sldiv</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vaspect</span> = <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">vymax</span> = <span class="ruby-identifier">vymax</span><span class="ruby-operator">*</span><span class="ruby-identifier">vaspect</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">vaspect</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">vxmax</span> = <span class="ruby-identifier">vxmax</span><span class="ruby-operator">/</span><span class="ruby-identifier">vaspect</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">vaspect</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">vxymax</span> = [<span class="ruby-identifier">vxmax</span>,<span class="ruby-identifier">vymax</span>].<span class="ruby-identifier">max</span>
      <span class="ruby-identifier">vxmax</span> = <span class="ruby-identifier">vxmax</span><span class="ruby-operator">/</span><span class="ruby-identifier">vxymax</span>
      <span class="ruby-identifier">vymax</span> = <span class="ruby-identifier">vymax</span><span class="ruby-operator">/</span><span class="ruby-identifier">vxymax</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_panelfit</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">fact</span> = <span class="ruby-ivar">@OPT_panelfit</span>.<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">vxmargin</span> = (<span class="ruby-identifier">vxmax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vxmin</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">fact</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.5</span>
      <span class="ruby-identifier">vymargin</span> = (<span class="ruby-identifier">vymax</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">fact</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.5</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-identifier">vxmin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vxmargin</span>; <span class="ruby-identifier">vxmax</span> = <span class="ruby-identifier">vxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vxmargin</span>
      <span class="ruby-identifier">vymin</span> = <span class="ruby-identifier">vymin</span><span class="ruby-operator">+</span><span class="ruby-identifier">vymargin</span>; <span class="ruby-identifier">vymax</span> = <span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymargin</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> [<span class="ruby-identifier">vxmin</span>, <span class="ruby-identifier">vxmax</span>, <span class="ruby-identifier">vymin</span>, <span class="ruby-identifier">vymax</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">aspect</span> = <span class="ruby-identifier">aspect</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-identifier">iw</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpget</span>(<span class="ruby-string">&#39;iwidth&#39;</span>); <span class="ruby-identifier">ih</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpget</span>(<span class="ruby-string">&#39;iheight&#39;</span>)
  <span class="ruby-identifier">margin</span> = <span class="ruby-value">0.15</span>; <span class="ruby-identifier">yoffset</span> = <span class="ruby-value">-0.00</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sldiv</span>)
   <span class="ruby-identifier">xn</span> = <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_f</span>; <span class="ruby-identifier">yn</span> = <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_f</span>
   <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">3</span>] <span class="ruby-operator">==</span> <span class="ruby-string">&#39;full&#39;</span>)
     <span class="ruby-identifier">margin</span> = <span class="ruby-value">0.025</span>; <span class="ruby-identifier">yoffset</span> = <span class="ruby-value">-0.025</span>
   <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
   <span class="ruby-identifier">xn</span> = <span class="ruby-value">1.0</span>; <span class="ruby-identifier">yn</span> = <span class="ruby-value">1.0</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">iw</span><span class="ruby-operator">/</span><span class="ruby-identifier">xn</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">ih</span><span class="ruby-operator">/</span><span class="ruby-identifier">yn</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 1パネルの描画領域のviewportの最大値</span>
    <span class="ruby-identifier">vxlimit</span> = <span class="ruby-value">1.0</span>; <span class="ruby-identifier">vylimit</span> = (<span class="ruby-identifier">ih</span><span class="ruby-operator">/</span><span class="ruby-identifier">yn</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">iw</span><span class="ruby-operator">/</span><span class="ruby-identifier">xn</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">aspect</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">vylimit</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-identifier">aspect</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">margin</span>; <span class="ruby-identifier">vxmax</span> = <span class="ruby-value">1.0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">margin</span>
      <span class="ruby-identifier">vymin</span> = (<span class="ruby-identifier">vylimit</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>) <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vxmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">aspect</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span>
      <span class="ruby-identifier">vymax</span> = (<span class="ruby-identifier">vylimit</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vxmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">aspect</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">vymin</span> = <span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> (<span class="ruby-identifier">margin</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">vylimit</span> ; <span class="ruby-identifier">vymax</span> = <span class="ruby-identifier">vylimit</span> <span class="ruby-operator">+</span> (<span class="ruby-operator">-</span><span class="ruby-identifier">margin</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">vylimit</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-value">0.5</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">aspect</span>
      <span class="ruby-identifier">vxmax</span> = <span class="ruby-value">0.5</span> <span class="ruby-operator">+</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">aspect</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">vxlimit</span> = (<span class="ruby-identifier">iw</span><span class="ruby-operator">/</span><span class="ruby-identifier">xn</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">ih</span><span class="ruby-operator">/</span><span class="ruby-identifier">yn</span>); <span class="ruby-identifier">vylimit</span> = <span class="ruby-value">1.0</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">aspect</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1.0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">vxlimit</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">1.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">aspect</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vymin</span> = <span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">margin</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span>; <span class="ruby-identifier">vymax</span> = <span class="ruby-value">1.0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">margin</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span>
      <span class="ruby-identifier">vxmin</span> = (<span class="ruby-identifier">vxlimit</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>) <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">aspect</span>
      <span class="ruby-identifier">vxmax</span> = (<span class="ruby-identifier">vxlimit</span><span class="ruby-operator">/</span><span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vymax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vymin</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">aspect</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">vxmin</span> = <span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">margin</span><span class="ruby-operator">*</span><span class="ruby-identifier">vxlimit</span> ; <span class="ruby-identifier">vxmax</span> = <span class="ruby-identifier">vxlimit</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">margin</span><span class="ruby-operator">*</span><span class="ruby-identifier">vxlimit</span>
      <span class="ruby-identifier">vymin</span> = <span class="ruby-value">0.5</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vxmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">aspect</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span><span class="ruby-operator">*</span><span class="ruby-identifier">vxlimit</span>
      <span class="ruby-identifier">vymax</span> = <span class="ruby-value">0.5</span> <span class="ruby-operator">+</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">vxmax</span><span class="ruby-operator">-</span><span class="ruby-identifier">vxmin</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">aspect</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">yoffset</span><span class="ruby-operator">*</span><span class="ruby-identifier">vxlimit</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">vxmin</span>,<span class="ruby-identifier">vxmax</span>,<span class="ruby-identifier">vymin</span>,<span class="ruby-identifier">vymax</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sig2p" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sig2p</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert sigma coordinate ot pressure coordinate.</p>
          
          

          
          <div class="method-source-code" id="sig2p-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 94</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sig2p</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">dim</span> = (<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">SigmaCoord</span><span class="ruby-operator">::</span><span class="ruby-identifier">find_sigma_d</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">||</span> <span class="ruby-value">2</span>) <span class="ruby-comment"># if cannot find sigma axis, assume 3rd axis.</span>
  <span class="ruby-identifier">sig</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">to_gphys</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">sig</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-ivar">@PS</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">8</span><span class="ruby-operator">&gt;</span><span class="ruby-value">2.2E9</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 2GB超のオブジェクト生成を避ける</span>
    <span class="ruby-ivar">@OPT_parallel</span> = <span class="ruby-keyword">true</span>; <span class="ruby-ivar">@OPT_sig2p</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@OPT_sig2p</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">press</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">SigmaCoord</span><span class="ruby-operator">::</span><span class="ruby-identifier">sig_ps2p</span>(<span class="ruby-ivar">@PS</span>, <span class="ruby-identifier">sig</span>, <span class="ruby-identifier">dim</span>)
    <span class="ruby-identifier">press</span>.<span class="ruby-identifier">units</span>=(<span class="ruby-string">&quot;Pa&quot;</span>); <span class="ruby-identifier">press</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;positive&quot;</span>,<span class="ruby-string">&quot;down&quot;</span>)
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_assoc_coords</span>([<span class="ruby-identifier">press</span>])
<span class="ruby-comment">#    gp = gp.assoc_coord_gphys(&quot;p&quot;)</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-sig2z" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sig2z</span><span
            class="method-args">(gp, gt=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Convert sigma coordinate to height coordinate.</p>
          
          

          
          <div class="method-source-code" id="sig2z-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">sig2z</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">gt</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">print</span> <span class="ruby-string">&quot;CAUTION: sig2z needs data from lowest layer for calculation.\n&quot;</span>
  <span class="ruby-ivar">@T</span> = <span class="ruby-identifier">gt</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">gt</span>
  <span class="ruby-identifier">dim</span> = (<span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">SigmaCoord</span><span class="ruby-operator">::</span><span class="ruby-identifier">find_sigma_d</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-operator">||</span> <span class="ruby-value">2</span>) <span class="ruby-comment"># if cannot find sigma axis, assume 3rd axis.</span>
  <span class="ruby-identifier">sig</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@T</span>.<span class="ruby-identifier">length</span><span class="ruby-operator">*</span><span class="ruby-value">8</span><span class="ruby-operator">&gt;</span><span class="ruby-value">2.2E9</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">NArrayType</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;standard&quot;</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 2GB超のオブジェクト生成を避ける</span>
    <span class="ruby-ivar">@OPT_parallel</span> = <span class="ruby-keyword">true</span>; <span class="ruby-ivar">@OPT_sig2z</span> = <span class="ruby-keyword">true</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@OPT_sig2z</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">t_na</span> = <span class="ruby-ivar">@T</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">z_na</span> = <span class="ruby-identifier">t_na</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span> <span class="ruby-comment"># z の NArray を用意</span>
    <span class="ruby-identifier">fact</span> = (<span class="ruby-operator">-</span><span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span><span class="ruby-operator">::</span><span class="ruby-constant">R</span><span class="ruby-operator">/</span><span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Met</span>.<span class="ruby-identifier">g</span>).<span class="ruby-identifier">to_f</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-comment"># 鉛直軸 が 1次元目の場合</span>
      <span class="ruby-identifier">z_na</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">fact</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">t_na</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] <span class="ruby-comment"># z_1</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">sig</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>) <span class="ruby-comment"># z_2...K</span>
        <span class="ruby-identifier">z_na</span>[<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">fact</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>])<span class="ruby-operator">/</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>]) \
                        <span class="ruby-operator">*</span>(<span class="ruby-identifier">t_na</span>[<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">t_na</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>])
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-comment"># 鉛直軸 が 2次元目の場合</span>
      <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">fact</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">t_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] <span class="ruby-comment"># z_1</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">sig</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>) <span class="ruby-comment"># z_2...K</span>
        <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">fact</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>])<span class="ruby-operator">/</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>]) \
                                    <span class="ruby-operator">*</span>(<span class="ruby-identifier">t_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">t_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>])
      <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">dim</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-comment"># 鉛直軸 が 3次元目の場合</span>
      <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">fact</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-1.0</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+1.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">t_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] <span class="ruby-comment"># z_1</span>
      <span class="ruby-keyword">for</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">in</span> <span class="ruby-value">1</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">sig</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>) <span class="ruby-comment"># z_2...K</span>
        <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">z_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>] \
                                  <span class="ruby-operator">+</span> <span class="ruby-identifier">fact</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>])<span class="ruby-operator">/</span>(<span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">sig</span>[<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>]) \
                                    <span class="ruby-operator">*</span>(<span class="ruby-identifier">t_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span>,<span class="ruby-keyword">false</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">t_na</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">k</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>])
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;vertical axis must 1st, 2nd, or 3rd axis\n&quot;</span>
    <span class="ruby-keyword">end</span>


    <span class="ruby-identifier">z</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">grid</span>.<span class="ruby-identifier">copy</span>,<span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">z_na</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;height&quot;</span>,<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;m&quot;</span>},<span class="ruby-string">&quot;Z&quot;</span>))
    <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">set_assoc_coords</span>([<span class="ruby-identifier">z</span>])
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-solar_zenith_angle" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">solar_zenith_angle</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="solar_zenith_angle-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 469</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">solar_zenith_angle</span>(<span class="ruby-identifier">gp</span>) <span class="ruby-comment"># solar_zenith_angle at local noon</span>
  <span class="ruby-identifier">gt</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-string">&quot;time&quot;</span>).<span class="ruby-identifier">to_gphys</span>; <span class="ruby-identifier">vt</span> = <span class="ruby-identifier">gt</span>.<span class="ruby-identifier">val</span>;  <span class="ruby-identifier">day_array</span> = []
  <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">false</span>)
  <span class="ruby-identifier">glat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">to_gphys</span>; <span class="ruby-identifier">vlat</span> = <span class="ruby-identifier">glat</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">180.0</span>

  <span class="ruby-identifier">ndays</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span>, <span class="ruby-identifier">vt</span>.<span class="ruby-identifier">length</span>)
  <span class="ruby-identifier">hpara</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span>, <span class="ruby-identifier">vt</span>.<span class="ruby-identifier">length</span>).<span class="ruby-identifier">fill!</span>(<span class="ruby-value">1.0</span>)
  <span class="ruby-identifier">cos_theta0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">float</span>(<span class="ruby-identifier">vlat</span>.<span class="ruby-identifier">length</span>, <span class="ruby-identifier">vt</span>.<span class="ruby-identifier">length</span>)

  <span class="ruby-identifier">vt</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">un</span> = <span class="ruby-constant">UNumeric</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">vt</span>[<span class="ruby-identifier">i</span>],<span class="ruby-identifier">gt</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-identifier">ndays</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">i</span>] = <span class="ruby-identifier">un</span>.<span class="ruby-identifier">to_datetime</span>.<span class="ruby-identifier">yday</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">un</span>.<span class="ruby-identifier">to_datetime</span>.<span class="ruby-identifier">hour</span><span class="ruby-operator">/</span><span class="ruby-value">24.0</span>
  }
  <span class="ruby-identifier">gamma</span> = (<span class="ruby-identifier">ndays</span> <span class="ruby-operator">-</span> <span class="ruby-value">1.0</span>)<span class="ruby-operator">*</span><span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">/</span><span class="ruby-value">365.0</span>
  <span class="ruby-identifier">gamma</span>[<span class="ruby-value">0</span>,<span class="ruby-value">5</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
  <span class="ruby-comment"># Solar declination (太陽赤緯)</span>
  <span class="ruby-identifier">delta</span> = <span class="ruby-value">0.006918</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.399912</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">gamma</span>) <span class="ruby-operator">+</span> <span class="ruby-value">0.070257</span><span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">gamma</span>) <span class="ruby-operator">-</span> <span class="ruby-value">0.006758</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma</span>) <span class="ruby-operator">+</span> <span class="ruby-value">0.000907</span><span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma</span>) <span class="ruby-operator">-</span> <span class="ruby-value">0.002697</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-value">3.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma</span>) <span class="ruby-operator">+</span> <span class="ruby-value">0.001480</span><span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-value">3.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">gamma</span>)

  <span class="ruby-comment"># 日積算量の計算には必要↓</span>
  <span class="ruby-identifier">cosH</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">tan</span>(<span class="ruby-identifier">delta</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">tan</span>(<span class="ruby-identifier">vlat</span>)
  <span class="ruby-comment"># 極夜・白夜に対応する</span>
  <span class="ruby-identifier">mask_polar_night</span> = <span class="ruby-identifier">cosH</span>.<span class="ruby-identifier">ge</span>(<span class="ruby-value">1.0</span>); <span class="ruby-identifier">mask_polar_day</span> = <span class="ruby-identifier">cosH</span>.<span class="ruby-identifier">le</span>(<span class="ruby-value">-1.0</span>)
  <span class="ruby-identifier">cosH</span> = <span class="ruby-identifier">cosH</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">mask_polar_night</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0.0</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">mask_polar_day</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0.0</span>)) <span class="ruby-operator">+</span>
         <span class="ruby-identifier">mask_polar_night</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">*</span><span class="ruby-value">1.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">mask_polar_day</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">*</span>(<span class="ruby-value">-1.0</span>)
  <span class="ruby-identifier">hpara</span> = <span class="ruby-identifier">acos</span>(<span class="ruby-identifier">cosH</span>)
  <span class="ruby-identifier">cos_theta0</span> = (<span class="ruby-identifier">hpara</span><span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">vlat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">delta</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">cos</span>(<span class="ruby-identifier">vlat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">delta</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">hpara</span>))<span class="ruby-operator">/</span><span class="ruby-constant">PI</span>
  <span class="ruby-identifier">theta0</span> = <span class="ruby-identifier">acos</span>(<span class="ruby-identifier">cos_theta0</span>)<span class="ruby-operator">*</span><span class="ruby-value">180.0</span><span class="ruby-operator">/</span><span class="ruby-constant">PI</span>

  <span class="ruby-comment"># 南中時（時角=0)の天頂角で、その日の天頂角を代表させる。</span>
  <span class="ruby-identifier">cos_theta0</span> = (<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">vlat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">delta</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">vlat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">delta</span>))
  <span class="ruby-identifier">theta0</span> = <span class="ruby-identifier">acos</span>(<span class="ruby-identifier">cos_theta0</span>)<span class="ruby-operator">*</span><span class="ruby-value">180.0</span><span class="ruby-operator">/</span><span class="ruby-constant">PI</span>
  <span class="ruby-identifier">theta0</span> = <span class="ruby-constant">NArrayMiss</span>.<span class="ruby-identifier">to_nam</span>(<span class="ruby-identifier">theta0</span>).<span class="ruby-identifier">set_mask</span>(<span class="ruby-identifier">mask_polar_night</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>))

  <span class="ruby-identifier">gtheta0</span> = <span class="ruby-identifier">gp</span><span class="ruby-operator">*</span><span class="ruby-value">0.0</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">theta0</span>
  <span class="ruby-identifier">gtheta0</span>.<span class="ruby-identifier">name</span>=(<span class="ruby-string">&quot;solar_zenith_angle&quot;</span>)
  <span class="ruby-identifier">gtheta0</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-string">&quot;solar zenith angle at local noon&quot;</span>)
  <span class="ruby-identifier">gtheta0</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;units&quot;</span>,<span class="ruby-string">&quot;deg&quot;</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gtheta0</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-split_axis" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">split_axis</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>split axis</p>
          
          

          
          <div class="method-source-code" id="split_axis-source">
            <pre><span class="ruby-comment"># File gpv_arrange.rb, line 60</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">split_axis</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">sa_dim</span>, <span class="ruby-identifier">sa_span</span>, <span class="ruby-identifier">sa_axisname</span> = (<span class="ruby-ivar">@OPT_split_axis</span>).<span class="ruby-identifier">split</span>(<span class="ruby-regexp">/\s*,\s*/</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">sa_dim</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">sa_dim</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">sa_dim</span> = <span class="ruby-identifier">sa_dim</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">sa_span</span> = <span class="ruby-identifier">sa_span</span>.<span class="ruby-identifier">to_i</span>

  <span class="ruby-identifier">tmp</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">newaxis</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">sa_span</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">tmp</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gp</span>[{<span class="ruby-identifier">sa_dim</span><span class="ruby-operator">=&gt;</span>{(<span class="ruby-identifier">i</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>)<span class="ruby-operator">=&gt;</span><span class="ruby-identifier">sa_span</span>}}]
    <span class="ruby-identifier">newaxis</span> <span class="ruby-operator">&lt;&lt;</span> (<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>).<span class="ruby-identifier">to_f</span>
  }
  <span class="ruby-identifier">sa_axisname</span> = <span class="ruby-string">&quot;newaxis&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">sa_axisname</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-identifier">tmp</span>,<span class="ruby-identifier">newaxis</span>,<span class="ruby-identifier">sa_axisname</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-step_shape" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">step_shape</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>1次元のgpをline plotしたときにstep状になるように変更する。 元々の格子点を <a href="n">x</a>、データを <a href="n">v</a> としたとき、いかのような配列にする。長さは2倍になる。 <a href="0">軸：x</a>, <a href="1">x</a>, <a href="1">x</a>, <a href="2">x</a>, <a href="2">x</a>, …, <a href="N">x</a>, <a href="N">x</a>, <a href="N">x</a>+dx <a href="0">値：v</a>, <a href="0">v</a>, <a href="1">v</a>, <a href="1">v</a>, <a href="2">v</a>, …, <a href="N-1">v</a>, <a href="N">v</a>, <a href="N">v</a></p>
          
          

          
          <div class="method-source-code" id="step_shape-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1750</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">step_shape</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">axis</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_gphys</span>; <span class="ruby-identifier">aval</span> = <span class="ruby-identifier">axis</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">gpval</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">alen</span> = <span class="ruby-identifier">aval</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">axna</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">alen</span>)
  (<span class="ruby-identifier">alen</span><span class="ruby-value">-1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">axna</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>]=<span class="ruby-identifier">aval</span>[<span class="ruby-identifier">i</span>]; <span class="ruby-identifier">axna</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]=<span class="ruby-identifier">aval</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]}
  <span class="ruby-identifier">axna</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">alen</span><span class="ruby-value">-1</span>)]=<span class="ruby-identifier">aval</span>[(<span class="ruby-identifier">alen</span><span class="ruby-value">-1</span>)]; <span class="ruby-identifier">axna</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">alen</span><span class="ruby-value">-1</span>)<span class="ruby-value">+1</span>]=<span class="ruby-identifier">aval</span>[(<span class="ruby-identifier">alen</span><span class="ruby-value">-1</span>)]<span class="ruby-operator">+</span>(<span class="ruby-identifier">aval</span>[(<span class="ruby-identifier">alen</span><span class="ruby-value">-1</span>)]<span class="ruby-operator">-</span><span class="ruby-identifier">aval</span>[(<span class="ruby-identifier">alen</span><span class="ruby-value">-2</span>)])
  <span class="ruby-identifier">vana</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">alen</span>)
  <span class="ruby-identifier">gpval</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">vana</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span>]=<span class="ruby-identifier">gpval</span>[<span class="ruby-identifier">i</span>]; <span class="ruby-identifier">vana</span>[<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">i</span><span class="ruby-value">+1</span>]=<span class="ruby-identifier">gpval</span>[<span class="ruby-identifier">i</span>]}
  <span class="ruby-identifier">xaxis</span> = <span class="ruby-constant">Axis</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-identifier">xaxis</span>.<span class="ruby-identifier">pos</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">axna</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">axis</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>),<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">axis</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>},<span class="ruby-identifier">axis</span>.<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">grid</span> = <span class="ruby-constant">Grid</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">xaxis</span>)
  <span class="ruby-identifier">varray</span> = <span class="ruby-constant">VArray</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">vana</span>,{<span class="ruby-string">&quot;long_name&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>),<span class="ruby-string">&quot;units&quot;</span><span class="ruby-operator">=&gt;</span><span class="ruby-identifier">gp</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>},<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">gp</span> = <span class="ruby-constant">GPhys</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">grid</span>,<span class="ruby-identifier">varray</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-title" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">title</span><span
            class="method-args">(string, size=2)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="title-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1719</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">title</span>(<span class="ruby-identifier">string</span>, <span class="ruby-identifier">size</span>=<span class="ruby-value">2</span>)
  <span class="ruby-identifier">v</span> = <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgqvpt</span>
  <span class="ruby-identifier">vx</span> = (<span class="ruby-identifier">v</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[<span class="ruby-value">1</span>])<span class="ruby-operator">/</span><span class="ruby-value">2</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">txhgt</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&#39;rsizec2&#39;</span>)     <span class="ruby-comment"># rsizec2: larger text</span>
    <span class="ruby-identifier">vy</span> = <span class="ruby-identifier">v</span>[<span class="ruby-value">3</span>] <span class="ruby-operator">+</span> (<span class="ruby-value">0.5</span> <span class="ruby-operator">+</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&#39;pad1&#39;</span>)) <span class="ruby-operator">*</span> <span class="ruby-identifier">txhgt</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">size</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">txhgt</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&#39;rsizec1&#39;</span>)     <span class="ruby-comment"># rsizec1: small text</span>
    <span class="ruby-identifier">vy</span> = <span class="ruby-identifier">v</span>[<span class="ruby-value">3</span>] <span class="ruby-operator">+</span> (<span class="ruby-value">0.5</span> <span class="ruby-operator">+</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpget</span>(<span class="ruby-string">&#39;pad1&#39;</span>)) <span class="ruby-operator">*</span> <span class="ruby-identifier">txhgt</span> <span class="ruby-operator">*</span> <span class="ruby-identifier">size</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">lw</span> = <span class="ruby-value">3</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_miscindex</span>
  <span class="ruby-identifier">lw</span> = <span class="ruby-ivar">@OPT_miscindex</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_miscindex</span>
  <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgtxzr</span>(<span class="ruby-identifier">vx</span> , <span class="ruby-identifier">vy</span>, <span class="ruby-identifier">string</span>, <span class="ruby-identifier">txhgt</span>, <span class="ruby-value">0</span>, <span class="ruby-value">0</span>, <span class="ruby-identifier">lw</span>)
<span class="ruby-comment">#      DCL.uxmttl(&#39;t&#39;,string,0.0)</span>

  <span class="ruby-comment"># top-left-corner</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_sldiv</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@prev_panelname</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@prev_panelname</span>
    <span class="ruby-identifier">panelnum</span> = (<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpget</span>(<span class="ruby-string">&quot;nframe&quot;</span>)<span class="ruby-value">-1</span>) <span class="ruby-operator">%</span> (<span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">*</span> <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span>)
    <span class="ruby-identifier">panelname</span> = <span class="ruby-string">&quot;(&quot;</span><span class="ruby-operator">+</span><span class="ruby-ivar">@alphabet</span>[<span class="ruby-identifier">panelnum</span>]<span class="ruby-string">+&quot;)&quot;</span>
    <span class="ruby-constant">DCL</span><span class="ruby-operator">::</span><span class="ruby-identifier">sgtxzr</span>(<span class="ruby-identifier">v</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-value">0.5</span> , <span class="ruby-identifier">v</span>[<span class="ruby-value">3</span>]<span class="ruby-operator">*</span><span class="ruby-value">1.075</span>, <span class="ruby-identifier">panelname</span>, <span class="ruby-identifier">txhgt</span><span class="ruby-operator">*</span><span class="ruby-value">1.35</span>, <span class="ruby-value">0</span>, <span class="ruby-value">-1</span>, <span class="ruby-identifier">lw</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@prev_panelname</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">panelname</span>
    <span class="ruby-ivar">@prev_panelname</span> = <span class="ruby-identifier">panelname</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment">#p DCL.sgpget(&quot;nframe&quot;), DCL.sgpget(&quot;npage&quot;), DCL.sgpget(&quot;nlevel&quot;)</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-tone_full" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tone_full</span><span
            class="method-args">(gphys, newframe=true, options=nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="tone_full-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 5</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">tone_full</span>(<span class="ruby-identifier">gphys</span>, <span class="ruby-identifier">newframe</span>=<span class="ruby-keyword">true</span>, <span class="ruby-identifier">options</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">gropn_1_if_not_yet</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">newframe</span><span class="ruby-operator">!=</span><span class="ruby-keyword">true</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">newframe</span><span class="ruby-operator">!=</span><span class="ruby-keyword">false</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-string">&quot;2nd arg (newframe) must be true or false&quot;</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">@@tone_options</span>.<span class="ruby-identifier">interpret</span>(<span class="ruby-identifier">options</span>)

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>, <span class="ruby-identifier">closer</span>, <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">data_prep_2D</span>([<span class="ruby-identifier">gphys</span>], <span class="ruby-identifier">newframe</span>, <span class="ruby-identifier">opts</span>)
    <span class="ruby-identifier">fig</span>(<span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">newframe</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uwsgxa</span>(<span class="ruby-identifier">xax</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">xax</span>.<span class="ruby-identifier">rank</span><span class="ruby-operator">==</span><span class="ruby-value">1</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uwsgya</span>(<span class="ruby-identifier">yax</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">yax</span>.<span class="ruby-identifier">rank</span><span class="ruby-operator">==</span><span class="ruby-value">1</span>
    <span class="ruby-identifier">val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-comment"># set colored value range</span>
    <span class="ruby-identifier">zmin</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;min&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">zmax</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;max&#39;</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">max</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uiscrg</span>(<span class="ruby-identifier">zmin</span>,<span class="ruby-identifier">zmax</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uiscsq</span>([<span class="ruby-identifier">zmin</span>,<span class="ruby-identifier">zmax</span>],[<span class="ruby-value">0</span>,<span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uifpac</span>(<span class="ruby-value">255</span>,<span class="ruby-value">255</span>,<span class="ruby-value">255</span>)]) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_nocolor</span>
    <span class="ruby-comment"># draw full color fig.</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipdat</span>(<span class="ruby-identifier">val</span>)
     <span class="ruby-keyword">if</span> <span class="ruby-identifier">newframe</span>
       <span class="ruby-identifier">axes_or_map_and_ttl</span>(<span class="ruby-identifier">gp</span>,<span class="ruby-identifier">opts</span>, <span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>)
     <span class="ruby-keyword">end</span>
     <span class="ruby-identifier">closer</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">closer</span>
    <span class="ruby-keyword">return</span> [<span class="ruby-identifier">zmin</span>, <span class="ruby-identifier">zmax</span>]

  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">gp1</span> = <span class="ruby-identifier">gphys</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">gp2</span> = <span class="ruby-identifier">gphys</span>[<span class="ruby-value">1</span>]
    <span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>, <span class="ruby-identifier">closer</span>, <span class="ruby-identifier">gp2</span> = <span class="ruby-identifier">data_prep_2D</span>([<span class="ruby-identifier">gp2</span>], <span class="ruby-identifier">newframe</span>, <span class="ruby-identifier">opts</span>)
    <span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>, <span class="ruby-identifier">closer</span>, <span class="ruby-identifier">gp1</span> = <span class="ruby-identifier">data_prep_2D</span>([<span class="ruby-identifier">gp1</span>], <span class="ruby-identifier">newframe</span>, <span class="ruby-identifier">opts</span>)
    <span class="ruby-identifier">fig</span>(<span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">newframe</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uwsgxa</span>(<span class="ruby-identifier">xax</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">xax</span>.<span class="ruby-identifier">rank</span><span class="ruby-operator">==</span><span class="ruby-value">1</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uwsgya</span>(<span class="ruby-identifier">yax</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">yax</span>.<span class="ruby-identifier">rank</span><span class="ruby-operator">==</span><span class="ruby-value">1</span>
    <span class="ruby-identifier">val1</span> = <span class="ruby-identifier">gp1</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">val</span>; <span class="ruby-identifier">val2</span> = <span class="ruby-identifier">gp2</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-comment"># set colored value range</span>
    <span class="ruby-identifier">zmin1</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;min&#39;</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">zmax1</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;max&#39;</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val1</span>.<span class="ruby-identifier">max</span>
    <span class="ruby-identifier">zmin2</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;min&#39;</span>][<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val2</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">zmax2</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;max&#39;</span>][<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val2</span>.<span class="ruby-identifier">max</span>

    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp3</span> = <span class="ruby-identifier">gphys</span>[<span class="ruby-value">2</span>]
      <span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>, <span class="ruby-identifier">closer</span>, <span class="ruby-identifier">gp3</span> = <span class="ruby-identifier">data_prep_2D</span>([<span class="ruby-identifier">gp3</span>], <span class="ruby-identifier">newframe</span>, <span class="ruby-identifier">opts</span>)
      <span class="ruby-identifier">val3</span> = <span class="ruby-identifier">gp3</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">val</span>
      <span class="ruby-identifier">zmin3</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;min&#39;</span>][<span class="ruby-value">2</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val3</span>.<span class="ruby-identifier">min</span>
      <span class="ruby-identifier">zmax3</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-string">&#39;max&#39;</span>][<span class="ruby-value">2</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">val3</span>.<span class="ruby-identifier">max</span>
    <span class="ruby-keyword">end</span>


    <span class="ruby-keyword">if</span> (<span class="ruby-keyword">false</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipset</span>(<span class="ruby-string">&quot;lcycle&quot;</span>,<span class="ruby-keyword">true</span>)
      <span class="ruby-comment"># HSV to RGB translation: c1 左上、c2 右上、c3 左下、c4 右下</span>
      <span class="ruby-identifier">c1</span> = [<span class="ruby-value">180</span>,<span class="ruby-value">100</span>,<span class="ruby-value">65</span>]
      <span class="ruby-identifier">c2</span> = [<span class="ruby-value">60</span>,<span class="ruby-value">100</span>,<span class="ruby-value">65</span>]
      <span class="ruby-identifier">c3</span> = [<span class="ruby-value">240</span>,<span class="ruby-value">100</span>,<span class="ruby-value">35</span>]
      <span class="ruby-identifier">c4</span> = [<span class="ruby-value">0</span>,<span class="ruby-value">100</span>,<span class="ruby-value">35</span>]
      <span class="ruby-identifier">colors</span> = [<span class="ruby-identifier">c1</span>, <span class="ruby-identifier">c2</span>, <span class="ruby-identifier">c3</span>, <span class="ruby-identifier">c4</span>]
      <span class="ruby-identifier">colors</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">hsl</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">r</span> = <span class="ruby-constant">Color</span><span class="ruby-operator">::</span><span class="ruby-constant">HSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">hsl</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">hsl</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">hsl</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">to_rgb</span>.<span class="ruby-identifier">red</span>
        <span class="ruby-identifier">b</span> = <span class="ruby-constant">Color</span><span class="ruby-operator">::</span><span class="ruby-constant">HSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">hsl</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">hsl</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">hsl</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">to_rgb</span>.<span class="ruby-identifier">blue</span>
        <span class="ruby-identifier">g</span> = <span class="ruby-constant">Color</span><span class="ruby-operator">::</span><span class="ruby-constant">HSL</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">hsl</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">hsl</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">hsl</span>[<span class="ruby-value">2</span>]).<span class="ruby-identifier">to_rgb</span>.<span class="ruby-identifier">green</span>
        [<span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span>]
      }
      <span class="ruby-identifier">colors</span>.<span class="ruby-identifier">map!</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">rgb</span><span class="ruby-operator">|</span> <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uifpac</span>(<span class="ruby-identifier">rgb</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">rgb</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">rgb</span>[<span class="ruby-value">2</span>]) }
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uiscmp</span>(<span class="ruby-identifier">colors</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">colors</span>[<span class="ruby-value">1</span>],<span class="ruby-identifier">colors</span>[<span class="ruby-value">2</span>],<span class="ruby-identifier">colors</span>[<span class="ruby-value">3</span>])
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uiscr2</span>(<span class="ruby-identifier">zmin1</span>,<span class="ruby-identifier">zmax1</span>,<span class="ruby-identifier">zmin2</span>,<span class="ruby-identifier">zmax2</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipda2</span>(<span class="ruby-identifier">val1</span>, <span class="ruby-identifier">val2</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># set hue and values</span>
    <span class="ruby-identifier">sang</span> = <span class="ruby-value">320</span>; <span class="ruby-identifier">wang</span> = <span class="ruby-value">280</span> <span class="ruby-comment"># start and width of hue circle [sang = 320, wang = 350]</span>
    <span class="ruby-identifier">valwidth</span> = <span class="ruby-value">220.0</span>; <span class="ruby-identifier">valpower</span> = <span class="ruby-value">1.5</span>
    <span class="ruby-comment"># 0 &lt;= h &lt; 360.0, 0.0 &lt;= s &lt;= 1.0, 0 &lt;= v &lt;= 255</span>
    <span class="ruby-identifier">nval1</span>= (<span class="ruby-identifier">val1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">zmin1</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">zmax1</span><span class="ruby-operator">-</span><span class="ruby-identifier">zmin1</span>)
      <span class="ruby-identifier">lm</span> = <span class="ruby-identifier">nval1</span>.<span class="ruby-identifier">lt</span>(<span class="ruby-value">0</span>); <span class="ruby-identifier">rm</span> = <span class="ruby-identifier">nval1</span>.<span class="ruby-identifier">ge</span>(<span class="ruby-value">1.0</span>)
      <span class="ruby-identifier">nval1</span> = <span class="ruby-identifier">nval1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">lm</span><span class="ruby-operator">*</span><span class="ruby-identifier">nval1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">rm</span><span class="ruby-operator">*</span><span class="ruby-identifier">nval1</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">rm</span><span class="ruby-operator">*</span><span class="ruby-value">1.0</span>
      <span class="ruby-identifier">nval1</span> = ((<span class="ruby-value">1.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">nval1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">wang</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sang</span>).<span class="ruby-identifier">to_i</span><span class="ruby-operator">%</span><span class="ruby-value">360</span>
<span class="ruby-comment">#    nval1= (sang + 360*(1 - (val1 - zmin1)/(zmax1-zmin1))).to_i%360</span>
    <span class="ruby-identifier">nval2</span> = (((<span class="ruby-identifier">val2</span><span class="ruby-operator">-</span><span class="ruby-identifier">zmin2</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">zmax2</span><span class="ruby-operator">-</span><span class="ruby-identifier">zmin2</span>))<span class="ruby-operator">**</span><span class="ruby-identifier">valpower</span>  )<span class="ruby-operator">*</span><span class="ruby-identifier">valwidth</span> <span class="ruby-operator">+</span> (<span class="ruby-value">255.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">valwidth</span>)
      <span class="ruby-identifier">lm</span> = <span class="ruby-identifier">nval2</span>.<span class="ruby-identifier">lt</span>(<span class="ruby-value">255.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">valwidth</span>); <span class="ruby-identifier">rm</span> = <span class="ruby-identifier">nval2</span>.<span class="ruby-identifier">gt</span>(<span class="ruby-value">255.0</span>)
      <span class="ruby-identifier">nval2</span> = <span class="ruby-identifier">nval2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">lm</span><span class="ruby-operator">*</span><span class="ruby-identifier">nval2</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">rm</span><span class="ruby-operator">*</span><span class="ruby-identifier">nval2</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">lm</span><span class="ruby-operator">*</span>(<span class="ruby-value">255.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">valwidth</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">rm</span><span class="ruby-operator">*</span><span class="ruby-value">255.0</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">3</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">nval3</span> = ((<span class="ruby-identifier">val3</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">zmin3</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">zmax3</span><span class="ruby-operator">-</span><span class="ruby-identifier">zmin3</span>))
        <span class="ruby-identifier">lm</span> = <span class="ruby-identifier">nval3</span>.<span class="ruby-identifier">lt</span>(<span class="ruby-value">0</span>); <span class="ruby-identifier">rm</span> = <span class="ruby-identifier">nval3</span>.<span class="ruby-identifier">ge</span>(<span class="ruby-value">1.0</span>)
        <span class="ruby-identifier">nval3</span> = <span class="ruby-identifier">nval3</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">lm</span><span class="ruby-operator">*</span><span class="ruby-identifier">nval3</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">rm</span><span class="ruby-operator">*</span><span class="ruby-identifier">nval3</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">rm</span><span class="ruby-operator">*</span><span class="ruby-value">1.0</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nval1</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],<span class="ruby-identifier">nval1</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]).<span class="ruby-identifier">fill</span>(<span class="ruby-value">0.0</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gphys</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> ) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">clsvrg</span>(<span class="ruby-identifier">nval1</span>, <span class="ruby-identifier">c</span><span class="ruby-value">+1.0</span>, <span class="ruby-identifier">nval2</span>) <span class="ruby-comment"># このr,g,bは0-255で出てくる。</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">clsvrg</span>(<span class="ruby-identifier">nval1</span>, <span class="ruby-identifier">nval3</span>, <span class="ruby-identifier">nval2</span>) <span class="ruby-comment"># このr,g,bは0-255で出てくる。</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">r</span> = (<span class="ruby-identifier">c</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">r</span>)<span class="ruby-operator">/</span><span class="ruby-value">255.0</span>; <span class="ruby-identifier">g</span> = (<span class="ruby-identifier">c</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">g</span>)<span class="ruby-operator">/</span><span class="ruby-value">255.0</span>;  <span class="ruby-identifier">b</span> = (<span class="ruby-identifier">c</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">b</span>)<span class="ruby-operator">/</span><span class="ruby-value">255.0</span>
    <span class="ruby-comment"># draw full color fig.</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipda3</span>(<span class="ruby-identifier">r</span>, <span class="ruby-identifier">g</span>, <span class="ruby-identifier">b</span>) <span class="ruby-comment"># ここのr,g,bは0.0-1.0に正規化したもの。</span>

    <span class="ruby-identifier">axes_or_map_and_ttl</span>(<span class="ruby-identifier">gp1</span>,<span class="ruby-identifier">opts</span>, <span class="ruby-identifier">xax</span>, <span class="ruby-identifier">yax</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">newframe</span>
    <span class="ruby-identifier">closer</span>.<span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">closer</span>

    <span class="ruby-comment"># colorbar-----------</span>
    <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_nocolorbar</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">vx0</span>, <span class="ruby-identifier">vx1</span>, <span class="ruby-identifier">vy0</span>, <span class="ruby-identifier">vy1</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgqvpt</span> <span class="ruby-comment"># viewportの記憶</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzfact</span>(<span class="ruby-value">0.6</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXB&quot;</span>,<span class="ruby-keyword">false</span>);  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYL&quot;</span>,<span class="ruby-keyword">false</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uiscr2</span>(<span class="ruby-identifier">zmin1</span>,<span class="ruby-identifier">zmax1</span>,<span class="ruby-identifier">zmin2</span>,<span class="ruby-identifier">zmax2</span>)
      <span class="ruby-identifier">aspect</span> = (<span class="ruby-identifier">vx1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vx0</span>) <span class="ruby-operator">/</span> (<span class="ruby-identifier">vy1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">vy0</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">aspect</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipcmp</span>(<span class="ruby-identifier">vx0</span>,<span class="ruby-identifier">vx0</span><span class="ruby-value">+0.25</span>,<span class="ruby-identifier">vy0</span><span class="ruby-value">-0.15</span>,<span class="ruby-identifier">vy0</span><span class="ruby-value">-0.05</span>,<span class="ruby-string">&quot;B&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipcmp</span>(<span class="ruby-identifier">vx1</span><span class="ruby-value">+0.01</span>,<span class="ruby-identifier">vx1</span><span class="ruby-value">+0.21</span>,<span class="ruby-identifier">vy0</span>,<span class="ruby-identifier">vy0</span><span class="ruby-value">+0.2</span>,<span class="ruby-string">&quot;B&quot;</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">nm</span> = <span class="ruby-value">20</span>
      <span class="ruby-identifier">hue</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nm</span>,<span class="ruby-identifier">nm</span>); <span class="ruby-identifier">val</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nm</span>,<span class="ruby-identifier">nm</span>)
      <span class="ruby-identifier">sat</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">nm</span>,<span class="ruby-identifier">nm</span>).<span class="ruby-identifier">fill</span>(<span class="ruby-value">0.0</span>)
      <span class="ruby-identifier">nm</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">hue</span>[<span class="ruby-identifier">n</span>,<span class="ruby-keyword">true</span>] = (<span class="ruby-identifier">sang</span><span class="ruby-operator">+</span><span class="ruby-identifier">wang</span><span class="ruby-operator">*</span>(<span class="ruby-value">1</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-identifier">nm</span>))).<span class="ruby-identifier">to_i</span><span class="ruby-operator">%</span><span class="ruby-value">360</span>
                   <span class="ruby-identifier">val</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">n</span>] = ((<span class="ruby-identifier">n</span>.<span class="ruby-identifier">to_f</span><span class="ruby-operator">/</span><span class="ruby-identifier">nm</span>)<span class="ruby-operator">**</span><span class="ruby-identifier">valpower</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">valwidth</span> <span class="ruby-operator">+</span> (<span class="ruby-value">255.0</span><span class="ruby-operator">-</span><span class="ruby-identifier">valwidth</span>) }
      <span class="ruby-identifier">r</span>,<span class="ruby-identifier">g</span>,<span class="ruby-identifier">b</span> = <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">clsvrg</span>(<span class="ruby-identifier">hue</span>, <span class="ruby-identifier">sat</span><span class="ruby-value">+1.0</span>, <span class="ruby-identifier">val</span>)
      <span class="ruby-identifier">r</span> = (<span class="ruby-identifier">sat</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">r</span>)<span class="ruby-operator">/</span><span class="ruby-value">255.0</span>; <span class="ruby-identifier">g</span> = (<span class="ruby-identifier">sat</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">g</span>)<span class="ruby-operator">/</span><span class="ruby-value">255.0</span>;  <span class="ruby-identifier">b</span> = (<span class="ruby-identifier">sat</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">b</span>)<span class="ruby-operator">/</span><span class="ruby-value">255.0</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uwsgxb</span>(<span class="ruby-identifier">zmin1</span>,<span class="ruby-identifier">zmax1</span>,<span class="ruby-identifier">nm</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uwsgyb</span>(<span class="ruby-identifier">zmin2</span>,<span class="ruby-identifier">zmax2</span>,<span class="ruby-identifier">nm</span>)
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uipda3</span>(<span class="ruby-identifier">r</span>, <span class="ruby-identifier">g</span>, <span class="ruby-identifier">b</span>)

  <span class="ruby-comment">#    DCL.uxptmk(&quot;B&quot;,2, [240,260,280,300])</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELXB&quot;</span>,<span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">aspect</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">1.5</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYL&quot;</span>,<span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzpset</span>(<span class="ruby-string">&quot;LABELYR&quot;</span>,<span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzinit</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">usdaxs</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uxsttl</span>(<span class="ruby-string">&quot;B&quot;</span>, <span class="ruby-identifier">gp1</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; [&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp1</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>, <span class="ruby-value">0</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">aspect</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2.0</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uysttl</span>(<span class="ruby-string">&quot;L&quot;</span>, <span class="ruby-identifier">gp2</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; [&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp2</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>, <span class="ruby-value">0</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uysttl</span>(<span class="ruby-string">&quot;R&quot;</span>, <span class="ruby-identifier">gp2</span>.<span class="ruby-identifier">name</span><span class="ruby-string">+&quot; [&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp2</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span><span class="ruby-string">+&quot;]&quot;</span>, <span class="ruby-value">0</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgsvpt</span>(<span class="ruby-identifier">vx0</span>, <span class="ruby-identifier">vx1</span>, <span class="ruby-identifier">vy0</span>, <span class="ruby-identifier">vy1</span>) <span class="ruby-comment"># viewportを戻す</span>
      <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">uzfact</span>(<span class="ruby-value">1.0</span><span class="ruby-operator">/</span><span class="ruby-value">0.6</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment">#-----------------</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-visualize_and_output" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">visualize_and_output</span><span
            class="method-args">(g)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="visualize_and_output-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 1811</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">visualize_and_output</span>(<span class="ruby-identifier">g</span>)
  <span class="ruby-comment">## set title from @OPT_title_array</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_title_array</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@Overplot</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
    <span class="ruby-ivar">@OPT_title</span> = <span class="ruby-ivar">@title_array</span>[<span class="ruby-value">0</span>]
    <span class="ruby-ivar">@title_array</span>.<span class="ruby-identifier">shift</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">## set index from @index_array</span>
  <span class="ruby-ivar">@OPT_index</span> = <span class="ruby-ivar">@index_array</span>[<span class="ruby-ivar">@Overplot</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_nocolor</span>

  <span class="ruby-comment">## set type from @type_array</span>
  <span class="ruby-ivar">@OPT_type</span> = <span class="ruby-ivar">@type_array</span>[<span class="ruby-ivar">@Overplot</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_type_array</span>

  <span class="ruby-comment"># judge draw kind</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">GPhys</span>)
    <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@kind_of_fig</span>
      <span class="ruby-identifier">gp_rank</span> = (<span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">VERSION</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-string">&quot;1.5.4&quot;</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">rank_len_ne_1</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">rank</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_mark</span>)
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;mark&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_histogram</span>)
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;histogram1D&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_line</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">gp_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;line&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-ivar">@OPT_fullcolor</span>)
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;fullcolor&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_line</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gp_rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_noshade</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_nocont</span>
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;nocont&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_line</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gp_rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_noshade</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_nocont</span>
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;noshade&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_line</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gp_rank</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">2</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_noshade</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_nocont</span>
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;full&quot;</span>
      <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gp_rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-ivar">@kind_of_fig</span> = <span class="ruby-string">&quot;nofig&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">#g.axis(1).set_pos(VArray.new(NArray.to_na([1,2,3,4,5,6,7,8,9,10,11,12]), {&quot;units&quot;=&gt;&quot;month&quot;}, &quot;time&quot;) )</span>

    <span class="ruby-comment"># change the netcdf var name and attributes.</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_rename</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_long_name</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@OPT_unit</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">copy</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>)
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">rename</span>(<span class="ruby-ivar">@OPT_rename</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_rename</span>
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-ivar">@OPT_long_name</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_long_name</span>
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;long_name&quot;</span>, <span class="ruby-ivar">@OPT_rename</span>) <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-ivar">@OPT_long_name</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@OPT_rename</span>)
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">units</span>=<span class="ruby-ivar">@OPT_unit</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_unit</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">### output operated gphys object as NetCDF file</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nc</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_output_assoc_coords</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">assoc_coord_gphys</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">assoccoordnames</span>[<span class="ruby-value">0</span>])
      <span class="ruby-keyword">end</span>


      <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-ivar">@OPT_ntype</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ntype</span>
      <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">copy</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_nc</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;&quot;</span>); <span class="ruby-identifier">outfilename</span> = <span class="ruby-string">&quot;out.nc&quot;</span>; <span class="ruby-keyword">else</span>; <span class="ruby-identifier">outfilename</span> = <span class="ruby-ivar">@OPT_nc</span>; <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@outncfile</span> <span class="ruby-keyword">then</span>
        <span class="ruby-comment">#NetCDF.creation_format=(NetCDF::NC_NETCDF4 | NetCDF::NC_CLASSIC_MODEL) # for netcdf ver 4 compression</span>
        <span class="ruby-ivar">@outncfile</span>=<span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">outfilename</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># to set missing values to output netcdf files.</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">sum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># skip if there are no missing value points.</span>
          <span class="ruby-identifier">val</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>
          <span class="ruby-identifier">rmiss</span> = (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span><span class="ruby-operator">*</span><span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">max</span>
          <span class="ruby-identifier">rmiss</span> = (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span><span class="ruby-operator">*</span><span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">min</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rmiss</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span> <span class="ruby-comment"># get missing value</span>
          <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;missing_value&quot;</span>, [<span class="ruby-identifier">rmiss</span>])
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&quot;positive&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-string">&quot;positive&quot;</span>)
      <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">IO</span>.<span class="ruby-identifier">write</span>( <span class="ruby-ivar">@outncfile</span>, <span class="ruby-identifier">g</span> )
      <span class="ruby-comment"># @outncfile.var(g.name).deflate(1,true) # netcdf ver 4 compression</span>
      <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operated GPhys object is written as #{outfilename}.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">### output operated gphys object as CSV file</span>
    <span class="ruby-identifier">output_csv</span>(<span class="ruby-identifier">g</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_csv</span>)
    <span class="ruby-comment">###</span>


    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_scatter</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_color_scatter</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_histogram2D</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_cot</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_rmap</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_fullcolor</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;2&quot;</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_vector</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">g</span> <span class="ruby-comment"># do not draw single var plot; store vars in array.</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">draw</span>(<span class="ruby-identifier">g</span>, <span class="ruby-ivar">@kind_of_fig</span>) <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_scatter</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_color_scatter</span> <span class="ruby-keyword">or</span> <span class="ruby-ivar">@OPT_nodraw</span>)
      <span class="ruby-ivar">@prev_gp</span> = <span class="ruby-identifier">g</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">g</span> <span class="ruby-comment">#if (@OPT_pry or @OPT_auto_pry or @OPT_nc4)</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">g</span> <span class="ruby-comment"># if g is scalar, just print the value</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># print g.val, &quot;,&quot;</span>
      <span class="ruby-identifier">p</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">g</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-window_setup" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">window_setup</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>setup the window and <a href="GPV.html#method-i-draw_setup"><code>draw_setup</code></a></p>
          
          

          
          <div class="method-source-code" id="window_setup-source">
            <pre><span class="ruby-comment"># File gpv_visualize.rb, line 366</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">window_setup</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-constant">DCLVERNUM</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">710</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swlset</span>(<span class="ruby-string">&quot;lsysfnt&quot;</span>,<span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swlset</span>(<span class="ruby-string">&quot;sysfont&quot;</span>,<span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swcset</span>(<span class="ruby-string">&quot;fontname&quot;</span>,<span class="ruby-string">&quot;Hiragino Sans W5&quot;</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">ENV</span>[<span class="ruby-string">&quot;SW_FONTNAME&quot;</span>] <span class="ruby-comment"># font name</span>
<span class="ruby-comment">#  DCL.swcset(&quot;fontname&quot;, &quot;Helvectica&quot;)</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_lwf</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;rlwfact&quot;</span>, (<span class="ruby-ivar">@OPT_lwf</span>.<span class="ruby-identifier">to_i</span>)<span class="ruby-operator">*</span><span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpget</span>(<span class="ruby-string">&quot;rlwfact&quot;</span>)) <span class="ruby-comment"># line width factor for pdf.</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;rlwfact&quot;</span>, <span class="ruby-value">999</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&#39;lalt&#39;</span>,<span class="ruby-keyword">true</span>)
  <span class="ruby-keyword">if</span>(<span class="ruby-ivar">@OPT_size</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_size</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&#39;auto&#39;</span>))
      <span class="ruby-identifier">sizefact</span> = (<span class="ruby-ivar">@OPT_size</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;x&#39;</span>)[<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-value">1</span>).<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">aspect</span> = (<span class="ruby-ivar">@OPT_aspect</span> <span class="ruby-operator">||</span> <span class="ruby-value">2</span>).<span class="ruby-identifier">to_f</span>
      <span class="ruby-identifier">xn</span> = <span class="ruby-ivar">@OPT_sldiv</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">yn</span> = <span class="ruby-ivar">@OPT_sldiv</span> <span class="ruby-operator">?</span> <span class="ruby-ivar">@OPT_sldiv</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&#39;,&#39;</span>)[<span class="ruby-value">2</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">:</span> <span class="ruby-value">1</span>
      <span class="ruby-identifier">xlen</span> = <span class="ruby-identifier">aspect</span><span class="ruby-operator">*</span><span class="ruby-identifier">xn</span>; <span class="ruby-identifier">ylen</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">yn</span>
      <span class="ruby-identifier">xsizefact</span> = <span class="ruby-identifier">xlen</span><span class="ruby-operator">/</span>[<span class="ruby-identifier">xlen</span>,<span class="ruby-identifier">ylen</span>].<span class="ruby-identifier">max</span><span class="ruby-operator">*</span><span class="ruby-identifier">sizefact</span>
      <span class="ruby-identifier">ysizefact</span> = <span class="ruby-identifier">ylen</span><span class="ruby-operator">/</span>[<span class="ruby-identifier">xlen</span>,<span class="ruby-identifier">ylen</span>].<span class="ruby-identifier">max</span><span class="ruby-operator">*</span><span class="ruby-identifier">sizefact</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">xsizefact</span>, <span class="ruby-identifier">ysizefact</span> = <span class="ruby-ivar">@OPT_size</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;x&quot;</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ysizefact</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">nil</span>)
        <span class="ruby-identifier">xsizefact</span> = <span class="ruby-identifier">xsizefact</span>.<span class="ruby-identifier">to_f</span>; <span class="ruby-identifier">ysizefact</span> = <span class="ruby-identifier">xsizefact</span><span class="ruby-operator">*</span><span class="ruby-value">0.75</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">xsizefact</span> = <span class="ruby-identifier">xsizefact</span>.<span class="ruby-identifier">to_f</span>; <span class="ruby-identifier">ysizefact</span> = <span class="ruby-identifier">ysizefact</span>.<span class="ruby-identifier">to_f</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">xsizefact</span> = <span class="ruby-value">1.0</span>; <span class="ruby-identifier">ysizefact</span> = <span class="ruby-value">0.75</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_file</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-ivar">@OPT_file</span>, <span class="ruby-identifier">fname</span> = <span class="ruby-ivar">@OPT_file</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;,&quot;</span>)
    <span class="ruby-keyword">case</span> <span class="ruby-ivar">@OPT_file</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;png&quot;</span>; <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swiset</span>(<span class="ruby-string">&#39;ifl&#39;</span>,<span class="ruby-value">1</span>); <span class="ruby-identifier">fname</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-string">&quot;.png&quot;</span>,<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fname</span>
      <span class="ruby-identifier">xsizefact</span> = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">xsizefact</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_size</span>; <span class="ruby-identifier">ysizefact</span> = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">ysizefact</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_size</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;eps&quot;</span>; <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swiset</span>(<span class="ruby-string">&#39;ifl&#39;</span>,<span class="ruby-value">2</span>); <span class="ruby-identifier">fname</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-string">&quot;.eps&quot;</span>,<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fname</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;svg&quot;</span>; <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swiset</span>(<span class="ruby-string">&#39;ifl&#39;</span>,<span class="ruby-value">3</span>); <span class="ruby-identifier">fname</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-string">&quot;.svg&quot;</span>,<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fname</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;pdf&quot;</span>; <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swiset</span>(<span class="ruby-string">&#39;ifl&#39;</span>,<span class="ruby-value">4</span>); <span class="ruby-identifier">fname</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-string">&quot;.pdf&quot;</span>,<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fname</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;iwidth&quot;</span>,<span class="ruby-value">900</span><span class="ruby-operator">*</span><span class="ruby-identifier">xsizefact</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;iheight&quot;</span>,<span class="ruby-value">900</span><span class="ruby-operator">*</span><span class="ruby-identifier">ysizefact</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;fname&quot;</span>,<span class="ruby-identifier">fname</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">fname</span>

    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">gropn</span>(<span class="ruby-value">2</span>)

  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># 以下は set_vpsize に移動</span>
    <span class="ruby-comment"># Xwindowの大きさを@OPT_size倍にする。（Defalut: x 1.25）</span>
    <span class="ruby-identifier">xsizefact</span> = <span class="ruby-value">1.25</span><span class="ruby-operator">*</span><span class="ruby-identifier">xsizefact</span>; <span class="ruby-identifier">ysizefact</span> = <span class="ruby-value">1.25</span><span class="ruby-operator">*</span><span class="ruby-identifier">ysizefact</span>
    <span class="ruby-identifier">iw</span> = <span class="ruby-value">900.0</span>; <span class="ruby-identifier">ih</span> = <span class="ruby-value">650.0</span>
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;iwidth&quot;</span>,<span class="ruby-value">900</span><span class="ruby-operator">*</span><span class="ruby-identifier">xsizefact</span>)
    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">swpset</span>(<span class="ruby-string">&quot;iheight&quot;</span>,<span class="ruby-value">900</span><span class="ruby-operator">*</span><span class="ruby-identifier">ysizefact</span>)

    <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">gropn</span>(<span class="ruby-ivar">@OPT_wsn</span><span class="ruby-operator">||</span><span class="ruby-value">1</span>)

  <span class="ruby-keyword">end</span>

  <span class="ruby-ivar">@VIEWPORT</span> = <span class="ruby-identifier">set_vpsize</span>( <span class="ruby-constant">VIEWPORT</span>, (<span class="ruby-ivar">@OPT_aspect</span><span class="ruby-operator">||</span><span class="ruby-value">2.0</span>) ) <span class="ruby-comment"># ここに移すのは良くないかも...</span>

  <span class="ruby-identifier">draw_setup</span>
  <span class="ruby-ivar">@flag_window_open</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-constant">DCL</span>.<span class="ruby-identifier">sgpset</span>(<span class="ruby-string">&quot;LSOFTF&quot;</span>,<span class="ruby-string">&quot;true&quot;</span>) <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_fill</span> <span class="ruby-keyword">and</span> (<span class="ruby-ivar">@OPT_wsn</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>))
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-wnf_analysis" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">wnf_analysis</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>時空間スペクトル（とりあえずGCM出力データのみに対応） 入力は（lon, lat, time）の3次元データ。ただし lat は赤道域（±15 deg）とする。</p>
          
          

          
          <div class="method-source-code" id="wnf_analysis-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 238</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">wnf_analysis</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">true</span>)
  <span class="ruby-comment"># detrend</span>
  <span class="ruby-identifier">gp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">detrend</span>(<span class="ruby-value">-1</span>)
  <span class="ruby-comment"># calculate symmetric and anti-symmetric components</span>
  <span class="ruby-identifier">gp_sym</span>  = (<span class="ruby-identifier">gp</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>])<span class="ruby-operator">*</span><span class="ruby-value">0.5</span>
  <span class="ruby-identifier">gp_asym</span> = (<span class="ruby-identifier">gp</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">gp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>])<span class="ruby-operator">*</span><span class="ruby-value">0.5</span>
  <span class="ruby-comment"># calculate raw spectra</span>
  <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-identifier">fft_ignore_missing</span>(<span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">nt</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">-1</span>]<span class="ruby-value">-1</span> <span class="ruby-comment"># 時間方向のデータ数</span>
  <span class="ruby-identifier">t</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">span</span> = <span class="ruby-value">30</span> <span class="ruby-comment"># 1解析期間 (days)</span>
  <span class="ruby-identifier">ndpd</span> = <span class="ruby-value">8</span>  <span class="ruby-comment"># 1 day あたりのデータ数</span>
  <span class="ruby-keyword">while</span> (((<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">span</span>)<span class="ruby-value">-1</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">nt</span><span class="ruby-operator">/</span><span class="ruby-identifier">ndpd</span>)
    <span class="ruby-identifier">trange</span> = (<span class="ruby-identifier">t</span><span class="ruby-operator">*</span><span class="ruby-identifier">span</span><span class="ruby-operator">*</span><span class="ruby-identifier">ndpd</span>)<span class="ruby-operator">..</span>[((<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">span</span><span class="ruby-operator">*</span><span class="ruby-identifier">ndpd</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>), <span class="ruby-identifier">nt</span>].<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">gp_sym_sp</span>  = <span class="ruby-identifier">gp_sym</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">trange</span>].<span class="ruby-identifier">detrend</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">cos_taper</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>,<span class="ruby-value">0</span>,<span class="ruby-value">2</span>)
    <span class="ruby-identifier">gp_asym_sp</span> = <span class="ruby-identifier">gp_asym</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">trange</span>].<span class="ruby-identifier">detrend</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">cos_taper</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">fft</span>(<span class="ruby-keyword">false</span>,<span class="ruby-value">0</span>,<span class="ruby-value">2</span>)
    <span class="ruby-identifier">gp_sym_pw</span>, <span class="ruby-identifier">gp_asym_pw</span> = [<span class="ruby-identifier">gp_sym_sp</span>, <span class="ruby-identifier">gp_asym_sp</span>].<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># change axes</span>
      <span class="ruby-identifier">z0</span>=<span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">pos</span>
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">z0</span>); <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">name</span> = <span class="ruby-string">&#39;k&#39;</span>; <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;k-wavenumber&#39;</span>)
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&#39;standard_name&#39;</span>); <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&#39;axis&#39;</span>); <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&#39;gt_calc_weight&#39;</span>)
      <span class="ruby-identifier">z1</span>=<span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">pos</span>.<span class="ruby-identifier">convert_units</span>(<span class="ruby-string">&quot;day-1&quot;</span>)<span class="ruby-operator">/</span>(<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-constant">Math</span><span class="ruby-operator">::</span><span class="ruby-constant">PI</span>)
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">z1</span>); <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">name</span> = <span class="ruby-string">&#39;freq&#39;</span>; <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;frequency&#39;</span>)
      <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&#39;standard_name&#39;</span>); <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&#39;axis&#39;</span>); <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">del_att</span>(<span class="ruby-string">&#39;delta_t&#39;</span>)
      <span class="ruby-comment"># calculate powerspectra</span>
      <span class="ruby-identifier">power</span>=(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">abs</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>).<span class="ruby-identifier">mean</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">rawspect2powerspect</span>(<span class="ruby-value">0</span>,<span class="ruby-value">-1</span>).<span class="ruby-identifier">spect_zero_centering</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">spect_one_sided</span>(<span class="ruby-value">-1</span>)<span class="ruby-operator">*</span> <span class="ruby-constant">GPhys</span><span class="ruby-operator">::</span><span class="ruby-constant">COS_TAPER_SP_FACTOR</span>
    }
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">t</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">gp_sym_pw_sum</span> = <span class="ruby-identifier">gp_sym_pw</span>.<span class="ruby-identifier">copy</span>; <span class="ruby-identifier">gp_asym_pw_sum</span> = <span class="ruby-identifier">gp_asym_pw</span>.<span class="ruby-identifier">copy</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">gp_sym_pw_sum</span> = <span class="ruby-identifier">gp_sym_pw_sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp_sym_pw</span>; <span class="ruby-identifier">gp_asym_pw_sum</span> = <span class="ruby-identifier">gp_asym_pw_sum</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp_asym_pw</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">t</span> = <span class="ruby-identifier">t</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">gp_sym_pw</span> = <span class="ruby-identifier">gp_sym_pw_sum</span><span class="ruby-operator">/</span><span class="ruby-identifier">t</span> ; <span class="ruby-identifier">gp_asym_pw</span> = <span class="ruby-identifier">gp_asym_pw_sum</span><span class="ruby-operator">/</span><span class="ruby-identifier">t</span>

  <span class="ruby-comment"># estimate background spectra by smoothing</span>
  <span class="ruby-identifier">tmp</span> = (<span class="ruby-identifier">gp_sym_pw</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">gp_asym_pw</span>).<span class="ruby-identifier">val</span>
  <span class="ruby-value">10</span>.<span class="ruby-identifier">times</span>{ <span class="ruby-comment"># smoothing in frequency</span>
    <span class="ruby-identifier">tmp0</span> = (<span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>])<span class="ruby-operator">/</span><span class="ruby-value">3.0</span>; <span class="ruby-identifier">tmp1</span> = (<span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">-2</span>] <span class="ruby-operator">+</span> <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">-1</span>])<span class="ruby-operator">/</span><span class="ruby-value">3.0</span>
    <span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>] = (<span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-3</span>] <span class="ruby-operator">+</span> <span class="ruby-value">2.0</span><span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])<span class="ruby-operator">/</span><span class="ruby-value">4.0</span>
    <span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>] = <span class="ruby-identifier">tmp0</span>; <span class="ruby-identifier">tmp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">-1</span>] = <span class="ruby-identifier">tmp1</span>
  }
  <span class="ruby-value">40</span>.<span class="ruby-identifier">times</span>{ <span class="ruby-comment"># smoothing in k</span>
    <span class="ruby-identifier">tmp0</span> = (<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">true</span>])<span class="ruby-operator">/</span><span class="ruby-value">3.0</span>; <span class="ruby-identifier">tmp1</span> = (<span class="ruby-identifier">tmp</span>[<span class="ruby-value">-2</span>,<span class="ruby-keyword">true</span>] <span class="ruby-operator">+</span> <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>[<span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>])<span class="ruby-operator">/</span><span class="ruby-value">3.0</span>
    <span class="ruby-identifier">tmp</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>,<span class="ruby-keyword">true</span>] = (<span class="ruby-identifier">tmp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">-3</span>,<span class="ruby-keyword">true</span>] <span class="ruby-operator">+</span> <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">tmp</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>,<span class="ruby-keyword">true</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">tmp</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>])<span class="ruby-operator">/</span><span class="ruby-value">4.0</span>
    <span class="ruby-identifier">tmp</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>] = <span class="ruby-identifier">tmp0</span>; <span class="ruby-identifier">tmp</span>[<span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>] = <span class="ruby-identifier">tmp1</span>
  }
  <span class="ruby-identifier">gp_bg_pw</span> = <span class="ruby-identifier">gp_sym_pw</span>.<span class="ruby-identifier">copy</span>; <span class="ruby-identifier">gp_bg_pw</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">tmp</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp_sym_pw</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;sym-spectra of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_sym_pw</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sym&quot;</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp_asym_pw</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;asym-spectra of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_asym_pw</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;asym&quot;</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">gp_bg_pw</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;log10   bg-spectra of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_bg_pw</span>.<span class="ruby-identifier">name</span> ).<span class="ruby-identifier">log10</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;bg&quot;</span>
  <span class="ruby-keyword">return</span> (<span class="ruby-identifier">gp_sym_pw</span><span class="ruby-operator">/</span><span class="ruby-identifier">gp_bg_pw</span>).<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;sym/bg-spectra of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_sym_pw</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;sym/bg&quot;</span>
  <span class="ruby-keyword">return</span> (<span class="ruby-identifier">gp_asym_pw</span><span class="ruby-operator">/</span><span class="ruby-identifier">gp_bg_pw</span>).<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;asym/bg-spectra of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_asym_pw</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;asym/bg&quot;</span>
  <span class="ruby-keyword">return</span> ((<span class="ruby-identifier">gp_sym_pw</span><span class="ruby-operator">/</span><span class="ruby-identifier">gp_bg_pw</span>).<span class="ruby-identifier">log10</span>).<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;log10(sym/bg-spectra) of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_sym_pw</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;log_sym/bg&quot;</span>
  <span class="ruby-keyword">return</span> ((<span class="ruby-identifier">gp_asym_pw</span><span class="ruby-operator">/</span><span class="ruby-identifier">gp_bg_pw</span>).<span class="ruby-identifier">log10</span>).<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&#39;long_name&#39;</span>, <span class="ruby-string">&#39;log10(asym/bg-spectra) of &#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">gp_asym_pw</span>.<span class="ruby-identifier">name</span> ) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_wnf_analysis</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;log_asym/bg&quot;</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;argument for wnf_analysis must be \&quot;sym, asym, bg, sym/bg, asym/bg, log_sym/bg, or log_asym/bg \&quot; \n&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-write_netcdf4" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_netcdf4</span><span
            class="method-args">(gary, ncfilename, deflate=1, shuffle=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>write out gphys object to a single netcdf ver 4 file. gary is an Array of GPhys, ncfilename is name of output netcdf file. All GPhys objects must have same shape.</p>
          
          

          
          <div class="method-source-code" id="write_netcdf4-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 407</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">write_netcdf4</span>(<span class="ruby-identifier">gary</span>, <span class="ruby-identifier">ncfilename</span>, <span class="ruby-identifier">deflate</span>=<span class="ruby-value">1</span>, <span class="ruby-identifier">shuffle</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">creation_format</span>=(<span class="ruby-constant">NetCDF</span><span class="ruby-operator">::</span><span class="ruby-constant">NC_NETCDF4</span> <span class="ruby-operator">|</span> <span class="ruby-constant">NetCDF</span><span class="ruby-operator">::</span><span class="ruby-constant">NC_CLASSIC_MODEL</span>)
  <span class="ruby-identifier">nc</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">create</span>(<span class="ruby-identifier">ncfilename</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">false</span>)
  <span class="ruby-comment"># define dims and axes</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@OPT_output_assoc_coords</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">tmp_ary</span> = []
    <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">assoccoordnames</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">an</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">tmp_ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">gary</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">assoc_coord_gphys</span>(<span class="ruby-identifier">an</span>)
    }
    <span class="ruby-identifier">gary</span> = <span class="ruby-identifier">tmp_ary</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-comment">#  binding.pry</span>
  <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">g</span>.<span class="ruby-identifier">rank</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-identifier">nc</span>.<span class="ruby-identifier">dim_names</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">i</span>).<span class="ruby-identifier">name</span>)) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">ga</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-identifier">i</span>)
        <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">def_dim</span>(<span class="ruby-identifier">ga</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">ga</span>.<span class="ruby-identifier">length</span>)
<span class="ruby-comment">#        nc.def_var(ga.name, ga.ntype, [nc.dims[-1]])</span>
        <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">def_var</span>(<span class="ruby-identifier">ga</span>.<span class="ruby-identifier">name</span>, <span class="ruby-string">&quot;sfloat&quot;</span>, [<span class="ruby-identifier">nc</span>.<span class="ruby-identifier">dims</span>[<span class="ruby-value">-1</span>]])
        <span class="ruby-comment"># set axes att</span>
        <span class="ruby-identifier">ga</span>.<span class="ruby-identifier">att_names</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">an</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">ga</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put_att</span>(<span class="ruby-identifier">an</span>, <span class="ruby-identifier">ga</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-identifier">an</span>))}
      <span class="ruby-keyword">end</span>
    }
  }
  <span class="ruby-comment"># set global atts</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@sources</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sources</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;.nc&quot;</span>)) <span class="ruby-keyword">then</span> <span class="ruby-comment"># copy the global atts of the source file.</span>
    <span class="ruby-identifier">old_nc</span> = <span class="ruby-constant">NetCDF</span>.<span class="ruby-identifier">open</span>(<span class="ruby-ivar">@sources</span>[<span class="ruby-value">0</span>], <span class="ruby-string">&quot;r&quot;</span>)
    <span class="ruby-identifier">old_nc</span>.<span class="ruby-identifier">each_att</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">at</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-identifier">at</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">at</span>.<span class="ruby-identifier">get</span>) }
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;sources&quot;</span>, <span class="ruby-ivar">@sources</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>))
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;command&quot;</span>, <span class="ruby-ivar">@commandline</span> )
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;working_directory&quot;</span>, <span class="ruby-ivar">@current_dir</span> )
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">put_att</span>(<span class="ruby-string">&quot;process_date&quot;</span>, <span class="ruby-node">&quot;#{Time.now}&quot;</span> )

<span class="ruby-comment">#  binding.pry</span>
  <span class="ruby-comment"># define vars</span>
  <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">to_type</span>(<span class="ruby-ivar">@OPT_ntype</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@OPT_ntype</span>
    <span class="ruby-identifier">g</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">copy</span> <span class="ruby-keyword">if</span> ( (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword">nil</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">data</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) )<span class="ruby-comment"># &amp;&amp; g.rank != 0 &amp;&amp; g.assoccoordnames == nil)</span>
    <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">def_var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">g</span>.<span class="ruby-identifier">ntype</span>, <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">dims</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">axnames</span>))
    <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">deflate</span>(<span class="ruby-identifier">deflate</span>, <span class="ruby-identifier">shuffle</span>) <span class="ruby-comment"># set commpression level and shuffle.</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># to set missing values to output netcdf files.</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">sum</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># skip if there are no missing value points.</span>
        <span class="ruby-identifier">val</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>
        <span class="ruby-identifier">rmiss</span> = (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span><span class="ruby-operator">*</span><span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">max</span>
        <span class="ruby-identifier">rmiss</span> = (<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span><span class="ruby-operator">*</span><span class="ruby-identifier">val</span>.<span class="ruby-identifier">get_mask</span>.<span class="ruby-identifier">eq</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_f</span>).<span class="ruby-identifier">min</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">rmiss</span> <span class="ruby-operator">==</span> <span class="ruby-value">0.0</span> <span class="ruby-comment"># get missing value</span>
        <span class="ruby-identifier">g</span>.<span class="ruby-identifier">set_att</span>(<span class="ruby-string">&quot;missing_value&quot;</span>, [<span class="ruby-identifier">rmiss</span>])
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
<span class="ruby-comment">#    g.del_att(&quot;positive&quot;) if (g.get_att(&quot;positive&quot;) &amp;&amp; g.rank != 0)</span>
    <span class="ruby-comment"># set var att</span>
    <span class="ruby-identifier">g</span>.<span class="ruby-identifier">att_names</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">an</span><span class="ruby-operator">|</span> <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put_att</span>(<span class="ruby-identifier">an</span>, <span class="ruby-identifier">g</span>.<span class="ruby-identifier">get_att</span>(<span class="ruby-identifier">an</span>))  }
  }
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">enddef</span> <span class="ruby-comment"># change to data models</span>

  <span class="ruby-comment"># write axes</span>
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">each_dim</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span> <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">gr</span> = <span class="ruby-identifier">g</span>.<span class="ruby-identifier">grid</span>.<span class="ruby-identifier">copy</span> <span class="ruby-comment"># to avoid error when axis name has changed.</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gr</span>.<span class="ruby-identifier">axnames</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">d</span>.<span class="ruby-identifier">name</span>)) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">d</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put</span>(<span class="ruby-identifier">gr</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-identifier">d</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">val</span>); <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
  }  }

  <span class="ruby-comment"># write vars</span>
  <span class="ruby-identifier">gary</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">g</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put_with_miss</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>
    <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">var</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">put</span>(<span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">g</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>
    <span class="ruby-identifier">print</span> <span class="ruby-node">&quot;Operated GPhys object #{g.name} is written in #{ncfilename}.\n&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@OPT_silent</span>
  }
  <span class="ruby-identifier">nc</span>.<span class="ruby-identifier">close</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ymd2date" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ymd2date</span><span
            class="method-args">(subset)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="ymd2date-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 67</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ymd2date</span>(<span class="ruby-identifier">subset</span>)
  <span class="ruby-comment"># treat y????m?d? like expression.</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">subset</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/y([0-9]+)m([0-9]+)d([0-9]+)/</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">ymd</span> = <span class="ruby-identifier">subset</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/y([0-9]+)m([0-9]+)d([0-9]+)/</span>)
    <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">tmp</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">subset</span>[<span class="ruby-string">&quot;y&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">tmp</span>[<span class="ruby-value">0</span>]<span class="ruby-string">+&quot;m&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">tmp</span>[<span class="ruby-value">1</span>]<span class="ruby-string">+&quot;d&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">tmp</span>[<span class="ruby-value">2</span>]]=<span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">tmp</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)<span class="ruby-string">+&#39;&quot;)&#39;</span>
    }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">subset</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/y([0-9]+)m([0-9]+)/</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">ym</span> = <span class="ruby-identifier">subset</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/y([0-9]+)m([0-9]+)/</span>)
    <span class="ruby-identifier">ym</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">date_parse</span> = <span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)<span class="ruby-string">+&#39;-01&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_calendar360</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">date_parse</span> = <span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)<span class="ruby-string">+&#39;-28&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
        <span class="ruby-identifier">date_parse</span> = <span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)<span class="ruby-string">+&#39;-30&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> [<span class="ruby-value">4</span>,<span class="ruby-value">6</span>,<span class="ruby-value">9</span>,<span class="ruby-value">11</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>)
        <span class="ruby-identifier">date_parse</span> = <span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)<span class="ruby-string">+&#39;-31&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> [<span class="ruby-value">1</span>,<span class="ruby-value">3</span>,<span class="ruby-value">5</span>,<span class="ruby-value">7</span>,<span class="ruby-value">8</span>,<span class="ruby-value">10</span>,<span class="ruby-value">12</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">date_parse</span> = <span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>].<span class="ruby-identifier">join</span>(<span class="ruby-string">&#39;-&#39;</span>)<span class="ruby-string">+&#39;-30&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">subset</span>[<span class="ruby-string">&quot;y&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]<span class="ruby-string">+&quot;m&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">ym</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">1</span>]] = <span class="ruby-identifier">date_parse</span>
    }
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">subset</span>.<span class="ruby-identifier">match</span>(<span class="ruby-regexp">/y([0-9]+)/</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">y</span> = <span class="ruby-identifier">subset</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/y([0-9]+)/</span>)
    <span class="ruby-identifier">y</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">subset</span>[<span class="ruby-string">&quot;y&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]]=<span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]<span class="ruby-string">+&#39;-01-01&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">unless</span> (<span class="ruby-ivar">@OPT_calendar360</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">subset</span>[<span class="ruby-string">&quot;y&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]]=<span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]<span class="ruby-string">+&#39;-12-31&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">subset</span>[<span class="ruby-string">&quot;y&quot;</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]]=<span class="ruby-string">&#39;Date.parse(&quot;&#39;</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span>[<span class="ruby-identifier">i</span>][<span class="ruby-value">0</span>]<span class="ruby-string">+&#39;-12-30&#39;</span><span class="ruby-string">+&#39;&quot;)&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
    }
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">subset</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-ymd2time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ymd2time</span><span
            class="method-args">(unit, ymd)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="ymd2time-source">
            <pre><span class="ruby-comment"># File gpv_utils.rb, line 35</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">ymd2time</span>(<span class="ruby-identifier">unit</span>, <span class="ruby-identifier">ymd</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">to_f</span> <span class="ruby-keyword">if</span> (<span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">to_i</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ymd</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">to_f</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">ymd</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">unit</span>, <span class="ruby-identifier">sdate</span> = <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;day&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;month&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;year&quot;</span>))
      <span class="ruby-identifier">sdate</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">sdate</span>)
      <span class="ruby-identifier">ymd</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;m1&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;m&quot;</span>)
      <span class="ruby-identifier">ymd</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;d1&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;d&quot;</span>)
      <span class="ruby-identifier">ymd</span> = <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;y&quot;</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;m&quot;</span>,<span class="ruby-string">&quot;-&quot;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;d&quot;</span>,<span class="ruby-string">&quot;-&quot;</span>)
      <span class="ruby-identifier">vdate</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">ymd</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">vdate</span>, <span class="ruby-identifier">sdate</span>, <span class="ruby-string">&quot;year&quot;</span> ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;year&quot;</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">vdate</span>, <span class="ruby-identifier">sdate</span>, <span class="ruby-string">&quot;month&quot;</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;month&quot;</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">vdate</span>, <span class="ruby-identifier">sdate</span>, <span class="ruby-string">&quot;day&quot;</span>  ) <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;day&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">value</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;sec&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;min&quot;</span>) <span class="ruby-keyword">or</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;hour&quot;</span>))
      <span class="ruby-identifier">sdate</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">sdate</span>)
      <span class="ruby-identifier">ymd</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;m1&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;m&quot;</span>)
      <span class="ruby-identifier">ymd</span> <span class="ruby-operator">+=</span> <span class="ruby-string">&quot;d1&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;d&quot;</span>)
      <span class="ruby-identifier">ymd</span> = <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;y&quot;</span>,<span class="ruby-string">&quot;&quot;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;m&quot;</span>,<span class="ruby-string">&quot;-&quot;</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-string">&quot;d&quot;</span>,<span class="ruby-string">&quot;-&quot;</span>)
      <span class="ruby-identifier">vdate</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">ymd</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">vdate</span>, <span class="ruby-identifier">sdate</span>, <span class="ruby-string">&quot;hour&quot;</span>)    <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;hour&quot;</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">vdate</span>, <span class="ruby-identifier">sdate</span>, <span class="ruby-string">&quot;min&quot;</span> )    <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;min&quot;</span>)
      <span class="ruby-identifier">value</span> = <span class="ruby-identifier">date_diff</span>(<span class="ruby-identifier">vdate</span>, <span class="ruby-identifier">sdate</span>, <span class="ruby-string">&quot;sec&quot;</span> )    <span class="ruby-keyword">if</span> <span class="ruby-identifier">unit</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;sec&quot;</span>)
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">value</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;unsupported time unit\n&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">ymd</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-zonal_shift_on_sphere" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">zonal_shift_on_sphere</span><span
            class="method-args">(gp, u)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>剛体回転（角速度：angvel）分、東西にシフトさせる。最後の軸は時間。 経度軸の単位は deg, 等間隔。 シフトは最近傍のグリッドデータを使う（補間・内挿はしない）</p>
          
          

          
          <div class="method-source-code" id="zonal_shift_on_sphere-source">
            <pre><span class="ruby-comment"># File gpv_analysis.rb, line 532</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">zonal_shift_on_sphere</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">u</span>)
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">u</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;@&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">u</span> = <span class="ruby-identifier">open_gturl</span>(<span class="ruby-identifier">u</span>).<span class="ruby-identifier">mean</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">angvel</span> = <span class="ruby-identifier">u</span><span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">u</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-identifier">angvel</span> = <span class="ruby-identifier">u</span><span class="ruby-operator">/</span><span class="ruby-ivar">@Radius</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">end</span>


  <span class="ruby-identifier">lon_dim</span>, <span class="ruby-identifier">lat_dim</span> = <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">find_lon_lat_dims</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">time_ax</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">to_gphys</span>
  <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lon_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">del_lon</span> = <span class="ruby-identifier">lon</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">lon</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-identifier">lat_dim</span>).<span class="ruby-identifier">to_gphys</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">new_val</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">val</span>

  <span class="ruby-comment"># 時間軸の単位の秒数</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;day&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">unit_time</span> = <span class="ruby-value">24.0</span><span class="ruby-operator">*</span><span class="ruby-value">60.0</span><span class="ruby-operator">*</span><span class="ruby-value">60.0</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;hour&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">unit_time</span> = <span class="ruby-value">60.0</span><span class="ruby-operator">*</span><span class="ruby-value">60.0</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;min&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">unit_time</span> = <span class="ruby-value">60.0</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;sec&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">unit_time</span> = <span class="ruby-value">1.0</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">unit_time</span> = <span class="ruby-value">1.0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">angvel</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Float</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">delta_deg</span> = (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">t</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">unit_time</span><span class="ruby-operator">*</span><span class="ruby-identifier">angvel</span><span class="ruby-operator">*</span><span class="ruby-constant">R2D</span> <span class="ruby-operator">%</span> <span class="ruby-value">360</span>
      <span class="ruby-identifier">delta_i</span> = (<span class="ruby-identifier">delta_deg</span><span class="ruby-operator">/</span><span class="ruby-identifier">del_lon</span>).<span class="ruby-identifier">round</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">lon</span>.<span class="ruby-identifier">length</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment"># gp に鉛直軸がある（x,y,z,t）場合</span>
        <span class="ruby-identifier">new_val</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">+1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>] = <span class="ruby-identifier">gp</span>[(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
        <span class="ruby-identifier">new_val</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>]  = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">-1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-comment"># gp に鉛直軸がない（x,y,t）場合</span>
        <span class="ruby-identifier">new_val</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">+1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>] = <span class="ruby-identifier">gp</span>[(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
        <span class="ruby-identifier">new_val</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>]  = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">-1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">angvel</span>.<span class="ruby-identifier">rank</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 剛体回転</span>
      <span class="ruby-identifier">delta_deg</span> = (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">t</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">unit_time</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">angvel</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">t</span>].<span class="ruby-identifier">mean</span>)<span class="ruby-operator">*</span><span class="ruby-constant">R2D</span> <span class="ruby-operator">%</span> <span class="ruby-value">360</span>
      <span class="ruby-identifier">delta_i</span> = (<span class="ruby-identifier">delta_deg</span><span class="ruby-operator">/</span><span class="ruby-identifier">del_lon</span>).<span class="ruby-identifier">round</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">lon</span>.<span class="ruby-identifier">length</span>
      <span class="ruby-comment"># gp に鉛直軸がない（x,y,t）場合</span>
      <span class="ruby-identifier">new_val</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">+1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>] = <span class="ruby-identifier">gp</span>[(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
      <span class="ruby-identifier">new_val</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>]  = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">-1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># 緯度ごとに角速度を変える</span>
      <span class="ruby-identifier">lat</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">delta_deg</span> = (<span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">val</span>[<span class="ruby-identifier">t</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">time_ax</span>.<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>])<span class="ruby-operator">*</span><span class="ruby-identifier">unit_time</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">angvel</span>[<span class="ruby-identifier">j</span>,<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">t</span>].<span class="ruby-identifier">mean</span><span class="ruby-operator">/</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>[<span class="ruby-identifier">j</span>]<span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>))<span class="ruby-operator">*</span><span class="ruby-constant">R2D</span> <span class="ruby-operator">%</span> <span class="ruby-value">360</span>
        <span class="ruby-identifier">delta_i</span> = (<span class="ruby-identifier">delta_deg</span><span class="ruby-operator">/</span><span class="ruby-identifier">del_lon</span>).<span class="ruby-identifier">round</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">lon</span>.<span class="ruby-identifier">length</span>
        <span class="ruby-comment"># gp に鉛直軸がない（x,y,t）場合</span>
        <span class="ruby-identifier">new_val</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">j</span>,<span class="ruby-identifier">t</span>] = <span class="ruby-identifier">gp</span>[(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
        <span class="ruby-identifier">new_val</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">delta_i</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>,<span class="ruby-identifier">t</span>]  = <span class="ruby-identifier">gp</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">delta_i</span><span class="ruby-value">-1</span>),<span class="ruby-identifier">j</span>,<span class="ruby-identifier">t</span>].<span class="ruby-identifier">val</span>
      }
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-identifier">ngp</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">copy</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ngp</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">new_val</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

