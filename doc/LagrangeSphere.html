<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module LagrangeSphere - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">




<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-data_ext">#data_ext</a>
    
    <li ><a href="#method-i-data_ext_halo_only">#data_ext_halo_only</a>
    
    <li ><a href="#method-i-find_departurepoint">#find_departurepoint</a>
    
    <li ><a href="#method-i-find_departurepoint_Hortal2002">#find_departurepoint_Hortal2002</a>
    
    <li ><a href="#method-i-find_departurepoint_xyz">#find_departurepoint_xyz</a>
    
    <li ><a href="#method-i-find_midpoint">#find_midpoint</a>
    
    <li ><a href="#method-i-find_midpoint_xyz">#find_midpoint_xyz</a>
    
    <li ><a href="#method-i-find_stencil">#find_stencil</a>
    
    <li ><a href="#method-i-find_stencil_1D">#find_stencil_1D</a>
    
    <li ><a href="#method-i-grid_ext">#grid_ext</a>
    
    <li ><a href="#method-i-init">#init</a>
    
    <li ><a href="#method-i-init_3D">#init_3D</a>
    
    <li ><a href="#method-i-interp1D">#interp1D</a>
    
    <li ><a href="#method-i-interp2D">#interp2D</a>
    
    <li ><a href="#method-i-interp2D_2">#interp2D_2</a>
    
    <li ><a href="#method-i-interp2D_2all">#interp2D_2all</a>
    
    <li ><a href="#method-i-interp3D">#interp3D</a>
    
    <li ><a href="#method-i-interp3D_1">#interp3D_1</a>
    
    <li ><a href="#method-i-interp4D_1_gp">#interp4D_1_gp</a>
    
    <li ><a href="#method-i-interp4D_gp">#interp4D_gp</a>
    
    <li ><a href="#method-i-lonlat2xyz">#lonlat2xyz</a>
    
    <li ><a href="#method-i-particle_advection_2D">#particle_advection_2D</a>
    
    <li ><a href="#method-i-particle_advection_3D">#particle_advection_3D</a>
    
    <li ><a href="#method-i-uv2xyz">#uv2xyz</a>
    
    <li ><a href="#method-i-xyz2lonlat">#xyz2lonlat</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-LagrangeSphere">
  <h1 id="module-LagrangeSphere" class="module">
    module LagrangeSphere
  </h1>

  <section class="description">
    
  </section>

  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-data_ext" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">data_ext</span><span
            class="method-args">(data, n=1, keep_index=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="data_ext-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 52</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">data_ext</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">n</span>=<span class="ruby-value">1</span>, <span class="ruby-identifier">keep_index</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">shape</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shape</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>] <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">data_ext</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">data_ext</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">data_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-1</span>), <span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span>),<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data</span>
  <span class="ruby-identifier">n</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># 経度方向</span>
    <span class="ruby-identifier">data_ext</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>), <span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span>),<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>),<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]
    <span class="ruby-identifier">data_ext</span>[<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">m</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span>),<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span><span class="ruby-operator">+</span><span class="ruby-identifier">m</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>]
    <span class="ruby-comment"># 緯度方向 ↓ 以下の拡張は、東西半球が変わることを考慮していないので、不適では？</span>
    <span class="ruby-identifier">data_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-1</span>), <span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>),<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">m</span><span class="ruby-value">+1</span>,<span class="ruby-keyword">false</span>]
    <span class="ruby-identifier">data_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-1</span>), <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">+</span><span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+2</span>),<span class="ruby-keyword">false</span>]
  }
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">keep_index</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">data_ext</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">data_ext_o</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">data_ext_o</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">data_ext_o</span>[<span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>), <span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>),<span class="ruby-keyword">false</span>]
    <span class="ruby-identifier">data_ext_o</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>), <span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data_ext</span>[(<span class="ruby-operator">-</span><span class="ruby-identifier">n</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">-1</span>), <span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>),<span class="ruby-keyword">false</span>]
    <span class="ruby-identifier">data_ext_o</span>[<span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>, <span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>),<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">data_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>), (<span class="ruby-operator">-</span><span class="ruby-identifier">n</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">-1</span>),<span class="ruby-keyword">false</span>]
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">data_ext_o</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-data_ext_halo_only" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">data_ext_halo_only</span><span
            class="method-args">(gp, n=1, vect_comp=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="data_ext_halo_only-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 84</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">data_ext_halo_only</span>(<span class="ruby-identifier">gp</span>, <span class="ruby-identifier">n</span>=<span class="ruby-value">1</span>, <span class="ruby-identifier">vect_comp</span>=<span class="ruby-keyword">true</span>)
  <span class="ruby-identifier">shape</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">shape</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">shape</span>[<span class="ruby-value">3</span>]) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">de_x0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">3</span>]) <span class="ruby-comment"># 左端</span>
    <span class="ruby-identifier">de_x1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">3</span>]) <span class="ruby-comment"># 右端</span>
    <span class="ruby-identifier">de_y0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">3</span>]) <span class="ruby-comment"># 下端</span>
    <span class="ruby-identifier">de_y1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">3</span>]) <span class="ruby-comment"># 上端</span>
  <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">de_x0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>]) <span class="ruby-comment"># 左端</span>
    <span class="ruby-identifier">de_x1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>]) <span class="ruby-comment"># 右端</span>
    <span class="ruby-identifier">de_y0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>]) <span class="ruby-comment"># 下端</span>
    <span class="ruby-identifier">de_y1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">2</span>]) <span class="ruby-comment"># 上端</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">de_x0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]) <span class="ruby-comment"># 左端</span>
    <span class="ruby-identifier">de_x1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>, <span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]) <span class="ruby-comment"># 右端</span>
    <span class="ruby-identifier">de_y0</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>) <span class="ruby-comment"># 下端</span>
    <span class="ruby-identifier">de_y1</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>) <span class="ruby-comment"># 上端</span>
  <span class="ruby-keyword">end</span>
  (<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-1</span>).<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># 経度方向</span>
    <span class="ruby-identifier">de_x0</span>[<span class="ruby-identifier">m</span>, <span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gp</span>[<span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">+</span><span class="ruby-identifier">m</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>
    <span class="ruby-identifier">de_x1</span>[<span class="ruby-identifier">m</span>, <span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gp</span>[(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span><span class="ruby-operator">+</span><span class="ruby-identifier">m</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>], <span class="ruby-keyword">true</span>,<span class="ruby-keyword">false</span>].<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>
    <span class="ruby-comment"># 緯度方向</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">m</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">n</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 東西半球の反転</span>
      <span class="ruby-identifier">de_y0</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gp</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">n</span><span class="ruby-operator">-</span><span class="ruby-identifier">m</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>
      <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">de_y0</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span><span class="ruby-value">-1</span>),<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>]
      <span class="ruby-identifier">de_y0</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span><span class="ruby-value">-1</span>),<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">de_y0</span>[(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>]
      <span class="ruby-identifier">de_y0</span>[(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">tmp</span>

      <span class="ruby-identifier">de_y1</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-2</span><span class="ruby-operator">-</span><span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span><span class="ruby-operator">+</span><span class="ruby-identifier">m</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>
      <span class="ruby-identifier">de_y1</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span><span class="ruby-value">-1</span>),<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">de_y0</span>[(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>]
      <span class="ruby-identifier">de_y1</span>[(<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-operator">/</span><span class="ruby-value">2</span>)<span class="ruby-operator">..</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-operator">-</span><span class="ruby-identifier">tmp</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">de_y0</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gp</span>[<span class="ruby-keyword">true</span>, <span class="ruby-identifier">m</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>, <span class="ruby-keyword">false</span>].<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>
      <span class="ruby-identifier">de_y1</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span><span class="ruby-value">-2</span><span class="ruby-operator">-</span><span class="ruby-identifier">m</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-identifier">gp</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-1</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>),<span class="ruby-keyword">false</span>].<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>
    <span class="ruby-keyword">end</span>
  }
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">de_x0</span>, <span class="ruby-identifier">de_x1</span>, <span class="ruby-identifier">de_y0</span>, <span class="ruby-identifier">de_y1</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_departurepoint" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_departurepoint</span><span
            class="method-args">(lon, lat, mlon, mlat, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_departurepoint-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 753</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_departurepoint</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment">#始点を求める</span>
  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span> = <span class="ruby-identifier">lonlat2xyz</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-identifier">xm</span>, <span class="ruby-identifier">ym</span>, <span class="ruby-identifier">zm</span> = <span class="ruby-identifier">lonlat2xyz</span>(<span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-identifier">x0</span>, <span class="ruby-identifier">y0</span>, <span class="ruby-identifier">z0</span> = <span class="ruby-identifier">find_departurepoint_xyz</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">xm</span>, <span class="ruby-identifier">ym</span>, <span class="ruby-identifier">zm</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-identifier">lon0</span>, <span class="ruby-identifier">lat0</span> = <span class="ruby-identifier">xyz2lonlat</span>(<span class="ruby-identifier">x0</span>,<span class="ruby-identifier">y0</span>,<span class="ruby-identifier">z0</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">lon0</span>, <span class="ruby-identifier">lat0</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_departurepoint_Hortal2002" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_departurepoint_Hortal2002</span><span
            class="method-args">(lon, lat, u, v, slon, slat, su, sv, dt, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_departurepoint_Hortal2002-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 762</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_departurepoint_Hortal2002</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">su</span>, <span class="ruby-identifier">sv</span>, <span class="ruby-identifier">dt</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment"># 始点を求める（Hortal 2002）</span>
  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span> = <span class="ruby-identifier">lonlat2xyz</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-identifier">xd</span>, <span class="ruby-identifier">yd</span>, <span class="ruby-identifier">zd</span> = <span class="ruby-identifier">uv2xyz</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-identifier">lon</span>,<span class="ruby-identifier">lat</span>)
  <span class="ruby-identifier">sxd</span>, <span class="ruby-identifier">syd</span>, <span class="ruby-identifier">szd</span> = <span class="ruby-identifier">uv2xyz</span>(<span class="ruby-identifier">su</span>,<span class="ruby-identifier">sv</span>,<span class="ruby-identifier">slon</span>,<span class="ruby-identifier">slat</span>)
  <span class="ruby-comment"># 球面上に束縛するために係数</span>
  <span class="ruby-identifier">tmp</span> = ((<span class="ruby-identifier">xd</span><span class="ruby-operator">+</span><span class="ruby-identifier">sxd</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">yd</span><span class="ruby-operator">+</span><span class="ruby-identifier">syd</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">zd</span><span class="ruby-operator">+</span><span class="ruby-identifier">szd</span>)<span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">dt</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>)<span class="ruby-operator">*</span><span class="ruby-value">0.25</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">r</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>) <span class="ruby-operator">-</span>
        ((<span class="ruby-identifier">xd</span><span class="ruby-operator">+</span><span class="ruby-identifier">sxd</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">x</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">yd</span><span class="ruby-operator">+</span><span class="ruby-identifier">syd</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">y</span><span class="ruby-operator">+</span>(<span class="ruby-identifier">zd</span><span class="ruby-operator">+</span><span class="ruby-identifier">szd</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">z</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">r</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1.0</span>
  <span class="ruby-identifier">b</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">tmp</span><span class="ruby-operator">**</span><span class="ruby-value">0.5</span>)
  <span class="ruby-identifier">sx</span> = (<span class="ruby-identifier">x</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">xd</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">sxd</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">b</span>
  <span class="ruby-identifier">sy</span> = (<span class="ruby-identifier">y</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">yd</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">syd</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">b</span>
  <span class="ruby-identifier">sz</span> = (<span class="ruby-identifier">z</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">zd</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">szd</span>))<span class="ruby-operator">*</span><span class="ruby-identifier">b</span>
  <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span> = <span class="ruby-identifier">xyz2lonlat</span>(<span class="ruby-identifier">sx</span>,<span class="ruby-identifier">sy</span>,<span class="ruby-identifier">sz</span>,<span class="ruby-identifier">r</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_departurepoint_xyz" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_departurepoint_xyz</span><span
            class="method-args">(x, y, z, xm, ym, zm, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_departurepoint_xyz-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 164</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_departurepoint_xyz</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">xm</span>, <span class="ruby-identifier">ym</span>, <span class="ruby-identifier">zm</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment">#始点を求める</span>
  <span class="ruby-identifier">b</span> = <span class="ruby-value">2.0</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">x</span><span class="ruby-operator">*</span><span class="ruby-identifier">xm</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">y</span><span class="ruby-operator">*</span><span class="ruby-identifier">ym</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">z</span><span class="ruby-operator">*</span><span class="ruby-identifier">zm</span>)<span class="ruby-operator">/</span>(<span class="ruby-identifier">r</span><span class="ruby-operator">*</span><span class="ruby-identifier">r</span>) <span class="ruby-comment"># 球面上に束縛するための係数</span>
  <span class="ruby-identifier">x0</span> = <span class="ruby-identifier">b</span><span class="ruby-operator">*</span><span class="ruby-identifier">xm</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">x</span> <span class="ruby-comment"># xm.mul!(b).sbt!(x)</span>
  <span class="ruby-identifier">y0</span> = <span class="ruby-identifier">b</span><span class="ruby-operator">*</span><span class="ruby-identifier">ym</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">y</span> <span class="ruby-comment"># ym.mul!(b).sbt!(y)</span>
  <span class="ruby-identifier">z0</span> = <span class="ruby-identifier">b</span><span class="ruby-operator">*</span><span class="ruby-identifier">zm</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">z</span> <span class="ruby-comment"># zm.mul!(b).sbt!(z)</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">x0</span>, <span class="ruby-identifier">y0</span>, <span class="ruby-identifier">z0</span>] <span class="ruby-comment"># [xm, ym, zm]</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_midpoint" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_midpoint</span><span
            class="method-args">(lon, lat, u, v, dt, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_midpoint-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 744</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_midpoint</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">dt</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment">#中間点を推定する</span>
  <span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span> = <span class="ruby-identifier">lonlat2xyz</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-identifier">xd</span>, <span class="ruby-identifier">yd</span>, <span class="ruby-identifier">zd</span> = <span class="ruby-identifier">uv2xyz</span>(<span class="ruby-identifier">u</span>,<span class="ruby-identifier">v</span>,<span class="ruby-identifier">lon</span>,<span class="ruby-identifier">lat</span>)
  <span class="ruby-identifier">xm</span>, <span class="ruby-identifier">ym</span>, <span class="ruby-identifier">zm</span> = <span class="ruby-identifier">find_midpoint_xyz</span>(<span class="ruby-identifier">x</span>,<span class="ruby-identifier">y</span>,<span class="ruby-identifier">z</span>,<span class="ruby-identifier">xd</span>,<span class="ruby-identifier">yd</span>,<span class="ruby-identifier">zd</span>,<span class="ruby-identifier">dt</span>,<span class="ruby-identifier">r</span>)
  <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span> = <span class="ruby-identifier">xyz2lonlat</span>(<span class="ruby-identifier">xm</span>,<span class="ruby-identifier">ym</span>,<span class="ruby-identifier">zm</span>, <span class="ruby-identifier">r</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_midpoint_xyz" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_midpoint_xyz</span><span
            class="method-args">(x, y, z, xd, yd, zd, dt, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_midpoint_xyz-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 154</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_midpoint_xyz</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">xd</span>, <span class="ruby-identifier">yd</span>, <span class="ruby-identifier">zd</span>, <span class="ruby-identifier">dt</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment">#中間点を推定する</span>
  <span class="ruby-identifier">tmp</span> = <span class="ruby-identifier">r</span><span class="ruby-operator">*</span><span class="ruby-identifier">r</span> <span class="ruby-operator">+</span> (<span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span>)<span class="ruby-operator">*</span>(<span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">xd</span><span class="ruby-operator">*</span><span class="ruby-identifier">xd</span><span class="ruby-operator">+</span><span class="ruby-identifier">yd</span><span class="ruby-operator">*</span><span class="ruby-identifier">yd</span><span class="ruby-operator">+</span><span class="ruby-identifier">zd</span><span class="ruby-operator">*</span><span class="ruby-identifier">zd</span>) <span class="ruby-operator">-</span> <span class="ruby-value">2.0</span><span class="ruby-operator">*</span>(<span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span>)<span class="ruby-operator">*</span>(<span class="ruby-identifier">x</span><span class="ruby-operator">*</span><span class="ruby-identifier">xd</span><span class="ruby-operator">+</span><span class="ruby-identifier">y</span><span class="ruby-operator">*</span><span class="ruby-identifier">yd</span><span class="ruby-operator">+</span><span class="ruby-identifier">z</span><span class="ruby-operator">*</span><span class="ruby-identifier">zd</span>)
  <span class="ruby-identifier">b</span> = <span class="ruby-identifier">r</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">tmp</span><span class="ruby-operator">**</span><span class="ruby-value">0.5</span>) <span class="ruby-comment"># 球面上に束縛するための係数</span>
  <span class="ruby-identifier">xm</span> = <span class="ruby-identifier">b</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">x</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">*</span><span class="ruby-identifier">xd</span>) <span class="ruby-comment"># x.sbt!(xd*dt*0.5).mul!(b)</span>
  <span class="ruby-identifier">ym</span> = <span class="ruby-identifier">b</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">y</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">*</span><span class="ruby-identifier">yd</span>) <span class="ruby-comment"># y.sbt!(yd*dt*0.5).mul!(b)</span>
  <span class="ruby-identifier">zm</span> = <span class="ruby-identifier">b</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">z</span> <span class="ruby-operator">-</span> <span class="ruby-value">0.5</span><span class="ruby-operator">*</span><span class="ruby-identifier">dt</span><span class="ruby-operator">*</span><span class="ruby-identifier">zd</span>) <span class="ruby-comment"># z.sbt!(zd*dt*0.5).mul!(b)</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">xm</span>, <span class="ruby-identifier">ym</span>, <span class="ruby-identifier">zm</span>] <span class="ruby-comment"># [x, y, z]</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_stencil" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_stencil</span><span
            class="method-args">(plon, plat)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_stencil-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 187</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_stencil</span>(<span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>) <span class="ruby-comment"># 指定座標を囲む4つのグリッド点を見つける</span>
  <span class="ruby-comment"># plon, plat が指定座標</span>
  <span class="ruby-comment"># 指定座標を囲むグリッドのインデックスは i_na, i_na + 1, j_na, j_na + 1 になる。</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">plon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 1次元 NArray</span>
    <span class="ruby-identifier">len</span> = <span class="ruby-identifier">plon</span>.<span class="ruby-identifier">length</span>
    <span class="ruby-identifier">i_na</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">len</span>).<span class="ruby-identifier">fill</span>(<span class="ruby-value">-999999</span>)
    <span class="ruby-identifier">j_na</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">len</span>).<span class="ruby-identifier">fill</span>(<span class="ruby-value">-999999</span>)
    <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">i_na</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-ivar">@gslv_lon_ext</span>, <span class="ruby-identifier">plon</span>[<span class="ruby-identifier">n</span>], <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_lon_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)
      <span class="ruby-identifier">j_na</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-ivar">@gslv_lat_ext</span>, <span class="ruby-identifier">plat</span>[<span class="ruby-identifier">n</span>], <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)
    }
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">i_na</span>, <span class="ruby-identifier">j_na</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">i_na</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-ivar">@gslv_lon_ext</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_lon_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)
    <span class="ruby-identifier">j_na</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-ivar">@gslv_lat_ext</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">i_na</span>, <span class="ruby-identifier">j_na</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-find_stencil_1D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">find_stencil_1D</span><span
            class="method-args">(pz)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="find_stencil_1D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 206</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">find_stencil_1D</span>(<span class="ruby-identifier">pz</span>) <span class="ruby-comment"># 指定座標を囲む4つのグリッド点を見つける</span>
  <span class="ruby-comment"># pz が指定座標</span>
  <span class="ruby-comment"># 指定座標を囲むグリッドのインデックスは k_na, k_na + 1になる。</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">pz</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 1次元 NArray</span>
    <span class="ruby-identifier">len</span> = <span class="ruby-identifier">pz</span>.<span class="ruby-identifier">length</span>
    <span class="ruby-identifier">k_na</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">int</span>(<span class="ruby-identifier">len</span>).<span class="ruby-identifier">fill</span>(<span class="ruby-value">-999999</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@flag_sigma</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k_na</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-operator">-</span><span class="ruby-ivar">@gslv_z</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">pz</span>[<span class="ruby-identifier">n</span>], <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_z</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)  }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">len</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">k_na</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-ivar">@gslv_z</span>, <span class="ruby-identifier">pz</span>[<span class="ruby-identifier">n</span>], <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_z</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>)  }
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">k_na</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">k_na</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-ivar">@gslv_z</span>, <span class="ruby-identifier">pz</span>, <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_z</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@flag_sigma</span>
    <span class="ruby-identifier">k_na</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">bsearch</span>(<span class="ruby-operator">-</span><span class="ruby-ivar">@gslv_z</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">pz</span>, <span class="ruby-value">0</span>, <span class="ruby-ivar">@gslv_z</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-1</span>) <span class="ruby-keyword">if</span> <span class="ruby-ivar">@flag_sigma</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">k_na</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-grid_ext" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">grid_ext</span><span
            class="method-args">(glon, glat, n=1, keep_index=true)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>lon, lat は radian 単位、latは南極から詰める 入力は <a href="NArray.html"><code>NArray</code></a> or <a href="Float.html"><code>Float</code></a></p>
          
          

          
          <div class="method-source-code" id="grid_ext-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 18</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">grid_ext</span>(<span class="ruby-identifier">glon</span>, <span class="ruby-identifier">glat</span>, <span class="ruby-identifier">n</span>=<span class="ruby-value">1</span>, <span class="ruby-identifier">keep_index</span>=<span class="ruby-keyword">true</span>) <span class="ruby-comment"># grid を両側にnずつ拡張する。ただしindexはそのまま。</span>
  <span class="ruby-identifier">lonlen</span> = <span class="ruby-identifier">glon</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">latlen</span> = <span class="ruby-identifier">glat</span>.<span class="ruby-identifier">length</span>
  <span class="ruby-identifier">glon_ext</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">lonlen</span><span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
  <span class="ruby-identifier">glat_ext</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">latlen</span><span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)

  <span class="ruby-identifier">glon_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">lonlen</span><span class="ruby-value">-1</span>)] = <span class="ruby-identifier">glon</span>
  <span class="ruby-identifier">glat_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">latlen</span><span class="ruby-value">-1</span>)] = <span class="ruby-identifier">glat</span>

  <span class="ruby-comment"># 等間隔格子を仮定</span>
  <span class="ruby-identifier">dlon</span> = <span class="ruby-identifier">glon</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">glon</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">dlat</span> = <span class="ruby-identifier">glat</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">glat</span>[<span class="ruby-value">0</span>]

  <span class="ruby-identifier">n</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">glon_ext</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)] = <span class="ruby-identifier">glon</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">dlon</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)
    <span class="ruby-identifier">glon_ext</span>[<span class="ruby-identifier">lonlen</span><span class="ruby-operator">+</span><span class="ruby-identifier">m</span>] = <span class="ruby-identifier">glon</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">dlon</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)
    <span class="ruby-identifier">glat_ext</span>[<span class="ruby-operator">-</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)] = <span class="ruby-identifier">glat</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">dlat</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)
    <span class="ruby-identifier">glat_ext</span>[<span class="ruby-identifier">latlen</span><span class="ruby-operator">+</span><span class="ruby-identifier">m</span>] = <span class="ruby-identifier">glat</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">dlat</span><span class="ruby-operator">*</span>(<span class="ruby-identifier">m</span><span class="ruby-value">+1</span>)
  }

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">keep_index</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">glon_ext</span>, <span class="ruby-identifier">glat_ext</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">glon_ext_o</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">lonlen</span><span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
    <span class="ruby-identifier">glat_ext_o</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">latlen</span><span class="ruby-value">+2</span><span class="ruby-operator">*</span><span class="ruby-identifier">n</span>)
    <span class="ruby-identifier">glon_ext_o</span>[<span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] = <span class="ruby-identifier">glon_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>)]
    <span class="ruby-identifier">glon_ext_o</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>)] = <span class="ruby-identifier">glon_ext</span>[(<span class="ruby-operator">-</span><span class="ruby-identifier">n</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">-1</span>)]
    <span class="ruby-identifier">glat_ext_o</span>[<span class="ruby-identifier">n</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] = <span class="ruby-identifier">glat_ext</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-value">-1</span><span class="ruby-operator">-</span><span class="ruby-identifier">n</span>)]
    <span class="ruby-identifier">glat_ext_o</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">n</span><span class="ruby-value">-1</span>)] = <span class="ruby-identifier">glat_ext</span>[(<span class="ruby-operator">-</span><span class="ruby-identifier">n</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">-1</span>)]
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">glon_ext_o</span>, <span class="ruby-identifier">glat_ext_o</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-init" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">init</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>初期化ルーチン</p>
          
          

          
          <div class="method-source-code" id="init-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 778</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">init</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-comment"># gslとNArrayの連携が切れているので、配列は GSL::Vector オブジェクトにしておく。</span>
  <span class="ruby-comment"># グリッドの取り出しと拡張</span>
  <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>
  <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>
  <span class="ruby-identifier">lon_ext</span>, <span class="ruby-identifier">lat_ext</span> = <span class="ruby-identifier">grid_ext</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-value">4</span>)

  <span class="ruby-ivar">@gslv_lon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lon</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_lat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lat</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_lon_ext</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lon_ext</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_lat_ext</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lat_ext</span>.<span class="ruby-identifier">to_a</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-init_3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">init_3D</span><span
            class="method-args">(gp)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>初期化ルーチン</p>
          
          

          
          <div class="method-source-code" id="init_3D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 792</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">init_3D</span>(<span class="ruby-identifier">gp</span>)
  <span class="ruby-comment"># gslとNArrayの連携が切れているので、配列は GSL::Vector オブジェクトにしておく。</span>
  <span class="ruby-comment"># グリッドの取り出しと拡張</span>
  <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>
  <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">1</span>).<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>
  <span class="ruby-identifier">z</span> = <span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">val</span>
  <span class="ruby-identifier">lon_ext</span>, <span class="ruby-identifier">lat_ext</span> = <span class="ruby-identifier">grid_ext</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-value">4</span>)

  <span class="ruby-ivar">@gslv_lon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lon</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_lat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lat</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_lon_ext</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lon_ext</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_lat_ext</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">lat_ext</span>.<span class="ruby-identifier">to_a</span>]
  <span class="ruby-ivar">@gslv_z</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">z</span>.<span class="ruby-identifier">to_a</span>]

  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gp</span>.<span class="ruby-identifier">coordinate</span>(<span class="ruby-value">2</span>).<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;sig&quot;</span>))
    <span class="ruby-ivar">@flag_sigma</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-ivar">@flag_sigma</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp1D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp1D</span><span
            class="method-args">(xa, ya, xt, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp1D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 227</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp1D</span>(<span class="ruby-identifier">xa</span>, <span class="ruby-identifier">ya</span>, <span class="ruby-identifier">xt</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>)
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">xa</span>, <span class="ruby-identifier">ya</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">xa</span>, <span class="ruby-identifier">ya</span>, <span class="ruby-identifier">xt</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp2D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp2D</span><span
            class="method-args">(glon, glat, data, plon, plat, i, j, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp2D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 233</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp2D</span>(<span class="ruby-identifier">glon</span>, <span class="ruby-identifier">glat</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 2次元補完（１点のみ）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">type</span>
  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;linear&quot;</span>, <span class="ruby-string">&quot;cspline&quot;</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">glon</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">slon</span> = <span class="ruby-identifier">glon</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)]
      <span class="ruby-identifier">da0</span> = <span class="ruby-identifier">data</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">-1</span>]
      <span class="ruby-identifier">da1</span> = <span class="ruby-identifier">data</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span>  ]
      <span class="ruby-identifier">da2</span> = <span class="ruby-identifier">data</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">+1</span>]
      <span class="ruby-identifier">da3</span> = <span class="ruby-identifier">data</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">+2</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">slon</span> = <span class="ruby-constant">NArray</span>[ <span class="ruby-identifier">glon</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">glon</span>[<span class="ruby-identifier">i</span>], <span class="ruby-identifier">glon</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">glon</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>] ]
      <span class="ruby-identifier">da0</span> = <span class="ruby-constant">NArray</span>[ <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>] ]
      <span class="ruby-identifier">da1</span> = <span class="ruby-constant">NArray</span>[ <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ] ]
      <span class="ruby-identifier">da2</span> = <span class="ruby-constant">NArray</span>[ <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>] ]
      <span class="ruby-identifier">da3</span> = <span class="ruby-constant">NArray</span>[ <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">data</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">glat</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
     <span class="ruby-identifier">slat</span> = <span class="ruby-identifier">glat</span>[(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>)]
    <span class="ruby-keyword">else</span>
     <span class="ruby-identifier">slat</span> = <span class="ruby-constant">NArray</span>[ <span class="ruby-identifier">glat</span>[<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">glat</span>[<span class="ruby-identifier">j</span>], <span class="ruby-identifier">glat</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">glat</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">#puts slon.to_a, slat.to_a, plon, plat</span>

    <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">da0</span>) <span class="ruby-comment"># 初期化</span>
    <span class="ruby-identifier">d0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">da0</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">d1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">da1</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">d2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">da2</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">d3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">da3</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">pval</span> = <span class="ruby-identifier">interp1D</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-constant">NArray</span>[<span class="ruby-identifier">d0</span>,<span class="ruby-identifier">d1</span>,<span class="ruby-identifier">d2</span>,<span class="ruby-identifier">d3</span>], <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">type</span>)

  <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;nearest-neighbor&quot;</span>
    <span class="ruby-identifier">dlon0</span> = (<span class="ruby-identifier">plon</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">glon</span>[<span class="ruby-identifier">i</span>]).<span class="ruby-identifier">abs</span>; <span class="ruby-identifier">dlon1</span> = (<span class="ruby-identifier">glon</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">plon</span>).<span class="ruby-identifier">abs</span>
    <span class="ruby-identifier">dlat0</span> = (<span class="ruby-identifier">plat</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">glat</span>[<span class="ruby-identifier">j</span>]).<span class="ruby-identifier">abs</span>; <span class="ruby-identifier">dlat1</span> = (<span class="ruby-identifier">glat</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">plat</span>).<span class="ruby-identifier">abs</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlon0</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">dlon1</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">it</span> = <span class="ruby-identifier">i</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">it</span> = <span class="ruby-identifier">i</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">dlat0</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">dlat1</span>) <span class="ruby-keyword">then</span> <span class="ruby-identifier">jt</span> = <span class="ruby-identifier">j</span> <span class="ruby-keyword">else</span> <span class="ruby-identifier">jt</span> = <span class="ruby-identifier">j</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span> <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">pval</span> = <span class="ruby-identifier">data</span>[<span class="ruby-identifier">it</span>,<span class="ruby-identifier">jt</span>]

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;#{type} interpolation is not supported.&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">pval</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp2D_2" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp2D_2</span><span
            class="method-args">(u, v, plon, plat, i, j, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp2D_2-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 281</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp2D_2</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 2次元補完（１点のみ, 2変数同時）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-comment"># case type</span>
  <span class="ruby-comment"># when &quot;linear&quot;, &quot;cspline&quot;</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lon_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-ivar">@gslv_lon_ext</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)]
    <span class="ruby-identifier">ua0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span>  ].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">+1</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">+2</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span>  ].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">+1</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">j</span><span class="ruby-value">+2</span>].<span class="ruby-identifier">to_a</span>]

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-identifier">ua0</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>] ]
    <span class="ruby-identifier">ua1</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ] ]
    <span class="ruby-identifier">ua2</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>] ]
    <span class="ruby-identifier">ua3</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-identifier">va0</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>] ]
    <span class="ruby-identifier">va1</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ] ]
    <span class="ruby-identifier">va2</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>] ]
    <span class="ruby-identifier">va3</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]

  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-ivar">@gslv_lat_ext</span>[(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>)]
  <span class="ruby-keyword">else</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#puts slon.to_a, slat.to_a, plon, plat</span>

  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">u0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua1</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua2</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua3</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va0</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va1</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va2</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va3</span>, <span class="ruby-identifier">plon</span>)

  <span class="ruby-identifier">uaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u0</span>,<span class="ruby-identifier">u1</span>,<span class="ruby-identifier">u2</span>,<span class="ruby-identifier">u3</span>]
  <span class="ruby-identifier">vaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v0</span>,<span class="ruby-identifier">v1</span>,<span class="ruby-identifier">v2</span>,<span class="ruby-identifier">v3</span>]
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">uval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-identifier">vval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">vaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-comment"># else</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">uval</span>, <span class="ruby-identifier">vval</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp2D_2all" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp2D_2all</span><span
            class="method-args">(glon, glat, u, v, plon, plat, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp2D_2all-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 338</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp2D_2all</span>(<span class="ruby-identifier">glon</span>, <span class="ruby-identifier">glat</span>, <span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 2次元補完（2変数同時）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-comment"># case type</span>
  <span class="ruby-comment"># when &quot;linear&quot;, &quot;cspline&quot;</span>

  <span class="ruby-comment"># 準備</span>
  <span class="ruby-identifier">rlonlen</span> = <span class="ruby-identifier">plon</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]
  <span class="ruby-identifier">rlatlen</span> = <span class="ruby-identifier">plon</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]

  <span class="ruby-identifier">uval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">rlonlen</span>, <span class="ruby-identifier">rlatlen</span>)
  <span class="ruby-identifier">vval</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">rlonlen</span>, <span class="ruby-identifier">rlatlen</span>)

  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">glon</span>, <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">u_i_lon</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">rlonlen</span>, <span class="ruby-identifier">rlatlen</span>, <span class="ruby-identifier">glat</span>.<span class="ruby-identifier">length</span>)
  <span class="ruby-identifier">v_i_lon</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">rlonlen</span>, <span class="ruby-identifier">rlatlen</span>, <span class="ruby-identifier">glat</span>.<span class="ruby-identifier">length</span>)
  <span class="ruby-identifier">glat</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">j</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">u_i_lon</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>] = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">glon</span>,<span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">j</span>],<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>.<span class="ruby-identifier">to_gv</span>(<span class="ruby-identifier">plon</span>)).<span class="ruby-identifier">to_na</span>.<span class="ruby-identifier">reshape</span>(<span class="ruby-identifier">rlonlen</span>, <span class="ruby-identifier">rlatlen</span>)
    <span class="ruby-identifier">v_i_lon</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>, <span class="ruby-identifier">j</span>] = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">glon</span>,<span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-identifier">j</span>],<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>.<span class="ruby-identifier">to_gv</span>(<span class="ruby-identifier">plon</span>)).<span class="ruby-identifier">to_na</span>.<span class="ruby-identifier">reshape</span>(<span class="ruby-identifier">rlonlen</span>, <span class="ruby-identifier">rlatlen</span>)
  }

  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">glat</span>, <span class="ruby-identifier">u</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">true</span>]) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">rlatlen</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">rlonlen</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span>
     <span class="ruby-identifier">uval</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">glat</span>,<span class="ruby-identifier">u_i_lon</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">true</span>],<span class="ruby-identifier">plat</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>])
     <span class="ruby-identifier">vval</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">glat</span>,<span class="ruby-identifier">v_i_lon</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>,<span class="ruby-keyword">true</span>],<span class="ruby-identifier">plat</span>[<span class="ruby-identifier">m</span>,<span class="ruby-identifier">n</span>])
    }
  }
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">uval</span>, <span class="ruby-identifier">vval</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp3D</span><span
            class="method-args">(u, v, plon, plat, pz, i, j, k, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp3D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 369</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp3D</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">pz</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">k</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 3次元補完（１点のみ, 2変数同時）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-comment"># case type</span>
  <span class="ruby-comment"># when &quot;linear&quot;, &quot;cspline&quot;</span>
  <span class="ruby-identifier">sz</span> = <span class="ruby-ivar">@gslv_z</span>[<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>)]
  <span class="ruby-comment"># 鉛直内挿の係数</span>
  <span class="ruby-identifier">c0</span> = (<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">pz</span>); <span class="ruby-identifier">c1</span> = (<span class="ruby-identifier">pz</span><span class="ruby-operator">-</span><span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>]); <span class="ruby-identifier">c2</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>])
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lon_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-ivar">@gslv_lon_ext</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)]
    <span class="ruby-comment"># 鉛直内挿して、GSL::Vectorにする。</span>
    <span class="ruby-identifier">ua0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-identifier">ua0</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">ua1</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">ua2</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">ua3</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">va0</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">va1</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">va2</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">va3</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">v</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-ivar">@gslv_lat_ext</span>[(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>)]
  <span class="ruby-keyword">else</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#水平補完</span>
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">u0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua1</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua2</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua3</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va0</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va1</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va2</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va3</span>, <span class="ruby-identifier">plon</span>)

  <span class="ruby-identifier">uaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u0</span>,<span class="ruby-identifier">u1</span>,<span class="ruby-identifier">u2</span>,<span class="ruby-identifier">u3</span>]
  <span class="ruby-identifier">vaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v0</span>,<span class="ruby-identifier">v1</span>,<span class="ruby-identifier">v2</span>,<span class="ruby-identifier">v3</span>]
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">uval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-identifier">vval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">vaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-comment"># else</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">uval</span>, <span class="ruby-identifier">vval</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp3D_1" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp3D_1</span><span
            class="method-args">(u, plon, plat, pz, i, j, k, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp3D_1-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 616</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp3D_1</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">pz</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">k</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 3次元補完（１点のみ, 1変数）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-comment"># case type</span>
  <span class="ruby-comment"># when &quot;linear&quot;, &quot;cspline&quot;</span>
  <span class="ruby-identifier">sz</span> = <span class="ruby-ivar">@gslv_z</span>[<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>)]
  <span class="ruby-comment"># 鉛直内挿の係数</span>
  <span class="ruby-identifier">c0</span> = (<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">pz</span>); <span class="ruby-identifier">c1</span> = (<span class="ruby-identifier">pz</span><span class="ruby-operator">-</span><span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>]); <span class="ruby-identifier">c2</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>])
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lon_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-ivar">@gslv_lon_ext</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)]
    <span class="ruby-comment"># 鉛直内挿して、GSL::Vectorにする。</span>
    <span class="ruby-identifier">ua0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">ua3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ ((<span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>).<span class="ruby-identifier">to_a</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-identifier">ua0</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">ua1</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span>  ,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">ua2</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">ua3</span> = (<span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span>  ]]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span> <span class="ruby-operator">+</span>
           <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>], <span class="ruby-identifier">u</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>,<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>]]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>   )<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-ivar">@gslv_lat_ext</span>[(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>)]
  <span class="ruby-keyword">else</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#水平補完</span>
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">u0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">u1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua1</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">u2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua2</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">u3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua3</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">uaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u0</span>,<span class="ruby-identifier">u1</span>,<span class="ruby-identifier">u2</span>,<span class="ruby-identifier">u3</span>]
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">uval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-comment"># else</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">uval</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp4D_1_gp" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp4D_1_gp</span><span
            class="method-args">(gw, plon, plat, pz, i, j, k, t, t_div, tn, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp4D_1_gp-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 667</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp4D_1_gp</span>(<span class="ruby-identifier">gw</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">pz</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">k</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">t_div</span>, <span class="ruby-identifier">tn</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 3次元補完（１点のみ, 1変数）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-comment"># case type</span>
  <span class="ruby-comment"># when &quot;linear&quot;, &quot;cspline&quot;</span>
  <span class="ruby-identifier">sz</span> = <span class="ruby-ivar">@gslv_z</span>[<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>)]
  <span class="ruby-comment"># 鉛直内挿の係数</span>
  <span class="ruby-identifier">c0</span> = (<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">pz</span>); <span class="ruby-identifier">c1</span> = (<span class="ruby-identifier">pz</span><span class="ruby-operator">-</span><span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>]); <span class="ruby-identifier">c2</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>])
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># indexがはみ出さない場合</span>
    <span class="ruby-comment"># 必要なデータの切り出し、NArray化</span>
    <span class="ruby-identifier">w</span> = <span class="ruby-identifier">gw</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)].<span class="ruby-identifier">val</span>
    <span class="ruby-comment"># 時間内挿</span>
    <span class="ruby-identifier">w</span> = (<span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">t_div</span><span class="ruby-operator">-</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">t_div</span>
    <span class="ruby-comment"># 鉛直内挿</span>
    <span class="ruby-identifier">w</span> = (<span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-comment"># 水平補完の準備　</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-ivar">@gslv_lon_ext</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)]
    <span class="ruby-identifier">wa0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">wa1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">wa2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">wa3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">3</span>].<span class="ruby-identifier">to_a</span>]
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># indexがはみ出す場合</span>
    <span class="ruby-ivar">@w_halo</span> = <span class="ruby-identifier">data_ext_halo_only</span>(<span class="ruby-identifier">gw</span>,<span class="ruby-value">4</span>,<span class="ruby-keyword">false</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@w_halo</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 左側</span>
      <span class="ruby-identifier">w</span> = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">0</span>][(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 右側</span>
      <span class="ruby-identifier">w</span> = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">1</span>][(<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+3</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+3</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> ) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 下側</span>
      <span class="ruby-identifier">w</span> = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), (<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">j</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 上側</span>
      <span class="ruby-identifier">w</span> = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> ) <span class="ruby-keyword">then</span><span class="ruby-comment"># 下の隅</span>
      <span class="ruby-identifier">w</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">4</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">2</span>)
      <span class="ruby-identifier">w</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">w</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span>  )<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">w</span>[<span class="ruby-value">2</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">w</span>[<span class="ruby-value">3</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">j</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 上の隅</span>
      <span class="ruby-identifier">w</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">4</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">2</span>)
      <span class="ruby-identifier">w</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">w</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span>  )<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">w</span>[<span class="ruby-value">2</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">w</span>[<span class="ruby-value">3</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@w_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gw</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span> <span class="ruby-comment"># 当てはまらないはず</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># 時間内挿</span>
    <span class="ruby-identifier">w</span> = (<span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">t_div</span><span class="ruby-operator">-</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">t_div</span>
    <span class="ruby-comment"># 鉛直内挿</span>
    <span class="ruby-identifier">w</span> = (<span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-comment"># 水平補完の準備</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-identifier">wa0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">wa1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">wa2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">wa3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">w</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">3</span>].<span class="ruby-identifier">to_a</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">slat</span> = <span class="ruby-ivar">@gslv_lat_ext</span>[(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>)]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">slat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#水平補完</span>
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">wa0</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">w0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">wa0</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">w1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">wa1</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">w2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">wa2</span>, <span class="ruby-identifier">plon</span>)
    <span class="ruby-identifier">w3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">wa3</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-keyword">rescue</span>
    <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">waa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">w0</span>,<span class="ruby-identifier">w1</span>,<span class="ruby-identifier">w2</span>,<span class="ruby-identifier">w3</span>]
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">waa</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">wval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">waa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-comment"># else</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">wval</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-interp4D_gp" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">interp4D_gp</span><span
            class="method-args">(gu, gv, plon, plat, pz, i, j, k, t, t_div, tn, type=&quot;linear&quot;)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="interp4D_gp-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 434</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">interp4D_gp</span>(<span class="ruby-identifier">gu</span>, <span class="ruby-identifier">gv</span>, <span class="ruby-identifier">plon</span>, <span class="ruby-identifier">plat</span>, <span class="ruby-identifier">pz</span>, <span class="ruby-identifier">i</span>, <span class="ruby-identifier">j</span>, <span class="ruby-identifier">k</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">t_div</span>, <span class="ruby-identifier">tn</span>, <span class="ruby-identifier">type</span>=<span class="ruby-string">&quot;linear&quot;</span>) <span class="ruby-comment"># 3次元補完（１点のみ, 2変数同時）</span>
  <span class="ruby-comment"># グリッド、データ、補完座標、補完座標の左と下のインデックス</span>
  <span class="ruby-comment"># 内部で方向分離して、1次元補完を呼ぶ。</span>
  <span class="ruby-comment"># case type</span>
  <span class="ruby-comment"># when &quot;linear&quot;, &quot;cspline&quot;</span>
  <span class="ruby-identifier">sz</span> = <span class="ruby-ivar">@gslv_z</span>[<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>)]
  <span class="ruby-comment"># 鉛直内挿の係数</span>
  <span class="ruby-identifier">c0</span> = (<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>]<span class="ruby-operator">-</span><span class="ruby-identifier">pz</span>); <span class="ruby-identifier">c1</span> = (<span class="ruby-identifier">pz</span><span class="ruby-operator">-</span><span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>]); <span class="ruby-identifier">c2</span> = <span class="ruby-value">1.0</span><span class="ruby-operator">/</span>(<span class="ruby-identifier">sz</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">-</span> <span class="ruby-identifier">sz</span>[<span class="ruby-value">0</span>])

  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># indexがはみ出さない場合</span>
    <span class="ruby-comment"># 必要なデータの切り出し、NArray化</span>
    <span class="ruby-identifier">u</span> = <span class="ruby-identifier">gu</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)].<span class="ruby-identifier">val</span>
    <span class="ruby-identifier">v</span> = <span class="ruby-identifier">gv</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)].<span class="ruby-identifier">val</span>
    <span class="ruby-comment"># 時間内挿</span>
    <span class="ruby-identifier">u</span> = (<span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">t_div</span><span class="ruby-operator">-</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">t_div</span>
    <span class="ruby-identifier">v</span> = (<span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">t_div</span><span class="ruby-operator">-</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">t_div</span>
    <span class="ruby-comment"># 鉛直内挿</span>
    <span class="ruby-identifier">u</span> = (<span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">v</span> = (<span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-comment"># 水平補完の準備　</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-ivar">@gslv_lon_ext</span>[(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)]
    <span class="ruby-identifier">ua0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">ua1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">ua2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">ua3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">3</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">va1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">va2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">va3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">3</span>].<span class="ruby-identifier">to_a</span>]
  <span class="ruby-keyword">else</span> <span class="ruby-comment"># indexがはみ出す場合</span>
    <span class="ruby-ivar">@u_halo</span> = <span class="ruby-identifier">data_ext_halo_only</span>(<span class="ruby-identifier">gu</span>, <span class="ruby-value">4</span>, <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@u_halo</span>
    <span class="ruby-ivar">@v_halo</span> = <span class="ruby-identifier">data_ext_halo_only</span>(<span class="ruby-identifier">gv</span>, <span class="ruby-value">4</span>, <span class="ruby-keyword">true</span>) <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@v_halo</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 左側</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">0</span>][(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span> = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">0</span>][(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 右側</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">1</span>][(<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+3</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+3</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span> = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">1</span>][(<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+3</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">+3</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> ) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 下側</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), (<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span> = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>), (<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">i</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">j</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 上側</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span> = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>),(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span><span class="ruby-value">+2</span>),<span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">1</span> ) <span class="ruby-keyword">then</span><span class="ruby-comment"># 下の隅</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">4</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">2</span>)
      <span class="ruby-identifier">u</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">u</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span>  )<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">u</span>[<span class="ruby-value">2</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">u</span>[<span class="ruby-value">3</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">4</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">2</span>)
      <span class="ruby-identifier">v</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span>  )<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span>[<span class="ruby-value">2</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span>[<span class="ruby-value">3</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">2</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-value">4</span><span class="ruby-operator">+</span><span class="ruby-identifier">j</span><span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">elsif</span> (<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">-3</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">j</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># 上の隅</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">4</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">2</span>)
      <span class="ruby-identifier">u</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">u</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span>  )<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">u</span>[<span class="ruby-value">2</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">u</span>[<span class="ruby-value">3</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@u_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-value">4</span>,<span class="ruby-value">4</span>,<span class="ruby-value">2</span>,<span class="ruby-value">2</span>)
      <span class="ruby-identifier">v</span>[<span class="ruby-value">0</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span>[<span class="ruby-value">1</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span>  )<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span>[<span class="ruby-value">2</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
      <span class="ruby-identifier">v</span>[<span class="ruby-value">3</span>,<span class="ruby-keyword">false</span>] = <span class="ruby-ivar">@v_halo</span>[<span class="ruby-value">3</span>][(<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>)<span class="ruby-operator">%</span><span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">0</span>],(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-operator">-</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">shape</span>[<span class="ruby-value">1</span>]<span class="ruby-value">+3</span>)<span class="ruby-value">+2</span>), <span class="ruby-identifier">k</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">k</span><span class="ruby-value">+1</span>),<span class="ruby-identifier">t</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">t</span><span class="ruby-value">+1</span>)]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span> <span class="ruby-comment"># 当てはまらないはず</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># 時間内挿</span>
    <span class="ruby-identifier">u</span> = (<span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">t_div</span><span class="ruby-operator">-</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">t_div</span>
    <span class="ruby-identifier">v</span> = (<span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span>(<span class="ruby-identifier">t_div</span><span class="ruby-operator">-</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">tn</span>)<span class="ruby-operator">/</span><span class="ruby-identifier">t_div</span>
    <span class="ruby-comment"># 鉛直内挿</span>
    <span class="ruby-identifier">u</span> = (<span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-identifier">v</span> = (<span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">0</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c0</span><span class="ruby-operator">+</span><span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>,<span class="ruby-keyword">true</span>,<span class="ruby-value">1</span>]<span class="ruby-operator">*</span><span class="ruby-identifier">c1</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">c2</span>
    <span class="ruby-comment"># 水平補完の準備</span>
    <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lon_ext</span>[<span class="ruby-identifier">i</span><span class="ruby-value">+2</span>] ]
    <span class="ruby-identifier">ua0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">ua1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">ua2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">ua3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">u</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">3</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-identifier">va0</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">0</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">va1</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">1</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">va2</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">2</span>].<span class="ruby-identifier">to_a</span>]; <span class="ruby-identifier">va3</span> =  <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-identifier">v</span>[<span class="ruby-keyword">true</span>, <span class="ruby-value">3</span>].<span class="ruby-identifier">to_a</span>]
    <span class="ruby-keyword">rescue</span>
    <span class="ruby-identifier">binding</span>.<span class="ruby-identifier">pry</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">#</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># p i, j</span>
    <span class="ruby-comment"># p &quot;I0&quot;</span>
    <span class="ruby-comment"># imax = gu.shape[0] ; ia = [(i-1)%imax, i%imax, (i+1)%imax, (i+2)%imax] # 東西は周期境界</span>
    <span class="ruby-comment"># jmax = gu.shape[1]-1; ja = [j-1, j, j+1, j+2]</span>
    <span class="ruby-comment"># a = NArray.sfloat(4,4).fill(1.0) # ベクトル成分を反転するかどうかの係数</span>
    <span class="ruby-comment"># 4.times{|m|</span>
    <span class="ruby-comment">#   if (ja[m] &gt; jmax) then</span>
    <span class="ruby-comment">#     ja[m] = 2*jmax-ja[m]; a[true,m] = -1.0; ia[m] = (ia[m]+imax/2)%imax # 東西半球を反転させる</span>
    <span class="ruby-comment">#   elsif (ja[m] &lt; 0) then</span>
    <span class="ruby-comment">#     ja[m] = -ja[m]      ; a[true,m] = -1.0; ia[m] = (ia[m]+imax/2)%imax # 東西半球を反転させる</span>
    <span class="ruby-comment">#   end</span>
    <span class="ruby-comment"># }</span>
    <span class="ruby-comment"># p &quot;I1&quot;</span>
    <span class="ruby-comment"># # 必要なデータの切り出し、NArray化</span>
    <span class="ruby-comment"># gu = gu.val</span>
    <span class="ruby-comment"># uk0t0 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gu[ia[0],ja[0],k,t], gu[ia[1],ja[0],k,t], gu[ia[2],ja[0],k,t], gu[ia[3],ja[0],k,t]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[1],k,t], gu[ia[1],ja[1],k,t], gu[ia[2],ja[1],k,t], gu[ia[3],ja[1],k,t]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[2],k,t], gu[ia[1],ja[2],k,t], gu[ia[2],ja[2],k,t], gu[ia[3],ja[2],k,t]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[3],k,t], gu[ia[1],ja[3],k,t], gu[ia[2],ja[3],k,t], gu[ia[3],ja[3],k,t]] ] )</span>
    <span class="ruby-comment"># uk1t0 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gu[ia[0],ja[0],k+1,t], gu[ia[1],ja[0],k+1,t], gu[ia[2],ja[0],k+1,t], gu[ia[3],ja[0],k+1,t]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[1],k+1,t], gu[ia[1],ja[1],k+1,t], gu[ia[2],ja[1],k+1,t], gu[ia[3],ja[1],k+1,t]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[2],k+1,t], gu[ia[1],ja[2],k+1,t], gu[ia[2],ja[2],k+1,t], gu[ia[3],ja[2],k+1,t]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[3],k+1,t], gu[ia[1],ja[3],k+1,t], gu[ia[2],ja[3],k+1,t], gu[ia[3],ja[3],k+1,t]] ] )</span>
    <span class="ruby-comment"># uk0t1 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gu[ia[0],ja[0],k,t+1], gu[ia[1],ja[0],k,t+1], gu[ia[2],ja[0],k,t+1], gu[ia[3],ja[0],k,t+1]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[1],k,t+1], gu[ia[1],ja[1],k,t+1], gu[ia[2],ja[1],k,t+1], gu[ia[3],ja[1],k,t+1]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[2],k,t+1], gu[ia[1],ja[2],k,t+1], gu[ia[2],ja[2],k,t+1], gu[ia[3],ja[2],k,t+1]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[3],k,t+1], gu[ia[1],ja[3],k,t+1], gu[ia[2],ja[3],k,t+1], gu[ia[3],ja[3],k,t+1]] ] )</span>
    <span class="ruby-comment"># uk1t1 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gu[ia[0],ja[0],k+1,t+1], gu[ia[1],ja[0],k+1,t+1], gu[ia[2],ja[0],k+1,t+1], gu[ia[3],ja[0],k+1,t+1]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[1],k+1,t+1], gu[ia[1],ja[1],k+1,t+1], gu[ia[2],ja[1],k+1,t+1], gu[ia[3],ja[1],k+1,t+1]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[2],k+1,t+1], gu[ia[1],ja[2],k+1,t+1], gu[ia[2],ja[2],k+1,t+1], gu[ia[3],ja[2],k+1,t+1]],</span>
    <span class="ruby-comment">#         [gu[ia[0],ja[3],k+1,t+1], gu[ia[1],ja[3],k+1,t+1], gu[ia[2],ja[3],k+1,t+1], gu[ia[3],ja[3],k+1,t+1]] ] )</span>
    <span class="ruby-comment"># uk0t0.map!{|i| i}; uk0t0 = uk0t0.to_type(4)*a</span>
    <span class="ruby-comment"># uk1t0.map!{|i| i}; uk1t0 = uk1t0.to_type(4)*a</span>
    <span class="ruby-comment"># uk0t1.map!{|i| i}; uk0t1 = uk0t1.to_type(4)*a</span>
    <span class="ruby-comment"># uk1t1.map!{|i| i}; uk1t1 = uk1t1.to_type(4)*a</span>
    <span class="ruby-comment"># p &quot;I2&quot;</span>
    <span class="ruby-comment"># vk0t0 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gv[ia[0],ja[0],k,t], gv[ia[1],ja[0],k,t], gv[ia[2],ja[0],k,t], gv[ia[3],ja[0],k,t]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[1],k,t], gv[ia[1],ja[1],k,t], gv[ia[2],ja[1],k,t], gv[ia[3],ja[1],k,t]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[2],k,t], gv[ia[1],ja[2],k,t], gv[ia[2],ja[2],k,t], gv[ia[3],ja[2],k,t]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[3],k,t], gv[ia[1],ja[3],k,t], gv[ia[2],ja[3],k,t], gv[ia[3],ja[3],k,t]] ] )</span>
    <span class="ruby-comment"># vk1t0 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gv[ia[0],ja[0],k+1,t], gv[ia[1],ja[0],k+1,t], gv[ia[2],ja[0],k+1,t], gv[ia[3],ja[0],k+1,t]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[1],k+1,t], gv[ia[1],ja[1],k+1,t], gv[ia[2],ja[1],k+1,t], gv[ia[3],ja[1],k+1,t]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[2],k+1,t], gv[ia[1],ja[2],k+1,t], gv[ia[2],ja[2],k+1,t], gv[ia[3],ja[2],k+1,t]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[3],k+1,t], gv[ia[1],ja[3],k+1,t], gv[ia[2],ja[3],k+1,t], gv[ia[3],ja[3],k+1,t]] ] )</span>
    <span class="ruby-comment"># vk0t1 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gv[ia[0],ja[0],k,t+1], gv[ia[1],ja[0],k,t+1], gv[ia[2],ja[0],k,t+1], gv[ia[3],ja[0],k,t+1]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[1],k,t+1], gv[ia[1],ja[1],k,t+1], gv[ia[2],ja[1],k,t+1], gv[ia[3],ja[1],k,t+1]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[2],k,t+1], gv[ia[1],ja[2],k,t+1], gv[ia[2],ja[2],k,t+1], gv[ia[3],ja[2],k,t+1]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[3],k,t+1], gv[ia[1],ja[3],k,t+1], gv[ia[2],ja[3],k,t+1], gv[ia[3],ja[3],k,t+1]] ] )</span>
    <span class="ruby-comment"># vk1t1 = NArray.to_na(</span>
    <span class="ruby-comment">#       [ [gv[ia[0],ja[0],k+1,t+1], gv[ia[1],ja[0],k+1,t+1], gv[ia[2],ja[0],k+1,t+1], gv[ia[3],ja[0],k+1,t+1]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[1],k+1,t+1], gv[ia[1],ja[1],k+1,t+1], gv[ia[2],ja[1],k+1,t+1], gv[ia[3],ja[1],k+1,t+1]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[2],k+1,t+1], gv[ia[1],ja[2],k+1,t+1], gv[ia[2],ja[2],k+1,t+1], gv[ia[3],ja[2],k+1,t+1]],</span>
    <span class="ruby-comment">#         [gv[ia[0],ja[3],k+1,t+1], gv[ia[1],ja[3],k+1,t+1], gv[ia[2],ja[3],k+1,t+1], gv[ia[3],ja[3],k+1,t+1]] ] )</span>
    <span class="ruby-comment"># vk0t0.map!{|i| i.val[0]}; vk0t0 = vk0t0.to_type(4)*a</span>
    <span class="ruby-comment"># vk1t0.map!{|i| i.val[0]}; vk1t0 = vk1t0.to_type(4)*a</span>
    <span class="ruby-comment"># vk0t1.map!{|i| i.val[0]}; vk0t1 = vk0t1.to_type(4)*a</span>
    <span class="ruby-comment"># vk1t1.map!{|i| i.val[0]}; vk1t1 = vk1t1.to_type(4)*a</span>
    <span class="ruby-comment"># p &quot;I3&quot;</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># # 時間内挿</span>
    <span class="ruby-comment"># uk0 = (uk0t0*(t_div-n)+uk0t1*n)/t_div; uk1 = (uk1t0*(t_div-n)+uk1t1*n)/t_div</span>
    <span class="ruby-comment"># vk0 = (vk0t0*(t_div-n)+vk0t1*n)/t_div; vk1 = (vk1t0*(t_div-n)+vk1t1*n)/t_div</span>
    <span class="ruby-comment"># # 鉛直内挿</span>
    <span class="ruby-comment"># u = (uk0*c0+uk1*c1)*c2</span>
    <span class="ruby-comment"># v = (vk0*c0+vk1*c1)*c2</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-value">1</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">j</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-ivar">@gslv_lat_ext</span>.<span class="ruby-identifier">length</span><span class="ruby-value">-3</span>) <span class="ruby-keyword">then</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-ivar">@gslv_lat_ext</span>[(<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>)<span class="ruby-operator">..</span>(<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>)]
  <span class="ruby-keyword">else</span>
   <span class="ruby-identifier">slat</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[ <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">-1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+1</span>], <span class="ruby-ivar">@gslv_lat_ext</span>[<span class="ruby-identifier">j</span><span class="ruby-value">+2</span>] ]
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">#水平補完</span>
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">u0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua0</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua1</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua2</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">u3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">ua3</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v0</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va0</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v1</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va1</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v2</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va2</span>, <span class="ruby-identifier">plon</span>)
  <span class="ruby-identifier">v3</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">va3</span>, <span class="ruby-identifier">plon</span>)

  <span class="ruby-identifier">uaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">u0</span>,<span class="ruby-identifier">u1</span>,<span class="ruby-identifier">u2</span>,<span class="ruby-identifier">u3</span>]
  <span class="ruby-identifier">vaa</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Vector</span>[<span class="ruby-identifier">v0</span>,<span class="ruby-identifier">v1</span>,<span class="ruby-identifier">v2</span>,<span class="ruby-identifier">v3</span>]
  <span class="ruby-identifier">ip</span> = <span class="ruby-constant">GSL</span><span class="ruby-operator">::</span><span class="ruby-constant">Interp</span>.<span class="ruby-identifier">alloc</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>) <span class="ruby-comment"># 初期化</span>
  <span class="ruby-identifier">uval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">uaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-identifier">vval</span> = <span class="ruby-identifier">ip</span>.<span class="ruby-identifier">eval</span>(<span class="ruby-identifier">slat</span>, <span class="ruby-identifier">vaa</span>, <span class="ruby-identifier">plat</span>)
  <span class="ruby-comment"># else</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">uval</span>, <span class="ruby-identifier">vval</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-lonlat2xyz" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lonlat2xyz</span><span
            class="method-args">(lon, lat, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="lonlat2xyz-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 126</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">lonlat2xyz</span>(<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment"># 緯度経度座標からデカルト座標に変換</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">lon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">x</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">r</span>
    <span class="ruby-identifier">y</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">r</span>
    <span class="ruby-identifier">z</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">r</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">x</span> = <span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">r</span>
    <span class="ruby-identifier">y</span> = <span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">r</span>
    <span class="ruby-identifier">z</span> = <span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">r</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-particle_advection_2D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">particle_advection_2D</span><span
            class="method-args">(p_lon, p_lat, gu, gv, dt)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>始点グリッド(slon, slat, sz)と水平流速場(u,v)を与えて、 終点グリッド(elon, elat, ez)を返す。u, v は GPhysオブジェクト dt もGPhysオブジェクト（単位つき）で渡す</p>
          
          

          
          <div class="method-source-code" id="particle_advection_2D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 817</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">particle_advection_2D</span>(<span class="ruby-identifier">p_lon</span>, <span class="ruby-identifier">p_lat</span>, <span class="ruby-identifier">gu</span>, <span class="ruby-identifier">gv</span>, <span class="ruby-identifier">dt</span>)
  <span class="ruby-identifier">vTYPE</span> = <span class="ruby-string">&quot;cspline&quot;</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">dt</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">VArray</span> <span class="ruby-keyword">then</span><span class="ruby-comment"># dtを負で与えることで、始点探索を終点探索に変える。</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">dt</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">dt</span>.<span class="ruby-identifier">units</span>=<span class="ruby-identifier">dt</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">strip</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">dt_in_sec</span> = <span class="ruby-operator">-</span>(<span class="ruby-constant">UNumeric</span>[<span class="ruby-value">0.0</span>,<span class="ruby-string">&quot;s&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">dt</span>).<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">dt_in_sec</span> = <span class="ruby-operator">-</span>(<span class="ruby-constant">UNumeric</span>[<span class="ruby-value">0.0</span>,<span class="ruby-string">&quot;s&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">dt</span>).<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># 始点位置のGPhysをNArray化。単位変換（Deg→Rad）も実施。</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;deg&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>; <span class="ruby-identifier">slat</span> = <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">slon</span> = <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">val</span>    ; <span class="ruby-identifier">slat</span> = <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">val</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-comment"># 流速のNArray化と拡張</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArrayMiss</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">u_ext</span> = <span class="ruby-identifier">data_ext</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>, <span class="ruby-value">4</span>)
    <span class="ruby-identifier">v_ext</span> = <span class="ruby-identifier">data_ext</span>(<span class="ruby-identifier">gv</span>.<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_na</span>, <span class="ruby-value">4</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">u_ext</span> = <span class="ruby-identifier">data_ext</span>(<span class="ruby-identifier">gu</span>.<span class="ruby-identifier">val</span>, <span class="ruby-value">4</span>)
    <span class="ruby-identifier">v_ext</span> = <span class="ruby-identifier">data_ext</span>(<span class="ruby-identifier">gv</span>.<span class="ruby-identifier">val</span>, <span class="ruby-value">4</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># 初期推定値</span>
  <span class="ruby-identifier">mlon</span> = <span class="ruby-identifier">slon</span>; <span class="ruby-identifier">mlat</span> = <span class="ruby-identifier">slat</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">i_st</span>, <span class="ruby-identifier">j_st</span> = <span class="ruby-identifier">find_stencil</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>)
    <span class="ruby-identifier">mu</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>); <span class="ruby-identifier">mv</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>)
    <span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">mv</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">interp2D_2</span>(<span class="ruby-identifier">u_ext</span>,<span class="ruby-identifier">v_ext</span>,<span class="ruby-identifier">slon</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">slat</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">j_st</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">vTYPE</span>)
    }
  <span class="ruby-comment"># elsif (true) then # 以下も遅い</span>
  <span class="ruby-comment">#   mu = NArray.sfloat(slon.length); mv = NArray.sfloat(slon.length)</span>
  <span class="ruby-comment">#   slon.length.times{|n|</span>
  <span class="ruby-comment">#     mu[n] = gu.cut(slon[n],slat[n]).val</span>
  <span class="ruby-comment">#     mv[n] = gv.cut(slon[n],slat[n]).val</span>
  <span class="ruby-comment">#   }</span>
  <span class="ruby-comment"># elsif (true) then # 以下は遅い</span>
  <span class="ruby-comment">#   tmp = NMatrix.to_na(gu.cut(slon,slat).val.to_a) # NMatrix 生成</span>
  <span class="ruby-comment">#   mu = NArray.to_na( (tmp - tmp.diagonal(0)).sum(1).flatten.to_a ) # 対角成分だけ取り出したい</span>
  <span class="ruby-comment">#   tmp = NMatrix.to_na(gv.cut(slon,slat).val.to_a) # NMatrix 生成</span>
  <span class="ruby-comment">#   mv = NArray.to_na( (tmp - tmp.diagonal(0)).sum(1).flatten.to_a ) # 対角成分だけ取り出したい</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">mu</span> = <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">slon</span>,<span class="ruby-identifier">slat</span>).<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">mv</span> = <span class="ruby-identifier">gv</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">slon</span>,<span class="ruby-identifier">slat</span>).<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Ritchie (1987)「大円上の等角速度運動を仮定」の方法</span>
  <span class="ruby-value">10</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">it</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># 前回の推定値を保存</span>
    <span class="ruby-identifier">pmlon</span> = <span class="ruby-identifier">mlon</span>; <span class="ruby-identifier">pmlat</span> = <span class="ruby-identifier">mlat</span>
    <span class="ruby-comment"># 中間点の推定</span>
    <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span> = <span class="ruby-identifier">find_midpoint</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">mu</span>, <span class="ruby-identifier">mv</span>, <span class="ruby-identifier">dt_in_sec</span>, <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>.<span class="ruby-identifier">to_f</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">it</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">dellon</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlon</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlon</span>)
        <span class="ruby-identifier">dellat</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlat</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlat</span>)
        <span class="ruby-identifier">delta</span> = [<span class="ruby-identifier">dellon</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">max</span>, <span class="ruby-identifier">dellat</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">max</span>].<span class="ruby-identifier">max</span>
        <span class="ruby-identifier">delmean</span> = [<span class="ruby-identifier">dellon</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">mean</span>, <span class="ruby-identifier">dellat</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">mean</span>]
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">dellon</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlon</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlon</span>)
        <span class="ruby-identifier">dellat</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlat</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlat</span>)
        <span class="ruby-identifier">delta</span> = [<span class="ruby-identifier">dellon</span>.<span class="ruby-identifier">abs</span>, <span class="ruby-identifier">dellat</span>.<span class="ruby-identifier">abs</span>].<span class="ruby-identifier">max</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">delta</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0.01</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">it</span> <span class="ruby-operator">==</span> <span class="ruby-value">9</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># ステンシルを求める</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">i_st</span>, <span class="ruby-identifier">j_st</span> = <span class="ruby-identifier">find_stencil</span>(<span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>)
      <span class="ruby-comment"># 中間点の u, v を求める</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">mv</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">interp2D_2</span>(<span class="ruby-identifier">u_ext</span>,<span class="ruby-identifier">v_ext</span>,<span class="ruby-identifier">mlon</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">mlat</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">j_st</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">vTYPE</span>)
        }
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">mu</span>, <span class="ruby-identifier">mv</span> = <span class="ruby-identifier">interp2D_2</span>(<span class="ruby-identifier">u_ext</span>,<span class="ruby-identifier">v_ext</span>,<span class="ruby-identifier">mlon</span>,<span class="ruby-identifier">mlat</span>,<span class="ruby-identifier">i_st</span>,<span class="ruby-identifier">j_st</span>,<span class="ruby-identifier">vTYPE</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># 中間点の u, v を求める</span>
      <span class="ruby-comment"># rlatlen.times{|j|</span>
      <span class="ruby-comment">#   rlonlen.times{|i|</span>
      <span class="ruby-comment">#     next if (rad_org[i,j] == miss_value) # 欠損値グリッドはスキップ</span>
      <span class="ruby-comment">#     next if ([dellon[i,j].abs, dellat[i,j].abs].max &lt; EPS)</span>
      <span class="ruby-comment">#     i_st[i,j] = GSL::Interp.bsearch(gslv_gvlon, mlon[i,j], 0, gvlon_ext.length-1)</span>
      <span class="ruby-comment">#     j_st[i,j] = GSL::Interp.bsearch(gslv_gvlat, mlat[i,j], 0, gvlat_ext.length-1)</span>
      <span class="ruby-comment">#     mu[i,j], mv[i,j] = interp2D_2(lon_ext,lat_ext,u_ext,v_ext,mlon[i,j],mlat[i,j],i_st[i,j],j_st[i,j], vTYPE)</span>
      <span class="ruby-comment">#   }</span>
      <span class="ruby-comment"># }</span>
    <span class="ruby-keyword">end</span>
  }<span class="ruby-comment"># イタレーション ここまで</span>

  <span class="ruby-comment"># 始点を求める</span>
  <span class="ruby-identifier">elon</span>, <span class="ruby-identifier">elat</span> = <span class="ruby-identifier">find_departurepoint</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>, <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>.<span class="ruby-identifier">to_f</span>)
  <span class="ruby-comment">######### Ritchie (1987) ここまで ############</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;deg&quot;</span>)) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elon</span><span class="ruby-operator">*</span><span class="ruby-constant">R2D</span>)
    <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elat</span><span class="ruby-operator">*</span><span class="ruby-constant">R2D</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elon</span>)
    <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elat</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">t</span> = <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>)
  <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">t</span><span class="ruby-operator">+</span><span class="ruby-identifier">dt</span>.<span class="ruby-identifier">val</span>)
  <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">t</span><span class="ruby-operator">+</span><span class="ruby-identifier">dt</span>.<span class="ruby-identifier">val</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">p_lon</span>, <span class="ruby-identifier">p_lat</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-particle_advection_3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">particle_advection_3D</span><span
            class="method-args">(p_lon, p_lat, p_z, gu, gv, gw, dt, t, t_div, tn)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>始点グリッド(slon, slat, sz)と水平流速場(u,v)を与えて、 終点グリッド(elon, elat, ez)を返す。u, v は GPhysオブジェクト dt もGPhysオブジェクト（単位つき）で渡す 計算手順：水平と鉛直は方向分離で計算する</p>

<pre>sz の高度で中間点(mlon, mlat)、終点(elon,elat)をもとめ、
中間点の鉛直流の値で sz → ezの鉛直変位を計算する。</pre>
          
          

          
          <div class="method-source-code" id="particle_advection_3D-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 937</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">particle_advection_3D</span>(<span class="ruby-identifier">p_lon</span>, <span class="ruby-identifier">p_lat</span>, <span class="ruby-identifier">p_z</span>, <span class="ruby-identifier">gu</span>, <span class="ruby-identifier">gv</span>, <span class="ruby-identifier">gw</span>, <span class="ruby-identifier">dt</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">t_div</span>, <span class="ruby-identifier">tn</span>)
    <span class="ruby-identifier">vTYPE</span> = <span class="ruby-string">&quot;cspline&quot;</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">dt</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">VArray</span> <span class="ruby-keyword">then</span><span class="ruby-comment"># dtを負で与えることで、始点探索を終点探索に変える。</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">dt</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;since&quot;</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">dt</span>.<span class="ruby-identifier">units</span>=<span class="ruby-identifier">dt</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">split</span>(<span class="ruby-string">&quot;since&quot;</span>)[<span class="ruby-value">0</span>].<span class="ruby-identifier">strip</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">dt_in_sec</span> = <span class="ruby-operator">-</span>(<span class="ruby-constant">UNumeric</span>[<span class="ruby-value">0.0</span>,<span class="ruby-string">&quot;s&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">dt</span>).<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">dt_in_sec</span> = <span class="ruby-operator">-</span>(<span class="ruby-constant">UNumeric</span>[<span class="ruby-value">0.0</span>,<span class="ruby-string">&quot;s&quot;</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">dt</span>).<span class="ruby-identifier">to_f</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 始点位置のGPhysをNArray化。単位変換（Deg→Rad）も実施。</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;deg&quot;</span>)) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">slon</span> = <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>; <span class="ruby-identifier">slat</span> = <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">val</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">slon</span> = <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">val</span>    ; <span class="ruby-identifier">slat</span> = <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 鉛直位置のNArray化</span>
    <span class="ruby-identifier">sz</span> = <span class="ruby-identifier">p_z</span>.<span class="ruby-identifier">val</span>
    <span class="ruby-comment"># 流速のNArray化と拡張</span>
    <span class="ruby-comment"># if (gu.val.class == NArrayMiss) then</span>
      <span class="ruby-comment"># u_ext = data_ext(gu.val.to_na, 4)</span>
      <span class="ruby-comment"># v_ext = data_ext(gv.val.to_na, 4)</span>
      <span class="ruby-comment"># w_ext = data_ext(gw.val.to_na, 4)</span>
    <span class="ruby-comment"># else</span>
      <span class="ruby-comment"># u_ext = data_ext(gu.val, 4)</span>
      <span class="ruby-comment"># v_ext = data_ext(gv.val, 4)</span>
      <span class="ruby-comment"># w_ext = data_ext(gw.val, 4)</span>
    <span class="ruby-comment"># end</span>
    <span class="ruby-comment"># @u_halo = data_ext_halo_only(gu, 4, true)</span>
    <span class="ruby-comment"># @v_halo = data_ext_halo_only(gv, 4, true)</span>
    <span class="ruby-comment"># @w_halo = data_ext_halo_only(gw, 4, false)</span>
    <span class="ruby-ivar">@u_halo</span> = <span class="ruby-keyword">nil</span>; <span class="ruby-ivar">@v_halo</span> = <span class="ruby-keyword">nil</span>; <span class="ruby-ivar">@w_halo</span> = <span class="ruby-keyword">nil</span>

    <span class="ruby-comment"># 初期推定値</span>
    <span class="ruby-identifier">mlon</span> = <span class="ruby-identifier">slon</span>; <span class="ruby-identifier">mlat</span> = <span class="ruby-identifier">slat</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">i_st</span>, <span class="ruby-identifier">j_st</span> = <span class="ruby-identifier">find_stencil</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>)
      <span class="ruby-identifier">k_st</span> = <span class="ruby-identifier">find_stencil_1D</span>(<span class="ruby-identifier">sz</span>)
      <span class="ruby-identifier">mu</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>); <span class="ruby-identifier">mv</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>); <span class="ruby-identifier">mw</span> = <span class="ruby-constant">NArray</span>.<span class="ruby-identifier">sfloat</span>(<span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>)
      <span class="ruby-identifier">slon</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
<span class="ruby-comment">#        mu[n], mv[n] = interp3D(u_ext,v_ext,slon[n],slat[n],sz[n],i_st[n],j_st[n],k_st[n],vTYPE)</span>
        <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">mv</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">interp4D_gp</span>(<span class="ruby-identifier">gu</span>,<span class="ruby-identifier">gv</span>,<span class="ruby-identifier">slon</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">slat</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">sz</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">j_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">k_st</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">t</span>, <span class="ruby-identifier">t_div</span>, <span class="ruby-identifier">tn</span>, <span class="ruby-identifier">vTYPE</span>)
      }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">mu</span> = <span class="ruby-identifier">gu</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">slon</span>,<span class="ruby-identifier">slat</span>).<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]; <span class="ruby-identifier">mv</span> = <span class="ruby-identifier">gv</span>.<span class="ruby-identifier">cut</span>(<span class="ruby-identifier">slon</span>,<span class="ruby-identifier">slat</span>).<span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># Ritchie (1987)「大円上の等角速度運動を仮定」の方法</span>
    <span class="ruby-value">10</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">it</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># 前回の推定値を保存</span>
      <span class="ruby-identifier">pmlon</span> = <span class="ruby-identifier">mlon</span>; <span class="ruby-identifier">pmlat</span> = <span class="ruby-identifier">mlat</span>
      <span class="ruby-comment"># 中間点の推定</span>
      <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span> = <span class="ruby-identifier">find_midpoint</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">mu</span>, <span class="ruby-identifier">mv</span>, <span class="ruby-identifier">dt_in_sec</span>, <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>.<span class="ruby-identifier">to_f</span>)
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">it</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">dellon</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlon</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlon</span>)
          <span class="ruby-identifier">dellat</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlat</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlat</span>)
          <span class="ruby-identifier">delta</span> = [<span class="ruby-identifier">dellon</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">max</span>, <span class="ruby-identifier">dellat</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">max</span>].<span class="ruby-identifier">max</span>
          <span class="ruby-identifier">delmean</span> = [<span class="ruby-identifier">dellon</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">mean</span>, <span class="ruby-identifier">dellat</span>.<span class="ruby-identifier">abs</span>.<span class="ruby-identifier">mean</span>]
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">dellon</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlon</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlon</span>)
          <span class="ruby-identifier">dellat</span> = <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">mlat</span>) <span class="ruby-operator">-</span> <span class="ruby-constant">Math</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">pmlat</span>)
          <span class="ruby-identifier">delta</span> = [<span class="ruby-identifier">dellon</span>.<span class="ruby-identifier">abs</span>, <span class="ruby-identifier">dellat</span>.<span class="ruby-identifier">abs</span>].<span class="ruby-identifier">max</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">delta</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0.001</span><span class="ruby-operator">*</span><span class="ruby-constant">D2R</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-identifier">it</span> <span class="ruby-operator">==</span> <span class="ruby-value">9</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-comment"># ステンシルを求める</span>
      <span class="ruby-keyword">if</span> (<span class="ruby-keyword">true</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">i_st</span>, <span class="ruby-identifier">j_st</span> = <span class="ruby-identifier">find_stencil</span>(<span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>)
        <span class="ruby-comment"># 中間点の u, v を求める</span>
        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
<span class="ruby-comment">#            mu[n], mv[n] = interp3D(u_ext,v_ext,mlon[n],mlat[n],sz[n],i_st[n],j_st[n],k_st[n], vTYPE)</span>
            <span class="ruby-identifier">mu</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">mv</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">interp4D_gp</span>(<span class="ruby-identifier">gu</span>,<span class="ruby-identifier">gv</span>,<span class="ruby-identifier">mlon</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">mlat</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">sz</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">j_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">k_st</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">t</span>, <span class="ruby-identifier">t_div</span>, <span class="ruby-identifier">tn</span>, <span class="ruby-identifier">vTYPE</span>)
          }
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">mu</span>, <span class="ruby-identifier">mv</span> = <span class="ruby-identifier">interp3D</span>(<span class="ruby-identifier">u_ext</span>,<span class="ruby-identifier">v_ext</span>,<span class="ruby-identifier">mlon</span>,<span class="ruby-identifier">mlat</span>,<span class="ruby-identifier">sz</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>,<span class="ruby-identifier">j_st</span>,<span class="ruby-identifier">k_st</span>,<span class="ruby-identifier">vTYPE</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-comment"># 中間点の u, v を求める</span>
        <span class="ruby-comment"># rlatlen.times{|j|</span>
        <span class="ruby-comment">#   rlonlen.times{|i|</span>
        <span class="ruby-comment">#     next if (rad_org[i,j] == miss_value) # 欠損値グリッドはスキップ</span>
        <span class="ruby-comment">#     next if ([dellon[i,j].abs, dellat[i,j].abs].max &lt; EPS)</span>
        <span class="ruby-comment">#     i_st[i,j] = GSL::Interp.bsearch(gslv_gvlon, mlon[i,j], 0, gvlon_ext.length-1)</span>
        <span class="ruby-comment">#     j_st[i,j] = GSL::Interp.bsearch(gslv_gvlat, mlat[i,j], 0, gvlat_ext.length-1)</span>
        <span class="ruby-comment">#     mu[i,j], mv[i,j] = interp2D_2(lon_ext,lat_ext,u_ext,v_ext,mlon[i,j],mlat[i,j],i_st[i,j],j_st[i,j], vTYPE)</span>
        <span class="ruby-comment">#   }</span>
        <span class="ruby-comment"># }</span>
      <span class="ruby-keyword">end</span>
    }<span class="ruby-comment"># イタレーション ここまで</span>
    <span class="ruby-comment"># 始点を求める</span>
    <span class="ruby-identifier">elon</span>, <span class="ruby-identifier">elat</span> = <span class="ruby-identifier">find_departurepoint</span>(<span class="ruby-identifier">slon</span>, <span class="ruby-identifier">slat</span>, <span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>, <span class="ruby-constant">GAnalysis</span><span class="ruby-operator">::</span><span class="ruby-constant">Planet</span>.<span class="ruby-identifier">radius</span>.<span class="ruby-identifier">to_f</span>)

    <span class="ruby-comment"># 中間点での w を求める</span>
    <span class="ruby-identifier">i_st</span>, <span class="ruby-identifier">j_st</span> = <span class="ruby-identifier">find_stencil</span>(<span class="ruby-identifier">mlon</span>, <span class="ruby-identifier">mlat</span>)
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">mlon</span>.<span class="ruby-identifier">length</span>.<span class="ruby-identifier">times</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span>
<span class="ruby-comment">#        mw[n] = interp3D_1(w_ext,mlon[n],mlat[n],sz[n],i_st[n],j_st[n],k_st[n], vTYPE)</span>
        <span class="ruby-identifier">mw</span>[<span class="ruby-identifier">n</span>] = <span class="ruby-identifier">interp4D_1_gp</span>(<span class="ruby-identifier">gw</span>,<span class="ruby-identifier">mlon</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">mlat</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">sz</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">j_st</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">k_st</span>[<span class="ruby-identifier">n</span>], <span class="ruby-identifier">t</span>, <span class="ruby-identifier">t_div</span>, <span class="ruby-identifier">tn</span>, <span class="ruby-identifier">vTYPE</span>)
      }
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">mw</span> = <span class="ruby-identifier">interp3D_1</span>(<span class="ruby-identifier">w_ext</span>,<span class="ruby-identifier">mlon</span>,<span class="ruby-identifier">mlat</span>,<span class="ruby-identifier">sz</span>[<span class="ruby-identifier">n</span>],<span class="ruby-identifier">i_st</span>,<span class="ruby-identifier">j_st</span>,<span class="ruby-identifier">k_st</span>,<span class="ruby-identifier">vTYPE</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-comment"># 中間点の w の値で鉛直移流させる</span>
    <span class="ruby-identifier">sz</span>.<span class="ruby-identifier">add!</span>(<span class="ruby-identifier">mw</span><span class="ruby-operator">*</span>(<span class="ruby-operator">-</span><span class="ruby-identifier">dt_in_sec</span>))
    <span class="ruby-identifier">sz</span>.<span class="ruby-identifier">mul!</span>(<span class="ruby-identifier">sz</span>.<span class="ruby-identifier">gt</span>(<span class="ruby-value">0</span>)) <span class="ruby-comment"># 高度が負になった場合に ゼロ に補正する。</span>

<span class="ruby-comment">#    print &quot;u=#{mu[0]}, v=#{mv[0]}, w=#{mw[0]}\n&quot;</span>
<span class="ruby-comment">#    binding.pry</span>


    <span class="ruby-comment">######### Ritchie (1987) ここまで ############</span>
    <span class="ruby-keyword">if</span> (<span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">units</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-string">&quot;deg&quot;</span>)) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elon</span><span class="ruby-operator">*</span><span class="ruby-constant">R2D</span>)
      <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elat</span><span class="ruby-operator">*</span><span class="ruby-constant">R2D</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elon</span>)
      <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">elat</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">p_z</span>.<span class="ruby-identifier">replace_val</span>(<span class="ruby-identifier">sz</span>)
    <span class="ruby-identifier">t</span> = <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">coord</span>(<span class="ruby-value">-1</span>)
    <span class="ruby-identifier">p_lon</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">t</span><span class="ruby-operator">+</span><span class="ruby-identifier">dt</span>.<span class="ruby-identifier">val</span>)
    <span class="ruby-identifier">p_lat</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">t</span><span class="ruby-operator">+</span><span class="ruby-identifier">dt</span>.<span class="ruby-identifier">val</span>)
    <span class="ruby-identifier">p_z</span>.<span class="ruby-identifier">axis</span>(<span class="ruby-value">-1</span>).<span class="ruby-identifier">set_pos</span>(<span class="ruby-identifier">t</span><span class="ruby-operator">+</span><span class="ruby-identifier">dt</span>.<span class="ruby-identifier">val</span>)
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">p_lon</span>, <span class="ruby-identifier">p_lat</span>, <span class="ruby-identifier">p_z</span>




  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-uv2xyz" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">uv2xyz</span><span
            class="method-args">(u, v, lon, lat)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="uv2xyz-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 140</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">uv2xyz</span>(<span class="ruby-identifier">u</span>, <span class="ruby-identifier">v</span>, <span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>) <span class="ruby-comment"># 緯度経度座標の流速 u, v からデカルト座標の流速 xd, yd, zd に変換</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">u</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">xd</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">u</span><span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lon</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>)
    <span class="ruby-identifier">yd</span> = <span class="ruby-identifier">u</span><span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lon</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>)
    <span class="ruby-identifier">zd</span> = <span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-constant">NMath</span>.<span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">xd</span> = <span class="ruby-operator">-</span><span class="ruby-identifier">u</span><span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lon</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>)
    <span class="ruby-identifier">yd</span> = <span class="ruby-identifier">u</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lon</span>) <span class="ruby-operator">-</span> <span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lon</span>)<span class="ruby-operator">*</span><span class="ruby-identifier">sin</span>(<span class="ruby-identifier">lat</span>)
    <span class="ruby-identifier">zd</span> = <span class="ruby-identifier">v</span><span class="ruby-operator">*</span><span class="ruby-identifier">cos</span>(<span class="ruby-identifier">lat</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">xd</span>, <span class="ruby-identifier">yd</span>, <span class="ruby-identifier">zd</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-xyz2lonlat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">xyz2lonlat</span><span
            class="method-args">(x, y, z, r=1.0)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="xyz2lonlat-source">
            <pre><span class="ruby-comment"># File src/gpv_lagrange.rb, line 173</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">xyz2lonlat</span>(<span class="ruby-identifier">x</span>, <span class="ruby-identifier">y</span>, <span class="ruby-identifier">z</span>, <span class="ruby-identifier">r</span>=<span class="ruby-value">1.0</span>) <span class="ruby-comment"># デカルト座標から緯度経度座標に変換（0:2PI）</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-identifier">x</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">NArray</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">lat</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">asin</span>(<span class="ruby-identifier">z</span><span class="ruby-operator">/</span><span class="ruby-identifier">r</span>)
    <span class="ruby-identifier">lon</span> = <span class="ruby-constant">NMath</span>.<span class="ruby-identifier">atan2</span>(<span class="ruby-identifier">y</span><span class="ruby-operator">/</span><span class="ruby-identifier">r</span>,<span class="ruby-identifier">x</span><span class="ruby-operator">/</span><span class="ruby-identifier">r</span>) <span class="ruby-operator">+</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span> <span class="ruby-operator">%</span> <span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span>
    <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">lon</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">lon</span>.<span class="ruby-identifier">lt</span>(<span class="ruby-value">0</span>).<span class="ruby-identifier">to_type</span>(<span class="ruby-string">&quot;sfloat&quot;</span>)<span class="ruby-operator">*</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">lat</span> = <span class="ruby-identifier">asin</span>(<span class="ruby-identifier">z</span><span class="ruby-operator">/</span><span class="ruby-identifier">r</span>)
    <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">atan2</span>(<span class="ruby-identifier">y</span><span class="ruby-operator">/</span><span class="ruby-identifier">r</span>,<span class="ruby-identifier">x</span><span class="ruby-operator">/</span><span class="ruby-identifier">r</span>)<span class="ruby-operator">+</span><span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span> <span class="ruby-operator">%</span> <span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span>
    <span class="ruby-identifier">lon</span> = <span class="ruby-identifier">lon</span> <span class="ruby-operator">+</span> <span class="ruby-constant">PI</span><span class="ruby-operator">*</span><span class="ruby-value">2.0</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lon</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> [<span class="ruby-identifier">lon</span>, <span class="ruby-identifier">lat</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>

</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.1.1.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

